<!DOCTYPE HTML>
<html lang="en">
<head>
<!-- Generated by javadoc (17) -->
<title>SnapshotFileCache (Apache HBase 2.6.0 API)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="description" content="declaration: package: org.apache.hadoop.hbase.master.snapshot, class: SnapshotFileCache">
<meta name="generator" content="javadoc/ClassWriterImpl">
<link rel="stylesheet" type="text/css" href="../../../../../../stylesheet.css" title="Style">
<link rel="stylesheet" type="text/css" href="../../../../../../script-dir/jquery-ui.min.css" title="Style">
<link rel="stylesheet" type="text/css" href="../../../../../../jquery-ui.overrides.css" title="Style">
<script type="text/javascript" src="../../../../../../script.js"></script>
<script type="text/javascript" src="../../../../../../script-dir/jquery-3.6.1.min.js"></script>
<script type="text/javascript" src="../../../../../../script-dir/jquery-ui.min.js"></script>
</head>
<body class="class-declaration-page">
<script type="text/javascript">var evenRowColor = "even-row-color";
var oddRowColor = "odd-row-color";
var tableTab = "table-tab";
var activeTableTab = "active-table-tab";
var pathtoroot = "../../../../../../";
loadScripts(document, 'script');</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<div class="flex-box">
<header role="banner" class="flex-header">
<nav role="navigation">
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="top-nav" id="navbar-top">
<div class="skip-nav"><a href="#skip-navbar-top" title="Skip navigation links">Skip navigation links</a></div>
<ul id="navbar-top-firstrow" class="nav-list" title="Navigation">
<li><a href="../../../../../../index.html">Overview</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="nav-bar-cell1-rev">Class</li>
<li><a href="class-use/SnapshotFileCache.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../../../index-all.html">Index</a></li>
<li><a href="../../../../../../help-doc.html#class">Help</a></li>
</ul>
</div>
<div class="sub-nav">
<div>
<ul class="sub-nav-list">
<li>Summary:&nbsp;</li>
<li><a href="#nested-class-summary">Nested</a>&nbsp;|&nbsp;</li>
<li><a href="#field-summary">Field</a>&nbsp;|&nbsp;</li>
<li><a href="#constructor-summary">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method-summary">Method</a></li>
</ul>
<ul class="sub-nav-list">
<li>Detail:&nbsp;</li>
<li><a href="#field-detail">Field</a>&nbsp;|&nbsp;</li>
<li><a href="#constructor-detail">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method-detail">Method</a></li>
</ul>
</div>
<div class="nav-list-search"><label for="search-input">SEARCH:</label>
<input type="text" id="search-input" value="search" disabled="disabled">
<input type="reset" id="reset-button" value="reset" disabled="disabled">
</div>
</div>
<!-- ========= END OF TOP NAVBAR ========= -->
<span class="skip-nav" id="skip-navbar-top"></span></nav>
</header>
<div class="flex-content">
<main role="main">
<!-- ======== START OF CLASS DATA ======== -->
<div class="header">
<div class="sub-title"><span class="package-label-in-type">Package</span>&nbsp;<a href="package-summary.html">org.apache.hadoop.hbase.master.snapshot</a></div>
<h1 title="Class SnapshotFileCache" class="title">Class SnapshotFileCache</h1>
</div>
<div class="inheritance" title="Inheritance Tree"><a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html" title="class or interface in java.lang" class="external-link">java.lang.Object</a>
<div class="inheritance">org.apache.hadoop.hbase.master.snapshot.SnapshotFileCache</div>
</div>
<section class="class-description" id="class-description">
<dl class="notes">
<dt>All Implemented Interfaces:</dt>
<dd><code><a href="../../Stoppable.html" title="interface in org.apache.hadoop.hbase">Stoppable</a></code></dd>
</dl>
<hr>
<div class="type-signature"><span class="annotations">@Private
@Evolving
</span><span class="modifiers">public class </span><span class="element-name"><a href="../../../../../../src-html/org/apache/hadoop/hbase/master/snapshot/SnapshotFileCache.html#line-74">SnapshotFileCache</a></span>
<span class="extends-implements">extends <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html" title="class or interface in java.lang" class="external-link">Object</a>
implements <a href="../../Stoppable.html" title="interface in org.apache.hadoop.hbase">Stoppable</a></span></div>
<div class="block">Intelligently keep track of all the files for all the snapshots.
 <p>
 A cache of files is kept to avoid querying the <code>FileSystem</code> frequently. If there is a cache
 miss the directory modification time is used to ensure that we don't rescan directories that we
 already have in cache. We only check the modification times of the snapshot directories
 (/hbase/.snapshot/[snapshot_name]) to determine if the files need to be loaded into the cache.
 <p>
 New snapshots will be added to the cache and deleted snapshots will be removed when we refresh
 the cache. If the files underneath a snapshot directory are changed, but not the snapshot itself,
 we will ignore updates to that snapshot's files.
 <p>
 This is sufficient because each snapshot has its own directory and is added via an atomic rename
 <i>once</i>, when the snapshot is created. We don't need to worry about the data in the snapshot
 being run.
 <p>
 Further, the cache is periodically refreshed ensure that files in snapshots that were deleted are
 also removed from the cache.
 <p>
 A <a href="SnapshotFileCache.SnapshotFileInspector.html" title="interface in org.apache.hadoop.hbase.master.snapshot"><code>SnapshotFileCache.SnapshotFileInspector</code></a> must be passed when creating <tt>this</tt> to
 allow extraction of files under /hbase/.snapshot/[snapshot name] directory, for each snapshot.
 This allows you to only cache files under, for instance, all the logs in the .logs directory or
 all the files under all the regions.
 <p>
 <tt>this</tt> also considers all running snapshots (those under /hbase/.snapshot/.tmp) as valid
 snapshots and will attempt to cache files from those snapshots as well.
 <p>
 Queries about a given file are thread-safe with respect to multiple queries and cache refreshes.</div>
</section>
<section class="summary">
<ul class="summary-list">
<!-- ======== NESTED CLASS SUMMARY ======== -->
<li>
<section class="nested-class-summary" id="nested-class-summary">
<h2>Nested Class Summary</h2>
<div class="caption"><span>Nested Classes</span></div>
<div class="summary-table three-column-summary">
<div class="table-header col-first">Modifier and Type</div>
<div class="table-header col-second">Class</div>
<div class="table-header col-last">Description</div>
<div class="col-first even-row-color"><code>class&nbsp;</code></div>
<div class="col-second even-row-color"><code><a href="SnapshotFileCache.RefreshCacheTask.html" class="type-name-link" title="class in org.apache.hadoop.hbase.master.snapshot">SnapshotFileCache.RefreshCacheTask</a></code></div>
<div class="col-last even-row-color">
<div class="block">Simple helper task that just periodically attempts to refresh the cache</div>
</div>
<div class="col-first odd-row-color"><code>private static class&nbsp;</code></div>
<div class="col-second odd-row-color"><code><a href="SnapshotFileCache.SnapshotDirectoryInfo.html" class="type-name-link" title="class in org.apache.hadoop.hbase.master.snapshot">SnapshotFileCache.SnapshotDirectoryInfo</a></code></div>
<div class="col-last odd-row-color">
<div class="block">Information about a snapshot directory</div>
</div>
<div class="col-first even-row-color"><code>(package private) static interface&nbsp;</code></div>
<div class="col-second even-row-color"><code><a href="SnapshotFileCache.SnapshotFileInspector.html" class="type-name-link" title="interface in org.apache.hadoop.hbase.master.snapshot">SnapshotFileCache.SnapshotFileInspector</a></code></div>
<div class="col-last even-row-color">&nbsp;</div>
</div>
</section>
</li>
<!-- =========== FIELD SUMMARY =========== -->
<li>
<section class="field-summary" id="field-summary">
<h2>Field Summary</h2>
<div class="caption"><span>Fields</span></div>
<div class="summary-table three-column-summary">
<div class="table-header col-first">Modifier and Type</div>
<div class="table-header col-second">Field</div>
<div class="table-header col-last">Description</div>
<div class="col-first even-row-color"><code>private org.apache.hbase.thirdparty.com.google.common.collect.ImmutableSet&lt;<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a>&gt;</code></div>
<div class="col-second even-row-color"><code><a href="#cache" class="member-name-link">cache</a></code></div>
<div class="col-last even-row-color">&nbsp;</div>
<div class="col-first odd-row-color"><code>private final <a href="SnapshotFileCache.SnapshotFileInspector.html" title="interface in org.apache.hadoop.hbase.master.snapshot">SnapshotFileCache.SnapshotFileInspector</a></code></div>
<div class="col-second odd-row-color"><code><a href="#fileInspector" class="member-name-link">fileInspector</a></code></div>
<div class="col-last odd-row-color">&nbsp;</div>
<div class="col-first even-row-color"><code>private final org.apache.hadoop.fs.FileSystem</code></div>
<div class="col-second even-row-color"><code><a href="#fs" class="member-name-link">fs</a></code></div>
<div class="col-last even-row-color">&nbsp;</div>
<div class="col-first odd-row-color"><code>private static final int</code></div>
<div class="col-second odd-row-color"><code><a href="#LOCK_TIMEOUT_MS" class="member-name-link">LOCK_TIMEOUT_MS</a></code></div>
<div class="col-last odd-row-color">&nbsp;</div>
<div class="col-first even-row-color"><code>private static final org.slf4j.Logger</code></div>
<div class="col-second even-row-color"><code><a href="#LOG" class="member-name-link">LOG</a></code></div>
<div class="col-last even-row-color">&nbsp;</div>
<div class="col-first odd-row-color"><code>private final <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Timer.html" title="class or interface in java.util" class="external-link">Timer</a></code></div>
<div class="col-second odd-row-color"><code><a href="#refreshTimer" class="member-name-link">refreshTimer</a></code></div>
<div class="col-last odd-row-color">&nbsp;</div>
<div class="col-first even-row-color"><code>private final org.apache.hadoop.fs.Path</code></div>
<div class="col-second even-row-color"><code><a href="#snapshotDir" class="member-name-link">snapshotDir</a></code></div>
<div class="col-last even-row-color">&nbsp;</div>
<div class="col-first odd-row-color"><code>private org.apache.hbase.thirdparty.com.google.common.collect.ImmutableMap&lt;<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a>,<wbr><a href="SnapshotFileCache.SnapshotDirectoryInfo.html" title="class in org.apache.hadoop.hbase.master.snapshot">SnapshotFileCache.SnapshotDirectoryInfo</a>&gt;</code></div>
<div class="col-second odd-row-color"><code><a href="#snapshots" class="member-name-link">snapshots</a></code></div>
<div class="col-last odd-row-color">
<div class="block">This is a helper map of information about the snapshot directories so we don't need to rescan
 them if they haven't changed since the last time we looked.</div>
</div>
<div class="col-first even-row-color"><code>private boolean</code></div>
<div class="col-second even-row-color"><code><a href="#stop" class="member-name-link">stop</a></code></div>
<div class="col-last even-row-color">&nbsp;</div>
<div class="col-first odd-row-color"><code>private final org.apache.hadoop.fs.FileSystem</code></div>
<div class="col-second odd-row-color"><code><a href="#workingFs" class="member-name-link">workingFs</a></code></div>
<div class="col-last odd-row-color">&nbsp;</div>
<div class="col-first even-row-color"><code>private final org.apache.hadoop.fs.Path</code></div>
<div class="col-second even-row-color"><code><a href="#workingSnapshotDir" class="member-name-link">workingSnapshotDir</a></code></div>
<div class="col-last even-row-color">&nbsp;</div>
</div>
</section>
</li>
<!-- ======== CONSTRUCTOR SUMMARY ======== -->
<li>
<section class="constructor-summary" id="constructor-summary">
<h2>Constructor Summary</h2>
<div class="caption"><span>Constructors</span></div>
<div class="summary-table two-column-summary">
<div class="table-header col-first">Constructor</div>
<div class="table-header col-last">Description</div>
<div class="col-constructor-name even-row-color"><code><a href="#%3Cinit%3E(org.apache.hadoop.conf.Configuration,long,long,java.lang.String,org.apache.hadoop.hbase.master.snapshot.SnapshotFileCache.SnapshotFileInspector)" class="member-name-link">SnapshotFileCache</a><wbr>(org.apache.hadoop.conf.Configuration&nbsp;conf,
 long&nbsp;cacheRefreshPeriod,
 long&nbsp;cacheRefreshDelay,
 <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a>&nbsp;refreshThreadName,
 <a href="SnapshotFileCache.SnapshotFileInspector.html" title="interface in org.apache.hadoop.hbase.master.snapshot">SnapshotFileCache.SnapshotFileInspector</a>&nbsp;inspectSnapshotFiles)</code></div>
<div class="col-last even-row-color">
<div class="block">Create a snapshot file cache for all snapshots under the specified [root]/.snapshot on the
 filesystem.</div>
</div>
<div class="col-constructor-name odd-row-color"><code><a href="#%3Cinit%3E(org.apache.hadoop.fs.FileSystem,org.apache.hadoop.fs.Path,org.apache.hadoop.fs.FileSystem,org.apache.hadoop.fs.Path,long,long,java.lang.String,org.apache.hadoop.hbase.master.snapshot.SnapshotFileCache.SnapshotFileInspector)" class="member-name-link">SnapshotFileCache</a><wbr>(org.apache.hadoop.fs.FileSystem&nbsp;fs,
 org.apache.hadoop.fs.Path&nbsp;rootDir,
 org.apache.hadoop.fs.FileSystem&nbsp;workingFs,
 org.apache.hadoop.fs.Path&nbsp;workingDir,
 long&nbsp;cacheRefreshPeriod,
 long&nbsp;cacheRefreshDelay,
 <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a>&nbsp;refreshThreadName,
 <a href="SnapshotFileCache.SnapshotFileInspector.html" title="interface in org.apache.hadoop.hbase.master.snapshot">SnapshotFileCache.SnapshotFileInspector</a>&nbsp;inspectSnapshotFiles)</code></div>
<div class="col-last odd-row-color">
<div class="block">Create a snapshot file cache for all snapshots under the specified [root]/.snapshot on the
 filesystem</div>
</div>
</div>
</section>
</li>
<!-- ========== METHOD SUMMARY =========== -->
<li>
<section class="method-summary" id="method-summary">
<h2>Method Summary</h2>
<div id="method-summary-table">
<div class="table-tabs" role="tablist" aria-orientation="horizontal"><button id="method-summary-table-tab0" role="tab" aria-selected="true" aria-controls="method-summary-table.tabpanel" tabindex="0" onkeydown="switchTab(event)" onclick="show('method-summary-table', 'method-summary-table', 3)" class="active-table-tab">All Methods</button><button id="method-summary-table-tab2" role="tab" aria-selected="false" aria-controls="method-summary-table.tabpanel" tabindex="-1" onkeydown="switchTab(event)" onclick="show('method-summary-table', 'method-summary-table-tab2', 3)" class="table-tab">Instance Methods</button><button id="method-summary-table-tab4" role="tab" aria-selected="false" aria-controls="method-summary-table.tabpanel" tabindex="-1" onkeydown="switchTab(event)" onclick="show('method-summary-table', 'method-summary-table-tab4', 3)" class="table-tab">Concrete Methods</button></div>
<div id="method-summary-table.tabpanel" role="tabpanel" aria-labelledby="method-summary-table-tab0">
<div class="summary-table three-column-summary">
<div class="table-header col-first">Modifier and Type</div>
<div class="table-header col-second">Method</div>
<div class="table-header col-last">Description</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>(package private) <a href="https://docs.oracle.com/javase/8/docs/api/java/util/List.html" title="class or interface in java.util" class="external-link">List</a>&lt;<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a>&gt;</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#getSnapshotsInProgress()" class="member-name-link">getSnapshotsInProgress</a>()</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">&nbsp;</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Iterable.html" title="class or interface in java.lang" class="external-link">Iterable</a>&lt;org.apache.hadoop.fs.FileStatus&gt;</code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#getUnreferencedFiles(java.util.List,org.apache.hadoop.hbase.master.snapshot.SnapshotManager)" class="member-name-link">getUnreferencedFiles</a><wbr>(<a href="https://docs.oracle.com/javase/8/docs/api/java/util/List.html" title="class or interface in java.util" class="external-link">List</a>&lt;org.apache.hadoop.fs.FileStatus&gt;&nbsp;files,
 <a href="SnapshotManager.html" title="class in org.apache.hadoop.hbase.master.snapshot">SnapshotManager</a>&nbsp;snapshotManager)</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Check to see if any of the passed file names is contained in any of the snapshots.</div>
</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>boolean</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#isStopped()" class="member-name-link">isStopped</a>()</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Returns True if <a href="../../Stoppable.html#stop(java.lang.String)"><code>Stoppable.stop(String)</code></a> has been closed.</div>
</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>private void</code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#refreshCache()" class="member-name-link">refreshCache</a>()</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">&nbsp;</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>void</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#stop(java.lang.String)" class="member-name-link">stop</a><wbr>(<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a>&nbsp;why)</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Stop this service.</div>
</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>void</code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#triggerCacheRefreshForTesting()" class="member-name-link">triggerCacheRefreshForTesting</a>()</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Trigger a cache refresh, even if its before the next cache refresh.</div>
</div>
</div>
</div>
</div>
<div class="inherited-list">
<h3 id="methods-inherited-from-class-java.lang.Object">Methods inherited from class&nbsp;java.lang.<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html" title="class or interface in java.lang" class="external-link">Object</a></h3>
<code><a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#clone--" title="class or interface in java.lang" class="external-link">clone</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#equals-java.lang.Object-" title="class or interface in java.lang" class="external-link">equals</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#finalize--" title="class or interface in java.lang" class="external-link">finalize</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#getClass--" title="class or interface in java.lang" class="external-link">getClass</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#hashCode--" title="class or interface in java.lang" class="external-link">hashCode</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#notify--" title="class or interface in java.lang" class="external-link">notify</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#notifyAll--" title="class or interface in java.lang" class="external-link">notifyAll</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#toString--" title="class or interface in java.lang" class="external-link">toString</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#wait--" title="class or interface in java.lang" class="external-link">wait</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#wait-long-" title="class or interface in java.lang" class="external-link">wait</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#wait-long-int-" title="class or interface in java.lang" class="external-link">wait</a></code></div>
</section>
</li>
</ul>
</section>
<section class="details">
<ul class="details-list">
<!-- ============ FIELD DETAIL =========== -->
<li>
<section class="field-details" id="field-detail">
<h2>Field Details</h2>
<ul class="member-list">
<li>
<section class="detail" id="LOG">
<h3>LOG</h3>
<div class="member-signature"><span class="modifiers">private static final</span>&nbsp;<span class="return-type">org.slf4j.Logger</span>&nbsp;<span class="element-name"><a href="../../../../../../src-html/org/apache/hadoop/hbase/master/snapshot/SnapshotFileCache.html#line-88">LOG</a></span></div>
</section>
</li>
<li>
<section class="detail" id="stop">
<h3>stop</h3>
<div class="member-signature"><span class="modifiers">private volatile</span>&nbsp;<span class="return-type">boolean</span>&nbsp;<span class="element-name"><a href="../../../../../../src-html/org/apache/hadoop/hbase/master/snapshot/SnapshotFileCache.html#line-89">stop</a></span></div>
</section>
</li>
<li>
<section class="detail" id="fs">
<h3>fs</h3>
<div class="member-signature"><span class="modifiers">private final</span>&nbsp;<span class="return-type">org.apache.hadoop.fs.FileSystem</span>&nbsp;<span class="element-name"><a href="../../../../../../src-html/org/apache/hadoop/hbase/master/snapshot/SnapshotFileCache.html#line-90">fs</a></span></div>
</section>
</li>
<li>
<section class="detail" id="workingFs">
<h3>workingFs</h3>
<div class="member-signature"><span class="modifiers">private final</span>&nbsp;<span class="return-type">org.apache.hadoop.fs.FileSystem</span>&nbsp;<span class="element-name"><a href="../../../../../../src-html/org/apache/hadoop/hbase/master/snapshot/SnapshotFileCache.html#line-90">workingFs</a></span></div>
</section>
</li>
<li>
<section class="detail" id="fileInspector">
<h3>fileInspector</h3>
<div class="member-signature"><span class="modifiers">private final</span>&nbsp;<span class="return-type"><a href="SnapshotFileCache.SnapshotFileInspector.html" title="interface in org.apache.hadoop.hbase.master.snapshot">SnapshotFileCache.SnapshotFileInspector</a></span>&nbsp;<span class="element-name"><a href="../../../../../../src-html/org/apache/hadoop/hbase/master/snapshot/SnapshotFileCache.html#line-91">fileInspector</a></span></div>
</section>
</li>
<li>
<section class="detail" id="snapshotDir">
<h3>snapshotDir</h3>
<div class="member-signature"><span class="modifiers">private final</span>&nbsp;<span class="return-type">org.apache.hadoop.fs.Path</span>&nbsp;<span class="element-name"><a href="../../../../../../src-html/org/apache/hadoop/hbase/master/snapshot/SnapshotFileCache.html#line-92">snapshotDir</a></span></div>
</section>
</li>
<li>
<section class="detail" id="workingSnapshotDir">
<h3>workingSnapshotDir</h3>
<div class="member-signature"><span class="modifiers">private final</span>&nbsp;<span class="return-type">org.apache.hadoop.fs.Path</span>&nbsp;<span class="element-name"><a href="../../../../../../src-html/org/apache/hadoop/hbase/master/snapshot/SnapshotFileCache.html#line-92">workingSnapshotDir</a></span></div>
</section>
</li>
<li>
<section class="detail" id="cache">
<h3>cache</h3>
<div class="member-signature"><span class="modifiers">private volatile</span>&nbsp;<span class="return-type">org.apache.hbase.thirdparty.com.google.common.collect.ImmutableSet&lt;<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a>&gt;</span>&nbsp;<span class="element-name"><a href="../../../../../../src-html/org/apache/hadoop/hbase/master/snapshot/SnapshotFileCache.html#line-93">cache</a></span></div>
</section>
</li>
<li>
<section class="detail" id="snapshots">
<h3>snapshots</h3>
<div class="member-signature"><span class="modifiers">private</span>&nbsp;<span class="return-type">org.apache.hbase.thirdparty.com.google.common.collect.ImmutableMap&lt;<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a>,<wbr><a href="SnapshotFileCache.SnapshotDirectoryInfo.html" title="class in org.apache.hadoop.hbase.master.snapshot">SnapshotFileCache.SnapshotDirectoryInfo</a>&gt;</span>&nbsp;<span class="element-name"><a href="../../../../../../src-html/org/apache/hadoop/hbase/master/snapshot/SnapshotFileCache.html#line-98">snapshots</a></span></div>
<div class="block">This is a helper map of information about the snapshot directories so we don't need to rescan
 them if they haven't changed since the last time we looked.</div>
</section>
</li>
<li>
<section class="detail" id="refreshTimer">
<h3>refreshTimer</h3>
<div class="member-signature"><span class="modifiers">private final</span>&nbsp;<span class="return-type"><a href="https://docs.oracle.com/javase/8/docs/api/java/util/Timer.html" title="class or interface in java.util" class="external-link">Timer</a></span>&nbsp;<span class="element-name"><a href="../../../../../../src-html/org/apache/hadoop/hbase/master/snapshot/SnapshotFileCache.html#line-99">refreshTimer</a></span></div>
</section>
</li>
<li>
<section class="detail" id="LOCK_TIMEOUT_MS">
<h3>LOCK_TIMEOUT_MS</h3>
<div class="member-signature"><span class="modifiers">private static final</span>&nbsp;<span class="return-type">int</span>&nbsp;<span class="element-name"><a href="../../../../../../src-html/org/apache/hadoop/hbase/master/snapshot/SnapshotFileCache.html#line-101">LOCK_TIMEOUT_MS</a></span></div>
<dl class="notes">
<dt>See Also:</dt>
<dd>
<ul class="see-list">
<li><a href="../../../../../../constant-values.html#org.apache.hadoop.hbase.master.snapshot.SnapshotFileCache.LOCK_TIMEOUT_MS">Constant Field Values</a></li>
</ul>
</dd>
</dl>
</section>
</li>
</ul>
</section>
</li>
<!-- ========= CONSTRUCTOR DETAIL ======== -->
<li>
<section class="constructor-details" id="constructor-detail">
<h2>Constructor Details</h2>
<ul class="member-list">
<li>
<section class="detail" id="&lt;init&gt;(org.apache.hadoop.conf.Configuration,long,long,java.lang.String,org.apache.hadoop.hbase.master.snapshot.SnapshotFileCache.SnapshotFileInspector)">
<h3>SnapshotFileCache</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="element-name"><a href="../../../../../../src-html/org/apache/hadoop/hbase/master/snapshot/SnapshotFileCache.html#line-116">SnapshotFileCache</a></span><wbr><span class="parameters">(org.apache.hadoop.conf.Configuration&nbsp;conf,
 long&nbsp;cacheRefreshPeriod,
 long&nbsp;cacheRefreshDelay,
 <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a>&nbsp;refreshThreadName,
 <a href="SnapshotFileCache.SnapshotFileInspector.html" title="interface in org.apache.hadoop.hbase.master.snapshot">SnapshotFileCache.SnapshotFileInspector</a>&nbsp;inspectSnapshotFiles)</span>
                  throws <span class="exceptions"><a href="https://docs.oracle.com/javase/8/docs/api/java/io/IOException.html" title="class or interface in java.io" class="external-link">IOException</a></span></div>
<div class="block">Create a snapshot file cache for all snapshots under the specified [root]/.snapshot on the
 filesystem.
 <p>
 Immediately loads the file cache.</div>
<dl class="notes">
<dt>Parameters:</dt>
<dd><code>conf</code> - to extract the configured <code>FileSystem</code> where the snapshots
                             are stored and hbase root directory</dd>
<dd><code>cacheRefreshPeriod</code> - frequency (ms) with which the cache should be refreshed</dd>
<dd><code>cacheRefreshDelay</code> - amount of time to wait for the cache to be refreshed</dd>
<dd><code>refreshThreadName</code> - name of the cache refresh thread</dd>
<dd><code>inspectSnapshotFiles</code> - Filter to apply to each snapshot to extract the files.</dd>
<dt>Throws:</dt>
<dd><code><a href="https://docs.oracle.com/javase/8/docs/api/java/io/IOException.html" title="class or interface in java.io" class="external-link">IOException</a></code> - if the <code>FileSystem</code> or root directory cannot be loaded</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="&lt;init&gt;(org.apache.hadoop.fs.FileSystem,org.apache.hadoop.fs.Path,org.apache.hadoop.fs.FileSystem,org.apache.hadoop.fs.Path,long,long,java.lang.String,org.apache.hadoop.hbase.master.snapshot.SnapshotFileCache.SnapshotFileInspector)">
<h3>SnapshotFileCache</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="element-name"><a href="../../../../../../src-html/org/apache/hadoop/hbase/master/snapshot/SnapshotFileCache.html#line-138">SnapshotFileCache</a></span><wbr><span class="parameters">(org.apache.hadoop.fs.FileSystem&nbsp;fs,
 org.apache.hadoop.fs.Path&nbsp;rootDir,
 org.apache.hadoop.fs.FileSystem&nbsp;workingFs,
 org.apache.hadoop.fs.Path&nbsp;workingDir,
 long&nbsp;cacheRefreshPeriod,
 long&nbsp;cacheRefreshDelay,
 <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a>&nbsp;refreshThreadName,
 <a href="SnapshotFileCache.SnapshotFileInspector.html" title="interface in org.apache.hadoop.hbase.master.snapshot">SnapshotFileCache.SnapshotFileInspector</a>&nbsp;inspectSnapshotFiles)</span></div>
<div class="block">Create a snapshot file cache for all snapshots under the specified [root]/.snapshot on the
 filesystem</div>
<dl class="notes">
<dt>Parameters:</dt>
<dd><code>fs</code> - <code>FileSystem</code> where the snapshots are stored</dd>
<dd><code>rootDir</code> - hbase root directory</dd>
<dd><code>workingFs</code> - <code>FileSystem</code> where ongoing snapshot mainifest files are
                             stored</dd>
<dd><code>workingDir</code> - Location to store ongoing snapshot manifest files</dd>
<dd><code>cacheRefreshPeriod</code> - period (ms) with which the cache should be refreshed</dd>
<dd><code>cacheRefreshDelay</code> - amount of time to wait for the cache to be refreshed</dd>
<dd><code>refreshThreadName</code> - name of the cache refresh thread</dd>
<dd><code>inspectSnapshotFiles</code> - Filter to apply to each snapshot to extract the files.</dd>
</dl>
</section>
</li>
</ul>
</section>
</li>
<!-- ============ METHOD DETAIL ========== -->
<li>
<section class="method-details" id="method-detail">
<h2>Method Details</h2>
<ul class="member-list">
<li>
<section class="detail" id="triggerCacheRefreshForTesting()">
<h3>triggerCacheRefreshForTesting</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type">void</span>&nbsp;<span class="element-name"><a href="../../../../../../src-html/org/apache/hadoop/hbase/master/snapshot/SnapshotFileCache.html#line-160">triggerCacheRefreshForTesting</a></span>()</div>
<div class="block">Trigger a cache refresh, even if its before the next cache refresh. Does not affect pending
 cache refreshes.
 <p/>
 Blocks until the cache is refreshed.
 <p/>
 Exposed for TESTING.</div>
</section>
</li>
<li>
<section class="detail" id="getUnreferencedFiles(java.util.List,org.apache.hadoop.hbase.master.snapshot.SnapshotManager)">
<h3>getUnreferencedFiles</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type"><a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Iterable.html" title="class or interface in java.lang" class="external-link">Iterable</a>&lt;org.apache.hadoop.fs.FileStatus&gt;</span>&nbsp;<span class="element-name"><a href="../../../../../../src-html/org/apache/hadoop/hbase/master/snapshot/SnapshotFileCache.html#line-185">getUnreferencedFiles</a></span><wbr><span class="parameters">(<a href="https://docs.oracle.com/javase/8/docs/api/java/util/List.html" title="class or interface in java.util" class="external-link">List</a>&lt;org.apache.hadoop.fs.FileStatus&gt;&nbsp;files,
 <a href="SnapshotManager.html" title="class in org.apache.hadoop.hbase.master.snapshot">SnapshotManager</a>&nbsp;snapshotManager)</span>
                                                               throws <span class="exceptions"><a href="https://docs.oracle.com/javase/8/docs/api/java/io/IOException.html" title="class or interface in java.io" class="external-link">IOException</a></span></div>
<div class="block">Check to see if any of the passed file names is contained in any of the snapshots. First checks
 an in-memory cache of the files to keep. If its not in the cache, then the cache is refreshed
 and the cache checked again for that file. This ensures that we never return files that exist.
 <p>
 Note this may lead to periodic false positives for the file being referenced. Periodically, the
 cache is refreshed even if there are no requests to ensure that the false negatives get removed
 eventually. For instance, suppose you have a file in the snapshot and it gets loaded into the
 cache. Then at some point later that snapshot is deleted. If the cache has not been refreshed
 at that point, cache will still think the file system contains that file and return
 <tt>true</tt>, even if it is no longer present (false positive). However, if the file never was
 on the filesystem, we will never find it and always return <tt>false</tt>.</div>
<dl class="notes">
<dt>Parameters:</dt>
<dd><code>files</code> - file to check</dd>
<dt>Returns:</dt>
<dd><tt>unReferencedFiles</tt> the collection of files that do not have snapshot references</dd>
<dt>Throws:</dt>
<dd><code><a href="https://docs.oracle.com/javase/8/docs/api/java/io/IOException.html" title="class or interface in java.io" class="external-link">IOException</a></code> - if there is an unexpected error reaching the filesystem.</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="refreshCache()">
<h3>refreshCache</h3>
<div class="member-signature"><span class="modifiers">private</span>&nbsp;<span class="return-type">void</span>&nbsp;<span class="element-name"><a href="../../../../../../src-html/org/apache/hadoop/hbase/master/snapshot/SnapshotFileCache.html#line-239">refreshCache</a></span>()
                   throws <span class="exceptions"><a href="https://docs.oracle.com/javase/8/docs/api/java/io/IOException.html" title="class or interface in java.io" class="external-link">IOException</a></span></div>
<dl class="notes">
<dt>Throws:</dt>
<dd><code><a href="https://docs.oracle.com/javase/8/docs/api/java/io/IOException.html" title="class or interface in java.io" class="external-link">IOException</a></code></dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="getSnapshotsInProgress()">
<h3>getSnapshotsInProgress</h3>
<div class="member-signature"><span class="return-type"><a href="https://docs.oracle.com/javase/8/docs/api/java/util/List.html" title="class or interface in java.util" class="external-link">List</a>&lt;<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a>&gt;</span>&nbsp;<span class="element-name"><a href="../../../../../../src-html/org/apache/hadoop/hbase/master/snapshot/SnapshotFileCache.html#line-284">getSnapshotsInProgress</a></span>()
                             throws <span class="exceptions"><a href="https://docs.oracle.com/javase/8/docs/api/java/io/IOException.html" title="class or interface in java.io" class="external-link">IOException</a></span></div>
<dl class="notes">
<dt>Throws:</dt>
<dd><code><a href="https://docs.oracle.com/javase/8/docs/api/java/io/IOException.html" title="class or interface in java.io" class="external-link">IOException</a></code></dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="stop(java.lang.String)">
<h3>stop</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type">void</span>&nbsp;<span class="element-name"><a href="../../../../../../src-html/org/apache/hadoop/hbase/master/snapshot/SnapshotFileCache.html#line-323">stop</a></span><wbr><span class="parameters">(<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html" title="class or interface in java.lang" class="external-link">String</a>&nbsp;why)</span></div>
<div class="block"><span class="descfrm-type-label">Description copied from interface:&nbsp;<code><a href="../../Stoppable.html#stop(java.lang.String)">Stoppable</a></code></span></div>
<div class="block">Stop this service. Implementers should favor logging errors over throwing RuntimeExceptions.</div>
<dl class="notes">
<dt>Specified by:</dt>
<dd><code><a href="../../Stoppable.html#stop(java.lang.String)">stop</a></code>&nbsp;in interface&nbsp;<code><a href="../../Stoppable.html" title="interface in org.apache.hadoop.hbase">Stoppable</a></code></dd>
<dt>Parameters:</dt>
<dd><code>why</code> - Why we're stopping.</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="isStopped()">
<h3>isStopped</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type">boolean</span>&nbsp;<span class="element-name"><a href="../../../../../../src-html/org/apache/hadoop/hbase/master/snapshot/SnapshotFileCache.html#line-331">isStopped</a></span>()</div>
<div class="block"><span class="descfrm-type-label">Description copied from interface:&nbsp;<code><a href="../../Stoppable.html#isStopped()">Stoppable</a></code></span></div>
<div class="block">Returns True if <a href="../../Stoppable.html#stop(java.lang.String)"><code>Stoppable.stop(String)</code></a> has been closed.</div>
<dl class="notes">
<dt>Specified by:</dt>
<dd><code><a href="../../Stoppable.html#isStopped()">isStopped</a></code>&nbsp;in interface&nbsp;<code><a href="../../Stoppable.html" title="interface in org.apache.hadoop.hbase">Stoppable</a></code></dd>
</dl>
</section>
</li>
</ul>
</section>
</li>
</ul>
</section>
<!-- ========= END OF CLASS DATA ========= -->
</main>
<footer role="contentinfo">
<hr>
<p class="legal-copy"><small>Copyright &#169; 2007&#x2013;2020 <a href="https://www.apache.org/">The Apache Software Foundation</a>. All rights reserved.</small></p>
</footer>
</div>
</div>
</body>
</html>

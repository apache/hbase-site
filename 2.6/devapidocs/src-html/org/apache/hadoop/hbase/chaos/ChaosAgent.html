<!DOCTYPE HTML>
<html lang="en">
<head>
<!-- Generated by javadoc (17) -->
<title>Source code</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="source: package: org.apache.hadoop.hbase.chaos, class: ChaosAgent">
<meta name="generator" content="javadoc/SourceToHTMLConverter">
<link rel="stylesheet" type="text/css" href="../../../../../../stylesheet.css" title="Style">
</head>
<body class="source-page">
<main role="main">
<div class="source-container">
<pre><span class="source-line-no">001</span><span id="line-1">/*</span>
<span class="source-line-no">002</span><span id="line-2"> * Licensed to the Apache Software Foundation (ASF) under one</span>
<span class="source-line-no">003</span><span id="line-3"> * or more contributor license agreements.  See the NOTICE file</span>
<span class="source-line-no">004</span><span id="line-4"> * distributed with this work for additional information</span>
<span class="source-line-no">005</span><span id="line-5"> * regarding copyright ownership.  The ASF licenses this file</span>
<span class="source-line-no">006</span><span id="line-6"> * to you under the Apache License, Version 2.0 (the</span>
<span class="source-line-no">007</span><span id="line-7"> * "License"); you may not use this file except in compliance</span>
<span class="source-line-no">008</span><span id="line-8"> * with the License.  You may obtain a copy of the License at</span>
<span class="source-line-no">009</span><span id="line-9"> *</span>
<span class="source-line-no">010</span><span id="line-10"> *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="source-line-no">011</span><span id="line-11"> *</span>
<span class="source-line-no">012</span><span id="line-12"> * Unless required by applicable law or agreed to in writing, software</span>
<span class="source-line-no">013</span><span id="line-13"> * distributed under the License is distributed on an "AS IS" BASIS,</span>
<span class="source-line-no">014</span><span id="line-14"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="source-line-no">015</span><span id="line-15"> * See the License for the specific language governing permissions and</span>
<span class="source-line-no">016</span><span id="line-16"> * limitations under the License.</span>
<span class="source-line-no">017</span><span id="line-17"> */</span>
<span class="source-line-no">018</span><span id="line-18">package org.apache.hadoop.hbase.chaos;</span>
<span class="source-line-no">019</span><span id="line-19"></span>
<span class="source-line-no">020</span><span id="line-20">import java.io.Closeable;</span>
<span class="source-line-no">021</span><span id="line-21">import java.io.IOException;</span>
<span class="source-line-no">022</span><span id="line-22">import java.nio.charset.StandardCharsets;</span>
<span class="source-line-no">023</span><span id="line-23">import java.util.ArrayList;</span>
<span class="source-line-no">024</span><span id="line-24">import java.util.List;</span>
<span class="source-line-no">025</span><span id="line-25">import java.util.concurrent.atomic.AtomicBoolean;</span>
<span class="source-line-no">026</span><span id="line-26">import org.apache.hadoop.conf.Configuration;</span>
<span class="source-line-no">027</span><span id="line-27">import org.apache.hadoop.hbase.util.Pair;</span>
<span class="source-line-no">028</span><span id="line-28">import org.apache.hadoop.hbase.util.RetryCounter;</span>
<span class="source-line-no">029</span><span id="line-29">import org.apache.hadoop.hbase.util.RetryCounterFactory;</span>
<span class="source-line-no">030</span><span id="line-30">import org.apache.hadoop.util.Shell;</span>
<span class="source-line-no">031</span><span id="line-31">import org.apache.yetus.audience.InterfaceAudience;</span>
<span class="source-line-no">032</span><span id="line-32">import org.apache.zookeeper.AsyncCallback;</span>
<span class="source-line-no">033</span><span id="line-33">import org.apache.zookeeper.CreateMode;</span>
<span class="source-line-no">034</span><span id="line-34">import org.apache.zookeeper.KeeperException;</span>
<span class="source-line-no">035</span><span id="line-35">import org.apache.zookeeper.WatchedEvent;</span>
<span class="source-line-no">036</span><span id="line-36">import org.apache.zookeeper.Watcher;</span>
<span class="source-line-no">037</span><span id="line-37">import org.apache.zookeeper.ZooDefs;</span>
<span class="source-line-no">038</span><span id="line-38">import org.apache.zookeeper.ZooKeeper;</span>
<span class="source-line-no">039</span><span id="line-39">import org.apache.zookeeper.data.Stat;</span>
<span class="source-line-no">040</span><span id="line-40">import org.slf4j.Logger;</span>
<span class="source-line-no">041</span><span id="line-41">import org.slf4j.LoggerFactory;</span>
<span class="source-line-no">042</span><span id="line-42"></span>
<span class="source-line-no">043</span><span id="line-43">/***</span>
<span class="source-line-no">044</span><span id="line-44"> * An agent for executing destructive actions for ChaosMonkey. Uses ZooKeeper Watchers and</span>
<span class="source-line-no">045</span><span id="line-45"> * LocalShell, to do the killing and getting status of service on targeted host without SSH. uses</span>
<span class="source-line-no">046</span><span id="line-46"> * given ZNode Structure: /perfChaosTest (root) | | /chaosAgents (Used for registration has hostname</span>
<span class="source-line-no">047</span><span id="line-47"> * ephemeral nodes as children) | | /chaosAgentTaskStatus (Used for task Execution, has hostname</span>
<span class="source-line-no">048</span><span id="line-48"> * persistent nodes as child with tasks as their children) | | /hostname | | /task0000001 (command</span>
<span class="source-line-no">049</span><span id="line-49"> * as data) (has two types of command : 1: starts with "exec" for executing a destructive action. 2:</span>
<span class="source-line-no">050</span><span id="line-50"> * starts with "bool" for getting only status of service.</span>
<span class="source-line-no">051</span><span id="line-51"> */</span>
<span class="source-line-no">052</span><span id="line-52">@InterfaceAudience.Private</span>
<span class="source-line-no">053</span><span id="line-53">public class ChaosAgent implements Watcher, Closeable, Runnable {</span>
<span class="source-line-no">054</span><span id="line-54"></span>
<span class="source-line-no">055</span><span id="line-55">  private static final Logger LOG = LoggerFactory.getLogger(ChaosAgent.class);</span>
<span class="source-line-no">056</span><span id="line-56">  static AtomicBoolean stopChaosAgent = new AtomicBoolean();</span>
<span class="source-line-no">057</span><span id="line-57">  private ZooKeeper zk;</span>
<span class="source-line-no">058</span><span id="line-58">  private String quorum;</span>
<span class="source-line-no">059</span><span id="line-59">  private String agentName;</span>
<span class="source-line-no">060</span><span id="line-60">  private Configuration conf;</span>
<span class="source-line-no">061</span><span id="line-61">  private RetryCounterFactory retryCounterFactory;</span>
<span class="source-line-no">062</span><span id="line-62">  private volatile boolean connected = false;</span>
<span class="source-line-no">063</span><span id="line-63"></span>
<span class="source-line-no">064</span><span id="line-64">  public ChaosAgent(Configuration conf, String quorum, String agentName) {</span>
<span class="source-line-no">065</span><span id="line-65">    initChaosAgent(conf, quorum, agentName);</span>
<span class="source-line-no">066</span><span id="line-66">  }</span>
<span class="source-line-no">067</span><span id="line-67"></span>
<span class="source-line-no">068</span><span id="line-68">  /***</span>
<span class="source-line-no">069</span><span id="line-69">   * sets global params and initiates connection with ZooKeeper then does registration.</span>
<span class="source-line-no">070</span><span id="line-70">   * @param conf      initial configuration to use</span>
<span class="source-line-no">071</span><span id="line-71">   * @param quorum    ZK Quorum</span>
<span class="source-line-no">072</span><span id="line-72">   * @param agentName AgentName to use</span>
<span class="source-line-no">073</span><span id="line-73">   */</span>
<span class="source-line-no">074</span><span id="line-74">  private void initChaosAgent(Configuration conf, String quorum, String agentName) {</span>
<span class="source-line-no">075</span><span id="line-75">    this.conf = conf;</span>
<span class="source-line-no">076</span><span id="line-76">    this.quorum = quorum;</span>
<span class="source-line-no">077</span><span id="line-77">    this.agentName = agentName;</span>
<span class="source-line-no">078</span><span id="line-78">    this.retryCounterFactory = new RetryCounterFactory(new RetryCounter.RetryConfig()</span>
<span class="source-line-no">079</span><span id="line-79">      .setMaxAttempts(</span>
<span class="source-line-no">080</span><span id="line-80">        conf.getInt(ChaosConstants.RETRY_ATTEMPTS_KEY, ChaosConstants.DEFAULT_RETRY_ATTEMPTS))</span>
<span class="source-line-no">081</span><span id="line-81">      .setSleepInterval(conf.getLong(ChaosConstants.RETRY_SLEEP_INTERVAL_KEY,</span>
<span class="source-line-no">082</span><span id="line-82">        ChaosConstants.DEFAULT_RETRY_SLEEP_INTERVAL)));</span>
<span class="source-line-no">083</span><span id="line-83">    try {</span>
<span class="source-line-no">084</span><span id="line-84">      this.createZKConnection(null);</span>
<span class="source-line-no">085</span><span id="line-85">      this.register();</span>
<span class="source-line-no">086</span><span id="line-86">    } catch (IOException e) {</span>
<span class="source-line-no">087</span><span id="line-87">      LOG.error("Error Creating Connection: " + e);</span>
<span class="source-line-no">088</span><span id="line-88">    }</span>
<span class="source-line-no">089</span><span id="line-89">  }</span>
<span class="source-line-no">090</span><span id="line-90"></span>
<span class="source-line-no">091</span><span id="line-91">  /***</span>
<span class="source-line-no">092</span><span id="line-92">   * Creates Connection with ZooKeeper.</span>
<span class="source-line-no">093</span><span id="line-93">   * @throws IOException if something goes wrong</span>
<span class="source-line-no">094</span><span id="line-94">   */</span>
<span class="source-line-no">095</span><span id="line-95">  private void createZKConnection(Watcher watcher) throws IOException {</span>
<span class="source-line-no">096</span><span id="line-96">    if (watcher == null) {</span>
<span class="source-line-no">097</span><span id="line-97">      zk = new ZooKeeper(quorum, ChaosConstants.SESSION_TIMEOUT_ZK, this);</span>
<span class="source-line-no">098</span><span id="line-98">    } else {</span>
<span class="source-line-no">099</span><span id="line-99">      zk = new ZooKeeper(quorum, ChaosConstants.SESSION_TIMEOUT_ZK, watcher);</span>
<span class="source-line-no">100</span><span id="line-100">    }</span>
<span class="source-line-no">101</span><span id="line-101">    LOG.info("ZooKeeper Connection created for ChaosAgent: " + agentName);</span>
<span class="source-line-no">102</span><span id="line-102">  }</span>
<span class="source-line-no">103</span><span id="line-103"></span>
<span class="source-line-no">104</span><span id="line-104">  // WATCHERS: Below are the Watches used by ChaosAgent</span>
<span class="source-line-no">105</span><span id="line-105"></span>
<span class="source-line-no">106</span><span id="line-106">  /***</span>
<span class="source-line-no">107</span><span id="line-107">   * Watcher for notifying if any task is assigned to agent or not, by seeking if any Node is being</span>
<span class="source-line-no">108</span><span id="line-108">   * added to agent as Child.</span>
<span class="source-line-no">109</span><span id="line-109">   */</span>
<span class="source-line-no">110</span><span id="line-110">  Watcher newTaskCreatedWatcher = new Watcher() {</span>
<span class="source-line-no">111</span><span id="line-111">    @Override</span>
<span class="source-line-no">112</span><span id="line-112">    public void process(WatchedEvent watchedEvent) {</span>
<span class="source-line-no">113</span><span id="line-113">      if (watchedEvent.getType() == Event.EventType.NodeChildrenChanged) {</span>
<span class="source-line-no">114</span><span id="line-114">        if (</span>
<span class="source-line-no">115</span><span id="line-115">          !(ChaosConstants.CHAOS_AGENT_STATUS_PERSISTENT_ZNODE + ChaosConstants.ZNODE_PATH_SEPARATOR</span>
<span class="source-line-no">116</span><span id="line-116">            + agentName).equals(watchedEvent.getPath())</span>
<span class="source-line-no">117</span><span id="line-117">        ) {</span>
<span class="source-line-no">118</span><span id="line-118">          throw new RuntimeException(</span>
<span class="source-line-no">119</span><span id="line-119">            KeeperException.create(KeeperException.Code.DATAINCONSISTENCY));</span>
<span class="source-line-no">120</span><span id="line-120">        }</span>
<span class="source-line-no">121</span><span id="line-121"></span>
<span class="source-line-no">122</span><span id="line-122">        LOG.info("Change in Tasks Node, checking for Tasks again.");</span>
<span class="source-line-no">123</span><span id="line-123">        getTasks();</span>
<span class="source-line-no">124</span><span id="line-124">      }</span>
<span class="source-line-no">125</span><span id="line-125"></span>
<span class="source-line-no">126</span><span id="line-126">    }</span>
<span class="source-line-no">127</span><span id="line-127">  };</span>
<span class="source-line-no">128</span><span id="line-128"></span>
<span class="source-line-no">129</span><span id="line-129">  // CALLBACKS: Below are the Callbacks used by Chaos Agent</span>
<span class="source-line-no">130</span><span id="line-130"></span>
<span class="source-line-no">131</span><span id="line-131">  /**</span>
<span class="source-line-no">132</span><span id="line-132">   * Callback used while setting status of a given task, Logs given status.</span>
<span class="source-line-no">133</span><span id="line-133">   */</span>
<span class="source-line-no">134</span><span id="line-134">  AsyncCallback.StatCallback setStatusOfTaskZNodeCallback = (rc, path, ctx, stat) -&gt; {</span>
<span class="source-line-no">135</span><span id="line-135">    switch (KeeperException.Code.get(rc)) {</span>
<span class="source-line-no">136</span><span id="line-136">      case CONNECTIONLOSS:</span>
<span class="source-line-no">137</span><span id="line-137">        // Connection to the server was lost while setting status setting again.</span>
<span class="source-line-no">138</span><span id="line-138">        try {</span>
<span class="source-line-no">139</span><span id="line-139">          recreateZKConnection();</span>
<span class="source-line-no">140</span><span id="line-140">        } catch (Exception e) {</span>
<span class="source-line-no">141</span><span id="line-141">          break;</span>
<span class="source-line-no">142</span><span id="line-142">        }</span>
<span class="source-line-no">143</span><span id="line-143">        setStatusOfTaskZNode(path, (String) ctx);</span>
<span class="source-line-no">144</span><span id="line-144">        break;</span>
<span class="source-line-no">145</span><span id="line-145"></span>
<span class="source-line-no">146</span><span id="line-146">      case OK:</span>
<span class="source-line-no">147</span><span id="line-147">        LOG.info("Status of Task has been set");</span>
<span class="source-line-no">148</span><span id="line-148">        break;</span>
<span class="source-line-no">149</span><span id="line-149"></span>
<span class="source-line-no">150</span><span id="line-150">      case NONODE:</span>
<span class="source-line-no">151</span><span id="line-151">        LOG.error("Chaos Agent status node does not exists: "</span>
<span class="source-line-no">152</span><span id="line-152">          + "check for ZNode directory structure again.");</span>
<span class="source-line-no">153</span><span id="line-153">        break;</span>
<span class="source-line-no">154</span><span id="line-154"></span>
<span class="source-line-no">155</span><span id="line-155">      default:</span>
<span class="source-line-no">156</span><span id="line-156">        LOG.error("Error while setting status of task ZNode: " + path,</span>
<span class="source-line-no">157</span><span id="line-157">          KeeperException.create(KeeperException.Code.get(rc), path));</span>
<span class="source-line-no">158</span><span id="line-158">    }</span>
<span class="source-line-no">159</span><span id="line-159">  };</span>
<span class="source-line-no">160</span><span id="line-160"></span>
<span class="source-line-no">161</span><span id="line-161">  /**</span>
<span class="source-line-no">162</span><span id="line-162">   * Callback used while creating a Persistent ZNode tries to create ZNode again if Connection was</span>
<span class="source-line-no">163</span><span id="line-163">   * lost in previous try.</span>
<span class="source-line-no">164</span><span id="line-164">   */</span>
<span class="source-line-no">165</span><span id="line-165">  AsyncCallback.StringCallback createZNodeCallback = (rc, path, ctx, name) -&gt; {</span>
<span class="source-line-no">166</span><span id="line-166">    switch (KeeperException.Code.get(rc)) {</span>
<span class="source-line-no">167</span><span id="line-167">      case CONNECTIONLOSS:</span>
<span class="source-line-no">168</span><span id="line-168">        try {</span>
<span class="source-line-no">169</span><span id="line-169">          recreateZKConnection();</span>
<span class="source-line-no">170</span><span id="line-170">        } catch (Exception e) {</span>
<span class="source-line-no">171</span><span id="line-171">          break;</span>
<span class="source-line-no">172</span><span id="line-172">        }</span>
<span class="source-line-no">173</span><span id="line-173">        createZNode(path, (byte[]) ctx);</span>
<span class="source-line-no">174</span><span id="line-174">        break;</span>
<span class="source-line-no">175</span><span id="line-175">      case OK:</span>
<span class="source-line-no">176</span><span id="line-176">        LOG.info("ZNode created : " + path);</span>
<span class="source-line-no">177</span><span id="line-177">        break;</span>
<span class="source-line-no">178</span><span id="line-178">      case NODEEXISTS:</span>
<span class="source-line-no">179</span><span id="line-179">        LOG.warn("ZNode already registered: " + path);</span>
<span class="source-line-no">180</span><span id="line-180">        break;</span>
<span class="source-line-no">181</span><span id="line-181">      default:</span>
<span class="source-line-no">182</span><span id="line-182">        LOG.error("Error occurred while creating Persistent ZNode: " + path,</span>
<span class="source-line-no">183</span><span id="line-183">          KeeperException.create(KeeperException.Code.get(rc), path));</span>
<span class="source-line-no">184</span><span id="line-184">    }</span>
<span class="source-line-no">185</span><span id="line-185">  };</span>
<span class="source-line-no">186</span><span id="line-186"></span>
<span class="source-line-no">187</span><span id="line-187">  /**</span>
<span class="source-line-no">188</span><span id="line-188">   * Callback used while creating a Ephemeral ZNode tries to create ZNode again if Connection was</span>
<span class="source-line-no">189</span><span id="line-189">   * lost in previous try.</span>
<span class="source-line-no">190</span><span id="line-190">   */</span>
<span class="source-line-no">191</span><span id="line-191">  AsyncCallback.StringCallback createEphemeralZNodeCallback = (rc, path, ctx, name) -&gt; {</span>
<span class="source-line-no">192</span><span id="line-192">    switch (KeeperException.Code.get(rc)) {</span>
<span class="source-line-no">193</span><span id="line-193">      case CONNECTIONLOSS:</span>
<span class="source-line-no">194</span><span id="line-194">        try {</span>
<span class="source-line-no">195</span><span id="line-195">          recreateZKConnection();</span>
<span class="source-line-no">196</span><span id="line-196">        } catch (Exception e) {</span>
<span class="source-line-no">197</span><span id="line-197">          break;</span>
<span class="source-line-no">198</span><span id="line-198">        }</span>
<span class="source-line-no">199</span><span id="line-199">        createEphemeralZNode(path, (byte[]) ctx);</span>
<span class="source-line-no">200</span><span id="line-200">        break;</span>
<span class="source-line-no">201</span><span id="line-201">      case OK:</span>
<span class="source-line-no">202</span><span id="line-202">        LOG.info("ZNode created : " + path);</span>
<span class="source-line-no">203</span><span id="line-203">        break;</span>
<span class="source-line-no">204</span><span id="line-204">      case NODEEXISTS:</span>
<span class="source-line-no">205</span><span id="line-205">        LOG.warn("ZNode already registered: " + path);</span>
<span class="source-line-no">206</span><span id="line-206">        break;</span>
<span class="source-line-no">207</span><span id="line-207">      default:</span>
<span class="source-line-no">208</span><span id="line-208">        LOG.error("Error occurred while creating Ephemeral ZNode: ",</span>
<span class="source-line-no">209</span><span id="line-209">          KeeperException.create(KeeperException.Code.get(rc), path));</span>
<span class="source-line-no">210</span><span id="line-210">    }</span>
<span class="source-line-no">211</span><span id="line-211">  };</span>
<span class="source-line-no">212</span><span id="line-212"></span>
<span class="source-line-no">213</span><span id="line-213">  /**</span>
<span class="source-line-no">214</span><span id="line-214">   * Callback used by getTasksForAgentCallback while getting command, after getting command</span>
<span class="source-line-no">215</span><span id="line-215">   * successfully, it executes command and set its status with respect to the command type.</span>
<span class="source-line-no">216</span><span id="line-216">   */</span>
<span class="source-line-no">217</span><span id="line-217">  AsyncCallback.DataCallback getTaskForExecutionCallback = new AsyncCallback.DataCallback() {</span>
<span class="source-line-no">218</span><span id="line-218">    @Override</span>
<span class="source-line-no">219</span><span id="line-219">    public void processResult(int rc, String path, Object ctx, byte[] data, Stat stat) {</span>
<span class="source-line-no">220</span><span id="line-220">      switch (KeeperException.Code.get(rc)) {</span>
<span class="source-line-no">221</span><span id="line-221">        case CONNECTIONLOSS:</span>
<span class="source-line-no">222</span><span id="line-222">          // Connection to the server has been lost while getting task, getting data again.</span>
<span class="source-line-no">223</span><span id="line-223">          try {</span>
<span class="source-line-no">224</span><span id="line-224">            recreateZKConnection();</span>
<span class="source-line-no">225</span><span id="line-225">          } catch (Exception e) {</span>
<span class="source-line-no">226</span><span id="line-226">            break;</span>
<span class="source-line-no">227</span><span id="line-227">          }</span>
<span class="source-line-no">228</span><span id="line-228">          zk.getData(path, false, getTaskForExecutionCallback,</span>
<span class="source-line-no">229</span><span id="line-229">            new String(data, StandardCharsets.UTF_8));</span>
<span class="source-line-no">230</span><span id="line-230">          break;</span>
<span class="source-line-no">231</span><span id="line-231">        case OK:</span>
<span class="source-line-no">232</span><span id="line-232">          String cmd = new String(data, StandardCharsets.UTF_8);</span>
<span class="source-line-no">233</span><span id="line-233">          LOG.info("Executing command : " + cmd);</span>
<span class="source-line-no">234</span><span id="line-234">          String status = ChaosConstants.TASK_COMPLETION_STRING;</span>
<span class="source-line-no">235</span><span id="line-235">          try {</span>
<span class="source-line-no">236</span><span id="line-236">            String user =</span>
<span class="source-line-no">237</span><span id="line-237">              conf.get(ChaosConstants.CHAOSAGENT_SHELL_USER, ChaosConstants.DEFAULT_SHELL_USER);</span>
<span class="source-line-no">238</span><span id="line-238">            switch (cmd.substring(0, 4)) {</span>
<span class="source-line-no">239</span><span id="line-239">              case "bool":</span>
<span class="source-line-no">240</span><span id="line-240">                String ret = execWithRetries(user, cmd.substring(4)).getSecond();</span>
<span class="source-line-no">241</span><span id="line-241">                status = Boolean.toString(ret.length() &gt; 0);</span>
<span class="source-line-no">242</span><span id="line-242">                break;</span>
<span class="source-line-no">243</span><span id="line-243"></span>
<span class="source-line-no">244</span><span id="line-244">              case "exec":</span>
<span class="source-line-no">245</span><span id="line-245">                execWithRetries(user, cmd.substring(4));</span>
<span class="source-line-no">246</span><span id="line-246">                break;</span>
<span class="source-line-no">247</span><span id="line-247"></span>
<span class="source-line-no">248</span><span id="line-248">              default:</span>
<span class="source-line-no">249</span><span id="line-249">                LOG.error("Unknown Command Type");</span>
<span class="source-line-no">250</span><span id="line-250">                status = ChaosConstants.TASK_ERROR_STRING;</span>
<span class="source-line-no">251</span><span id="line-251">            }</span>
<span class="source-line-no">252</span><span id="line-252">          } catch (IOException e) {</span>
<span class="source-line-no">253</span><span id="line-253">            LOG.error("Got error while executing command : " + cmd + " On agent : " + agentName</span>
<span class="source-line-no">254</span><span id="line-254">              + " Error : " + e);</span>
<span class="source-line-no">255</span><span id="line-255">            status = ChaosConstants.TASK_ERROR_STRING;</span>
<span class="source-line-no">256</span><span id="line-256">          }</span>
<span class="source-line-no">257</span><span id="line-257"></span>
<span class="source-line-no">258</span><span id="line-258">          try {</span>
<span class="source-line-no">259</span><span id="line-259">            setStatusOfTaskZNode(path, status);</span>
<span class="source-line-no">260</span><span id="line-260">            Thread.sleep(ChaosConstants.SET_STATUS_SLEEP_TIME);</span>
<span class="source-line-no">261</span><span id="line-261">          } catch (InterruptedException e) {</span>
<span class="source-line-no">262</span><span id="line-262">            LOG.error("Error occured after setting status: " + e);</span>
<span class="source-line-no">263</span><span id="line-263">          }</span>
<span class="source-line-no">264</span><span id="line-264"></span>
<span class="source-line-no">265</span><span id="line-265">        default:</span>
<span class="source-line-no">266</span><span id="line-266">          LOG.error("Error occurred while getting data",</span>
<span class="source-line-no">267</span><span id="line-267">            KeeperException.create(KeeperException.Code.get(rc), path));</span>
<span class="source-line-no">268</span><span id="line-268">      }</span>
<span class="source-line-no">269</span><span id="line-269">    }</span>
<span class="source-line-no">270</span><span id="line-270">  };</span>
<span class="source-line-no">271</span><span id="line-271"></span>
<span class="source-line-no">272</span><span id="line-272">  /***</span>
<span class="source-line-no">273</span><span id="line-273">   * Callback used while getting Tasks for agent if call executed without Exception, It creates a</span>
<span class="source-line-no">274</span><span id="line-274">   * separate thread for each children to execute given Tasks parallely.</span>
<span class="source-line-no">275</span><span id="line-275">   */</span>
<span class="source-line-no">276</span><span id="line-276">  AsyncCallback.ChildrenCallback getTasksForAgentCallback = new AsyncCallback.ChildrenCallback() {</span>
<span class="source-line-no">277</span><span id="line-277">    @Override</span>
<span class="source-line-no">278</span><span id="line-278">    public void processResult(int rc, String path, Object ctx, List&lt;String&gt; children) {</span>
<span class="source-line-no">279</span><span id="line-279">      switch (KeeperException.Code.get(rc)) {</span>
<span class="source-line-no">280</span><span id="line-280">        case CONNECTIONLOSS: {</span>
<span class="source-line-no">281</span><span id="line-281">          // Connection to the server has been lost, getting tasks again.</span>
<span class="source-line-no">282</span><span id="line-282">          try {</span>
<span class="source-line-no">283</span><span id="line-283">            recreateZKConnection();</span>
<span class="source-line-no">284</span><span id="line-284">          } catch (Exception e) {</span>
<span class="source-line-no">285</span><span id="line-285">            break;</span>
<span class="source-line-no">286</span><span id="line-286">          }</span>
<span class="source-line-no">287</span><span id="line-287">          getTasks();</span>
<span class="source-line-no">288</span><span id="line-288">          break;</span>
<span class="source-line-no">289</span><span id="line-289">        }</span>
<span class="source-line-no">290</span><span id="line-290"></span>
<span class="source-line-no">291</span><span id="line-291">        case OK: {</span>
<span class="source-line-no">292</span><span id="line-292">          if (children != null) {</span>
<span class="source-line-no">293</span><span id="line-293">            try {</span>
<span class="source-line-no">294</span><span id="line-294"></span>
<span class="source-line-no">295</span><span id="line-295">              LOG.info("Executing each task as a separate thread");</span>
<span class="source-line-no">296</span><span id="line-296">              List&lt;Thread&gt; tasksList = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">297</span><span id="line-297">              for (String task : children) {</span>
<span class="source-line-no">298</span><span id="line-298">                String threadName = agentName + "_" + task;</span>
<span class="source-line-no">299</span><span id="line-299">                Thread t = new Thread(() -&gt; {</span>
<span class="source-line-no">300</span><span id="line-300"></span>
<span class="source-line-no">301</span><span id="line-301">                  LOG.info("Executing task : " + task + " of agent : " + agentName);</span>
<span class="source-line-no">302</span><span id="line-302">                  zk.getData(</span>
<span class="source-line-no">303</span><span id="line-303">                    ChaosConstants.CHAOS_AGENT_STATUS_PERSISTENT_ZNODE</span>
<span class="source-line-no">304</span><span id="line-304">                      + ChaosConstants.ZNODE_PATH_SEPARATOR + agentName</span>
<span class="source-line-no">305</span><span id="line-305">                      + ChaosConstants.ZNODE_PATH_SEPARATOR + task,</span>
<span class="source-line-no">306</span><span id="line-306">                    false, getTaskForExecutionCallback, task);</span>
<span class="source-line-no">307</span><span id="line-307"></span>
<span class="source-line-no">308</span><span id="line-308">                });</span>
<span class="source-line-no">309</span><span id="line-309">                t.setName(threadName);</span>
<span class="source-line-no">310</span><span id="line-310">                t.start();</span>
<span class="source-line-no">311</span><span id="line-311">                tasksList.add(t);</span>
<span class="source-line-no">312</span><span id="line-312"></span>
<span class="source-line-no">313</span><span id="line-313">                for (Thread thread : tasksList) {</span>
<span class="source-line-no">314</span><span id="line-314">                  thread.join();</span>
<span class="source-line-no">315</span><span id="line-315">                }</span>
<span class="source-line-no">316</span><span id="line-316">              }</span>
<span class="source-line-no">317</span><span id="line-317">            } catch (InterruptedException e) {</span>
<span class="source-line-no">318</span><span id="line-318">              LOG.error(</span>
<span class="source-line-no">319</span><span id="line-319">                "Error scheduling next task : " + " for agent : " + agentName + " Error : " + e);</span>
<span class="source-line-no">320</span><span id="line-320">            }</span>
<span class="source-line-no">321</span><span id="line-321">          }</span>
<span class="source-line-no">322</span><span id="line-322">          break;</span>
<span class="source-line-no">323</span><span id="line-323">        }</span>
<span class="source-line-no">324</span><span id="line-324"></span>
<span class="source-line-no">325</span><span id="line-325">        default:</span>
<span class="source-line-no">326</span><span id="line-326">          LOG.error("Error occurred while getting task",</span>
<span class="source-line-no">327</span><span id="line-327">            KeeperException.create(KeeperException.Code.get(rc), path));</span>
<span class="source-line-no">328</span><span id="line-328">      }</span>
<span class="source-line-no">329</span><span id="line-329">    }</span>
<span class="source-line-no">330</span><span id="line-330">  };</span>
<span class="source-line-no">331</span><span id="line-331"></span>
<span class="source-line-no">332</span><span id="line-332">  /***</span>
<span class="source-line-no">333</span><span id="line-333">   * Function to create PERSISTENT ZNODE with given path and data given as params</span>
<span class="source-line-no">334</span><span id="line-334">   * @param path Path at which ZNode to create</span>
<span class="source-line-no">335</span><span id="line-335">   * @param data Data to put under ZNode</span>
<span class="source-line-no">336</span><span id="line-336">   */</span>
<span class="source-line-no">337</span><span id="line-337">  public void createZNode(String path, byte[] data) {</span>
<span class="source-line-no">338</span><span id="line-338">    zk.create(path, data, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT, createZNodeCallback,</span>
<span class="source-line-no">339</span><span id="line-339">      data);</span>
<span class="source-line-no">340</span><span id="line-340">  }</span>
<span class="source-line-no">341</span><span id="line-341"></span>
<span class="source-line-no">342</span><span id="line-342">  /***</span>
<span class="source-line-no">343</span><span id="line-343">   * Function to create EPHEMERAL ZNODE with given path and data as params.</span>
<span class="source-line-no">344</span><span id="line-344">   * @param path Path at which Ephemeral ZNode to create</span>
<span class="source-line-no">345</span><span id="line-345">   * @param data Data to put under ZNode</span>
<span class="source-line-no">346</span><span id="line-346">   */</span>
<span class="source-line-no">347</span><span id="line-347">  public void createEphemeralZNode(String path, byte[] data) {</span>
<span class="source-line-no">348</span><span id="line-348">    zk.create(path, data, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL,</span>
<span class="source-line-no">349</span><span id="line-349">      createEphemeralZNodeCallback, data);</span>
<span class="source-line-no">350</span><span id="line-350">  }</span>
<span class="source-line-no">351</span><span id="line-351"></span>
<span class="source-line-no">352</span><span id="line-352">  /**</span>
<span class="source-line-no">353</span><span id="line-353">   * Checks if given ZNode exists, if not creates a PERSISTENT ZNODE for same.</span>
<span class="source-line-no">354</span><span id="line-354">   * @param path Path to check for ZNode</span>
<span class="source-line-no">355</span><span id="line-355">   */</span>
<span class="source-line-no">356</span><span id="line-356">  private void createIfZNodeNotExists(String path) {</span>
<span class="source-line-no">357</span><span id="line-357">    try {</span>
<span class="source-line-no">358</span><span id="line-358">      if (zk.exists(path, false) == null) {</span>
<span class="source-line-no">359</span><span id="line-359">        createZNode(path, new byte[0]);</span>
<span class="source-line-no">360</span><span id="line-360">      }</span>
<span class="source-line-no">361</span><span id="line-361">    } catch (KeeperException | InterruptedException e) {</span>
<span class="source-line-no">362</span><span id="line-362">      LOG.error("Error checking given node : " + path + " " + e);</span>
<span class="source-line-no">363</span><span id="line-363">    }</span>
<span class="source-line-no">364</span><span id="line-364">  }</span>
<span class="source-line-no">365</span><span id="line-365"></span>
<span class="source-line-no">366</span><span id="line-366">  /**</span>
<span class="source-line-no">367</span><span id="line-367">   * sets given Status for Task Znode</span>
<span class="source-line-no">368</span><span id="line-368">   * @param taskZNode ZNode to set status</span>
<span class="source-line-no">369</span><span id="line-369">   * @param status    Status value</span>
<span class="source-line-no">370</span><span id="line-370">   */</span>
<span class="source-line-no">371</span><span id="line-371">  public void setStatusOfTaskZNode(String taskZNode, String status) {</span>
<span class="source-line-no">372</span><span id="line-372">    LOG.info("Setting status of Task ZNode: " + taskZNode + " status : " + status);</span>
<span class="source-line-no">373</span><span id="line-373">    zk.setData(taskZNode, status.getBytes(StandardCharsets.UTF_8), -1, setStatusOfTaskZNodeCallback,</span>
<span class="source-line-no">374</span><span id="line-374">      null);</span>
<span class="source-line-no">375</span><span id="line-375">  }</span>
<span class="source-line-no">376</span><span id="line-376"></span>
<span class="source-line-no">377</span><span id="line-377">  /**</span>
<span class="source-line-no">378</span><span id="line-378">   * registration of ChaosAgent by checking and creating necessary ZNodes.</span>
<span class="source-line-no">379</span><span id="line-379">   */</span>
<span class="source-line-no">380</span><span id="line-380">  private void register() {</span>
<span class="source-line-no">381</span><span id="line-381">    createIfZNodeNotExists(ChaosConstants.CHAOS_TEST_ROOT_ZNODE);</span>
<span class="source-line-no">382</span><span id="line-382">    createIfZNodeNotExists(ChaosConstants.CHAOS_AGENT_REGISTRATION_EPIMERAL_ZNODE);</span>
<span class="source-line-no">383</span><span id="line-383">    createIfZNodeNotExists(ChaosConstants.CHAOS_AGENT_STATUS_PERSISTENT_ZNODE);</span>
<span class="source-line-no">384</span><span id="line-384">    createIfZNodeNotExists(ChaosConstants.CHAOS_AGENT_STATUS_PERSISTENT_ZNODE</span>
<span class="source-line-no">385</span><span id="line-385">      + ChaosConstants.ZNODE_PATH_SEPARATOR + agentName);</span>
<span class="source-line-no">386</span><span id="line-386"></span>
<span class="source-line-no">387</span><span id="line-387">    createEphemeralZNode(ChaosConstants.CHAOS_AGENT_REGISTRATION_EPIMERAL_ZNODE</span>
<span class="source-line-no">388</span><span id="line-388">      + ChaosConstants.ZNODE_PATH_SEPARATOR + agentName, new byte[0]);</span>
<span class="source-line-no">389</span><span id="line-389">  }</span>
<span class="source-line-no">390</span><span id="line-390"></span>
<span class="source-line-no">391</span><span id="line-391">  /***</span>
<span class="source-line-no">392</span><span id="line-392">   * Gets tasks for execution, basically sets Watch on it's respective host's Znode and waits for</span>
<span class="source-line-no">393</span><span id="line-393">   * tasks to be assigned, also has a getTasksForAgentCallback which handles execution of task.</span>
<span class="source-line-no">394</span><span id="line-394">   */</span>
<span class="source-line-no">395</span><span id="line-395">  private void getTasks() {</span>
<span class="source-line-no">396</span><span id="line-396">    LOG.info("Getting Tasks for Agent: " + agentName + "and setting watch for new Tasks");</span>
<span class="source-line-no">397</span><span id="line-397">    zk.getChildren(ChaosConstants.CHAOS_AGENT_STATUS_PERSISTENT_ZNODE</span>
<span class="source-line-no">398</span><span id="line-398">      + ChaosConstants.ZNODE_PATH_SEPARATOR + agentName, newTaskCreatedWatcher,</span>
<span class="source-line-no">399</span><span id="line-399">      getTasksForAgentCallback, null);</span>
<span class="source-line-no">400</span><span id="line-400">  }</span>
<span class="source-line-no">401</span><span id="line-401"></span>
<span class="source-line-no">402</span><span id="line-402">  /**</span>
<span class="source-line-no">403</span><span id="line-403">   * Below function executes command with retries with given user. Uses LocalShell to execute a</span>
<span class="source-line-no">404</span><span id="line-404">   * command.</span>
<span class="source-line-no">405</span><span id="line-405">   * @param user user name, default none</span>
<span class="source-line-no">406</span><span id="line-406">   * @param cmd  Command to execute</span>
<span class="source-line-no">407</span><span id="line-407">   * @return A pair of Exit Code and Shell output</span>
<span class="source-line-no">408</span><span id="line-408">   * @throws IOException Exception while executing shell command</span>
<span class="source-line-no">409</span><span id="line-409">   */</span>
<span class="source-line-no">410</span><span id="line-410">  private Pair&lt;Integer, String&gt; execWithRetries(String user, String cmd) throws IOException {</span>
<span class="source-line-no">411</span><span id="line-411">    RetryCounter retryCounter = retryCounterFactory.create();</span>
<span class="source-line-no">412</span><span id="line-412">    while (true) {</span>
<span class="source-line-no">413</span><span id="line-413">      try {</span>
<span class="source-line-no">414</span><span id="line-414">        return exec(user, cmd);</span>
<span class="source-line-no">415</span><span id="line-415">      } catch (IOException e) {</span>
<span class="source-line-no">416</span><span id="line-416">        retryOrThrow(retryCounter, e, user, cmd);</span>
<span class="source-line-no">417</span><span id="line-417">      }</span>
<span class="source-line-no">418</span><span id="line-418">      try {</span>
<span class="source-line-no">419</span><span id="line-419">        retryCounter.sleepUntilNextRetry();</span>
<span class="source-line-no">420</span><span id="line-420">      } catch (InterruptedException e) {</span>
<span class="source-line-no">421</span><span id="line-421">        LOG.warn("Sleep Interrupted: " + e);</span>
<span class="source-line-no">422</span><span id="line-422">      }</span>
<span class="source-line-no">423</span><span id="line-423">    }</span>
<span class="source-line-no">424</span><span id="line-424">  }</span>
<span class="source-line-no">425</span><span id="line-425"></span>
<span class="source-line-no">426</span><span id="line-426">  private Pair&lt;Integer, String&gt; exec(String user, String cmd) throws IOException {</span>
<span class="source-line-no">427</span><span id="line-427">    LOG.info("Executing Shell command: " + cmd + " , user: " + user);</span>
<span class="source-line-no">428</span><span id="line-428"></span>
<span class="source-line-no">429</span><span id="line-429">    LocalShell shell = new LocalShell(user, cmd);</span>
<span class="source-line-no">430</span><span id="line-430">    try {</span>
<span class="source-line-no">431</span><span id="line-431">      shell.execute();</span>
<span class="source-line-no">432</span><span id="line-432">    } catch (Shell.ExitCodeException e) {</span>
<span class="source-line-no">433</span><span id="line-433">      String output = shell.getOutput();</span>
<span class="source-line-no">434</span><span id="line-434">      throw new Shell.ExitCodeException(e.getExitCode(),</span>
<span class="source-line-no">435</span><span id="line-435">        "stderr: " + e.getMessage() + ", stdout: " + output);</span>
<span class="source-line-no">436</span><span id="line-436">    }</span>
<span class="source-line-no">437</span><span id="line-437">    LOG.info("Executed Shell command, exit code: {}, output n{}", shell.getExitCode(),</span>
<span class="source-line-no">438</span><span id="line-438">      shell.getOutput());</span>
<span class="source-line-no">439</span><span id="line-439"></span>
<span class="source-line-no">440</span><span id="line-440">    return new Pair&lt;&gt;(shell.getExitCode(), shell.getOutput());</span>
<span class="source-line-no">441</span><span id="line-441">  }</span>
<span class="source-line-no">442</span><span id="line-442"></span>
<span class="source-line-no">443</span><span id="line-443">  private &lt;E extends Exception&gt; void retryOrThrow(RetryCounter retryCounter, E ex, String user,</span>
<span class="source-line-no">444</span><span id="line-444">    String cmd) throws E {</span>
<span class="source-line-no">445</span><span id="line-445">    if (retryCounter.shouldRetry()) {</span>
<span class="source-line-no">446</span><span id="line-446">      LOG.warn(</span>
<span class="source-line-no">447</span><span id="line-447">        "Local command: {}, user: {}, failed at attempt {}. Retrying until maxAttempts: {}."</span>
<span class="source-line-no">448</span><span id="line-448">          + "Exception {}",</span>
<span class="source-line-no">449</span><span id="line-449">        cmd, user, retryCounter.getAttemptTimes(), retryCounter.getMaxAttempts(), ex.getMessage());</span>
<span class="source-line-no">450</span><span id="line-450">      return;</span>
<span class="source-line-no">451</span><span id="line-451">    }</span>
<span class="source-line-no">452</span><span id="line-452">    throw ex;</span>
<span class="source-line-no">453</span><span id="line-453">  }</span>
<span class="source-line-no">454</span><span id="line-454"></span>
<span class="source-line-no">455</span><span id="line-455">  private boolean isConnected() {</span>
<span class="source-line-no">456</span><span id="line-456">    return connected;</span>
<span class="source-line-no">457</span><span id="line-457">  }</span>
<span class="source-line-no">458</span><span id="line-458"></span>
<span class="source-line-no">459</span><span id="line-459">  @Override</span>
<span class="source-line-no">460</span><span id="line-460">  public void close() throws IOException {</span>
<span class="source-line-no">461</span><span id="line-461">    LOG.info("Closing ZooKeeper Connection for Chaos Agent : " + agentName);</span>
<span class="source-line-no">462</span><span id="line-462">    try {</span>
<span class="source-line-no">463</span><span id="line-463">      zk.close();</span>
<span class="source-line-no">464</span><span id="line-464">    } catch (InterruptedException e) {</span>
<span class="source-line-no">465</span><span id="line-465">      LOG.error("Error while closing ZooKeeper Connection.");</span>
<span class="source-line-no">466</span><span id="line-466">    }</span>
<span class="source-line-no">467</span><span id="line-467">  }</span>
<span class="source-line-no">468</span><span id="line-468"></span>
<span class="source-line-no">469</span><span id="line-469">  @Override</span>
<span class="source-line-no">470</span><span id="line-470">  public void run() {</span>
<span class="source-line-no">471</span><span id="line-471">    try {</span>
<span class="source-line-no">472</span><span id="line-472">      LOG.info("Running Chaos Agent on : " + agentName);</span>
<span class="source-line-no">473</span><span id="line-473">      while (!this.isConnected()) {</span>
<span class="source-line-no">474</span><span id="line-474">        Thread.sleep(100);</span>
<span class="source-line-no">475</span><span id="line-475">      }</span>
<span class="source-line-no">476</span><span id="line-476">      this.getTasks();</span>
<span class="source-line-no">477</span><span id="line-477">      while (!stopChaosAgent.get()) {</span>
<span class="source-line-no">478</span><span id="line-478">        Thread.sleep(500);</span>
<span class="source-line-no">479</span><span id="line-479">      }</span>
<span class="source-line-no">480</span><span id="line-480">    } catch (InterruptedException e) {</span>
<span class="source-line-no">481</span><span id="line-481">      LOG.error("Error while running Chaos Agent", e);</span>
<span class="source-line-no">482</span><span id="line-482">    }</span>
<span class="source-line-no">483</span><span id="line-483"></span>
<span class="source-line-no">484</span><span id="line-484">  }</span>
<span class="source-line-no">485</span><span id="line-485"></span>
<span class="source-line-no">486</span><span id="line-486">  @Override</span>
<span class="source-line-no">487</span><span id="line-487">  public void process(WatchedEvent watchedEvent) {</span>
<span class="source-line-no">488</span><span id="line-488">    LOG.info("Processing event: " + watchedEvent.toString());</span>
<span class="source-line-no">489</span><span id="line-489">    if (watchedEvent.getType() == Event.EventType.None) {</span>
<span class="source-line-no">490</span><span id="line-490">      switch (watchedEvent.getState()) {</span>
<span class="source-line-no">491</span><span id="line-491">        case SyncConnected:</span>
<span class="source-line-no">492</span><span id="line-492">          connected = true;</span>
<span class="source-line-no">493</span><span id="line-493">          break;</span>
<span class="source-line-no">494</span><span id="line-494">        case Disconnected:</span>
<span class="source-line-no">495</span><span id="line-495">          connected = false;</span>
<span class="source-line-no">496</span><span id="line-496">          break;</span>
<span class="source-line-no">497</span><span id="line-497">        case Expired:</span>
<span class="source-line-no">498</span><span id="line-498">          connected = false;</span>
<span class="source-line-no">499</span><span id="line-499">          LOG.error("Session expired creating again");</span>
<span class="source-line-no">500</span><span id="line-500">          try {</span>
<span class="source-line-no">501</span><span id="line-501">            createZKConnection(null);</span>
<span class="source-line-no">502</span><span id="line-502">          } catch (IOException e) {</span>
<span class="source-line-no">503</span><span id="line-503">            LOG.error("Error creating Zookeeper connection", e);</span>
<span class="source-line-no">504</span><span id="line-504">          }</span>
<span class="source-line-no">505</span><span id="line-505">        default:</span>
<span class="source-line-no">506</span><span id="line-506">          LOG.error("Unknown State");</span>
<span class="source-line-no">507</span><span id="line-507">          break;</span>
<span class="source-line-no">508</span><span id="line-508">      }</span>
<span class="source-line-no">509</span><span id="line-509">    }</span>
<span class="source-line-no">510</span><span id="line-510">  }</span>
<span class="source-line-no">511</span><span id="line-511"></span>
<span class="source-line-no">512</span><span id="line-512">  private void recreateZKConnection() throws Exception {</span>
<span class="source-line-no">513</span><span id="line-513">    try {</span>
<span class="source-line-no">514</span><span id="line-514">      zk.close();</span>
<span class="source-line-no">515</span><span id="line-515">      createZKConnection(newTaskCreatedWatcher);</span>
<span class="source-line-no">516</span><span id="line-516">      createEphemeralZNode(ChaosConstants.CHAOS_AGENT_REGISTRATION_EPIMERAL_ZNODE</span>
<span class="source-line-no">517</span><span id="line-517">        + ChaosConstants.ZNODE_PATH_SEPARATOR + agentName, new byte[0]);</span>
<span class="source-line-no">518</span><span id="line-518">    } catch (IOException e) {</span>
<span class="source-line-no">519</span><span id="line-519">      LOG.error("Error creating new ZK COnnection for agent: {}", agentName + e);</span>
<span class="source-line-no">520</span><span id="line-520">      throw e;</span>
<span class="source-line-no">521</span><span id="line-521">    }</span>
<span class="source-line-no">522</span><span id="line-522">  }</span>
<span class="source-line-no">523</span><span id="line-523"></span>
<span class="source-line-no">524</span><span id="line-524">  /**</span>
<span class="source-line-no">525</span><span id="line-525">   * Executes Command locally.</span>
<span class="source-line-no">526</span><span id="line-526">   */</span>
<span class="source-line-no">527</span><span id="line-527">  protected static class LocalShell extends Shell.ShellCommandExecutor {</span>
<span class="source-line-no">528</span><span id="line-528"></span>
<span class="source-line-no">529</span><span id="line-529">    private String user;</span>
<span class="source-line-no">530</span><span id="line-530">    private String execCommand;</span>
<span class="source-line-no">531</span><span id="line-531"></span>
<span class="source-line-no">532</span><span id="line-532">    public LocalShell(String user, String execCommand) {</span>
<span class="source-line-no">533</span><span id="line-533">      super(new String[] { execCommand });</span>
<span class="source-line-no">534</span><span id="line-534">      this.user = user;</span>
<span class="source-line-no">535</span><span id="line-535">      this.execCommand = execCommand;</span>
<span class="source-line-no">536</span><span id="line-536">    }</span>
<span class="source-line-no">537</span><span id="line-537"></span>
<span class="source-line-no">538</span><span id="line-538">    @Override</span>
<span class="source-line-no">539</span><span id="line-539">    public String[] getExecString() {</span>
<span class="source-line-no">540</span><span id="line-540">      // TODO: Considering Agent is running with same user.</span>
<span class="source-line-no">541</span><span id="line-541">      if (!user.equals(ChaosConstants.DEFAULT_SHELL_USER)) {</span>
<span class="source-line-no">542</span><span id="line-542">        execCommand = String.format("su -u %1$s %2$s", user, execCommand);</span>
<span class="source-line-no">543</span><span id="line-543">      }</span>
<span class="source-line-no">544</span><span id="line-544">      return new String[] { "/usr/bin/env", "bash", "-c", execCommand };</span>
<span class="source-line-no">545</span><span id="line-545">    }</span>
<span class="source-line-no">546</span><span id="line-546"></span>
<span class="source-line-no">547</span><span id="line-547">    @Override</span>
<span class="source-line-no">548</span><span id="line-548">    public void execute() throws IOException {</span>
<span class="source-line-no">549</span><span id="line-549">      super.execute();</span>
<span class="source-line-no">550</span><span id="line-550">    }</span>
<span class="source-line-no">551</span><span id="line-551">  }</span>
<span class="source-line-no">552</span><span id="line-552">}</span>




























































</pre>
</div>
</main>
</body>
</html>

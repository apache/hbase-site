<!DOCTYPE HTML>
<html lang="en">
<head>
<!-- Generated by javadoc (17) -->
<title>Source code</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="source: package: org.apache.hadoop.hbase.client, class: HBaseAdmin, class: CreateTableFuture">
<meta name="generator" content="javadoc/SourceToHTMLConverter">
<link rel="stylesheet" type="text/css" href="../../../../../../stylesheet.css" title="Style">
</head>
<body class="source-page">
<main role="main">
<div class="source-container">
<pre><span class="source-line-no">001</span><span id="line-1">/*</span>
<span class="source-line-no">002</span><span id="line-2"> * Licensed to the Apache Software Foundation (ASF) under one</span>
<span class="source-line-no">003</span><span id="line-3"> * or more contributor license agreements.  See the NOTICE file</span>
<span class="source-line-no">004</span><span id="line-4"> * distributed with this work for additional information</span>
<span class="source-line-no">005</span><span id="line-5"> * regarding copyright ownership.  The ASF licenses this file</span>
<span class="source-line-no">006</span><span id="line-6"> * to you under the Apache License, Version 2.0 (the</span>
<span class="source-line-no">007</span><span id="line-7"> * "License"); you may not use this file except in compliance</span>
<span class="source-line-no">008</span><span id="line-8"> * with the License.  You may obtain a copy of the License at</span>
<span class="source-line-no">009</span><span id="line-9"> *</span>
<span class="source-line-no">010</span><span id="line-10"> *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="source-line-no">011</span><span id="line-11"> *</span>
<span class="source-line-no">012</span><span id="line-12"> * Unless required by applicable law or agreed to in writing, software</span>
<span class="source-line-no">013</span><span id="line-13"> * distributed under the License is distributed on an "AS IS" BASIS,</span>
<span class="source-line-no">014</span><span id="line-14"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="source-line-no">015</span><span id="line-15"> * See the License for the specific language governing permissions and</span>
<span class="source-line-no">016</span><span id="line-16"> * limitations under the License.</span>
<span class="source-line-no">017</span><span id="line-17"> */</span>
<span class="source-line-no">018</span><span id="line-18">package org.apache.hadoop.hbase.client;</span>
<span class="source-line-no">019</span><span id="line-19"></span>
<span class="source-line-no">020</span><span id="line-20">import com.google.protobuf.Descriptors;</span>
<span class="source-line-no">021</span><span id="line-21">import com.google.protobuf.Message;</span>
<span class="source-line-no">022</span><span id="line-22">import com.google.protobuf.RpcController;</span>
<span class="source-line-no">023</span><span id="line-23">import edu.umd.cs.findbugs.annotations.Nullable;</span>
<span class="source-line-no">024</span><span id="line-24">import java.io.Closeable;</span>
<span class="source-line-no">025</span><span id="line-25">import java.io.IOException;</span>
<span class="source-line-no">026</span><span id="line-26">import java.io.InterruptedIOException;</span>
<span class="source-line-no">027</span><span id="line-27">import java.util.ArrayList;</span>
<span class="source-line-no">028</span><span id="line-28">import java.util.Arrays;</span>
<span class="source-line-no">029</span><span id="line-29">import java.util.Collections;</span>
<span class="source-line-no">030</span><span id="line-30">import java.util.EnumSet;</span>
<span class="source-line-no">031</span><span id="line-31">import java.util.HashMap;</span>
<span class="source-line-no">032</span><span id="line-32">import java.util.Iterator;</span>
<span class="source-line-no">033</span><span id="line-33">import java.util.List;</span>
<span class="source-line-no">034</span><span id="line-34">import java.util.Map;</span>
<span class="source-line-no">035</span><span id="line-35">import java.util.Set;</span>
<span class="source-line-no">036</span><span id="line-36">import java.util.concurrent.Callable;</span>
<span class="source-line-no">037</span><span id="line-37">import java.util.concurrent.ExecutionException;</span>
<span class="source-line-no">038</span><span id="line-38">import java.util.concurrent.Future;</span>
<span class="source-line-no">039</span><span id="line-39">import java.util.concurrent.TimeUnit;</span>
<span class="source-line-no">040</span><span id="line-40">import java.util.concurrent.TimeoutException;</span>
<span class="source-line-no">041</span><span id="line-41">import java.util.concurrent.atomic.AtomicInteger;</span>
<span class="source-line-no">042</span><span id="line-42">import java.util.concurrent.atomic.AtomicReference;</span>
<span class="source-line-no">043</span><span id="line-43">import java.util.function.Supplier;</span>
<span class="source-line-no">044</span><span id="line-44">import java.util.regex.Pattern;</span>
<span class="source-line-no">045</span><span id="line-45">import java.util.stream.Collectors;</span>
<span class="source-line-no">046</span><span id="line-46">import java.util.stream.Stream;</span>
<span class="source-line-no">047</span><span id="line-47">import org.apache.hadoop.conf.Configuration;</span>
<span class="source-line-no">048</span><span id="line-48">import org.apache.hadoop.hbase.CacheEvictionStats;</span>
<span class="source-line-no">049</span><span id="line-49">import org.apache.hadoop.hbase.CacheEvictionStatsBuilder;</span>
<span class="source-line-no">050</span><span id="line-50">import org.apache.hadoop.hbase.ClusterMetrics;</span>
<span class="source-line-no">051</span><span id="line-51">import org.apache.hadoop.hbase.ClusterMetrics.Option;</span>
<span class="source-line-no">052</span><span id="line-52">import org.apache.hadoop.hbase.ClusterMetricsBuilder;</span>
<span class="source-line-no">053</span><span id="line-53">import org.apache.hadoop.hbase.DoNotRetryIOException;</span>
<span class="source-line-no">054</span><span id="line-54">import org.apache.hadoop.hbase.HBaseConfiguration;</span>
<span class="source-line-no">055</span><span id="line-55">import org.apache.hadoop.hbase.HConstants;</span>
<span class="source-line-no">056</span><span id="line-56">import org.apache.hadoop.hbase.HRegionInfo;</span>
<span class="source-line-no">057</span><span id="line-57">import org.apache.hadoop.hbase.HRegionLocation;</span>
<span class="source-line-no">058</span><span id="line-58">import org.apache.hadoop.hbase.HTableDescriptor;</span>
<span class="source-line-no">059</span><span id="line-59">import org.apache.hadoop.hbase.MasterNotRunningException;</span>
<span class="source-line-no">060</span><span id="line-60">import org.apache.hadoop.hbase.MetaTableAccessor;</span>
<span class="source-line-no">061</span><span id="line-61">import org.apache.hadoop.hbase.NamespaceDescriptor;</span>
<span class="source-line-no">062</span><span id="line-62">import org.apache.hadoop.hbase.NamespaceNotFoundException;</span>
<span class="source-line-no">063</span><span id="line-63">import org.apache.hadoop.hbase.NotServingRegionException;</span>
<span class="source-line-no">064</span><span id="line-64">import org.apache.hadoop.hbase.RegionLocations;</span>
<span class="source-line-no">065</span><span id="line-65">import org.apache.hadoop.hbase.RegionMetrics;</span>
<span class="source-line-no">066</span><span id="line-66">import org.apache.hadoop.hbase.RegionMetricsBuilder;</span>
<span class="source-line-no">067</span><span id="line-67">import org.apache.hadoop.hbase.ServerName;</span>
<span class="source-line-no">068</span><span id="line-68">import org.apache.hadoop.hbase.TableExistsException;</span>
<span class="source-line-no">069</span><span id="line-69">import org.apache.hadoop.hbase.TableName;</span>
<span class="source-line-no">070</span><span id="line-70">import org.apache.hadoop.hbase.TableNotDisabledException;</span>
<span class="source-line-no">071</span><span id="line-71">import org.apache.hadoop.hbase.TableNotEnabledException;</span>
<span class="source-line-no">072</span><span id="line-72">import org.apache.hadoop.hbase.TableNotFoundException;</span>
<span class="source-line-no">073</span><span id="line-73">import org.apache.hadoop.hbase.UnknownRegionException;</span>
<span class="source-line-no">074</span><span id="line-74">import org.apache.hadoop.hbase.ZooKeeperConnectionException;</span>
<span class="source-line-no">075</span><span id="line-75">import org.apache.hadoop.hbase.client.replication.ReplicationPeerConfigUtil;</span>
<span class="source-line-no">076</span><span id="line-76">import org.apache.hadoop.hbase.client.replication.TableCFs;</span>
<span class="source-line-no">077</span><span id="line-77">import org.apache.hadoop.hbase.client.security.SecurityCapability;</span>
<span class="source-line-no">078</span><span id="line-78">import org.apache.hadoop.hbase.exceptions.TimeoutIOException;</span>
<span class="source-line-no">079</span><span id="line-79">import org.apache.hadoop.hbase.ipc.CoprocessorRpcChannel;</span>
<span class="source-line-no">080</span><span id="line-80">import org.apache.hadoop.hbase.ipc.CoprocessorRpcUtils;</span>
<span class="source-line-no">081</span><span id="line-81">import org.apache.hadoop.hbase.ipc.HBaseRpcController;</span>
<span class="source-line-no">082</span><span id="line-82">import org.apache.hadoop.hbase.ipc.RpcControllerFactory;</span>
<span class="source-line-no">083</span><span id="line-83">import org.apache.hadoop.hbase.quotas.QuotaFilter;</span>
<span class="source-line-no">084</span><span id="line-84">import org.apache.hadoop.hbase.quotas.QuotaRetriever;</span>
<span class="source-line-no">085</span><span id="line-85">import org.apache.hadoop.hbase.quotas.QuotaSettings;</span>
<span class="source-line-no">086</span><span id="line-86">import org.apache.hadoop.hbase.quotas.SpaceQuotaSnapshot;</span>
<span class="source-line-no">087</span><span id="line-87">import org.apache.hadoop.hbase.regionserver.wal.FailedLogCloseException;</span>
<span class="source-line-no">088</span><span id="line-88">import org.apache.hadoop.hbase.replication.ReplicationPeerConfig;</span>
<span class="source-line-no">089</span><span id="line-89">import org.apache.hadoop.hbase.replication.ReplicationPeerDescription;</span>
<span class="source-line-no">090</span><span id="line-90">import org.apache.hadoop.hbase.security.access.GetUserPermissionsRequest;</span>
<span class="source-line-no">091</span><span id="line-91">import org.apache.hadoop.hbase.security.access.Permission;</span>
<span class="source-line-no">092</span><span id="line-92">import org.apache.hadoop.hbase.security.access.ShadedAccessControlUtil;</span>
<span class="source-line-no">093</span><span id="line-93">import org.apache.hadoop.hbase.security.access.UserPermission;</span>
<span class="source-line-no">094</span><span id="line-94">import org.apache.hadoop.hbase.snapshot.ClientSnapshotDescriptionUtils;</span>
<span class="source-line-no">095</span><span id="line-95">import org.apache.hadoop.hbase.snapshot.HBaseSnapshotException;</span>
<span class="source-line-no">096</span><span id="line-96">import org.apache.hadoop.hbase.snapshot.RestoreSnapshotException;</span>
<span class="source-line-no">097</span><span id="line-97">import org.apache.hadoop.hbase.snapshot.SnapshotCreationException;</span>
<span class="source-line-no">098</span><span id="line-98">import org.apache.hadoop.hbase.snapshot.UnknownSnapshotException;</span>
<span class="source-line-no">099</span><span id="line-99">import org.apache.hadoop.hbase.util.Addressing;</span>
<span class="source-line-no">100</span><span id="line-100">import org.apache.hadoop.hbase.util.Bytes;</span>
<span class="source-line-no">101</span><span id="line-101">import org.apache.hadoop.hbase.util.EnvironmentEdgeManager;</span>
<span class="source-line-no">102</span><span id="line-102">import org.apache.hadoop.hbase.util.ForeignExceptionUtil;</span>
<span class="source-line-no">103</span><span id="line-103">import org.apache.hadoop.hbase.util.Pair;</span>
<span class="source-line-no">104</span><span id="line-104">import org.apache.hadoop.hbase.util.Strings;</span>
<span class="source-line-no">105</span><span id="line-105">import org.apache.hadoop.ipc.RemoteException;</span>
<span class="source-line-no">106</span><span id="line-106">import org.apache.hadoop.util.StringUtils;</span>
<span class="source-line-no">107</span><span id="line-107">import org.apache.yetus.audience.InterfaceAudience;</span>
<span class="source-line-no">108</span><span id="line-108">import org.apache.yetus.audience.InterfaceStability;</span>
<span class="source-line-no">109</span><span id="line-109">import org.slf4j.Logger;</span>
<span class="source-line-no">110</span><span id="line-110">import org.slf4j.LoggerFactory;</span>
<span class="source-line-no">111</span><span id="line-111"></span>
<span class="source-line-no">112</span><span id="line-112">import org.apache.hbase.thirdparty.com.google.common.base.Preconditions;</span>
<span class="source-line-no">113</span><span id="line-113">import org.apache.hbase.thirdparty.com.google.protobuf.ServiceException;</span>
<span class="source-line-no">114</span><span id="line-114">import org.apache.hbase.thirdparty.org.apache.commons.collections4.CollectionUtils;</span>
<span class="source-line-no">115</span><span id="line-115"></span>
<span class="source-line-no">116</span><span id="line-116">import org.apache.hadoop.hbase.shaded.protobuf.ProtobufUtil;</span>
<span class="source-line-no">117</span><span id="line-117">import org.apache.hadoop.hbase.shaded.protobuf.RequestConverter;</span>
<span class="source-line-no">118</span><span id="line-118">import org.apache.hadoop.hbase.shaded.protobuf.generated.AccessControlProtos;</span>
<span class="source-line-no">119</span><span id="line-119">import org.apache.hadoop.hbase.shaded.protobuf.generated.AccessControlProtos.GrantRequest;</span>
<span class="source-line-no">120</span><span id="line-120">import org.apache.hadoop.hbase.shaded.protobuf.generated.AccessControlProtos.HasUserPermissionsRequest;</span>
<span class="source-line-no">121</span><span id="line-121">import org.apache.hadoop.hbase.shaded.protobuf.generated.AccessControlProtos.RevokeRequest;</span>
<span class="source-line-no">122</span><span id="line-122">import org.apache.hadoop.hbase.shaded.protobuf.generated.AdminProtos;</span>
<span class="source-line-no">123</span><span id="line-123">import org.apache.hadoop.hbase.shaded.protobuf.generated.AdminProtos.AdminService;</span>
<span class="source-line-no">124</span><span id="line-124">import org.apache.hadoop.hbase.shaded.protobuf.generated.AdminProtos.ClearCompactionQueuesRequest;</span>
<span class="source-line-no">125</span><span id="line-125">import org.apache.hadoop.hbase.shaded.protobuf.generated.AdminProtos.ClearRegionBlockCacheRequest;</span>
<span class="source-line-no">126</span><span id="line-126">import org.apache.hadoop.hbase.shaded.protobuf.generated.AdminProtos.ClearRegionBlockCacheResponse;</span>
<span class="source-line-no">127</span><span id="line-127">import org.apache.hadoop.hbase.shaded.protobuf.generated.AdminProtos.CompactRegionRequest;</span>
<span class="source-line-no">128</span><span id="line-128">import org.apache.hadoop.hbase.shaded.protobuf.generated.AdminProtos.CompactionSwitchRequest;</span>
<span class="source-line-no">129</span><span id="line-129">import org.apache.hadoop.hbase.shaded.protobuf.generated.AdminProtos.CompactionSwitchResponse;</span>
<span class="source-line-no">130</span><span id="line-130">import org.apache.hadoop.hbase.shaded.protobuf.generated.AdminProtos.FlushRegionRequest;</span>
<span class="source-line-no">131</span><span id="line-131">import org.apache.hadoop.hbase.shaded.protobuf.generated.AdminProtos.GetRegionInfoRequest;</span>
<span class="source-line-no">132</span><span id="line-132">import org.apache.hadoop.hbase.shaded.protobuf.generated.AdminProtos.GetRegionInfoResponse;</span>
<span class="source-line-no">133</span><span id="line-133">import org.apache.hadoop.hbase.shaded.protobuf.generated.AdminProtos.RollWALWriterRequest;</span>
<span class="source-line-no">134</span><span id="line-134">import org.apache.hadoop.hbase.shaded.protobuf.generated.AdminProtos.RollWALWriterResponse;</span>
<span class="source-line-no">135</span><span id="line-135">import org.apache.hadoop.hbase.shaded.protobuf.generated.AdminProtos.StopServerRequest;</span>
<span class="source-line-no">136</span><span id="line-136">import org.apache.hadoop.hbase.shaded.protobuf.generated.AdminProtos.UpdateConfigurationRequest;</span>
<span class="source-line-no">137</span><span id="line-137">import org.apache.hadoop.hbase.shaded.protobuf.generated.ClientProtos;</span>
<span class="source-line-no">138</span><span id="line-138">import org.apache.hadoop.hbase.shaded.protobuf.generated.ClientProtos.CoprocessorServiceRequest;</span>
<span class="source-line-no">139</span><span id="line-139">import org.apache.hadoop.hbase.shaded.protobuf.generated.ClientProtos.CoprocessorServiceResponse;</span>
<span class="source-line-no">140</span><span id="line-140">import org.apache.hadoop.hbase.shaded.protobuf.generated.HBaseProtos;</span>
<span class="source-line-no">141</span><span id="line-141">import org.apache.hadoop.hbase.shaded.protobuf.generated.HBaseProtos.ProcedureDescription;</span>
<span class="source-line-no">142</span><span id="line-142">import org.apache.hadoop.hbase.shaded.protobuf.generated.HBaseProtos.RegionSpecifier.RegionSpecifierType;</span>
<span class="source-line-no">143</span><span id="line-143">import org.apache.hadoop.hbase.shaded.protobuf.generated.HBaseProtos.TableSchema;</span>
<span class="source-line-no">144</span><span id="line-144">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos;</span>
<span class="source-line-no">145</span><span id="line-145">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.AbortProcedureRequest;</span>
<span class="source-line-no">146</span><span id="line-146">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.AbortProcedureResponse;</span>
<span class="source-line-no">147</span><span id="line-147">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.AddColumnRequest;</span>
<span class="source-line-no">148</span><span id="line-148">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.AddColumnResponse;</span>
<span class="source-line-no">149</span><span id="line-149">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.AssignRegionRequest;</span>
<span class="source-line-no">150</span><span id="line-150">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.ClearDeadServersRequest;</span>
<span class="source-line-no">151</span><span id="line-151">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.CreateNamespaceRequest;</span>
<span class="source-line-no">152</span><span id="line-152">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.CreateNamespaceResponse;</span>
<span class="source-line-no">153</span><span id="line-153">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.CreateTableRequest;</span>
<span class="source-line-no">154</span><span id="line-154">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.CreateTableResponse;</span>
<span class="source-line-no">155</span><span id="line-155">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.DeleteColumnRequest;</span>
<span class="source-line-no">156</span><span id="line-156">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.DeleteColumnResponse;</span>
<span class="source-line-no">157</span><span id="line-157">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.DeleteNamespaceRequest;</span>
<span class="source-line-no">158</span><span id="line-158">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.DeleteNamespaceResponse;</span>
<span class="source-line-no">159</span><span id="line-159">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.DeleteSnapshotRequest;</span>
<span class="source-line-no">160</span><span id="line-160">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.DeleteTableRequest;</span>
<span class="source-line-no">161</span><span id="line-161">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.DeleteTableResponse;</span>
<span class="source-line-no">162</span><span id="line-162">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.DisableTableRequest;</span>
<span class="source-line-no">163</span><span id="line-163">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.DisableTableResponse;</span>
<span class="source-line-no">164</span><span id="line-164">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.EnableTableRequest;</span>
<span class="source-line-no">165</span><span id="line-165">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.EnableTableResponse;</span>
<span class="source-line-no">166</span><span id="line-166">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.ExecProcedureRequest;</span>
<span class="source-line-no">167</span><span id="line-167">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.ExecProcedureResponse;</span>
<span class="source-line-no">168</span><span id="line-168">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.FlushMasterStoreRequest;</span>
<span class="source-line-no">169</span><span id="line-169">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.FlushTableRequest;</span>
<span class="source-line-no">170</span><span id="line-170">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.FlushTableResponse;</span>
<span class="source-line-no">171</span><span id="line-171">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.GetClusterStatusRequest;</span>
<span class="source-line-no">172</span><span id="line-172">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.GetCompletedSnapshotsRequest;</span>
<span class="source-line-no">173</span><span id="line-173">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.GetLocksRequest;</span>
<span class="source-line-no">174</span><span id="line-174">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.GetLocksResponse;</span>
<span class="source-line-no">175</span><span id="line-175">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.GetNamespaceDescriptorRequest;</span>
<span class="source-line-no">176</span><span id="line-176">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.GetProcedureResultRequest;</span>
<span class="source-line-no">177</span><span id="line-177">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.GetProcedureResultResponse;</span>
<span class="source-line-no">178</span><span id="line-178">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.GetProceduresRequest;</span>
<span class="source-line-no">179</span><span id="line-179">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.GetProceduresResponse;</span>
<span class="source-line-no">180</span><span id="line-180">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.GetSchemaAlterStatusRequest;</span>
<span class="source-line-no">181</span><span id="line-181">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.GetSchemaAlterStatusResponse;</span>
<span class="source-line-no">182</span><span id="line-182">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.GetTableDescriptorsRequest;</span>
<span class="source-line-no">183</span><span id="line-183">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.GetTableDescriptorsResponse;</span>
<span class="source-line-no">184</span><span id="line-184">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.GetTableNamesRequest;</span>
<span class="source-line-no">185</span><span id="line-185">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.IsInMaintenanceModeRequest;</span>
<span class="source-line-no">186</span><span id="line-186">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.IsInMaintenanceModeResponse;</span>
<span class="source-line-no">187</span><span id="line-187">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.IsProcedureDoneRequest;</span>
<span class="source-line-no">188</span><span id="line-188">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.IsProcedureDoneResponse;</span>
<span class="source-line-no">189</span><span id="line-189">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.IsRpcThrottleEnabledRequest;</span>
<span class="source-line-no">190</span><span id="line-190">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.IsSnapshotCleanupEnabledRequest;</span>
<span class="source-line-no">191</span><span id="line-191">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.IsSnapshotDoneRequest;</span>
<span class="source-line-no">192</span><span id="line-192">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.IsSnapshotDoneResponse;</span>
<span class="source-line-no">193</span><span id="line-193">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.ListDecommissionedRegionServersRequest;</span>
<span class="source-line-no">194</span><span id="line-194">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.ListNamespaceDescriptorsRequest;</span>
<span class="source-line-no">195</span><span id="line-195">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.ListNamespacesRequest;</span>
<span class="source-line-no">196</span><span id="line-196">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.ListTableDescriptorsByNamespaceRequest;</span>
<span class="source-line-no">197</span><span id="line-197">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.ListTableDescriptorsByStateRequest;</span>
<span class="source-line-no">198</span><span id="line-198">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.ListTableDescriptorsByStateResponse;</span>
<span class="source-line-no">199</span><span id="line-199">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.ListTableNamesByNamespaceRequest;</span>
<span class="source-line-no">200</span><span id="line-200">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.ListTableNamesByStateRequest;</span>
<span class="source-line-no">201</span><span id="line-201">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.ListTableNamesByStateResponse;</span>
<span class="source-line-no">202</span><span id="line-202">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.MajorCompactionTimestampForRegionRequest;</span>
<span class="source-line-no">203</span><span id="line-203">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.MajorCompactionTimestampRequest;</span>
<span class="source-line-no">204</span><span id="line-204">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.MergeTableRegionsRequest;</span>
<span class="source-line-no">205</span><span id="line-205">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.MergeTableRegionsResponse;</span>
<span class="source-line-no">206</span><span id="line-206">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.ModifyColumnRequest;</span>
<span class="source-line-no">207</span><span id="line-207">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.ModifyColumnResponse;</span>
<span class="source-line-no">208</span><span id="line-208">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.ModifyColumnStoreFileTrackerRequest;</span>
<span class="source-line-no">209</span><span id="line-209">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.ModifyColumnStoreFileTrackerResponse;</span>
<span class="source-line-no">210</span><span id="line-210">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.ModifyNamespaceRequest;</span>
<span class="source-line-no">211</span><span id="line-211">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.ModifyNamespaceResponse;</span>
<span class="source-line-no">212</span><span id="line-212">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.ModifyTableRequest;</span>
<span class="source-line-no">213</span><span id="line-213">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.ModifyTableResponse;</span>
<span class="source-line-no">214</span><span id="line-214">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.ModifyTableStoreFileTrackerRequest;</span>
<span class="source-line-no">215</span><span id="line-215">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.ModifyTableStoreFileTrackerResponse;</span>
<span class="source-line-no">216</span><span id="line-216">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.MoveRegionRequest;</span>
<span class="source-line-no">217</span><span id="line-217">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.RestoreSnapshotRequest;</span>
<span class="source-line-no">218</span><span id="line-218">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.RestoreSnapshotResponse;</span>
<span class="source-line-no">219</span><span id="line-219">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.SecurityCapabilitiesRequest;</span>
<span class="source-line-no">220</span><span id="line-220">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.SetBalancerRunningRequest;</span>
<span class="source-line-no">221</span><span id="line-221">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.SetNormalizerRunningRequest;</span>
<span class="source-line-no">222</span><span id="line-222">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.SetSnapshotCleanupRequest;</span>
<span class="source-line-no">223</span><span id="line-223">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.ShutdownRequest;</span>
<span class="source-line-no">224</span><span id="line-224">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.SnapshotRequest;</span>
<span class="source-line-no">225</span><span id="line-225">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.SnapshotResponse;</span>
<span class="source-line-no">226</span><span id="line-226">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.SplitTableRegionRequest;</span>
<span class="source-line-no">227</span><span id="line-227">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.SplitTableRegionResponse;</span>
<span class="source-line-no">228</span><span id="line-228">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.StopMasterRequest;</span>
<span class="source-line-no">229</span><span id="line-229">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.TruncateTableRequest;</span>
<span class="source-line-no">230</span><span id="line-230">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.TruncateTableResponse;</span>
<span class="source-line-no">231</span><span id="line-231">import org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos.UnassignRegionRequest;</span>
<span class="source-line-no">232</span><span id="line-232">import org.apache.hadoop.hbase.shaded.protobuf.generated.ProcedureProtos;</span>
<span class="source-line-no">233</span><span id="line-233">import org.apache.hadoop.hbase.shaded.protobuf.generated.QuotaProtos.GetQuotaStatesResponse;</span>
<span class="source-line-no">234</span><span id="line-234">import org.apache.hadoop.hbase.shaded.protobuf.generated.QuotaProtos.GetSpaceQuotaRegionSizesResponse;</span>
<span class="source-line-no">235</span><span id="line-235">import org.apache.hadoop.hbase.shaded.protobuf.generated.QuotaProtos.GetSpaceQuotaRegionSizesResponse.RegionSizes;</span>
<span class="source-line-no">236</span><span id="line-236">import org.apache.hadoop.hbase.shaded.protobuf.generated.QuotaProtos.GetSpaceQuotaSnapshotsResponse;</span>
<span class="source-line-no">237</span><span id="line-237">import org.apache.hadoop.hbase.shaded.protobuf.generated.QuotaProtos.GetSpaceQuotaSnapshotsResponse.TableQuotaSnapshot;</span>
<span class="source-line-no">238</span><span id="line-238">import org.apache.hadoop.hbase.shaded.protobuf.generated.ReplicationProtos;</span>
<span class="source-line-no">239</span><span id="line-239">import org.apache.hadoop.hbase.shaded.protobuf.generated.ReplicationProtos.AddReplicationPeerResponse;</span>
<span class="source-line-no">240</span><span id="line-240">import org.apache.hadoop.hbase.shaded.protobuf.generated.ReplicationProtos.DisableReplicationPeerResponse;</span>
<span class="source-line-no">241</span><span id="line-241">import org.apache.hadoop.hbase.shaded.protobuf.generated.ReplicationProtos.EnableReplicationPeerResponse;</span>
<span class="source-line-no">242</span><span id="line-242">import org.apache.hadoop.hbase.shaded.protobuf.generated.ReplicationProtos.GetReplicationPeerConfigResponse;</span>
<span class="source-line-no">243</span><span id="line-243">import org.apache.hadoop.hbase.shaded.protobuf.generated.ReplicationProtos.GetReplicationPeerModificationProceduresRequest;</span>
<span class="source-line-no">244</span><span id="line-244">import org.apache.hadoop.hbase.shaded.protobuf.generated.ReplicationProtos.GetReplicationPeerStateRequest;</span>
<span class="source-line-no">245</span><span id="line-245">import org.apache.hadoop.hbase.shaded.protobuf.generated.ReplicationProtos.GetReplicationPeerStateResponse;</span>
<span class="source-line-no">246</span><span id="line-246">import org.apache.hadoop.hbase.shaded.protobuf.generated.ReplicationProtos.IsReplicationPeerModificationEnabledRequest;</span>
<span class="source-line-no">247</span><span id="line-247">import org.apache.hadoop.hbase.shaded.protobuf.generated.ReplicationProtos.RemoveReplicationPeerResponse;</span>
<span class="source-line-no">248</span><span id="line-248">import org.apache.hadoop.hbase.shaded.protobuf.generated.ReplicationProtos.ReplicationPeerModificationSwitchRequest;</span>
<span class="source-line-no">249</span><span id="line-249">import org.apache.hadoop.hbase.shaded.protobuf.generated.ReplicationProtos.UpdateReplicationPeerConfigResponse;</span>
<span class="source-line-no">250</span><span id="line-250">import org.apache.hadoop.hbase.shaded.protobuf.generated.SnapshotProtos;</span>
<span class="source-line-no">251</span><span id="line-251"></span>
<span class="source-line-no">252</span><span id="line-252">/**</span>
<span class="source-line-no">253</span><span id="line-253"> * HBaseAdmin is no longer a client API. It is marked InterfaceAudience.Private indicating that this</span>
<span class="source-line-no">254</span><span id="line-254"> * is an HBase-internal class as defined in</span>
<span class="source-line-no">255</span><span id="line-255"> * https://hadoop.apache.org/docs/current/hadoop-project-dist/hadoop-common/InterfaceClassification.html</span>
<span class="source-line-no">256</span><span id="line-256"> * There are no guarantees for backwards source / binary compatibility and methods or class can</span>
<span class="source-line-no">257</span><span id="line-257"> * change or go away without deprecation. Use {@link Connection#getAdmin()} to obtain an instance of</span>
<span class="source-line-no">258</span><span id="line-258"> * {@link Admin} instead of constructing an HBaseAdmin directly.</span>
<span class="source-line-no">259</span><span id="line-259"> * &lt;p&gt;</span>
<span class="source-line-no">260</span><span id="line-260"> * Connection should be an &lt;i&gt;unmanaged&lt;/i&gt; connection obtained via</span>
<span class="source-line-no">261</span><span id="line-261"> * {@link ConnectionFactory#createConnection(Configuration)}</span>
<span class="source-line-no">262</span><span id="line-262"> * @see ConnectionFactory</span>
<span class="source-line-no">263</span><span id="line-263"> * @see Connection</span>
<span class="source-line-no">264</span><span id="line-264"> * @see Admin</span>
<span class="source-line-no">265</span><span id="line-265"> */</span>
<span class="source-line-no">266</span><span id="line-266">@InterfaceAudience.Private</span>
<span class="source-line-no">267</span><span id="line-267">public class HBaseAdmin implements Admin {</span>
<span class="source-line-no">268</span><span id="line-268">  private static final Logger LOG = LoggerFactory.getLogger(HBaseAdmin.class);</span>
<span class="source-line-no">269</span><span id="line-269"></span>
<span class="source-line-no">270</span><span id="line-270">  private ClusterConnection connection;</span>
<span class="source-line-no">271</span><span id="line-271"></span>
<span class="source-line-no">272</span><span id="line-272">  private final Configuration conf;</span>
<span class="source-line-no">273</span><span id="line-273">  private final long pause;</span>
<span class="source-line-no">274</span><span id="line-274">  private final int numRetries;</span>
<span class="source-line-no">275</span><span id="line-275">  private final int syncWaitTimeout;</span>
<span class="source-line-no">276</span><span id="line-276">  private boolean aborted;</span>
<span class="source-line-no">277</span><span id="line-277">  private int operationTimeout;</span>
<span class="source-line-no">278</span><span id="line-278">  private int rpcTimeout;</span>
<span class="source-line-no">279</span><span id="line-279">  private int getProcedureTimeout;</span>
<span class="source-line-no">280</span><span id="line-280"></span>
<span class="source-line-no">281</span><span id="line-281">  private RpcRetryingCallerFactory rpcCallerFactory;</span>
<span class="source-line-no">282</span><span id="line-282">  private RpcControllerFactory rpcControllerFactory;</span>
<span class="source-line-no">283</span><span id="line-283"></span>
<span class="source-line-no">284</span><span id="line-284">  private NonceGenerator ng;</span>
<span class="source-line-no">285</span><span id="line-285"></span>
<span class="source-line-no">286</span><span id="line-286">  @Override</span>
<span class="source-line-no">287</span><span id="line-287">  public int getOperationTimeout() {</span>
<span class="source-line-no">288</span><span id="line-288">    return operationTimeout;</span>
<span class="source-line-no">289</span><span id="line-289">  }</span>
<span class="source-line-no">290</span><span id="line-290"></span>
<span class="source-line-no">291</span><span id="line-291">  @Override</span>
<span class="source-line-no">292</span><span id="line-292">  public int getSyncWaitTimeout() {</span>
<span class="source-line-no">293</span><span id="line-293">    return syncWaitTimeout;</span>
<span class="source-line-no">294</span><span id="line-294">  }</span>
<span class="source-line-no">295</span><span id="line-295"></span>
<span class="source-line-no">296</span><span id="line-296">  HBaseAdmin(ClusterConnection connection) throws IOException {</span>
<span class="source-line-no">297</span><span id="line-297">    this.conf = connection.getConfiguration();</span>
<span class="source-line-no">298</span><span id="line-298">    this.connection = connection;</span>
<span class="source-line-no">299</span><span id="line-299"></span>
<span class="source-line-no">300</span><span id="line-300">    // TODO: receive ConnectionConfiguration here rather than re-parsing these configs every time.</span>
<span class="source-line-no">301</span><span id="line-301">    this.pause =</span>
<span class="source-line-no">302</span><span id="line-302">      this.conf.getLong(HConstants.HBASE_CLIENT_PAUSE, HConstants.DEFAULT_HBASE_CLIENT_PAUSE);</span>
<span class="source-line-no">303</span><span id="line-303">    this.numRetries = this.conf.getInt(HConstants.HBASE_CLIENT_RETRIES_NUMBER,</span>
<span class="source-line-no">304</span><span id="line-304">      HConstants.DEFAULT_HBASE_CLIENT_RETRIES_NUMBER);</span>
<span class="source-line-no">305</span><span id="line-305">    this.operationTimeout = this.conf.getInt(HConstants.HBASE_CLIENT_OPERATION_TIMEOUT,</span>
<span class="source-line-no">306</span><span id="line-306">      HConstants.DEFAULT_HBASE_CLIENT_OPERATION_TIMEOUT);</span>
<span class="source-line-no">307</span><span id="line-307">    this.rpcTimeout =</span>
<span class="source-line-no">308</span><span id="line-308">      this.conf.getInt(HConstants.HBASE_RPC_TIMEOUT_KEY, HConstants.DEFAULT_HBASE_RPC_TIMEOUT);</span>
<span class="source-line-no">309</span><span id="line-309">    this.syncWaitTimeout = this.conf.getInt("hbase.client.sync.wait.timeout.msec", 10 * 60000); // 10min</span>
<span class="source-line-no">310</span><span id="line-310">    this.getProcedureTimeout =</span>
<span class="source-line-no">311</span><span id="line-311">      this.conf.getInt("hbase.client.procedure.future.get.timeout.msec", 10 * 60000); // 10min</span>
<span class="source-line-no">312</span><span id="line-312"></span>
<span class="source-line-no">313</span><span id="line-313">    this.rpcCallerFactory = connection.getRpcRetryingCallerFactory();</span>
<span class="source-line-no">314</span><span id="line-314">    this.rpcControllerFactory = connection.getRpcControllerFactory();</span>
<span class="source-line-no">315</span><span id="line-315"></span>
<span class="source-line-no">316</span><span id="line-316">    this.ng = this.connection.getNonceGenerator();</span>
<span class="source-line-no">317</span><span id="line-317">  }</span>
<span class="source-line-no">318</span><span id="line-318"></span>
<span class="source-line-no">319</span><span id="line-319">  @Override</span>
<span class="source-line-no">320</span><span id="line-320">  public void abort(String why, Throwable e) {</span>
<span class="source-line-no">321</span><span id="line-321">    // Currently does nothing but throw the passed message and exception</span>
<span class="source-line-no">322</span><span id="line-322">    this.aborted = true;</span>
<span class="source-line-no">323</span><span id="line-323">    throw new RuntimeException(why, e);</span>
<span class="source-line-no">324</span><span id="line-324">  }</span>
<span class="source-line-no">325</span><span id="line-325"></span>
<span class="source-line-no">326</span><span id="line-326">  @Override</span>
<span class="source-line-no">327</span><span id="line-327">  public boolean isAborted() {</span>
<span class="source-line-no">328</span><span id="line-328">    return this.aborted;</span>
<span class="source-line-no">329</span><span id="line-329">  }</span>
<span class="source-line-no">330</span><span id="line-330"></span>
<span class="source-line-no">331</span><span id="line-331">  @Override</span>
<span class="source-line-no">332</span><span id="line-332">  public boolean abortProcedure(final long procId, final boolean mayInterruptIfRunning)</span>
<span class="source-line-no">333</span><span id="line-333">    throws IOException {</span>
<span class="source-line-no">334</span><span id="line-334">    return get(abortProcedureAsync(procId, mayInterruptIfRunning), this.syncWaitTimeout,</span>
<span class="source-line-no">335</span><span id="line-335">      TimeUnit.MILLISECONDS);</span>
<span class="source-line-no">336</span><span id="line-336">  }</span>
<span class="source-line-no">337</span><span id="line-337"></span>
<span class="source-line-no">338</span><span id="line-338">  @Override</span>
<span class="source-line-no">339</span><span id="line-339">  public Future&lt;Boolean&gt; abortProcedureAsync(final long procId, final boolean mayInterruptIfRunning)</span>
<span class="source-line-no">340</span><span id="line-340">    throws IOException {</span>
<span class="source-line-no">341</span><span id="line-341">    Boolean abortProcResponse = executeCallable(</span>
<span class="source-line-no">342</span><span id="line-342">      new MasterCallable&lt;AbortProcedureResponse&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">343</span><span id="line-343">        @Override</span>
<span class="source-line-no">344</span><span id="line-344">        protected AbortProcedureResponse rpcCall() throws Exception {</span>
<span class="source-line-no">345</span><span id="line-345">          AbortProcedureRequest abortProcRequest =</span>
<span class="source-line-no">346</span><span id="line-346">            AbortProcedureRequest.newBuilder().setProcId(procId).build();</span>
<span class="source-line-no">347</span><span id="line-347">          return master.abortProcedure(getRpcController(), abortProcRequest);</span>
<span class="source-line-no">348</span><span id="line-348">        }</span>
<span class="source-line-no">349</span><span id="line-349">      }).getIsProcedureAborted();</span>
<span class="source-line-no">350</span><span id="line-350">    return new AbortProcedureFuture(this, procId, abortProcResponse);</span>
<span class="source-line-no">351</span><span id="line-351">  }</span>
<span class="source-line-no">352</span><span id="line-352"></span>
<span class="source-line-no">353</span><span id="line-353">  @Override</span>
<span class="source-line-no">354</span><span id="line-354">  public List&lt;TableDescriptor&gt; listTableDescriptors() throws IOException {</span>
<span class="source-line-no">355</span><span id="line-355">    return listTableDescriptors((Pattern) null, false);</span>
<span class="source-line-no">356</span><span id="line-356">  }</span>
<span class="source-line-no">357</span><span id="line-357"></span>
<span class="source-line-no">358</span><span id="line-358">  @Override</span>
<span class="source-line-no">359</span><span id="line-359">  public List&lt;TableDescriptor&gt; listTableDescriptorsByState(boolean isEnabled) throws IOException {</span>
<span class="source-line-no">360</span><span id="line-360">    return executeCallable(</span>
<span class="source-line-no">361</span><span id="line-361">      new MasterCallable&lt;List&lt;TableDescriptor&gt;&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">362</span><span id="line-362">        @Override</span>
<span class="source-line-no">363</span><span id="line-363">        protected List&lt;TableDescriptor&gt; rpcCall() throws Exception {</span>
<span class="source-line-no">364</span><span id="line-364">          ListTableDescriptorsByStateResponse response =</span>
<span class="source-line-no">365</span><span id="line-365">            master.listTableDescriptorsByState(getRpcController(),</span>
<span class="source-line-no">366</span><span id="line-366">              ListTableDescriptorsByStateRequest.newBuilder().setIsEnabled(isEnabled).build());</span>
<span class="source-line-no">367</span><span id="line-367">          return ProtobufUtil.toTableDescriptorList(response);</span>
<span class="source-line-no">368</span><span id="line-368">        }</span>
<span class="source-line-no">369</span><span id="line-369">      });</span>
<span class="source-line-no">370</span><span id="line-370">  }</span>
<span class="source-line-no">371</span><span id="line-371"></span>
<span class="source-line-no">372</span><span id="line-372">  @Override</span>
<span class="source-line-no">373</span><span id="line-373">  public List&lt;TableDescriptor&gt; listTableDescriptors(Pattern pattern, boolean includeSysTables)</span>
<span class="source-line-no">374</span><span id="line-374">    throws IOException {</span>
<span class="source-line-no">375</span><span id="line-375">    return executeCallable(</span>
<span class="source-line-no">376</span><span id="line-376">      new MasterCallable&lt;List&lt;TableDescriptor&gt;&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">377</span><span id="line-377">        @Override</span>
<span class="source-line-no">378</span><span id="line-378">        protected List&lt;TableDescriptor&gt; rpcCall() throws Exception {</span>
<span class="source-line-no">379</span><span id="line-379">          GetTableDescriptorsRequest req =</span>
<span class="source-line-no">380</span><span id="line-380">            RequestConverter.buildGetTableDescriptorsRequest(pattern, includeSysTables);</span>
<span class="source-line-no">381</span><span id="line-381">          return ProtobufUtil</span>
<span class="source-line-no">382</span><span id="line-382">            .toTableDescriptorList(master.getTableDescriptors(getRpcController(), req));</span>
<span class="source-line-no">383</span><span id="line-383">        }</span>
<span class="source-line-no">384</span><span id="line-384">      });</span>
<span class="source-line-no">385</span><span id="line-385">  }</span>
<span class="source-line-no">386</span><span id="line-386"></span>
<span class="source-line-no">387</span><span id="line-387">  @Override</span>
<span class="source-line-no">388</span><span id="line-388">  public TableDescriptor getDescriptor(TableName tableName)</span>
<span class="source-line-no">389</span><span id="line-389">    throws TableNotFoundException, IOException {</span>
<span class="source-line-no">390</span><span id="line-390">    return getTableDescriptor(tableName, getConnection(), rpcCallerFactory, rpcControllerFactory,</span>
<span class="source-line-no">391</span><span id="line-391">      operationTimeout, rpcTimeout);</span>
<span class="source-line-no">392</span><span id="line-392">  }</span>
<span class="source-line-no">393</span><span id="line-393"></span>
<span class="source-line-no">394</span><span id="line-394">  @Override</span>
<span class="source-line-no">395</span><span id="line-395">  public Future&lt;Void&gt; modifyTableAsync(TableDescriptor td, boolean reopenRegions)</span>
<span class="source-line-no">396</span><span id="line-396">    throws IOException {</span>
<span class="source-line-no">397</span><span id="line-397">    ModifyTableResponse response = executeCallable(</span>
<span class="source-line-no">398</span><span id="line-398">      new MasterCallable&lt;ModifyTableResponse&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">399</span><span id="line-399">        long nonceGroup = ng.getNonceGroup();</span>
<span class="source-line-no">400</span><span id="line-400">        long nonce = ng.newNonce();</span>
<span class="source-line-no">401</span><span id="line-401"></span>
<span class="source-line-no">402</span><span id="line-402">        @Override</span>
<span class="source-line-no">403</span><span id="line-403">        protected ModifyTableResponse rpcCall() throws Exception {</span>
<span class="source-line-no">404</span><span id="line-404">          setPriority(td.getTableName());</span>
<span class="source-line-no">405</span><span id="line-405">          ModifyTableRequest request = RequestConverter.buildModifyTableRequest(td.getTableName(),</span>
<span class="source-line-no">406</span><span id="line-406">            td, nonceGroup, nonce, reopenRegions);</span>
<span class="source-line-no">407</span><span id="line-407">          return master.modifyTable(getRpcController(), request);</span>
<span class="source-line-no">408</span><span id="line-408">        }</span>
<span class="source-line-no">409</span><span id="line-409">      });</span>
<span class="source-line-no">410</span><span id="line-410">    return new ModifyTableFuture(this, td.getTableName(), response);</span>
<span class="source-line-no">411</span><span id="line-411">  }</span>
<span class="source-line-no">412</span><span id="line-412"></span>
<span class="source-line-no">413</span><span id="line-413">  @Override</span>
<span class="source-line-no">414</span><span id="line-414">  public Future&lt;Void&gt; modifyTableStoreFileTrackerAsync(TableName tableName, String dstSFT)</span>
<span class="source-line-no">415</span><span id="line-415">    throws IOException {</span>
<span class="source-line-no">416</span><span id="line-416">    ModifyTableStoreFileTrackerResponse response =</span>
<span class="source-line-no">417</span><span id="line-417">      executeCallable(new MasterCallable&lt;ModifyTableStoreFileTrackerResponse&gt;(getConnection(),</span>
<span class="source-line-no">418</span><span id="line-418">        getRpcControllerFactory()) {</span>
<span class="source-line-no">419</span><span id="line-419">        long nonceGroup = ng.getNonceGroup();</span>
<span class="source-line-no">420</span><span id="line-420">        long nonce = ng.newNonce();</span>
<span class="source-line-no">421</span><span id="line-421"></span>
<span class="source-line-no">422</span><span id="line-422">        @Override</span>
<span class="source-line-no">423</span><span id="line-423">        protected ModifyTableStoreFileTrackerResponse rpcCall() throws Exception {</span>
<span class="source-line-no">424</span><span id="line-424">          setPriority(tableName);</span>
<span class="source-line-no">425</span><span id="line-425">          ModifyTableStoreFileTrackerRequest request = RequestConverter</span>
<span class="source-line-no">426</span><span id="line-426">            .buildModifyTableStoreFileTrackerRequest(tableName, dstSFT, nonceGroup, nonce);</span>
<span class="source-line-no">427</span><span id="line-427">          return master.modifyTableStoreFileTracker(getRpcController(), request);</span>
<span class="source-line-no">428</span><span id="line-428">        }</span>
<span class="source-line-no">429</span><span id="line-429">      });</span>
<span class="source-line-no">430</span><span id="line-430">    return new ModifyTablerStoreFileTrackerFuture(this, tableName, response);</span>
<span class="source-line-no">431</span><span id="line-431">  }</span>
<span class="source-line-no">432</span><span id="line-432"></span>
<span class="source-line-no">433</span><span id="line-433">  private static class ModifyTablerStoreFileTrackerFuture extends ModifyTableFuture {</span>
<span class="source-line-no">434</span><span id="line-434">    public ModifyTablerStoreFileTrackerFuture(HBaseAdmin admin, TableName tableName,</span>
<span class="source-line-no">435</span><span id="line-435">      ModifyTableStoreFileTrackerResponse response) {</span>
<span class="source-line-no">436</span><span id="line-436">      super(admin, tableName,</span>
<span class="source-line-no">437</span><span id="line-437">        (response != null &amp;&amp; response.hasProcId()) ? response.getProcId() : null);</span>
<span class="source-line-no">438</span><span id="line-438">    }</span>
<span class="source-line-no">439</span><span id="line-439"></span>
<span class="source-line-no">440</span><span id="line-440">    @Override</span>
<span class="source-line-no">441</span><span id="line-441">    public String getOperationType() {</span>
<span class="source-line-no">442</span><span id="line-442">      return "MODIFY_TABLE_STORE_FILE_TRACKER";</span>
<span class="source-line-no">443</span><span id="line-443">    }</span>
<span class="source-line-no">444</span><span id="line-444">  }</span>
<span class="source-line-no">445</span><span id="line-445"></span>
<span class="source-line-no">446</span><span id="line-446">  @Override</span>
<span class="source-line-no">447</span><span id="line-447">  public List&lt;TableDescriptor&gt; listTableDescriptorsByNamespace(byte[] name) throws IOException {</span>
<span class="source-line-no">448</span><span id="line-448">    return executeCallable(</span>
<span class="source-line-no">449</span><span id="line-449">      new MasterCallable&lt;List&lt;TableDescriptor&gt;&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">450</span><span id="line-450">        @Override</span>
<span class="source-line-no">451</span><span id="line-451">        protected List&lt;TableDescriptor&gt; rpcCall() throws Exception {</span>
<span class="source-line-no">452</span><span id="line-452">          return master</span>
<span class="source-line-no">453</span><span id="line-453">            .listTableDescriptorsByNamespace(getRpcController(),</span>
<span class="source-line-no">454</span><span id="line-454">              ListTableDescriptorsByNamespaceRequest.newBuilder()</span>
<span class="source-line-no">455</span><span id="line-455">                .setNamespaceName(Bytes.toString(name)).build())</span>
<span class="source-line-no">456</span><span id="line-456">            .getTableSchemaList().stream().map(ProtobufUtil::toTableDescriptor)</span>
<span class="source-line-no">457</span><span id="line-457">            .collect(Collectors.toList());</span>
<span class="source-line-no">458</span><span id="line-458">        }</span>
<span class="source-line-no">459</span><span id="line-459">      });</span>
<span class="source-line-no">460</span><span id="line-460">  }</span>
<span class="source-line-no">461</span><span id="line-461"></span>
<span class="source-line-no">462</span><span id="line-462">  @Override</span>
<span class="source-line-no">463</span><span id="line-463">  public List&lt;TableDescriptor&gt; listTableDescriptors(List&lt;TableName&gt; tableNames) throws IOException {</span>
<span class="source-line-no">464</span><span id="line-464">    return executeCallable(</span>
<span class="source-line-no">465</span><span id="line-465">      new MasterCallable&lt;List&lt;TableDescriptor&gt;&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">466</span><span id="line-466">        @Override</span>
<span class="source-line-no">467</span><span id="line-467">        protected List&lt;TableDescriptor&gt; rpcCall() throws Exception {</span>
<span class="source-line-no">468</span><span id="line-468">          GetTableDescriptorsRequest req =</span>
<span class="source-line-no">469</span><span id="line-469">            RequestConverter.buildGetTableDescriptorsRequest(tableNames);</span>
<span class="source-line-no">470</span><span id="line-470">          return ProtobufUtil</span>
<span class="source-line-no">471</span><span id="line-471">            .toTableDescriptorList(master.getTableDescriptors(getRpcController(), req));</span>
<span class="source-line-no">472</span><span id="line-472">        }</span>
<span class="source-line-no">473</span><span id="line-473">      });</span>
<span class="source-line-no">474</span><span id="line-474">  }</span>
<span class="source-line-no">475</span><span id="line-475"></span>
<span class="source-line-no">476</span><span id="line-476">  @Override</span>
<span class="source-line-no">477</span><span id="line-477">  public List&lt;RegionInfo&gt; getRegions(final ServerName sn) throws IOException {</span>
<span class="source-line-no">478</span><span id="line-478">    AdminService.BlockingInterface admin = this.connection.getAdmin(sn);</span>
<span class="source-line-no">479</span><span id="line-479">    // TODO: There is no timeout on this controller. Set one!</span>
<span class="source-line-no">480</span><span id="line-480">    HBaseRpcController controller = rpcControllerFactory.newController();</span>
<span class="source-line-no">481</span><span id="line-481">    return ProtobufUtil.getOnlineRegions(controller, admin);</span>
<span class="source-line-no">482</span><span id="line-482">  }</span>
<span class="source-line-no">483</span><span id="line-483"></span>
<span class="source-line-no">484</span><span id="line-484">  @Override</span>
<span class="source-line-no">485</span><span id="line-485">  public List&lt;RegionInfo&gt; getRegions(TableName tableName) throws IOException {</span>
<span class="source-line-no">486</span><span id="line-486">    if (TableName.isMetaTableName(tableName)) {</span>
<span class="source-line-no">487</span><span id="line-487">      return Arrays.asList(RegionInfoBuilder.FIRST_META_REGIONINFO);</span>
<span class="source-line-no">488</span><span id="line-488">    } else {</span>
<span class="source-line-no">489</span><span id="line-489">      return MetaTableAccessor.getTableRegions(connection, tableName, true);</span>
<span class="source-line-no">490</span><span id="line-490">    }</span>
<span class="source-line-no">491</span><span id="line-491">  }</span>
<span class="source-line-no">492</span><span id="line-492"></span>
<span class="source-line-no">493</span><span id="line-493">  private static class AbortProcedureFuture extends ProcedureFuture&lt;Boolean&gt; {</span>
<span class="source-line-no">494</span><span id="line-494">    private boolean isAbortInProgress;</span>
<span class="source-line-no">495</span><span id="line-495"></span>
<span class="source-line-no">496</span><span id="line-496">    public AbortProcedureFuture(final HBaseAdmin admin, final Long procId,</span>
<span class="source-line-no">497</span><span id="line-497">      final Boolean abortProcResponse) {</span>
<span class="source-line-no">498</span><span id="line-498">      super(admin, procId);</span>
<span class="source-line-no">499</span><span id="line-499">      this.isAbortInProgress = abortProcResponse;</span>
<span class="source-line-no">500</span><span id="line-500">    }</span>
<span class="source-line-no">501</span><span id="line-501"></span>
<span class="source-line-no">502</span><span id="line-502">    @Override</span>
<span class="source-line-no">503</span><span id="line-503">    public Boolean get(long timeout, TimeUnit unit)</span>
<span class="source-line-no">504</span><span id="line-504">      throws InterruptedException, ExecutionException, TimeoutException {</span>
<span class="source-line-no">505</span><span id="line-505">      if (!this.isAbortInProgress) {</span>
<span class="source-line-no">506</span><span id="line-506">        return false;</span>
<span class="source-line-no">507</span><span id="line-507">      }</span>
<span class="source-line-no">508</span><span id="line-508">      super.get(timeout, unit);</span>
<span class="source-line-no">509</span><span id="line-509">      return true;</span>
<span class="source-line-no">510</span><span id="line-510">    }</span>
<span class="source-line-no">511</span><span id="line-511">  }</span>
<span class="source-line-no">512</span><span id="line-512"></span>
<span class="source-line-no">513</span><span id="line-513">  /** Returns Connection used by this object. */</span>
<span class="source-line-no">514</span><span id="line-514">  @Override</span>
<span class="source-line-no">515</span><span id="line-515">  public Connection getConnection() {</span>
<span class="source-line-no">516</span><span id="line-516">    return connection;</span>
<span class="source-line-no">517</span><span id="line-517">  }</span>
<span class="source-line-no">518</span><span id="line-518"></span>
<span class="source-line-no">519</span><span id="line-519">  @Override</span>
<span class="source-line-no">520</span><span id="line-520">  public boolean tableExists(final TableName tableName) throws IOException {</span>
<span class="source-line-no">521</span><span id="line-521">    return executeCallable(new RpcRetryingCallable&lt;Boolean&gt;() {</span>
<span class="source-line-no">522</span><span id="line-522">      @Override</span>
<span class="source-line-no">523</span><span id="line-523">      protected Boolean rpcCall(int callTimeout) throws Exception {</span>
<span class="source-line-no">524</span><span id="line-524">        return MetaTableAccessor.getTableState(getConnection(), tableName) != null;</span>
<span class="source-line-no">525</span><span id="line-525">      }</span>
<span class="source-line-no">526</span><span id="line-526">    });</span>
<span class="source-line-no">527</span><span id="line-527">  }</span>
<span class="source-line-no">528</span><span id="line-528"></span>
<span class="source-line-no">529</span><span id="line-529">  @Override</span>
<span class="source-line-no">530</span><span id="line-530">  public HTableDescriptor[] listTables() throws IOException {</span>
<span class="source-line-no">531</span><span id="line-531">    return listTables((Pattern) null, false);</span>
<span class="source-line-no">532</span><span id="line-532">  }</span>
<span class="source-line-no">533</span><span id="line-533"></span>
<span class="source-line-no">534</span><span id="line-534">  @Override</span>
<span class="source-line-no">535</span><span id="line-535">  public HTableDescriptor[] listTables(Pattern pattern) throws IOException {</span>
<span class="source-line-no">536</span><span id="line-536">    return listTables(pattern, false);</span>
<span class="source-line-no">537</span><span id="line-537">  }</span>
<span class="source-line-no">538</span><span id="line-538"></span>
<span class="source-line-no">539</span><span id="line-539">  @Override</span>
<span class="source-line-no">540</span><span id="line-540">  public HTableDescriptor[] listTables(String regex) throws IOException {</span>
<span class="source-line-no">541</span><span id="line-541">    return listTables(Pattern.compile(regex), false);</span>
<span class="source-line-no">542</span><span id="line-542">  }</span>
<span class="source-line-no">543</span><span id="line-543"></span>
<span class="source-line-no">544</span><span id="line-544">  @Override</span>
<span class="source-line-no">545</span><span id="line-545">  public HTableDescriptor[] listTables(final Pattern pattern, final boolean includeSysTables)</span>
<span class="source-line-no">546</span><span id="line-546">    throws IOException {</span>
<span class="source-line-no">547</span><span id="line-547">    return executeCallable(</span>
<span class="source-line-no">548</span><span id="line-548">      new MasterCallable&lt;HTableDescriptor[]&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">549</span><span id="line-549">        @Override</span>
<span class="source-line-no">550</span><span id="line-550">        protected HTableDescriptor[] rpcCall() throws Exception {</span>
<span class="source-line-no">551</span><span id="line-551">          GetTableDescriptorsRequest req =</span>
<span class="source-line-no">552</span><span id="line-552">            RequestConverter.buildGetTableDescriptorsRequest(pattern, includeSysTables);</span>
<span class="source-line-no">553</span><span id="line-553">          return ProtobufUtil</span>
<span class="source-line-no">554</span><span id="line-554">            .toTableDescriptorList(master.getTableDescriptors(getRpcController(), req)).stream()</span>
<span class="source-line-no">555</span><span id="line-555">            .map(ImmutableHTableDescriptor::new).toArray(HTableDescriptor[]::new);</span>
<span class="source-line-no">556</span><span id="line-556">        }</span>
<span class="source-line-no">557</span><span id="line-557">      });</span>
<span class="source-line-no">558</span><span id="line-558">  }</span>
<span class="source-line-no">559</span><span id="line-559"></span>
<span class="source-line-no">560</span><span id="line-560">  @Override</span>
<span class="source-line-no">561</span><span id="line-561">  public HTableDescriptor[] listTables(String regex, boolean includeSysTables) throws IOException {</span>
<span class="source-line-no">562</span><span id="line-562">    return listTables(Pattern.compile(regex), includeSysTables);</span>
<span class="source-line-no">563</span><span id="line-563">  }</span>
<span class="source-line-no">564</span><span id="line-564"></span>
<span class="source-line-no">565</span><span id="line-565">  @Override</span>
<span class="source-line-no">566</span><span id="line-566">  public TableName[] listTableNames() throws IOException {</span>
<span class="source-line-no">567</span><span id="line-567">    return listTableNames((Pattern) null, false);</span>
<span class="source-line-no">568</span><span id="line-568">  }</span>
<span class="source-line-no">569</span><span id="line-569"></span>
<span class="source-line-no">570</span><span id="line-570">  @Override</span>
<span class="source-line-no">571</span><span id="line-571">  public TableName[] listTableNames(String regex) throws IOException {</span>
<span class="source-line-no">572</span><span id="line-572">    return listTableNames(Pattern.compile(regex), false);</span>
<span class="source-line-no">573</span><span id="line-573">  }</span>
<span class="source-line-no">574</span><span id="line-574"></span>
<span class="source-line-no">575</span><span id="line-575">  @Override</span>
<span class="source-line-no">576</span><span id="line-576">  public TableName[] listTableNames(final Pattern pattern, final boolean includeSysTables)</span>
<span class="source-line-no">577</span><span id="line-577">    throws IOException {</span>
<span class="source-line-no">578</span><span id="line-578">    return executeCallable(</span>
<span class="source-line-no">579</span><span id="line-579">      new MasterCallable&lt;TableName[]&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">580</span><span id="line-580">        @Override</span>
<span class="source-line-no">581</span><span id="line-581">        protected TableName[] rpcCall() throws Exception {</span>
<span class="source-line-no">582</span><span id="line-582">          GetTableNamesRequest req =</span>
<span class="source-line-no">583</span><span id="line-583">            RequestConverter.buildGetTableNamesRequest(pattern, includeSysTables);</span>
<span class="source-line-no">584</span><span id="line-584">          return ProtobufUtil</span>
<span class="source-line-no">585</span><span id="line-585">            .getTableNameArray(master.getTableNames(getRpcController(), req).getTableNamesList());</span>
<span class="source-line-no">586</span><span id="line-586">        }</span>
<span class="source-line-no">587</span><span id="line-587">      });</span>
<span class="source-line-no">588</span><span id="line-588">  }</span>
<span class="source-line-no">589</span><span id="line-589"></span>
<span class="source-line-no">590</span><span id="line-590">  @Override</span>
<span class="source-line-no">591</span><span id="line-591">  public TableName[] listTableNames(final String regex, final boolean includeSysTables)</span>
<span class="source-line-no">592</span><span id="line-592">    throws IOException {</span>
<span class="source-line-no">593</span><span id="line-593">    return listTableNames(Pattern.compile(regex), includeSysTables);</span>
<span class="source-line-no">594</span><span id="line-594">  }</span>
<span class="source-line-no">595</span><span id="line-595"></span>
<span class="source-line-no">596</span><span id="line-596">  @Override</span>
<span class="source-line-no">597</span><span id="line-597">  public List&lt;TableName&gt; listTableNamesByState(boolean isEnabled) throws IOException {</span>
<span class="source-line-no">598</span><span id="line-598">    return executeCallable(</span>
<span class="source-line-no">599</span><span id="line-599">      new MasterCallable&lt;List&lt;TableName&gt;&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">600</span><span id="line-600">        @Override</span>
<span class="source-line-no">601</span><span id="line-601">        protected List&lt;TableName&gt; rpcCall() throws Exception {</span>
<span class="source-line-no">602</span><span id="line-602">          ListTableNamesByStateResponse response = master.listTableNamesByState(getRpcController(),</span>
<span class="source-line-no">603</span><span id="line-603">            ListTableNamesByStateRequest.newBuilder().setIsEnabled(isEnabled).build());</span>
<span class="source-line-no">604</span><span id="line-604">          return ProtobufUtil.toTableNameList(response.getTableNamesList());</span>
<span class="source-line-no">605</span><span id="line-605">        }</span>
<span class="source-line-no">606</span><span id="line-606">      });</span>
<span class="source-line-no">607</span><span id="line-607">  }</span>
<span class="source-line-no">608</span><span id="line-608"></span>
<span class="source-line-no">609</span><span id="line-609">  @Override</span>
<span class="source-line-no">610</span><span id="line-610">  public HTableDescriptor getTableDescriptor(final TableName tableName) throws IOException {</span>
<span class="source-line-no">611</span><span id="line-611">    return getHTableDescriptor(tableName, getConnection(), rpcCallerFactory, rpcControllerFactory,</span>
<span class="source-line-no">612</span><span id="line-612">      operationTimeout, rpcTimeout);</span>
<span class="source-line-no">613</span><span id="line-613">  }</span>
<span class="source-line-no">614</span><span id="line-614"></span>
<span class="source-line-no">615</span><span id="line-615">  static TableDescriptor getTableDescriptor(final TableName tableName, Connection connection,</span>
<span class="source-line-no">616</span><span id="line-616">    RpcRetryingCallerFactory rpcCallerFactory, final RpcControllerFactory rpcControllerFactory,</span>
<span class="source-line-no">617</span><span id="line-617">    int operationTimeout, int rpcTimeout) throws IOException {</span>
<span class="source-line-no">618</span><span id="line-618">    if (tableName == null) return null;</span>
<span class="source-line-no">619</span><span id="line-619">    TableDescriptor td =</span>
<span class="source-line-no">620</span><span id="line-620">      executeCallable(new MasterCallable&lt;TableDescriptor&gt;(connection, rpcControllerFactory) {</span>
<span class="source-line-no">621</span><span id="line-621">        @Override</span>
<span class="source-line-no">622</span><span id="line-622">        protected TableDescriptor rpcCall() throws Exception {</span>
<span class="source-line-no">623</span><span id="line-623">          GetTableDescriptorsRequest req =</span>
<span class="source-line-no">624</span><span id="line-624">            RequestConverter.buildGetTableDescriptorsRequest(tableName);</span>
<span class="source-line-no">625</span><span id="line-625">          GetTableDescriptorsResponse htds = master.getTableDescriptors(getRpcController(), req);</span>
<span class="source-line-no">626</span><span id="line-626">          if (!htds.getTableSchemaList().isEmpty()) {</span>
<span class="source-line-no">627</span><span id="line-627">            return ProtobufUtil.toTableDescriptor(htds.getTableSchemaList().get(0));</span>
<span class="source-line-no">628</span><span id="line-628">          }</span>
<span class="source-line-no">629</span><span id="line-629">          return null;</span>
<span class="source-line-no">630</span><span id="line-630">        }</span>
<span class="source-line-no">631</span><span id="line-631">      }, rpcCallerFactory, operationTimeout, rpcTimeout);</span>
<span class="source-line-no">632</span><span id="line-632">    if (td != null) {</span>
<span class="source-line-no">633</span><span id="line-633">      return td;</span>
<span class="source-line-no">634</span><span id="line-634">    }</span>
<span class="source-line-no">635</span><span id="line-635">    throw new TableNotFoundException(tableName.getNameAsString());</span>
<span class="source-line-no">636</span><span id="line-636">  }</span>
<span class="source-line-no">637</span><span id="line-637"></span>
<span class="source-line-no">638</span><span id="line-638">  /**</span>
<span class="source-line-no">639</span><span id="line-639">   * @deprecated since 2.0 version and will be removed in 3.0 version. use</span>
<span class="source-line-no">640</span><span id="line-640">   *             {@link #getTableDescriptor(TableName, Connection, RpcRetryingCallerFactory,RpcControllerFactory,int,int)}</span>
<span class="source-line-no">641</span><span id="line-641">   */</span>
<span class="source-line-no">642</span><span id="line-642">  @Deprecated</span>
<span class="source-line-no">643</span><span id="line-643">  static HTableDescriptor getHTableDescriptor(final TableName tableName, Connection connection,</span>
<span class="source-line-no">644</span><span id="line-644">    RpcRetryingCallerFactory rpcCallerFactory, final RpcControllerFactory rpcControllerFactory,</span>
<span class="source-line-no">645</span><span id="line-645">    int operationTimeout, int rpcTimeout) throws IOException {</span>
<span class="source-line-no">646</span><span id="line-646">    if (tableName == null) {</span>
<span class="source-line-no">647</span><span id="line-647">      return null;</span>
<span class="source-line-no">648</span><span id="line-648">    }</span>
<span class="source-line-no">649</span><span id="line-649">    HTableDescriptor htd =</span>
<span class="source-line-no">650</span><span id="line-650">      executeCallable(new MasterCallable&lt;HTableDescriptor&gt;(connection, rpcControllerFactory) {</span>
<span class="source-line-no">651</span><span id="line-651">        @Override</span>
<span class="source-line-no">652</span><span id="line-652">        protected HTableDescriptor rpcCall() throws Exception {</span>
<span class="source-line-no">653</span><span id="line-653">          GetTableDescriptorsRequest req =</span>
<span class="source-line-no">654</span><span id="line-654">            RequestConverter.buildGetTableDescriptorsRequest(tableName);</span>
<span class="source-line-no">655</span><span id="line-655">          GetTableDescriptorsResponse htds = master.getTableDescriptors(getRpcController(), req);</span>
<span class="source-line-no">656</span><span id="line-656">          if (!htds.getTableSchemaList().isEmpty()) {</span>
<span class="source-line-no">657</span><span id="line-657">            return new ImmutableHTableDescriptor(</span>
<span class="source-line-no">658</span><span id="line-658">              ProtobufUtil.toTableDescriptor(htds.getTableSchemaList().get(0)));</span>
<span class="source-line-no">659</span><span id="line-659">          }</span>
<span class="source-line-no">660</span><span id="line-660">          return null;</span>
<span class="source-line-no">661</span><span id="line-661">        }</span>
<span class="source-line-no">662</span><span id="line-662">      }, rpcCallerFactory, operationTimeout, rpcTimeout);</span>
<span class="source-line-no">663</span><span id="line-663">    if (htd != null) {</span>
<span class="source-line-no">664</span><span id="line-664">      return new ImmutableHTableDescriptor(htd);</span>
<span class="source-line-no">665</span><span id="line-665">    }</span>
<span class="source-line-no">666</span><span id="line-666">    throw new TableNotFoundException(tableName.getNameAsString());</span>
<span class="source-line-no">667</span><span id="line-667">  }</span>
<span class="source-line-no">668</span><span id="line-668"></span>
<span class="source-line-no">669</span><span id="line-669">  private long getPauseTime(int tries) {</span>
<span class="source-line-no">670</span><span id="line-670">    int triesCount = tries;</span>
<span class="source-line-no">671</span><span id="line-671">    if (triesCount &gt;= HConstants.RETRY_BACKOFF.length) {</span>
<span class="source-line-no">672</span><span id="line-672">      triesCount = HConstants.RETRY_BACKOFF.length - 1;</span>
<span class="source-line-no">673</span><span id="line-673">    }</span>
<span class="source-line-no">674</span><span id="line-674">    return this.pause * HConstants.RETRY_BACKOFF[triesCount];</span>
<span class="source-line-no">675</span><span id="line-675">  }</span>
<span class="source-line-no">676</span><span id="line-676"></span>
<span class="source-line-no">677</span><span id="line-677">  @Override</span>
<span class="source-line-no">678</span><span id="line-678">  public void createTable(TableDescriptor desc, byte[] startKey, byte[] endKey, int numRegions)</span>
<span class="source-line-no">679</span><span id="line-679">    throws IOException {</span>
<span class="source-line-no">680</span><span id="line-680">    if (numRegions &lt; 3) {</span>
<span class="source-line-no">681</span><span id="line-681">      throw new IllegalArgumentException("Must create at least three regions");</span>
<span class="source-line-no">682</span><span id="line-682">    } else if (Bytes.compareTo(startKey, endKey) &gt;= 0) {</span>
<span class="source-line-no">683</span><span id="line-683">      throw new IllegalArgumentException("Start key must be smaller than end key");</span>
<span class="source-line-no">684</span><span id="line-684">    }</span>
<span class="source-line-no">685</span><span id="line-685">    if (numRegions == 3) {</span>
<span class="source-line-no">686</span><span id="line-686">      createTable(desc, new byte[][] { startKey, endKey });</span>
<span class="source-line-no">687</span><span id="line-687">      return;</span>
<span class="source-line-no">688</span><span id="line-688">    }</span>
<span class="source-line-no">689</span><span id="line-689">    byte[][] splitKeys = Bytes.split(startKey, endKey, numRegions - 3);</span>
<span class="source-line-no">690</span><span id="line-690">    if (splitKeys == null || splitKeys.length != numRegions - 1) {</span>
<span class="source-line-no">691</span><span id="line-691">      throw new IllegalArgumentException("Unable to split key range into enough regions");</span>
<span class="source-line-no">692</span><span id="line-692">    }</span>
<span class="source-line-no">693</span><span id="line-693">    createTable(desc, splitKeys);</span>
<span class="source-line-no">694</span><span id="line-694">  }</span>
<span class="source-line-no">695</span><span id="line-695"></span>
<span class="source-line-no">696</span><span id="line-696">  @Override</span>
<span class="source-line-no">697</span><span id="line-697">  public Future&lt;Void&gt; createTableAsync(final TableDescriptor desc, final byte[][] splitKeys)</span>
<span class="source-line-no">698</span><span id="line-698">    throws IOException {</span>
<span class="source-line-no">699</span><span id="line-699">    if (desc.getTableName() == null) {</span>
<span class="source-line-no">700</span><span id="line-700">      throw new IllegalArgumentException("TableName cannot be null");</span>
<span class="source-line-no">701</span><span id="line-701">    }</span>
<span class="source-line-no">702</span><span id="line-702">    if (splitKeys != null &amp;&amp; splitKeys.length &gt; 0) {</span>
<span class="source-line-no">703</span><span id="line-703">      Arrays.sort(splitKeys, Bytes.BYTES_COMPARATOR);</span>
<span class="source-line-no">704</span><span id="line-704">      // Verify there are no duplicate split keys</span>
<span class="source-line-no">705</span><span id="line-705">      byte[] lastKey = null;</span>
<span class="source-line-no">706</span><span id="line-706">      for (byte[] splitKey : splitKeys) {</span>
<span class="source-line-no">707</span><span id="line-707">        if (Bytes.compareTo(splitKey, HConstants.EMPTY_BYTE_ARRAY) == 0) {</span>
<span class="source-line-no">708</span><span id="line-708">          throw new IllegalArgumentException(</span>
<span class="source-line-no">709</span><span id="line-709">            "Empty split key must not be passed in the split keys.");</span>
<span class="source-line-no">710</span><span id="line-710">        }</span>
<span class="source-line-no">711</span><span id="line-711">        if (lastKey != null &amp;&amp; Bytes.equals(splitKey, lastKey)) {</span>
<span class="source-line-no">712</span><span id="line-712">          throw new IllegalArgumentException("All split keys must be unique, " + "found duplicate: "</span>
<span class="source-line-no">713</span><span id="line-713">            + Bytes.toStringBinary(splitKey) + ", " + Bytes.toStringBinary(lastKey));</span>
<span class="source-line-no">714</span><span id="line-714">        }</span>
<span class="source-line-no">715</span><span id="line-715">        lastKey = splitKey;</span>
<span class="source-line-no">716</span><span id="line-716">      }</span>
<span class="source-line-no">717</span><span id="line-717">    }</span>
<span class="source-line-no">718</span><span id="line-718"></span>
<span class="source-line-no">719</span><span id="line-719">    CreateTableResponse response = executeCallable(</span>
<span class="source-line-no">720</span><span id="line-720">      new MasterCallable&lt;CreateTableResponse&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">721</span><span id="line-721">        Long nonceGroup = ng.getNonceGroup();</span>
<span class="source-line-no">722</span><span id="line-722">        Long nonce = ng.newNonce();</span>
<span class="source-line-no">723</span><span id="line-723"></span>
<span class="source-line-no">724</span><span id="line-724">        @Override</span>
<span class="source-line-no">725</span><span id="line-725">        protected CreateTableResponse rpcCall() throws Exception {</span>
<span class="source-line-no">726</span><span id="line-726">          setPriority(desc.getTableName());</span>
<span class="source-line-no">727</span><span id="line-727">          CreateTableRequest request =</span>
<span class="source-line-no">728</span><span id="line-728">            RequestConverter.buildCreateTableRequest(desc, splitKeys, nonceGroup, nonce);</span>
<span class="source-line-no">729</span><span id="line-729">          return master.createTable(getRpcController(), request);</span>
<span class="source-line-no">730</span><span id="line-730">        }</span>
<span class="source-line-no">731</span><span id="line-731">      });</span>
<span class="source-line-no">732</span><span id="line-732">    return new CreateTableFuture(this, desc, splitKeys, response);</span>
<span class="source-line-no">733</span><span id="line-733">  }</span>
<span class="source-line-no">734</span><span id="line-734"></span>
<span class="source-line-no">735</span><span id="line-735">  private static class CreateTableFuture extends TableFuture&lt;Void&gt; {</span>
<span class="source-line-no">736</span><span id="line-736">    private final TableDescriptor desc;</span>
<span class="source-line-no">737</span><span id="line-737">    private final byte[][] splitKeys;</span>
<span class="source-line-no">738</span><span id="line-738"></span>
<span class="source-line-no">739</span><span id="line-739">    public CreateTableFuture(final HBaseAdmin admin, final TableDescriptor desc,</span>
<span class="source-line-no">740</span><span id="line-740">      final byte[][] splitKeys, final CreateTableResponse response) {</span>
<span class="source-line-no">741</span><span id="line-741">      super(admin, desc.getTableName(),</span>
<span class="source-line-no">742</span><span id="line-742">        (response != null &amp;&amp; response.hasProcId()) ? response.getProcId() : null);</span>
<span class="source-line-no">743</span><span id="line-743">      this.splitKeys = splitKeys;</span>
<span class="source-line-no">744</span><span id="line-744">      this.desc = desc;</span>
<span class="source-line-no">745</span><span id="line-745">    }</span>
<span class="source-line-no">746</span><span id="line-746"></span>
<span class="source-line-no">747</span><span id="line-747">    @Override</span>
<span class="source-line-no">748</span><span id="line-748">    protected TableDescriptor getTableDescriptor() {</span>
<span class="source-line-no">749</span><span id="line-749">      return desc;</span>
<span class="source-line-no">750</span><span id="line-750">    }</span>
<span class="source-line-no">751</span><span id="line-751"></span>
<span class="source-line-no">752</span><span id="line-752">    @Override</span>
<span class="source-line-no">753</span><span id="line-753">    public String getOperationType() {</span>
<span class="source-line-no">754</span><span id="line-754">      return "CREATE";</span>
<span class="source-line-no">755</span><span id="line-755">    }</span>
<span class="source-line-no">756</span><span id="line-756"></span>
<span class="source-line-no">757</span><span id="line-757">    @Override</span>
<span class="source-line-no">758</span><span id="line-758">    protected Void waitOperationResult(final long deadlineTs) throws IOException, TimeoutException {</span>
<span class="source-line-no">759</span><span id="line-759">      waitForTableEnabled(deadlineTs);</span>
<span class="source-line-no">760</span><span id="line-760">      waitForAllRegionsOnline(deadlineTs, splitKeys);</span>
<span class="source-line-no">761</span><span id="line-761">      return null;</span>
<span class="source-line-no">762</span><span id="line-762">    }</span>
<span class="source-line-no">763</span><span id="line-763">  }</span>
<span class="source-line-no">764</span><span id="line-764"></span>
<span class="source-line-no">765</span><span id="line-765">  @Override</span>
<span class="source-line-no">766</span><span id="line-766">  public Future&lt;Void&gt; deleteTableAsync(final TableName tableName) throws IOException {</span>
<span class="source-line-no">767</span><span id="line-767">    DeleteTableResponse response = executeCallable(</span>
<span class="source-line-no">768</span><span id="line-768">      new MasterCallable&lt;DeleteTableResponse&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">769</span><span id="line-769">        Long nonceGroup = ng.getNonceGroup();</span>
<span class="source-line-no">770</span><span id="line-770">        Long nonce = ng.newNonce();</span>
<span class="source-line-no">771</span><span id="line-771"></span>
<span class="source-line-no">772</span><span id="line-772">        @Override</span>
<span class="source-line-no">773</span><span id="line-773">        protected DeleteTableResponse rpcCall() throws Exception {</span>
<span class="source-line-no">774</span><span id="line-774">          setPriority(tableName);</span>
<span class="source-line-no">775</span><span id="line-775">          DeleteTableRequest req =</span>
<span class="source-line-no">776</span><span id="line-776">            RequestConverter.buildDeleteTableRequest(tableName, nonceGroup, nonce);</span>
<span class="source-line-no">777</span><span id="line-777">          return master.deleteTable(getRpcController(), req);</span>
<span class="source-line-no">778</span><span id="line-778">        }</span>
<span class="source-line-no">779</span><span id="line-779">      });</span>
<span class="source-line-no">780</span><span id="line-780">    return new DeleteTableFuture(this, tableName, response);</span>
<span class="source-line-no">781</span><span id="line-781">  }</span>
<span class="source-line-no">782</span><span id="line-782"></span>
<span class="source-line-no">783</span><span id="line-783">  private static class DeleteTableFuture extends TableFuture&lt;Void&gt; {</span>
<span class="source-line-no">784</span><span id="line-784">    public DeleteTableFuture(final HBaseAdmin admin, final TableName tableName,</span>
<span class="source-line-no">785</span><span id="line-785">      final DeleteTableResponse response) {</span>
<span class="source-line-no">786</span><span id="line-786">      super(admin, tableName,</span>
<span class="source-line-no">787</span><span id="line-787">        (response != null &amp;&amp; response.hasProcId()) ? response.getProcId() : null);</span>
<span class="source-line-no">788</span><span id="line-788">    }</span>
<span class="source-line-no">789</span><span id="line-789"></span>
<span class="source-line-no">790</span><span id="line-790">    @Override</span>
<span class="source-line-no">791</span><span id="line-791">    public String getOperationType() {</span>
<span class="source-line-no">792</span><span id="line-792">      return "DELETE";</span>
<span class="source-line-no">793</span><span id="line-793">    }</span>
<span class="source-line-no">794</span><span id="line-794"></span>
<span class="source-line-no">795</span><span id="line-795">    @Override</span>
<span class="source-line-no">796</span><span id="line-796">    protected Void waitOperationResult(final long deadlineTs) throws IOException, TimeoutException {</span>
<span class="source-line-no">797</span><span id="line-797">      waitTableNotFound(deadlineTs);</span>
<span class="source-line-no">798</span><span id="line-798">      return null;</span>
<span class="source-line-no">799</span><span id="line-799">    }</span>
<span class="source-line-no">800</span><span id="line-800"></span>
<span class="source-line-no">801</span><span id="line-801">    @Override</span>
<span class="source-line-no">802</span><span id="line-802">    protected Void postOperationResult(final Void result, final long deadlineTs)</span>
<span class="source-line-no">803</span><span id="line-803">      throws IOException, TimeoutException {</span>
<span class="source-line-no">804</span><span id="line-804">      // Delete cached information to prevent clients from using old locations</span>
<span class="source-line-no">805</span><span id="line-805">      ((ClusterConnection) getAdmin().getConnection()).clearRegionCache(getTableName());</span>
<span class="source-line-no">806</span><span id="line-806">      return super.postOperationResult(result, deadlineTs);</span>
<span class="source-line-no">807</span><span id="line-807">    }</span>
<span class="source-line-no">808</span><span id="line-808">  }</span>
<span class="source-line-no">809</span><span id="line-809"></span>
<span class="source-line-no">810</span><span id="line-810">  @Override</span>
<span class="source-line-no">811</span><span id="line-811">  public HTableDescriptor[] deleteTables(String regex) throws IOException {</span>
<span class="source-line-no">812</span><span id="line-812">    return deleteTables(Pattern.compile(regex));</span>
<span class="source-line-no">813</span><span id="line-813">  }</span>
<span class="source-line-no">814</span><span id="line-814"></span>
<span class="source-line-no">815</span><span id="line-815">  /**</span>
<span class="source-line-no">816</span><span id="line-816">   * Delete tables matching the passed in pattern and wait on completion. Warning: Use this method</span>
<span class="source-line-no">817</span><span id="line-817">   * carefully, there is no prompting and the effect is immediate. Consider using</span>
<span class="source-line-no">818</span><span id="line-818">   * {@link #listTables(java.util.regex.Pattern) } and {@link #deleteTable(TableName)}</span>
<span class="source-line-no">819</span><span id="line-819">   * @param pattern The pattern to match table names against</span>
<span class="source-line-no">820</span><span id="line-820">   * @return Table descriptors for tables that couldn't be deleted</span>
<span class="source-line-no">821</span><span id="line-821">   * @throws IOException if a remote or network exception occurs</span>
<span class="source-line-no">822</span><span id="line-822">   */</span>
<span class="source-line-no">823</span><span id="line-823">  @Override</span>
<span class="source-line-no">824</span><span id="line-824">  public HTableDescriptor[] deleteTables(Pattern pattern) throws IOException {</span>
<span class="source-line-no">825</span><span id="line-825">    List&lt;HTableDescriptor&gt; failed = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">826</span><span id="line-826">    for (HTableDescriptor table : listTables(pattern)) {</span>
<span class="source-line-no">827</span><span id="line-827">      try {</span>
<span class="source-line-no">828</span><span id="line-828">        deleteTable(table.getTableName());</span>
<span class="source-line-no">829</span><span id="line-829">      } catch (IOException ex) {</span>
<span class="source-line-no">830</span><span id="line-830">        LOG.info("Failed to delete table " + table.getTableName(), ex);</span>
<span class="source-line-no">831</span><span id="line-831">        failed.add(table);</span>
<span class="source-line-no">832</span><span id="line-832">      }</span>
<span class="source-line-no">833</span><span id="line-833">    }</span>
<span class="source-line-no">834</span><span id="line-834">    return failed.toArray(new HTableDescriptor[failed.size()]);</span>
<span class="source-line-no">835</span><span id="line-835">  }</span>
<span class="source-line-no">836</span><span id="line-836"></span>
<span class="source-line-no">837</span><span id="line-837">  @Override</span>
<span class="source-line-no">838</span><span id="line-838">  public Future&lt;Void&gt; truncateTableAsync(final TableName tableName, final boolean preserveSplits)</span>
<span class="source-line-no">839</span><span id="line-839">    throws IOException {</span>
<span class="source-line-no">840</span><span id="line-840">    TruncateTableResponse response = executeCallable(</span>
<span class="source-line-no">841</span><span id="line-841">      new MasterCallable&lt;TruncateTableResponse&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">842</span><span id="line-842">        Long nonceGroup = ng.getNonceGroup();</span>
<span class="source-line-no">843</span><span id="line-843">        Long nonce = ng.newNonce();</span>
<span class="source-line-no">844</span><span id="line-844"></span>
<span class="source-line-no">845</span><span id="line-845">        @Override</span>
<span class="source-line-no">846</span><span id="line-846">        protected TruncateTableResponse rpcCall() throws Exception {</span>
<span class="source-line-no">847</span><span id="line-847">          setPriority(tableName);</span>
<span class="source-line-no">848</span><span id="line-848">          LOG.info("Started truncating " + tableName);</span>
<span class="source-line-no">849</span><span id="line-849">          TruncateTableRequest req = RequestConverter.buildTruncateTableRequest(tableName,</span>
<span class="source-line-no">850</span><span id="line-850">            preserveSplits, nonceGroup, nonce);</span>
<span class="source-line-no">851</span><span id="line-851">          return master.truncateTable(getRpcController(), req);</span>
<span class="source-line-no">852</span><span id="line-852">        }</span>
<span class="source-line-no">853</span><span id="line-853">      });</span>
<span class="source-line-no">854</span><span id="line-854">    return new TruncateTableFuture(this, tableName, preserveSplits, response);</span>
<span class="source-line-no">855</span><span id="line-855">  }</span>
<span class="source-line-no">856</span><span id="line-856"></span>
<span class="source-line-no">857</span><span id="line-857">  private static class TruncateTableFuture extends TableFuture&lt;Void&gt; {</span>
<span class="source-line-no">858</span><span id="line-858">    private final boolean preserveSplits;</span>
<span class="source-line-no">859</span><span id="line-859"></span>
<span class="source-line-no">860</span><span id="line-860">    public TruncateTableFuture(final HBaseAdmin admin, final TableName tableName,</span>
<span class="source-line-no">861</span><span id="line-861">      final boolean preserveSplits, final TruncateTableResponse response) {</span>
<span class="source-line-no">862</span><span id="line-862">      super(admin, tableName,</span>
<span class="source-line-no">863</span><span id="line-863">        (response != null &amp;&amp; response.hasProcId()) ? response.getProcId() : null);</span>
<span class="source-line-no">864</span><span id="line-864">      this.preserveSplits = preserveSplits;</span>
<span class="source-line-no">865</span><span id="line-865">    }</span>
<span class="source-line-no">866</span><span id="line-866"></span>
<span class="source-line-no">867</span><span id="line-867">    @Override</span>
<span class="source-line-no">868</span><span id="line-868">    public String getOperationType() {</span>
<span class="source-line-no">869</span><span id="line-869">      return "TRUNCATE";</span>
<span class="source-line-no">870</span><span id="line-870">    }</span>
<span class="source-line-no">871</span><span id="line-871"></span>
<span class="source-line-no">872</span><span id="line-872">    @Override</span>
<span class="source-line-no">873</span><span id="line-873">    protected Void waitOperationResult(final long deadlineTs) throws IOException, TimeoutException {</span>
<span class="source-line-no">874</span><span id="line-874">      waitForTableEnabled(deadlineTs);</span>
<span class="source-line-no">875</span><span id="line-875">      // once the table is enabled, we know the operation is done. so we can fetch the splitKeys</span>
<span class="source-line-no">876</span><span id="line-876">      byte[][] splitKeys = preserveSplits ? getAdmin().getTableSplits(getTableName()) : null;</span>
<span class="source-line-no">877</span><span id="line-877">      waitForAllRegionsOnline(deadlineTs, splitKeys);</span>
<span class="source-line-no">878</span><span id="line-878">      return null;</span>
<span class="source-line-no">879</span><span id="line-879">    }</span>
<span class="source-line-no">880</span><span id="line-880">  }</span>
<span class="source-line-no">881</span><span id="line-881"></span>
<span class="source-line-no">882</span><span id="line-882">  private byte[][] getTableSplits(final TableName tableName) throws IOException {</span>
<span class="source-line-no">883</span><span id="line-883">    byte[][] splits = null;</span>
<span class="source-line-no">884</span><span id="line-884">    try (RegionLocator locator = getConnection().getRegionLocator(tableName)) {</span>
<span class="source-line-no">885</span><span id="line-885">      byte[][] startKeys = locator.getStartKeys();</span>
<span class="source-line-no">886</span><span id="line-886">      if (startKeys.length == 1) {</span>
<span class="source-line-no">887</span><span id="line-887">        return splits;</span>
<span class="source-line-no">888</span><span id="line-888">      }</span>
<span class="source-line-no">889</span><span id="line-889">      splits = new byte[startKeys.length - 1][];</span>
<span class="source-line-no">890</span><span id="line-890">      for (int i = 1; i &lt; startKeys.length; i++) {</span>
<span class="source-line-no">891</span><span id="line-891">        splits[i - 1] = startKeys[i];</span>
<span class="source-line-no">892</span><span id="line-892">      }</span>
<span class="source-line-no">893</span><span id="line-893">    }</span>
<span class="source-line-no">894</span><span id="line-894">    return splits;</span>
<span class="source-line-no">895</span><span id="line-895">  }</span>
<span class="source-line-no">896</span><span id="line-896"></span>
<span class="source-line-no">897</span><span id="line-897">  @Override</span>
<span class="source-line-no">898</span><span id="line-898">  public Future&lt;Void&gt; enableTableAsync(final TableName tableName) throws IOException {</span>
<span class="source-line-no">899</span><span id="line-899">    TableName.isLegalFullyQualifiedTableName(tableName.getName());</span>
<span class="source-line-no">900</span><span id="line-900">    EnableTableResponse response = executeCallable(</span>
<span class="source-line-no">901</span><span id="line-901">      new MasterCallable&lt;EnableTableResponse&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">902</span><span id="line-902">        Long nonceGroup = ng.getNonceGroup();</span>
<span class="source-line-no">903</span><span id="line-903">        Long nonce = ng.newNonce();</span>
<span class="source-line-no">904</span><span id="line-904"></span>
<span class="source-line-no">905</span><span id="line-905">        @Override</span>
<span class="source-line-no">906</span><span id="line-906">        protected EnableTableResponse rpcCall() throws Exception {</span>
<span class="source-line-no">907</span><span id="line-907">          setPriority(tableName);</span>
<span class="source-line-no">908</span><span id="line-908">          LOG.info("Started enable of " + tableName);</span>
<span class="source-line-no">909</span><span id="line-909">          EnableTableRequest req =</span>
<span class="source-line-no">910</span><span id="line-910">            RequestConverter.buildEnableTableRequest(tableName, nonceGroup, nonce);</span>
<span class="source-line-no">911</span><span id="line-911">          return master.enableTable(getRpcController(), req);</span>
<span class="source-line-no">912</span><span id="line-912">        }</span>
<span class="source-line-no">913</span><span id="line-913">      });</span>
<span class="source-line-no">914</span><span id="line-914">    return new EnableTableFuture(this, tableName, response);</span>
<span class="source-line-no">915</span><span id="line-915">  }</span>
<span class="source-line-no">916</span><span id="line-916"></span>
<span class="source-line-no">917</span><span id="line-917">  private static class EnableTableFuture extends TableFuture&lt;Void&gt; {</span>
<span class="source-line-no">918</span><span id="line-918">    public EnableTableFuture(final HBaseAdmin admin, final TableName tableName,</span>
<span class="source-line-no">919</span><span id="line-919">      final EnableTableResponse response) {</span>
<span class="source-line-no">920</span><span id="line-920">      super(admin, tableName,</span>
<span class="source-line-no">921</span><span id="line-921">        (response != null &amp;&amp; response.hasProcId()) ? response.getProcId() : null);</span>
<span class="source-line-no">922</span><span id="line-922">    }</span>
<span class="source-line-no">923</span><span id="line-923"></span>
<span class="source-line-no">924</span><span id="line-924">    @Override</span>
<span class="source-line-no">925</span><span id="line-925">    public String getOperationType() {</span>
<span class="source-line-no">926</span><span id="line-926">      return "ENABLE";</span>
<span class="source-line-no">927</span><span id="line-927">    }</span>
<span class="source-line-no">928</span><span id="line-928"></span>
<span class="source-line-no">929</span><span id="line-929">    @Override</span>
<span class="source-line-no">930</span><span id="line-930">    protected Void waitOperationResult(final long deadlineTs) throws IOException, TimeoutException {</span>
<span class="source-line-no">931</span><span id="line-931">      waitForTableEnabled(deadlineTs);</span>
<span class="source-line-no">932</span><span id="line-932">      return null;</span>
<span class="source-line-no">933</span><span id="line-933">    }</span>
<span class="source-line-no">934</span><span id="line-934">  }</span>
<span class="source-line-no">935</span><span id="line-935"></span>
<span class="source-line-no">936</span><span id="line-936">  @Override</span>
<span class="source-line-no">937</span><span id="line-937">  public HTableDescriptor[] enableTables(String regex) throws IOException {</span>
<span class="source-line-no">938</span><span id="line-938">    return enableTables(Pattern.compile(regex));</span>
<span class="source-line-no">939</span><span id="line-939">  }</span>
<span class="source-line-no">940</span><span id="line-940"></span>
<span class="source-line-no">941</span><span id="line-941">  @Override</span>
<span class="source-line-no">942</span><span id="line-942">  public HTableDescriptor[] enableTables(Pattern pattern) throws IOException {</span>
<span class="source-line-no">943</span><span id="line-943">    List&lt;HTableDescriptor&gt; failed = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">944</span><span id="line-944">    for (HTableDescriptor table : listTables(pattern)) {</span>
<span class="source-line-no">945</span><span id="line-945">      if (isTableDisabled(table.getTableName())) {</span>
<span class="source-line-no">946</span><span id="line-946">        try {</span>
<span class="source-line-no">947</span><span id="line-947">          enableTable(table.getTableName());</span>
<span class="source-line-no">948</span><span id="line-948">        } catch (IOException ex) {</span>
<span class="source-line-no">949</span><span id="line-949">          LOG.info("Failed to enable table " + table.getTableName(), ex);</span>
<span class="source-line-no">950</span><span id="line-950">          failed.add(table);</span>
<span class="source-line-no">951</span><span id="line-951">        }</span>
<span class="source-line-no">952</span><span id="line-952">      }</span>
<span class="source-line-no">953</span><span id="line-953">    }</span>
<span class="source-line-no">954</span><span id="line-954">    return failed.toArray(new HTableDescriptor[failed.size()]);</span>
<span class="source-line-no">955</span><span id="line-955">  }</span>
<span class="source-line-no">956</span><span id="line-956"></span>
<span class="source-line-no">957</span><span id="line-957">  @Override</span>
<span class="source-line-no">958</span><span id="line-958">  public Future&lt;Void&gt; disableTableAsync(final TableName tableName) throws IOException {</span>
<span class="source-line-no">959</span><span id="line-959">    TableName.isLegalFullyQualifiedTableName(tableName.getName());</span>
<span class="source-line-no">960</span><span id="line-960">    DisableTableResponse response = executeCallable(</span>
<span class="source-line-no">961</span><span id="line-961">      new MasterCallable&lt;DisableTableResponse&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">962</span><span id="line-962">        Long nonceGroup = ng.getNonceGroup();</span>
<span class="source-line-no">963</span><span id="line-963">        Long nonce = ng.newNonce();</span>
<span class="source-line-no">964</span><span id="line-964"></span>
<span class="source-line-no">965</span><span id="line-965">        @Override</span>
<span class="source-line-no">966</span><span id="line-966">        protected DisableTableResponse rpcCall() throws Exception {</span>
<span class="source-line-no">967</span><span id="line-967">          setPriority(tableName);</span>
<span class="source-line-no">968</span><span id="line-968">          LOG.info("Started disable of " + tableName);</span>
<span class="source-line-no">969</span><span id="line-969">          DisableTableRequest req =</span>
<span class="source-line-no">970</span><span id="line-970">            RequestConverter.buildDisableTableRequest(tableName, nonceGroup, nonce);</span>
<span class="source-line-no">971</span><span id="line-971">          return master.disableTable(getRpcController(), req);</span>
<span class="source-line-no">972</span><span id="line-972">        }</span>
<span class="source-line-no">973</span><span id="line-973">      });</span>
<span class="source-line-no">974</span><span id="line-974">    return new DisableTableFuture(this, tableName, response);</span>
<span class="source-line-no">975</span><span id="line-975">  }</span>
<span class="source-line-no">976</span><span id="line-976"></span>
<span class="source-line-no">977</span><span id="line-977">  private static class DisableTableFuture extends TableFuture&lt;Void&gt; {</span>
<span class="source-line-no">978</span><span id="line-978">    public DisableTableFuture(final HBaseAdmin admin, final TableName tableName,</span>
<span class="source-line-no">979</span><span id="line-979">      final DisableTableResponse response) {</span>
<span class="source-line-no">980</span><span id="line-980">      super(admin, tableName,</span>
<span class="source-line-no">981</span><span id="line-981">        (response != null &amp;&amp; response.hasProcId()) ? response.getProcId() : null);</span>
<span class="source-line-no">982</span><span id="line-982">    }</span>
<span class="source-line-no">983</span><span id="line-983"></span>
<span class="source-line-no">984</span><span id="line-984">    @Override</span>
<span class="source-line-no">985</span><span id="line-985">    public String getOperationType() {</span>
<span class="source-line-no">986</span><span id="line-986">      return "DISABLE";</span>
<span class="source-line-no">987</span><span id="line-987">    }</span>
<span class="source-line-no">988</span><span id="line-988"></span>
<span class="source-line-no">989</span><span id="line-989">    @Override</span>
<span class="source-line-no">990</span><span id="line-990">    protected Void waitOperationResult(long deadlineTs) throws IOException, TimeoutException {</span>
<span class="source-line-no">991</span><span id="line-991">      waitForTableDisabled(deadlineTs);</span>
<span class="source-line-no">992</span><span id="line-992">      return null;</span>
<span class="source-line-no">993</span><span id="line-993">    }</span>
<span class="source-line-no">994</span><span id="line-994">  }</span>
<span class="source-line-no">995</span><span id="line-995"></span>
<span class="source-line-no">996</span><span id="line-996">  @Override</span>
<span class="source-line-no">997</span><span id="line-997">  public HTableDescriptor[] disableTables(String regex) throws IOException {</span>
<span class="source-line-no">998</span><span id="line-998">    return disableTables(Pattern.compile(regex));</span>
<span class="source-line-no">999</span><span id="line-999">  }</span>
<span class="source-line-no">1000</span><span id="line-1000"></span>
<span class="source-line-no">1001</span><span id="line-1001">  @Override</span>
<span class="source-line-no">1002</span><span id="line-1002">  public HTableDescriptor[] disableTables(Pattern pattern) throws IOException {</span>
<span class="source-line-no">1003</span><span id="line-1003">    List&lt;HTableDescriptor&gt; failed = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">1004</span><span id="line-1004">    for (HTableDescriptor table : listTables(pattern)) {</span>
<span class="source-line-no">1005</span><span id="line-1005">      if (isTableEnabled(table.getTableName())) {</span>
<span class="source-line-no">1006</span><span id="line-1006">        try {</span>
<span class="source-line-no">1007</span><span id="line-1007">          disableTable(table.getTableName());</span>
<span class="source-line-no">1008</span><span id="line-1008">        } catch (IOException ex) {</span>
<span class="source-line-no">1009</span><span id="line-1009">          LOG.info("Failed to disable table " + table.getTableName(), ex);</span>
<span class="source-line-no">1010</span><span id="line-1010">          failed.add(table);</span>
<span class="source-line-no">1011</span><span id="line-1011">        }</span>
<span class="source-line-no">1012</span><span id="line-1012">      }</span>
<span class="source-line-no">1013</span><span id="line-1013">    }</span>
<span class="source-line-no">1014</span><span id="line-1014">    return failed.toArray(new HTableDescriptor[failed.size()]);</span>
<span class="source-line-no">1015</span><span id="line-1015">  }</span>
<span class="source-line-no">1016</span><span id="line-1016"></span>
<span class="source-line-no">1017</span><span id="line-1017">  @Override</span>
<span class="source-line-no">1018</span><span id="line-1018">  public boolean isTableEnabled(final TableName tableName) throws IOException {</span>
<span class="source-line-no">1019</span><span id="line-1019">    checkTableExists(tableName);</span>
<span class="source-line-no">1020</span><span id="line-1020">    return executeCallable(new RpcRetryingCallable&lt;Boolean&gt;() {</span>
<span class="source-line-no">1021</span><span id="line-1021">      @Override</span>
<span class="source-line-no">1022</span><span id="line-1022">      protected Boolean rpcCall(int callTimeout) throws Exception {</span>
<span class="source-line-no">1023</span><span id="line-1023">        TableState tableState = MetaTableAccessor.getTableState(getConnection(), tableName);</span>
<span class="source-line-no">1024</span><span id="line-1024">        if (tableState == null) {</span>
<span class="source-line-no">1025</span><span id="line-1025">          throw new TableNotFoundException(tableName);</span>
<span class="source-line-no">1026</span><span id="line-1026">        }</span>
<span class="source-line-no">1027</span><span id="line-1027">        return tableState.inStates(TableState.State.ENABLED);</span>
<span class="source-line-no">1028</span><span id="line-1028">      }</span>
<span class="source-line-no">1029</span><span id="line-1029">    });</span>
<span class="source-line-no">1030</span><span id="line-1030">  }</span>
<span class="source-line-no">1031</span><span id="line-1031"></span>
<span class="source-line-no">1032</span><span id="line-1032">  @Override</span>
<span class="source-line-no">1033</span><span id="line-1033">  public boolean isTableDisabled(TableName tableName) throws IOException {</span>
<span class="source-line-no">1034</span><span id="line-1034">    checkTableExists(tableName);</span>
<span class="source-line-no">1035</span><span id="line-1035">    return connection.isTableDisabled(tableName);</span>
<span class="source-line-no">1036</span><span id="line-1036">  }</span>
<span class="source-line-no">1037</span><span id="line-1037"></span>
<span class="source-line-no">1038</span><span id="line-1038">  @Override</span>
<span class="source-line-no">1039</span><span id="line-1039">  public boolean isTableAvailable(TableName tableName) throws IOException {</span>
<span class="source-line-no">1040</span><span id="line-1040">    return connection.isTableAvailable(tableName, null);</span>
<span class="source-line-no">1041</span><span id="line-1041">  }</span>
<span class="source-line-no">1042</span><span id="line-1042"></span>
<span class="source-line-no">1043</span><span id="line-1043">  @Override</span>
<span class="source-line-no">1044</span><span id="line-1044">  public boolean isTableAvailable(TableName tableName, byte[][] splitKeys) throws IOException {</span>
<span class="source-line-no">1045</span><span id="line-1045">    return connection.isTableAvailable(tableName, splitKeys);</span>
<span class="source-line-no">1046</span><span id="line-1046">  }</span>
<span class="source-line-no">1047</span><span id="line-1047"></span>
<span class="source-line-no">1048</span><span id="line-1048">  @Override</span>
<span class="source-line-no">1049</span><span id="line-1049">  public Pair&lt;Integer, Integer&gt; getAlterStatus(final TableName tableName) throws IOException {</span>
<span class="source-line-no">1050</span><span id="line-1050">    return executeCallable(</span>
<span class="source-line-no">1051</span><span id="line-1051">      new MasterCallable&lt;Pair&lt;Integer, Integer&gt;&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">1052</span><span id="line-1052">        @Override</span>
<span class="source-line-no">1053</span><span id="line-1053">        protected Pair&lt;Integer, Integer&gt; rpcCall() throws Exception {</span>
<span class="source-line-no">1054</span><span id="line-1054">          setPriority(tableName);</span>
<span class="source-line-no">1055</span><span id="line-1055">          GetSchemaAlterStatusRequest req =</span>
<span class="source-line-no">1056</span><span id="line-1056">            RequestConverter.buildGetSchemaAlterStatusRequest(tableName);</span>
<span class="source-line-no">1057</span><span id="line-1057">          GetSchemaAlterStatusResponse ret = master.getSchemaAlterStatus(getRpcController(), req);</span>
<span class="source-line-no">1058</span><span id="line-1058">          Pair&lt;Integer, Integer&gt; pair =</span>
<span class="source-line-no">1059</span><span id="line-1059">            new Pair&lt;&gt;(ret.getYetToUpdateRegions(), ret.getTotalRegions());</span>
<span class="source-line-no">1060</span><span id="line-1060">          return pair;</span>
<span class="source-line-no">1061</span><span id="line-1061">        }</span>
<span class="source-line-no">1062</span><span id="line-1062">      });</span>
<span class="source-line-no">1063</span><span id="line-1063">  }</span>
<span class="source-line-no">1064</span><span id="line-1064"></span>
<span class="source-line-no">1065</span><span id="line-1065">  @Override</span>
<span class="source-line-no">1066</span><span id="line-1066">  public Pair&lt;Integer, Integer&gt; getAlterStatus(final byte[] tableName) throws IOException {</span>
<span class="source-line-no">1067</span><span id="line-1067">    return getAlterStatus(TableName.valueOf(tableName));</span>
<span class="source-line-no">1068</span><span id="line-1068">  }</span>
<span class="source-line-no">1069</span><span id="line-1069"></span>
<span class="source-line-no">1070</span><span id="line-1070">  @Override</span>
<span class="source-line-no">1071</span><span id="line-1071">  public Future&lt;Void&gt; addColumnFamilyAsync(final TableName tableName,</span>
<span class="source-line-no">1072</span><span id="line-1072">    final ColumnFamilyDescriptor columnFamily) throws IOException {</span>
<span class="source-line-no">1073</span><span id="line-1073">    AddColumnResponse response = executeCallable(</span>
<span class="source-line-no">1074</span><span id="line-1074">      new MasterCallable&lt;AddColumnResponse&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">1075</span><span id="line-1075">        Long nonceGroup = ng.getNonceGroup();</span>
<span class="source-line-no">1076</span><span id="line-1076">        Long nonce = ng.newNonce();</span>
<span class="source-line-no">1077</span><span id="line-1077"></span>
<span class="source-line-no">1078</span><span id="line-1078">        @Override</span>
<span class="source-line-no">1079</span><span id="line-1079">        protected AddColumnResponse rpcCall() throws Exception {</span>
<span class="source-line-no">1080</span><span id="line-1080">          setPriority(tableName);</span>
<span class="source-line-no">1081</span><span id="line-1081">          AddColumnRequest req =</span>
<span class="source-line-no">1082</span><span id="line-1082">            RequestConverter.buildAddColumnRequest(tableName, columnFamily, nonceGroup, nonce);</span>
<span class="source-line-no">1083</span><span id="line-1083">          return master.addColumn(getRpcController(), req);</span>
<span class="source-line-no">1084</span><span id="line-1084">        }</span>
<span class="source-line-no">1085</span><span id="line-1085">      });</span>
<span class="source-line-no">1086</span><span id="line-1086">    return new AddColumnFamilyFuture(this, tableName, response);</span>
<span class="source-line-no">1087</span><span id="line-1087">  }</span>
<span class="source-line-no">1088</span><span id="line-1088"></span>
<span class="source-line-no">1089</span><span id="line-1089">  private static class AddColumnFamilyFuture extends ModifyTableFuture {</span>
<span class="source-line-no">1090</span><span id="line-1090">    public AddColumnFamilyFuture(final HBaseAdmin admin, final TableName tableName,</span>
<span class="source-line-no">1091</span><span id="line-1091">      final AddColumnResponse response) {</span>
<span class="source-line-no">1092</span><span id="line-1092">      super(admin, tableName,</span>
<span class="source-line-no">1093</span><span id="line-1093">        (response != null &amp;&amp; response.hasProcId()) ? response.getProcId() : null);</span>
<span class="source-line-no">1094</span><span id="line-1094">    }</span>
<span class="source-line-no">1095</span><span id="line-1095"></span>
<span class="source-line-no">1096</span><span id="line-1096">    @Override</span>
<span class="source-line-no">1097</span><span id="line-1097">    public String getOperationType() {</span>
<span class="source-line-no">1098</span><span id="line-1098">      return "ADD_COLUMN_FAMILY";</span>
<span class="source-line-no">1099</span><span id="line-1099">    }</span>
<span class="source-line-no">1100</span><span id="line-1100">  }</span>
<span class="source-line-no">1101</span><span id="line-1101"></span>
<span class="source-line-no">1102</span><span id="line-1102">  /**</span>
<span class="source-line-no">1103</span><span id="line-1103">   * {@inheritDoc}</span>
<span class="source-line-no">1104</span><span id="line-1104">   * @deprecated Since 2.0. Will be removed in 3.0. Use</span>
<span class="source-line-no">1105</span><span id="line-1105">   *             {@link #deleteColumnFamily(TableName, byte[])} instead.</span>
<span class="source-line-no">1106</span><span id="line-1106">   */</span>
<span class="source-line-no">1107</span><span id="line-1107">  @Override</span>
<span class="source-line-no">1108</span><span id="line-1108">  @Deprecated</span>
<span class="source-line-no">1109</span><span id="line-1109">  public void deleteColumn(final TableName tableName, final byte[] columnFamily)</span>
<span class="source-line-no">1110</span><span id="line-1110">    throws IOException {</span>
<span class="source-line-no">1111</span><span id="line-1111">    deleteColumnFamily(tableName, columnFamily);</span>
<span class="source-line-no">1112</span><span id="line-1112">  }</span>
<span class="source-line-no">1113</span><span id="line-1113"></span>
<span class="source-line-no">1114</span><span id="line-1114">  @Override</span>
<span class="source-line-no">1115</span><span id="line-1115">  public Future&lt;Void&gt; deleteColumnFamilyAsync(final TableName tableName, final byte[] columnFamily)</span>
<span class="source-line-no">1116</span><span id="line-1116">    throws IOException {</span>
<span class="source-line-no">1117</span><span id="line-1117">    DeleteColumnResponse response = executeCallable(</span>
<span class="source-line-no">1118</span><span id="line-1118">      new MasterCallable&lt;DeleteColumnResponse&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">1119</span><span id="line-1119">        Long nonceGroup = ng.getNonceGroup();</span>
<span class="source-line-no">1120</span><span id="line-1120">        Long nonce = ng.newNonce();</span>
<span class="source-line-no">1121</span><span id="line-1121"></span>
<span class="source-line-no">1122</span><span id="line-1122">        @Override</span>
<span class="source-line-no">1123</span><span id="line-1123">        protected DeleteColumnResponse rpcCall() throws Exception {</span>
<span class="source-line-no">1124</span><span id="line-1124">          setPriority(tableName);</span>
<span class="source-line-no">1125</span><span id="line-1125">          DeleteColumnRequest req =</span>
<span class="source-line-no">1126</span><span id="line-1126">            RequestConverter.buildDeleteColumnRequest(tableName, columnFamily, nonceGroup, nonce);</span>
<span class="source-line-no">1127</span><span id="line-1127">          return master.deleteColumn(getRpcController(), req);</span>
<span class="source-line-no">1128</span><span id="line-1128">        }</span>
<span class="source-line-no">1129</span><span id="line-1129">      });</span>
<span class="source-line-no">1130</span><span id="line-1130">    return new DeleteColumnFamilyFuture(this, tableName, response);</span>
<span class="source-line-no">1131</span><span id="line-1131">  }</span>
<span class="source-line-no">1132</span><span id="line-1132"></span>
<span class="source-line-no">1133</span><span id="line-1133">  private static class DeleteColumnFamilyFuture extends ModifyTableFuture {</span>
<span class="source-line-no">1134</span><span id="line-1134">    public DeleteColumnFamilyFuture(final HBaseAdmin admin, final TableName tableName,</span>
<span class="source-line-no">1135</span><span id="line-1135">      final DeleteColumnResponse response) {</span>
<span class="source-line-no">1136</span><span id="line-1136">      super(admin, tableName,</span>
<span class="source-line-no">1137</span><span id="line-1137">        (response != null &amp;&amp; response.hasProcId()) ? response.getProcId() : null);</span>
<span class="source-line-no">1138</span><span id="line-1138">    }</span>
<span class="source-line-no">1139</span><span id="line-1139"></span>
<span class="source-line-no">1140</span><span id="line-1140">    @Override</span>
<span class="source-line-no">1141</span><span id="line-1141">    public String getOperationType() {</span>
<span class="source-line-no">1142</span><span id="line-1142">      return "DELETE_COLUMN_FAMILY";</span>
<span class="source-line-no">1143</span><span id="line-1143">    }</span>
<span class="source-line-no">1144</span><span id="line-1144">  }</span>
<span class="source-line-no">1145</span><span id="line-1145"></span>
<span class="source-line-no">1146</span><span id="line-1146">  @Override</span>
<span class="source-line-no">1147</span><span id="line-1147">  public Future&lt;Void&gt; modifyColumnFamilyAsync(final TableName tableName,</span>
<span class="source-line-no">1148</span><span id="line-1148">    final ColumnFamilyDescriptor columnFamily) throws IOException {</span>
<span class="source-line-no">1149</span><span id="line-1149">    ModifyColumnResponse response = executeCallable(</span>
<span class="source-line-no">1150</span><span id="line-1150">      new MasterCallable&lt;ModifyColumnResponse&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">1151</span><span id="line-1151">        long nonceGroup = ng.getNonceGroup();</span>
<span class="source-line-no">1152</span><span id="line-1152">        long nonce = ng.newNonce();</span>
<span class="source-line-no">1153</span><span id="line-1153"></span>
<span class="source-line-no">1154</span><span id="line-1154">        @Override</span>
<span class="source-line-no">1155</span><span id="line-1155">        protected ModifyColumnResponse rpcCall() throws Exception {</span>
<span class="source-line-no">1156</span><span id="line-1156">          setPriority(tableName);</span>
<span class="source-line-no">1157</span><span id="line-1157">          ModifyColumnRequest req =</span>
<span class="source-line-no">1158</span><span id="line-1158">            RequestConverter.buildModifyColumnRequest(tableName, columnFamily, nonceGroup, nonce);</span>
<span class="source-line-no">1159</span><span id="line-1159">          return master.modifyColumn(getRpcController(), req);</span>
<span class="source-line-no">1160</span><span id="line-1160">        }</span>
<span class="source-line-no">1161</span><span id="line-1161">      });</span>
<span class="source-line-no">1162</span><span id="line-1162">    return new ModifyColumnFamilyFuture(this, tableName, response);</span>
<span class="source-line-no">1163</span><span id="line-1163">  }</span>
<span class="source-line-no">1164</span><span id="line-1164"></span>
<span class="source-line-no">1165</span><span id="line-1165">  private static class ModifyColumnFamilyFuture extends ModifyTableFuture {</span>
<span class="source-line-no">1166</span><span id="line-1166">    public ModifyColumnFamilyFuture(final HBaseAdmin admin, final TableName tableName,</span>
<span class="source-line-no">1167</span><span id="line-1167">      final ModifyColumnResponse response) {</span>
<span class="source-line-no">1168</span><span id="line-1168">      super(admin, tableName,</span>
<span class="source-line-no">1169</span><span id="line-1169">        (response != null &amp;&amp; response.hasProcId()) ? response.getProcId() : null);</span>
<span class="source-line-no">1170</span><span id="line-1170">    }</span>
<span class="source-line-no">1171</span><span id="line-1171"></span>
<span class="source-line-no">1172</span><span id="line-1172">    @Override</span>
<span class="source-line-no">1173</span><span id="line-1173">    public String getOperationType() {</span>
<span class="source-line-no">1174</span><span id="line-1174">      return "MODIFY_COLUMN_FAMILY";</span>
<span class="source-line-no">1175</span><span id="line-1175">    }</span>
<span class="source-line-no">1176</span><span id="line-1176">  }</span>
<span class="source-line-no">1177</span><span id="line-1177"></span>
<span class="source-line-no">1178</span><span id="line-1178">  @Override</span>
<span class="source-line-no">1179</span><span id="line-1179">  public Future&lt;Void&gt; modifyColumnFamilyStoreFileTrackerAsync(TableName tableName, byte[] family,</span>
<span class="source-line-no">1180</span><span id="line-1180">    String dstSFT) throws IOException {</span>
<span class="source-line-no">1181</span><span id="line-1181">    ModifyColumnStoreFileTrackerResponse response =</span>
<span class="source-line-no">1182</span><span id="line-1182">      executeCallable(new MasterCallable&lt;ModifyColumnStoreFileTrackerResponse&gt;(getConnection(),</span>
<span class="source-line-no">1183</span><span id="line-1183">        getRpcControllerFactory()) {</span>
<span class="source-line-no">1184</span><span id="line-1184">        long nonceGroup = ng.getNonceGroup();</span>
<span class="source-line-no">1185</span><span id="line-1185">        long nonce = ng.newNonce();</span>
<span class="source-line-no">1186</span><span id="line-1186"></span>
<span class="source-line-no">1187</span><span id="line-1187">        @Override</span>
<span class="source-line-no">1188</span><span id="line-1188">        protected ModifyColumnStoreFileTrackerResponse rpcCall() throws Exception {</span>
<span class="source-line-no">1189</span><span id="line-1189">          setPriority(tableName);</span>
<span class="source-line-no">1190</span><span id="line-1190">          ModifyColumnStoreFileTrackerRequest req = RequestConverter</span>
<span class="source-line-no">1191</span><span id="line-1191">            .buildModifyColumnStoreFileTrackerRequest(tableName, family, dstSFT, nonceGroup, nonce);</span>
<span class="source-line-no">1192</span><span id="line-1192">          return master.modifyColumnStoreFileTracker(getRpcController(), req);</span>
<span class="source-line-no">1193</span><span id="line-1193">        }</span>
<span class="source-line-no">1194</span><span id="line-1194">      });</span>
<span class="source-line-no">1195</span><span id="line-1195">    return new ModifyColumnFamilyStoreFileTrackerFuture(this, tableName, response);</span>
<span class="source-line-no">1196</span><span id="line-1196">  }</span>
<span class="source-line-no">1197</span><span id="line-1197"></span>
<span class="source-line-no">1198</span><span id="line-1198">  private static class ModifyColumnFamilyStoreFileTrackerFuture extends ModifyTableFuture {</span>
<span class="source-line-no">1199</span><span id="line-1199">    public ModifyColumnFamilyStoreFileTrackerFuture(HBaseAdmin admin, TableName tableName,</span>
<span class="source-line-no">1200</span><span id="line-1200">      final ModifyColumnStoreFileTrackerResponse response) {</span>
<span class="source-line-no">1201</span><span id="line-1201">      super(admin, tableName,</span>
<span class="source-line-no">1202</span><span id="line-1202">        (response != null &amp;&amp; response.hasProcId()) ? response.getProcId() : null);</span>
<span class="source-line-no">1203</span><span id="line-1203">    }</span>
<span class="source-line-no">1204</span><span id="line-1204"></span>
<span class="source-line-no">1205</span><span id="line-1205">    @Override</span>
<span class="source-line-no">1206</span><span id="line-1206">    public String getOperationType() {</span>
<span class="source-line-no">1207</span><span id="line-1207">      return "MODIFY_COLUMN_FAMILY_STORE_FILE_TRACKER";</span>
<span class="source-line-no">1208</span><span id="line-1208">    }</span>
<span class="source-line-no">1209</span><span id="line-1209">  }</span>
<span class="source-line-no">1210</span><span id="line-1210"></span>
<span class="source-line-no">1211</span><span id="line-1211">  @Deprecated</span>
<span class="source-line-no">1212</span><span id="line-1212">  @Override</span>
<span class="source-line-no">1213</span><span id="line-1213">  public void closeRegion(final String regionName, final String unused) throws IOException {</span>
<span class="source-line-no">1214</span><span id="line-1214">    unassign(Bytes.toBytes(regionName), true);</span>
<span class="source-line-no">1215</span><span id="line-1215">  }</span>
<span class="source-line-no">1216</span><span id="line-1216"></span>
<span class="source-line-no">1217</span><span id="line-1217">  @Deprecated</span>
<span class="source-line-no">1218</span><span id="line-1218">  @Override</span>
<span class="source-line-no">1219</span><span id="line-1219">  public void closeRegion(final byte[] regionName, final String unused) throws IOException {</span>
<span class="source-line-no">1220</span><span id="line-1220">    unassign(regionName, true);</span>
<span class="source-line-no">1221</span><span id="line-1221">  }</span>
<span class="source-line-no">1222</span><span id="line-1222"></span>
<span class="source-line-no">1223</span><span id="line-1223">  @Deprecated</span>
<span class="source-line-no">1224</span><span id="line-1224">  @Override</span>
<span class="source-line-no">1225</span><span id="line-1225">  public boolean closeRegionWithEncodedRegionName(final String encodedRegionName,</span>
<span class="source-line-no">1226</span><span id="line-1226">    final String unused) throws IOException {</span>
<span class="source-line-no">1227</span><span id="line-1227">    unassign(Bytes.toBytes(encodedRegionName), true);</span>
<span class="source-line-no">1228</span><span id="line-1228">    return true;</span>
<span class="source-line-no">1229</span><span id="line-1229">  }</span>
<span class="source-line-no">1230</span><span id="line-1230"></span>
<span class="source-line-no">1231</span><span id="line-1231">  @Deprecated</span>
<span class="source-line-no">1232</span><span id="line-1232">  @Override</span>
<span class="source-line-no">1233</span><span id="line-1233">  public void closeRegion(final ServerName unused, final HRegionInfo hri) throws IOException {</span>
<span class="source-line-no">1234</span><span id="line-1234">    unassign(hri.getRegionName(), true);</span>
<span class="source-line-no">1235</span><span id="line-1235">  }</span>
<span class="source-line-no">1236</span><span id="line-1236"></span>
<span class="source-line-no">1237</span><span id="line-1237">  /**</span>
<span class="source-line-no">1238</span><span id="line-1238">   * @return List of {@link HRegionInfo}.</span>
<span class="source-line-no">1239</span><span id="line-1239">   * @throws IOException if a remote or network exception occurs</span>
<span class="source-line-no">1240</span><span id="line-1240">   * @deprecated As of release 2.0.0, this will be removed in HBase 3.0.0 Use</span>
<span class="source-line-no">1241</span><span id="line-1241">   *             {@link #getRegions(ServerName)}.</span>
<span class="source-line-no">1242</span><span id="line-1242">   */</span>
<span class="source-line-no">1243</span><span id="line-1243">  @Deprecated</span>
<span class="source-line-no">1244</span><span id="line-1244">  @Override</span>
<span class="source-line-no">1245</span><span id="line-1245">  public List&lt;HRegionInfo&gt; getOnlineRegions(final ServerName sn) throws IOException {</span>
<span class="source-line-no">1246</span><span id="line-1246">    return getRegions(sn).stream().map(ImmutableHRegionInfo::new).collect(Collectors.toList());</span>
<span class="source-line-no">1247</span><span id="line-1247">  }</span>
<span class="source-line-no">1248</span><span id="line-1248"></span>
<span class="source-line-no">1249</span><span id="line-1249">  @Override</span>
<span class="source-line-no">1250</span><span id="line-1250">  public void flush(final TableName tableName) throws IOException {</span>
<span class="source-line-no">1251</span><span id="line-1251">    flush(tableName, Collections.emptyList());</span>
<span class="source-line-no">1252</span><span id="line-1252">  }</span>
<span class="source-line-no">1253</span><span id="line-1253"></span>
<span class="source-line-no">1254</span><span id="line-1254">  @Override</span>
<span class="source-line-no">1255</span><span id="line-1255">  public void flush(final TableName tableName, byte[] columnFamily) throws IOException {</span>
<span class="source-line-no">1256</span><span id="line-1256">    flush(tableName, Collections.singletonList(columnFamily));</span>
<span class="source-line-no">1257</span><span id="line-1257">  }</span>
<span class="source-line-no">1258</span><span id="line-1258"></span>
<span class="source-line-no">1259</span><span id="line-1259">  @Override</span>
<span class="source-line-no">1260</span><span id="line-1260">  public Future&lt;Void&gt; flushAsync(TableName tableName, List&lt;byte[]&gt; columnFamilies)</span>
<span class="source-line-no">1261</span><span id="line-1261">    throws IOException {</span>
<span class="source-line-no">1262</span><span id="line-1262">    // check if the table exists and enabled</span>
<span class="source-line-no">1263</span><span id="line-1263">    if (!isTableEnabled(tableName)) {</span>
<span class="source-line-no">1264</span><span id="line-1264">      throw new TableNotEnabledException(tableName.getNameAsString());</span>
<span class="source-line-no">1265</span><span id="line-1265">    }</span>
<span class="source-line-no">1266</span><span id="line-1266">    // remove duplicate column families</span>
<span class="source-line-no">1267</span><span id="line-1267">    List&lt;byte[]&gt; columnFamilyList = columnFamilies.stream()</span>
<span class="source-line-no">1268</span><span id="line-1268">      .filter(cf -&gt; cf != null &amp;&amp; cf.length &gt; 0).distinct().collect(Collectors.toList());</span>
<span class="source-line-no">1269</span><span id="line-1269"></span>
<span class="source-line-no">1270</span><span id="line-1270">    try {</span>
<span class="source-line-no">1271</span><span id="line-1271">      FlushTableResponse resp = executeCallable(</span>
<span class="source-line-no">1272</span><span id="line-1272">        new MasterCallable&lt;FlushTableResponse&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">1273</span><span id="line-1273">          final long nonceGroup = ng.getNonceGroup();</span>
<span class="source-line-no">1274</span><span id="line-1274">          final long nonce = ng.newNonce();</span>
<span class="source-line-no">1275</span><span id="line-1275"></span>
<span class="source-line-no">1276</span><span id="line-1276">          @Override</span>
<span class="source-line-no">1277</span><span id="line-1277">          protected FlushTableResponse rpcCall() throws Exception {</span>
<span class="source-line-no">1278</span><span id="line-1278">            FlushTableRequest request = RequestConverter.buildFlushTableRequest(tableName,</span>
<span class="source-line-no">1279</span><span id="line-1279">              columnFamilyList, nonceGroup, nonce);</span>
<span class="source-line-no">1280</span><span id="line-1280">            return master.flushTable(getRpcController(), request);</span>
<span class="source-line-no">1281</span><span id="line-1281">          }</span>
<span class="source-line-no">1282</span><span id="line-1282">        });</span>
<span class="source-line-no">1283</span><span id="line-1283">      return new FlushTableFuture(this, tableName, resp);</span>
<span class="source-line-no">1284</span><span id="line-1284">    } catch (DoNotRetryIOException e) {</span>
<span class="source-line-no">1285</span><span id="line-1285">      // This is for keeping compatibility with old implementation.</span>
<span class="source-line-no">1286</span><span id="line-1286">      // usually the exception caused by the method is not present on the server or</span>
<span class="source-line-no">1287</span><span id="line-1287">      // the hbase hadoop version does not match the running hadoop version or</span>
<span class="source-line-no">1288</span><span id="line-1288">      // the FlushTableProcedure is disabled, if that happens, we need fall back</span>
<span class="source-line-no">1289</span><span id="line-1289">      // to the old flush implementation.</span>
<span class="source-line-no">1290</span><span id="line-1290">      Map&lt;String, String&gt; props = new HashMap&lt;&gt;();</span>
<span class="source-line-no">1291</span><span id="line-1291">      if (!columnFamilies.isEmpty()) {</span>
<span class="source-line-no">1292</span><span id="line-1292">        props.put(HConstants.FAMILY_KEY_STR, Strings.JOINER</span>
<span class="source-line-no">1293</span><span id="line-1293">          .join(columnFamilies.stream().map(Bytes::toString).collect(Collectors.toList())));</span>
<span class="source-line-no">1294</span><span id="line-1294">      }</span>
<span class="source-line-no">1295</span><span id="line-1295"></span>
<span class="source-line-no">1296</span><span id="line-1296">      executeCallable(</span>
<span class="source-line-no">1297</span><span id="line-1297">        new MasterCallable&lt;ExecProcedureResponse&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">1298</span><span id="line-1298">          @Override</span>
<span class="source-line-no">1299</span><span id="line-1299">          protected ExecProcedureResponse rpcCall() throws Exception {</span>
<span class="source-line-no">1300</span><span id="line-1300">            ExecProcedureRequest request = ExecProcedureRequest.newBuilder()</span>
<span class="source-line-no">1301</span><span id="line-1301">              .setProcedure(ProtobufUtil.buildProcedureDescription("flush-table-proc",</span>
<span class="source-line-no">1302</span><span id="line-1302">                tableName.getNameAsString(), props))</span>
<span class="source-line-no">1303</span><span id="line-1303">              .build();</span>
<span class="source-line-no">1304</span><span id="line-1304">            return master.execProcedure(getRpcController(), request);</span>
<span class="source-line-no">1305</span><span id="line-1305">          }</span>
<span class="source-line-no">1306</span><span id="line-1306">        });</span>
<span class="source-line-no">1307</span><span id="line-1307">      return new LegacyFlushFuture(this, tableName, props);</span>
<span class="source-line-no">1308</span><span id="line-1308">    }</span>
<span class="source-line-no">1309</span><span id="line-1309">  }</span>
<span class="source-line-no">1310</span><span id="line-1310"></span>
<span class="source-line-no">1311</span><span id="line-1311">  private static class FlushTableFuture extends TableFuture&lt;Void&gt; {</span>
<span class="source-line-no">1312</span><span id="line-1312"></span>
<span class="source-line-no">1313</span><span id="line-1313">    public FlushTableFuture(final HBaseAdmin admin, final TableName tableName,</span>
<span class="source-line-no">1314</span><span id="line-1314">      final FlushTableResponse resp) {</span>
<span class="source-line-no">1315</span><span id="line-1315">      super(admin, tableName, (resp != null &amp;&amp; resp.hasProcId()) ? resp.getProcId() : null);</span>
<span class="source-line-no">1316</span><span id="line-1316">    }</span>
<span class="source-line-no">1317</span><span id="line-1317"></span>
<span class="source-line-no">1318</span><span id="line-1318">    @Override</span>
<span class="source-line-no">1319</span><span id="line-1319">    public String getOperationType() {</span>
<span class="source-line-no">1320</span><span id="line-1320">      return "FLUSH";</span>
<span class="source-line-no">1321</span><span id="line-1321">    }</span>
<span class="source-line-no">1322</span><span id="line-1322">  }</span>
<span class="source-line-no">1323</span><span id="line-1323"></span>
<span class="source-line-no">1324</span><span id="line-1324">  private static class LegacyFlushFuture extends TableFuture&lt;Void&gt; {</span>
<span class="source-line-no">1325</span><span id="line-1325"></span>
<span class="source-line-no">1326</span><span id="line-1326">    private final Map&lt;String, String&gt; props;</span>
<span class="source-line-no">1327</span><span id="line-1327"></span>
<span class="source-line-no">1328</span><span id="line-1328">    public LegacyFlushFuture(HBaseAdmin admin, TableName tableName, Map&lt;String, String&gt; props) {</span>
<span class="source-line-no">1329</span><span id="line-1329">      super(admin, tableName, null);</span>
<span class="source-line-no">1330</span><span id="line-1330">      this.props = props;</span>
<span class="source-line-no">1331</span><span id="line-1331">    }</span>
<span class="source-line-no">1332</span><span id="line-1332"></span>
<span class="source-line-no">1333</span><span id="line-1333">    @Override</span>
<span class="source-line-no">1334</span><span id="line-1334">    public String getOperationType() {</span>
<span class="source-line-no">1335</span><span id="line-1335">      return "FLUSH";</span>
<span class="source-line-no">1336</span><span id="line-1336">    }</span>
<span class="source-line-no">1337</span><span id="line-1337"></span>
<span class="source-line-no">1338</span><span id="line-1338">    @Override</span>
<span class="source-line-no">1339</span><span id="line-1339">    protected Void waitOperationResult(long deadlineTs) throws IOException, TimeoutException {</span>
<span class="source-line-no">1340</span><span id="line-1340">      waitForState(deadlineTs, new TableWaitForStateCallable() {</span>
<span class="source-line-no">1341</span><span id="line-1341">        @Override</span>
<span class="source-line-no">1342</span><span id="line-1342">        public boolean checkState(int tries) throws IOException {</span>
<span class="source-line-no">1343</span><span id="line-1343">          return getAdmin().isProcedureFinished("flush-table-proc",</span>
<span class="source-line-no">1344</span><span id="line-1344">            getTableName().getNameAsString(), props);</span>
<span class="source-line-no">1345</span><span id="line-1345">        }</span>
<span class="source-line-no">1346</span><span id="line-1346">      });</span>
<span class="source-line-no">1347</span><span id="line-1347">      return null;</span>
<span class="source-line-no">1348</span><span id="line-1348">    }</span>
<span class="source-line-no">1349</span><span id="line-1349">  }</span>
<span class="source-line-no">1350</span><span id="line-1350"></span>
<span class="source-line-no">1351</span><span id="line-1351">  @Override</span>
<span class="source-line-no">1352</span><span id="line-1352">  public void flushRegion(final byte[] regionName) throws IOException {</span>
<span class="source-line-no">1353</span><span id="line-1353">    flushRegion(regionName, null);</span>
<span class="source-line-no">1354</span><span id="line-1354">  }</span>
<span class="source-line-no">1355</span><span id="line-1355"></span>
<span class="source-line-no">1356</span><span id="line-1356">  @Override</span>
<span class="source-line-no">1357</span><span id="line-1357">  public void flushRegion(final byte[] regionName, byte[] columnFamily) throws IOException {</span>
<span class="source-line-no">1358</span><span id="line-1358">    Pair&lt;RegionInfo, ServerName&gt; regionServerPair = getRegion(regionName);</span>
<span class="source-line-no">1359</span><span id="line-1359">    if (regionServerPair == null) {</span>
<span class="source-line-no">1360</span><span id="line-1360">      throw new IllegalArgumentException("Unknown regionname: " + Bytes.toStringBinary(regionName));</span>
<span class="source-line-no">1361</span><span id="line-1361">    }</span>
<span class="source-line-no">1362</span><span id="line-1362">    if (regionServerPair.getSecond() == null) {</span>
<span class="source-line-no">1363</span><span id="line-1363">      throw new NoServerForRegionException(Bytes.toStringBinary(regionName));</span>
<span class="source-line-no">1364</span><span id="line-1364">    }</span>
<span class="source-line-no">1365</span><span id="line-1365">    final RegionInfo regionInfo = regionServerPair.getFirst();</span>
<span class="source-line-no">1366</span><span id="line-1366">    ServerName serverName = regionServerPair.getSecond();</span>
<span class="source-line-no">1367</span><span id="line-1367">    flush(this.connection.getAdmin(serverName), regionInfo, columnFamily);</span>
<span class="source-line-no">1368</span><span id="line-1368">  }</span>
<span class="source-line-no">1369</span><span id="line-1369"></span>
<span class="source-line-no">1370</span><span id="line-1370">  private void flush(AdminService.BlockingInterface admin, final RegionInfo info,</span>
<span class="source-line-no">1371</span><span id="line-1371">    byte[] columnFamily) throws IOException {</span>
<span class="source-line-no">1372</span><span id="line-1372">    ProtobufUtil.call(() -&gt; {</span>
<span class="source-line-no">1373</span><span id="line-1373">      // TODO: There is no timeout on this controller. Set one!</span>
<span class="source-line-no">1374</span><span id="line-1374">      HBaseRpcController controller = rpcControllerFactory.newController();</span>
<span class="source-line-no">1375</span><span id="line-1375">      FlushRegionRequest request =</span>
<span class="source-line-no">1376</span><span id="line-1376">        RequestConverter.buildFlushRegionRequest(info.getRegionName(), columnFamily, false);</span>
<span class="source-line-no">1377</span><span id="line-1377">      admin.flushRegion(controller, request);</span>
<span class="source-line-no">1378</span><span id="line-1378">      return null;</span>
<span class="source-line-no">1379</span><span id="line-1379">    });</span>
<span class="source-line-no">1380</span><span id="line-1380">  }</span>
<span class="source-line-no">1381</span><span id="line-1381"></span>
<span class="source-line-no">1382</span><span id="line-1382">  @Override</span>
<span class="source-line-no">1383</span><span id="line-1383">  public void flushRegionServer(ServerName serverName) throws IOException {</span>
<span class="source-line-no">1384</span><span id="line-1384">    for (RegionInfo region : getRegions(serverName)) {</span>
<span class="source-line-no">1385</span><span id="line-1385">      flush(this.connection.getAdmin(serverName), region, null);</span>
<span class="source-line-no">1386</span><span id="line-1386">    }</span>
<span class="source-line-no">1387</span><span id="line-1387">  }</span>
<span class="source-line-no">1388</span><span id="line-1388"></span>
<span class="source-line-no">1389</span><span id="line-1389">  /**</span>
<span class="source-line-no">1390</span><span id="line-1390">   * {@inheritDoc}</span>
<span class="source-line-no">1391</span><span id="line-1391">   */</span>
<span class="source-line-no">1392</span><span id="line-1392">  @Override</span>
<span class="source-line-no">1393</span><span id="line-1393">  public void compact(final TableName tableName) throws IOException {</span>
<span class="source-line-no">1394</span><span id="line-1394">    compact(tableName, null, false, CompactType.NORMAL);</span>
<span class="source-line-no">1395</span><span id="line-1395">  }</span>
<span class="source-line-no">1396</span><span id="line-1396"></span>
<span class="source-line-no">1397</span><span id="line-1397">  @Override</span>
<span class="source-line-no">1398</span><span id="line-1398">  public void compactRegion(final byte[] regionName) throws IOException {</span>
<span class="source-line-no">1399</span><span id="line-1399">    compactRegion(regionName, null, false);</span>
<span class="source-line-no">1400</span><span id="line-1400">  }</span>
<span class="source-line-no">1401</span><span id="line-1401"></span>
<span class="source-line-no">1402</span><span id="line-1402">  /**</span>
<span class="source-line-no">1403</span><span id="line-1403">   * {@inheritDoc}</span>
<span class="source-line-no">1404</span><span id="line-1404">   */</span>
<span class="source-line-no">1405</span><span id="line-1405">  @Override</span>
<span class="source-line-no">1406</span><span id="line-1406">  public void compact(final TableName tableName, final byte[] columnFamily) throws IOException {</span>
<span class="source-line-no">1407</span><span id="line-1407">    compact(tableName, columnFamily, false, CompactType.NORMAL);</span>
<span class="source-line-no">1408</span><span id="line-1408">  }</span>
<span class="source-line-no">1409</span><span id="line-1409"></span>
<span class="source-line-no">1410</span><span id="line-1410">  /**</span>
<span class="source-line-no">1411</span><span id="line-1411">   * {@inheritDoc}</span>
<span class="source-line-no">1412</span><span id="line-1412">   */</span>
<span class="source-line-no">1413</span><span id="line-1413">  @Override</span>
<span class="source-line-no">1414</span><span id="line-1414">  public void compactRegion(final byte[] regionName, final byte[] columnFamily) throws IOException {</span>
<span class="source-line-no">1415</span><span id="line-1415">    compactRegion(regionName, columnFamily, false);</span>
<span class="source-line-no">1416</span><span id="line-1416">  }</span>
<span class="source-line-no">1417</span><span id="line-1417"></span>
<span class="source-line-no">1418</span><span id="line-1418">  @Override</span>
<span class="source-line-no">1419</span><span id="line-1419">  public Map&lt;ServerName, Boolean&gt; compactionSwitch(boolean switchState,</span>
<span class="source-line-no">1420</span><span id="line-1420">    List&lt;String&gt; serverNamesList) throws IOException {</span>
<span class="source-line-no">1421</span><span id="line-1421">    List&lt;ServerName&gt; serverList = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">1422</span><span id="line-1422">    if (serverNamesList.isEmpty()) {</span>
<span class="source-line-no">1423</span><span id="line-1423">      ClusterMetrics status = getClusterMetrics(EnumSet.of(Option.LIVE_SERVERS));</span>
<span class="source-line-no">1424</span><span id="line-1424">      serverList.addAll(status.getLiveServerMetrics().keySet());</span>
<span class="source-line-no">1425</span><span id="line-1425">    } else {</span>
<span class="source-line-no">1426</span><span id="line-1426">      for (String regionServerName : serverNamesList) {</span>
<span class="source-line-no">1427</span><span id="line-1427">        ServerName serverName = null;</span>
<span class="source-line-no">1428</span><span id="line-1428">        try {</span>
<span class="source-line-no">1429</span><span id="line-1429">          serverName = ServerName.valueOf(regionServerName);</span>
<span class="source-line-no">1430</span><span id="line-1430">        } catch (Exception e) {</span>
<span class="source-line-no">1431</span><span id="line-1431">          throw new IllegalArgumentException(</span>
<span class="source-line-no">1432</span><span id="line-1432">            String.format("Invalid ServerName format: %s", regionServerName));</span>
<span class="source-line-no">1433</span><span id="line-1433">        }</span>
<span class="source-line-no">1434</span><span id="line-1434">        if (serverName == null) {</span>
<span class="source-line-no">1435</span><span id="line-1435">          throw new IllegalArgumentException(</span>
<span class="source-line-no">1436</span><span id="line-1436">            String.format("Null ServerName: %s", regionServerName));</span>
<span class="source-line-no">1437</span><span id="line-1437">        }</span>
<span class="source-line-no">1438</span><span id="line-1438">        serverList.add(serverName);</span>
<span class="source-line-no">1439</span><span id="line-1439">      }</span>
<span class="source-line-no">1440</span><span id="line-1440">    }</span>
<span class="source-line-no">1441</span><span id="line-1441">    Map&lt;ServerName, Boolean&gt; res = new HashMap&lt;&gt;(serverList.size());</span>
<span class="source-line-no">1442</span><span id="line-1442">    for (ServerName serverName : serverList) {</span>
<span class="source-line-no">1443</span><span id="line-1443">      boolean prev_state = switchCompact(this.connection.getAdmin(serverName), switchState);</span>
<span class="source-line-no">1444</span><span id="line-1444">      res.put(serverName, prev_state);</span>
<span class="source-line-no">1445</span><span id="line-1445">    }</span>
<span class="source-line-no">1446</span><span id="line-1446">    return res;</span>
<span class="source-line-no">1447</span><span id="line-1447">  }</span>
<span class="source-line-no">1448</span><span id="line-1448"></span>
<span class="source-line-no">1449</span><span id="line-1449">  private Boolean switchCompact(AdminService.BlockingInterface admin, boolean onOrOff)</span>
<span class="source-line-no">1450</span><span id="line-1450">    throws IOException {</span>
<span class="source-line-no">1451</span><span id="line-1451">    return executeCallable(new RpcRetryingCallable&lt;Boolean&gt;() {</span>
<span class="source-line-no">1452</span><span id="line-1452">      @Override</span>
<span class="source-line-no">1453</span><span id="line-1453">      protected Boolean rpcCall(int callTimeout) throws Exception {</span>
<span class="source-line-no">1454</span><span id="line-1454">        HBaseRpcController controller = rpcControllerFactory.newController();</span>
<span class="source-line-no">1455</span><span id="line-1455">        CompactionSwitchRequest request =</span>
<span class="source-line-no">1456</span><span id="line-1456">          CompactionSwitchRequest.newBuilder().setEnabled(onOrOff).build();</span>
<span class="source-line-no">1457</span><span id="line-1457">        CompactionSwitchResponse compactionSwitchResponse =</span>
<span class="source-line-no">1458</span><span id="line-1458">          admin.compactionSwitch(controller, request);</span>
<span class="source-line-no">1459</span><span id="line-1459">        return compactionSwitchResponse.getPrevState();</span>
<span class="source-line-no">1460</span><span id="line-1460">      }</span>
<span class="source-line-no">1461</span><span id="line-1461">    });</span>
<span class="source-line-no">1462</span><span id="line-1462">  }</span>
<span class="source-line-no">1463</span><span id="line-1463"></span>
<span class="source-line-no">1464</span><span id="line-1464">  @Override</span>
<span class="source-line-no">1465</span><span id="line-1465">  public void compactRegionServer(final ServerName serverName) throws IOException {</span>
<span class="source-line-no">1466</span><span id="line-1466">    for (RegionInfo region : getRegions(serverName)) {</span>
<span class="source-line-no">1467</span><span id="line-1467">      compact(this.connection.getAdmin(serverName), region, false, null);</span>
<span class="source-line-no">1468</span><span id="line-1468">    }</span>
<span class="source-line-no">1469</span><span id="line-1469">  }</span>
<span class="source-line-no">1470</span><span id="line-1470"></span>
<span class="source-line-no">1471</span><span id="line-1471">  @Override</span>
<span class="source-line-no">1472</span><span id="line-1472">  public void majorCompactRegionServer(final ServerName serverName) throws IOException {</span>
<span class="source-line-no">1473</span><span id="line-1473">    for (RegionInfo region : getRegions(serverName)) {</span>
<span class="source-line-no">1474</span><span id="line-1474">      compact(this.connection.getAdmin(serverName), region, true, null);</span>
<span class="source-line-no">1475</span><span id="line-1475">    }</span>
<span class="source-line-no">1476</span><span id="line-1476">  }</span>
<span class="source-line-no">1477</span><span id="line-1477"></span>
<span class="source-line-no">1478</span><span id="line-1478">  @Override</span>
<span class="source-line-no">1479</span><span id="line-1479">  public void majorCompact(final TableName tableName) throws IOException {</span>
<span class="source-line-no">1480</span><span id="line-1480">    compact(tableName, null, true, CompactType.NORMAL);</span>
<span class="source-line-no">1481</span><span id="line-1481">  }</span>
<span class="source-line-no">1482</span><span id="line-1482"></span>
<span class="source-line-no">1483</span><span id="line-1483">  @Override</span>
<span class="source-line-no">1484</span><span id="line-1484">  public void majorCompactRegion(final byte[] regionName) throws IOException {</span>
<span class="source-line-no">1485</span><span id="line-1485">    compactRegion(regionName, null, true);</span>
<span class="source-line-no">1486</span><span id="line-1486">  }</span>
<span class="source-line-no">1487</span><span id="line-1487"></span>
<span class="source-line-no">1488</span><span id="line-1488">  /**</span>
<span class="source-line-no">1489</span><span id="line-1489">   * {@inheritDoc}</span>
<span class="source-line-no">1490</span><span id="line-1490">   */</span>
<span class="source-line-no">1491</span><span id="line-1491">  @Override</span>
<span class="source-line-no">1492</span><span id="line-1492">  public void majorCompact(final TableName tableName, final byte[] columnFamily)</span>
<span class="source-line-no">1493</span><span id="line-1493">    throws IOException {</span>
<span class="source-line-no">1494</span><span id="line-1494">    compact(tableName, columnFamily, true, CompactType.NORMAL);</span>
<span class="source-line-no">1495</span><span id="line-1495">  }</span>
<span class="source-line-no">1496</span><span id="line-1496"></span>
<span class="source-line-no">1497</span><span id="line-1497">  @Override</span>
<span class="source-line-no">1498</span><span id="line-1498">  public void majorCompactRegion(final byte[] regionName, final byte[] columnFamily)</span>
<span class="source-line-no">1499</span><span id="line-1499">    throws IOException {</span>
<span class="source-line-no">1500</span><span id="line-1500">    compactRegion(regionName, columnFamily, true);</span>
<span class="source-line-no">1501</span><span id="line-1501">  }</span>
<span class="source-line-no">1502</span><span id="line-1502"></span>
<span class="source-line-no">1503</span><span id="line-1503">  /**</span>
<span class="source-line-no">1504</span><span id="line-1504">   * Compact a table. Asynchronous operation.</span>
<span class="source-line-no">1505</span><span id="line-1505">   * @param tableName    table or region to compact</span>
<span class="source-line-no">1506</span><span id="line-1506">   * @param columnFamily column family within a table or region</span>
<span class="source-line-no">1507</span><span id="line-1507">   * @param major        True if we are to do a major compaction.</span>
<span class="source-line-no">1508</span><span id="line-1508">   * @param compactType  {@link org.apache.hadoop.hbase.client.CompactType}</span>
<span class="source-line-no">1509</span><span id="line-1509">   * @throws IOException if a remote or network exception occurs</span>
<span class="source-line-no">1510</span><span id="line-1510">   */</span>
<span class="source-line-no">1511</span><span id="line-1511">  private void compact(final TableName tableName, final byte[] columnFamily, final boolean major,</span>
<span class="source-line-no">1512</span><span id="line-1512">    CompactType compactType) throws IOException {</span>
<span class="source-line-no">1513</span><span id="line-1513">    switch (compactType) {</span>
<span class="source-line-no">1514</span><span id="line-1514">      case MOB:</span>
<span class="source-line-no">1515</span><span id="line-1515">        compact(this.connection.getAdminForMaster(), RegionInfo.createMobRegionInfo(tableName),</span>
<span class="source-line-no">1516</span><span id="line-1516">          major, columnFamily);</span>
<span class="source-line-no">1517</span><span id="line-1517">        break;</span>
<span class="source-line-no">1518</span><span id="line-1518">      case NORMAL:</span>
<span class="source-line-no">1519</span><span id="line-1519">        checkTableExists(tableName);</span>
<span class="source-line-no">1520</span><span id="line-1520">        for (HRegionLocation loc : connection.locateRegions(tableName, false, false)) {</span>
<span class="source-line-no">1521</span><span id="line-1521">          ServerName sn = loc.getServerName();</span>
<span class="source-line-no">1522</span><span id="line-1522">          if (sn == null) {</span>
<span class="source-line-no">1523</span><span id="line-1523">            continue;</span>
<span class="source-line-no">1524</span><span id="line-1524">          }</span>
<span class="source-line-no">1525</span><span id="line-1525">          try {</span>
<span class="source-line-no">1526</span><span id="line-1526">            compact(this.connection.getAdmin(sn), loc.getRegion(), major, columnFamily);</span>
<span class="source-line-no">1527</span><span id="line-1527">          } catch (NotServingRegionException e) {</span>
<span class="source-line-no">1528</span><span id="line-1528">            if (LOG.isDebugEnabled()) {</span>
<span class="source-line-no">1529</span><span id="line-1529">              LOG.debug("Trying to" + (major ? " major" : "") + " compact " + loc.getRegion() + ": "</span>
<span class="source-line-no">1530</span><span id="line-1530">                + StringUtils.stringifyException(e));</span>
<span class="source-line-no">1531</span><span id="line-1531">            }</span>
<span class="source-line-no">1532</span><span id="line-1532">          }</span>
<span class="source-line-no">1533</span><span id="line-1533">        }</span>
<span class="source-line-no">1534</span><span id="line-1534">        break;</span>
<span class="source-line-no">1535</span><span id="line-1535">      default:</span>
<span class="source-line-no">1536</span><span id="line-1536">        throw new IllegalArgumentException("Unknown compactType: " + compactType);</span>
<span class="source-line-no">1537</span><span id="line-1537">    }</span>
<span class="source-line-no">1538</span><span id="line-1538">  }</span>
<span class="source-line-no">1539</span><span id="line-1539"></span>
<span class="source-line-no">1540</span><span id="line-1540">  /**</span>
<span class="source-line-no">1541</span><span id="line-1541">   * Compact an individual region. Asynchronous operation.</span>
<span class="source-line-no">1542</span><span id="line-1542">   * @param regionName   region to compact</span>
<span class="source-line-no">1543</span><span id="line-1543">   * @param columnFamily column family within a table or region</span>
<span class="source-line-no">1544</span><span id="line-1544">   * @param major        True if we are to do a major compaction.</span>
<span class="source-line-no">1545</span><span id="line-1545">   * @throws IOException if a remote or network exception occurs</span>
<span class="source-line-no">1546</span><span id="line-1546">   */</span>
<span class="source-line-no">1547</span><span id="line-1547">  private void compactRegion(final byte[] regionName, final byte[] columnFamily,</span>
<span class="source-line-no">1548</span><span id="line-1548">    final boolean major) throws IOException {</span>
<span class="source-line-no">1549</span><span id="line-1549">    Pair&lt;RegionInfo, ServerName&gt; regionServerPair = getRegion(regionName);</span>
<span class="source-line-no">1550</span><span id="line-1550">    if (regionServerPair == null) {</span>
<span class="source-line-no">1551</span><span id="line-1551">      throw new IllegalArgumentException("Invalid region: " + Bytes.toStringBinary(regionName));</span>
<span class="source-line-no">1552</span><span id="line-1552">    }</span>
<span class="source-line-no">1553</span><span id="line-1553">    if (regionServerPair.getSecond() == null) {</span>
<span class="source-line-no">1554</span><span id="line-1554">      throw new NoServerForRegionException(Bytes.toStringBinary(regionName));</span>
<span class="source-line-no">1555</span><span id="line-1555">    }</span>
<span class="source-line-no">1556</span><span id="line-1556">    compact(this.connection.getAdmin(regionServerPair.getSecond()), regionServerPair.getFirst(),</span>
<span class="source-line-no">1557</span><span id="line-1557">      major, columnFamily);</span>
<span class="source-line-no">1558</span><span id="line-1558">  }</span>
<span class="source-line-no">1559</span><span id="line-1559"></span>
<span class="source-line-no">1560</span><span id="line-1560">  private void compact(AdminService.BlockingInterface admin, RegionInfo hri, boolean major,</span>
<span class="source-line-no">1561</span><span id="line-1561">    byte[] family) throws IOException {</span>
<span class="source-line-no">1562</span><span id="line-1562">    Callable&lt;Void&gt; callable = new Callable&lt;Void&gt;() {</span>
<span class="source-line-no">1563</span><span id="line-1563">      @Override</span>
<span class="source-line-no">1564</span><span id="line-1564">      public Void call() throws Exception {</span>
<span class="source-line-no">1565</span><span id="line-1565">        // TODO: There is no timeout on this controller. Set one!</span>
<span class="source-line-no">1566</span><span id="line-1566">        HBaseRpcController controller = rpcControllerFactory.newController();</span>
<span class="source-line-no">1567</span><span id="line-1567">        CompactRegionRequest request =</span>
<span class="source-line-no">1568</span><span id="line-1568">          RequestConverter.buildCompactRegionRequest(hri.getRegionName(), major, family);</span>
<span class="source-line-no">1569</span><span id="line-1569">        admin.compactRegion(controller, request);</span>
<span class="source-line-no">1570</span><span id="line-1570">        return null;</span>
<span class="source-line-no">1571</span><span id="line-1571">      }</span>
<span class="source-line-no">1572</span><span id="line-1572">    };</span>
<span class="source-line-no">1573</span><span id="line-1573">    ProtobufUtil.call(callable);</span>
<span class="source-line-no">1574</span><span id="line-1574">  }</span>
<span class="source-line-no">1575</span><span id="line-1575"></span>
<span class="source-line-no">1576</span><span id="line-1576">  @Override</span>
<span class="source-line-no">1577</span><span id="line-1577">  public void move(byte[] encodedRegionName) throws IOException {</span>
<span class="source-line-no">1578</span><span id="line-1578">    move(encodedRegionName, (ServerName) null);</span>
<span class="source-line-no">1579</span><span id="line-1579">  }</span>
<span class="source-line-no">1580</span><span id="line-1580"></span>
<span class="source-line-no">1581</span><span id="line-1581">  @Override</span>
<span class="source-line-no">1582</span><span id="line-1582">  public void move(final byte[] encodedRegionName, ServerName destServerName) throws IOException {</span>
<span class="source-line-no">1583</span><span id="line-1583">    executeCallable(new MasterCallable&lt;Void&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">1584</span><span id="line-1584">      @Override</span>
<span class="source-line-no">1585</span><span id="line-1585">      protected Void rpcCall() throws Exception {</span>
<span class="source-line-no">1586</span><span id="line-1586">        setPriority(encodedRegionName);</span>
<span class="source-line-no">1587</span><span id="line-1587">        MoveRegionRequest request =</span>
<span class="source-line-no">1588</span><span id="line-1588">          RequestConverter.buildMoveRegionRequest(encodedRegionName, destServerName);</span>
<span class="source-line-no">1589</span><span id="line-1589">        master.moveRegion(getRpcController(), request);</span>
<span class="source-line-no">1590</span><span id="line-1590">        return null;</span>
<span class="source-line-no">1591</span><span id="line-1591">      }</span>
<span class="source-line-no">1592</span><span id="line-1592">    });</span>
<span class="source-line-no">1593</span><span id="line-1593">  }</span>
<span class="source-line-no">1594</span><span id="line-1594"></span>
<span class="source-line-no">1595</span><span id="line-1595">  @Override</span>
<span class="source-line-no">1596</span><span id="line-1596">  public void assign(final byte[] regionName)</span>
<span class="source-line-no">1597</span><span id="line-1597">    throws MasterNotRunningException, ZooKeeperConnectionException, IOException {</span>
<span class="source-line-no">1598</span><span id="line-1598">    executeCallable(new MasterCallable&lt;Void&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">1599</span><span id="line-1599">      @Override</span>
<span class="source-line-no">1600</span><span id="line-1600">      protected Void rpcCall() throws Exception {</span>
<span class="source-line-no">1601</span><span id="line-1601">        setPriority(regionName);</span>
<span class="source-line-no">1602</span><span id="line-1602">        AssignRegionRequest request =</span>
<span class="source-line-no">1603</span><span id="line-1603">          RequestConverter.buildAssignRegionRequest(getRegionName(regionName));</span>
<span class="source-line-no">1604</span><span id="line-1604">        master.assignRegion(getRpcController(), request);</span>
<span class="source-line-no">1605</span><span id="line-1605">        return null;</span>
<span class="source-line-no">1606</span><span id="line-1606">      }</span>
<span class="source-line-no">1607</span><span id="line-1607">    });</span>
<span class="source-line-no">1608</span><span id="line-1608">  }</span>
<span class="source-line-no">1609</span><span id="line-1609"></span>
<span class="source-line-no">1610</span><span id="line-1610">  @Override</span>
<span class="source-line-no">1611</span><span id="line-1611">  public void unassign(final byte[] regionName) throws IOException {</span>
<span class="source-line-no">1612</span><span id="line-1612">    final byte[] toBeUnassigned = getRegionName(regionName);</span>
<span class="source-line-no">1613</span><span id="line-1613">    executeCallable(new MasterCallable&lt;Void&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">1614</span><span id="line-1614">      @Override</span>
<span class="source-line-no">1615</span><span id="line-1615">      protected Void rpcCall() throws Exception {</span>
<span class="source-line-no">1616</span><span id="line-1616">        setPriority(regionName);</span>
<span class="source-line-no">1617</span><span id="line-1617">        UnassignRegionRequest request = RequestConverter.buildUnassignRegionRequest(toBeUnassigned);</span>
<span class="source-line-no">1618</span><span id="line-1618">        master.unassignRegion(getRpcController(), request);</span>
<span class="source-line-no">1619</span><span id="line-1619">        return null;</span>
<span class="source-line-no">1620</span><span id="line-1620">      }</span>
<span class="source-line-no">1621</span><span id="line-1621">    });</span>
<span class="source-line-no">1622</span><span id="line-1622">  }</span>
<span class="source-line-no">1623</span><span id="line-1623"></span>
<span class="source-line-no">1624</span><span id="line-1624">  @Override</span>
<span class="source-line-no">1625</span><span id="line-1625">  public void offline(final byte[] regionName) throws IOException {</span>
<span class="source-line-no">1626</span><span id="line-1626">    executeCallable(new MasterCallable&lt;Void&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">1627</span><span id="line-1627">      @Override</span>
<span class="source-line-no">1628</span><span id="line-1628">      protected Void rpcCall() throws Exception {</span>
<span class="source-line-no">1629</span><span id="line-1629">        setPriority(regionName);</span>
<span class="source-line-no">1630</span><span id="line-1630">        master.offlineRegion(getRpcController(),</span>
<span class="source-line-no">1631</span><span id="line-1631">          RequestConverter.buildOfflineRegionRequest(regionName));</span>
<span class="source-line-no">1632</span><span id="line-1632">        return null;</span>
<span class="source-line-no">1633</span><span id="line-1633">      }</span>
<span class="source-line-no">1634</span><span id="line-1634">    });</span>
<span class="source-line-no">1635</span><span id="line-1635">  }</span>
<span class="source-line-no">1636</span><span id="line-1636"></span>
<span class="source-line-no">1637</span><span id="line-1637">  @Override</span>
<span class="source-line-no">1638</span><span id="line-1638">  public boolean balancerSwitch(final boolean on, final boolean synchronous) throws IOException {</span>
<span class="source-line-no">1639</span><span id="line-1639">    return executeCallable(new MasterCallable&lt;Boolean&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">1640</span><span id="line-1640">      @Override</span>
<span class="source-line-no">1641</span><span id="line-1641">      protected Boolean rpcCall() throws Exception {</span>
<span class="source-line-no">1642</span><span id="line-1642">        SetBalancerRunningRequest req =</span>
<span class="source-line-no">1643</span><span id="line-1643">          RequestConverter.buildSetBalancerRunningRequest(on, synchronous);</span>
<span class="source-line-no">1644</span><span id="line-1644">        return master.setBalancerRunning(getRpcController(), req).getPrevBalanceValue();</span>
<span class="source-line-no">1645</span><span id="line-1645">      }</span>
<span class="source-line-no">1646</span><span id="line-1646">    });</span>
<span class="source-line-no">1647</span><span id="line-1647">  }</span>
<span class="source-line-no">1648</span><span id="line-1648"></span>
<span class="source-line-no">1649</span><span id="line-1649">  @Override</span>
<span class="source-line-no">1650</span><span id="line-1650">  public BalanceResponse balance(BalanceRequest request) throws IOException {</span>
<span class="source-line-no">1651</span><span id="line-1651">    return executeCallable(</span>
<span class="source-line-no">1652</span><span id="line-1652">      new MasterCallable&lt;BalanceResponse&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">1653</span><span id="line-1653">        @Override</span>
<span class="source-line-no">1654</span><span id="line-1654">        protected BalanceResponse rpcCall() throws Exception {</span>
<span class="source-line-no">1655</span><span id="line-1655">          MasterProtos.BalanceRequest req = ProtobufUtil.toBalanceRequest(request);</span>
<span class="source-line-no">1656</span><span id="line-1656">          return ProtobufUtil.toBalanceResponse(master.balance(getRpcController(), req));</span>
<span class="source-line-no">1657</span><span id="line-1657">        }</span>
<span class="source-line-no">1658</span><span id="line-1658">      });</span>
<span class="source-line-no">1659</span><span id="line-1659">  }</span>
<span class="source-line-no">1660</span><span id="line-1660"></span>
<span class="source-line-no">1661</span><span id="line-1661">  @Override</span>
<span class="source-line-no">1662</span><span id="line-1662">  public boolean isBalancerEnabled() throws IOException {</span>
<span class="source-line-no">1663</span><span id="line-1663">    return executeCallable(new MasterCallable&lt;Boolean&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">1664</span><span id="line-1664">      @Override</span>
<span class="source-line-no">1665</span><span id="line-1665">      protected Boolean rpcCall() throws Exception {</span>
<span class="source-line-no">1666</span><span id="line-1666">        return master</span>
<span class="source-line-no">1667</span><span id="line-1667">          .isBalancerEnabled(getRpcController(), RequestConverter.buildIsBalancerEnabledRequest())</span>
<span class="source-line-no">1668</span><span id="line-1668">          .getEnabled();</span>
<span class="source-line-no">1669</span><span id="line-1669">      }</span>
<span class="source-line-no">1670</span><span id="line-1670">    });</span>
<span class="source-line-no">1671</span><span id="line-1671">  }</span>
<span class="source-line-no">1672</span><span id="line-1672"></span>
<span class="source-line-no">1673</span><span id="line-1673">  /**</span>
<span class="source-line-no">1674</span><span id="line-1674">   * {@inheritDoc}</span>
<span class="source-line-no">1675</span><span id="line-1675">   */</span>
<span class="source-line-no">1676</span><span id="line-1676">  @Override</span>
<span class="source-line-no">1677</span><span id="line-1677">  public CacheEvictionStats clearBlockCache(final TableName tableName) throws IOException {</span>
<span class="source-line-no">1678</span><span id="line-1678">    checkTableExists(tableName);</span>
<span class="source-line-no">1679</span><span id="line-1679">    CacheEvictionStatsBuilder cacheEvictionStats = CacheEvictionStats.builder();</span>
<span class="source-line-no">1680</span><span id="line-1680">    List&lt;Pair&lt;RegionInfo, ServerName&gt;&gt; pairs =</span>
<span class="source-line-no">1681</span><span id="line-1681">      MetaTableAccessor.getTableRegionsAndLocations(connection, tableName);</span>
<span class="source-line-no">1682</span><span id="line-1682">    Map&lt;ServerName,</span>
<span class="source-line-no">1683</span><span id="line-1683">      List&lt;RegionInfo&gt;&gt; regionInfoByServerName = pairs.stream()</span>
<span class="source-line-no">1684</span><span id="line-1684">        .filter(pair -&gt; !pair.getFirst().isOffline()).filter(pair -&gt; pair.getSecond() != null)</span>
<span class="source-line-no">1685</span><span id="line-1685">        .collect(Collectors.groupingBy(pair -&gt; pair.getSecond(),</span>
<span class="source-line-no">1686</span><span id="line-1686">          Collectors.mapping(pair -&gt; pair.getFirst(), Collectors.toList())));</span>
<span class="source-line-no">1687</span><span id="line-1687"></span>
<span class="source-line-no">1688</span><span id="line-1688">    for (Map.Entry&lt;ServerName, List&lt;RegionInfo&gt;&gt; entry : regionInfoByServerName.entrySet()) {</span>
<span class="source-line-no">1689</span><span id="line-1689">      CacheEvictionStats stats = clearBlockCache(entry.getKey(), entry.getValue());</span>
<span class="source-line-no">1690</span><span id="line-1690">      cacheEvictionStats = cacheEvictionStats.append(stats);</span>
<span class="source-line-no">1691</span><span id="line-1691">      if (stats.getExceptionCount() &gt; 0) {</span>
<span class="source-line-no">1692</span><span id="line-1692">        for (Map.Entry&lt;byte[], Throwable&gt; exception : stats.getExceptions().entrySet()) {</span>
<span class="source-line-no">1693</span><span id="line-1693">          LOG.debug("Failed to clear block cache for " + Bytes.toStringBinary(exception.getKey())</span>
<span class="source-line-no">1694</span><span id="line-1694">            + " on " + entry.getKey() + ": ", exception.getValue());</span>
<span class="source-line-no">1695</span><span id="line-1695">        }</span>
<span class="source-line-no">1696</span><span id="line-1696">      }</span>
<span class="source-line-no">1697</span><span id="line-1697">    }</span>
<span class="source-line-no">1698</span><span id="line-1698">    return cacheEvictionStats.build();</span>
<span class="source-line-no">1699</span><span id="line-1699">  }</span>
<span class="source-line-no">1700</span><span id="line-1700"></span>
<span class="source-line-no">1701</span><span id="line-1701">  private CacheEvictionStats clearBlockCache(final ServerName sn, final List&lt;RegionInfo&gt; hris)</span>
<span class="source-line-no">1702</span><span id="line-1702">    throws IOException {</span>
<span class="source-line-no">1703</span><span id="line-1703">    HBaseRpcController controller = rpcControllerFactory.newController();</span>
<span class="source-line-no">1704</span><span id="line-1704">    AdminService.BlockingInterface admin = this.connection.getAdmin(sn);</span>
<span class="source-line-no">1705</span><span id="line-1705">    ClearRegionBlockCacheRequest request = RequestConverter.buildClearRegionBlockCacheRequest(hris);</span>
<span class="source-line-no">1706</span><span id="line-1706">    ClearRegionBlockCacheResponse response;</span>
<span class="source-line-no">1707</span><span id="line-1707">    try {</span>
<span class="source-line-no">1708</span><span id="line-1708">      response = admin.clearRegionBlockCache(controller, request);</span>
<span class="source-line-no">1709</span><span id="line-1709">      return ProtobufUtil.toCacheEvictionStats(response.getStats());</span>
<span class="source-line-no">1710</span><span id="line-1710">    } catch (ServiceException se) {</span>
<span class="source-line-no">1711</span><span id="line-1711">      throw ProtobufUtil.getRemoteException(se);</span>
<span class="source-line-no">1712</span><span id="line-1712">    }</span>
<span class="source-line-no">1713</span><span id="line-1713">  }</span>
<span class="source-line-no">1714</span><span id="line-1714"></span>
<span class="source-line-no">1715</span><span id="line-1715">  @Override</span>
<span class="source-line-no">1716</span><span id="line-1716">  public boolean normalize(NormalizeTableFilterParams ntfp) throws IOException {</span>
<span class="source-line-no">1717</span><span id="line-1717">    return executeCallable(new MasterCallable&lt;Boolean&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">1718</span><span id="line-1718">      @Override</span>
<span class="source-line-no">1719</span><span id="line-1719">      protected Boolean rpcCall() throws Exception {</span>
<span class="source-line-no">1720</span><span id="line-1720">        return master.normalize(getRpcController(), RequestConverter.buildNormalizeRequest(ntfp))</span>
<span class="source-line-no">1721</span><span id="line-1721">          .getNormalizerRan();</span>
<span class="source-line-no">1722</span><span id="line-1722">      }</span>
<span class="source-line-no">1723</span><span id="line-1723">    });</span>
<span class="source-line-no">1724</span><span id="line-1724">  }</span>
<span class="source-line-no">1725</span><span id="line-1725"></span>
<span class="source-line-no">1726</span><span id="line-1726">  @Override</span>
<span class="source-line-no">1727</span><span id="line-1727">  public boolean isNormalizerEnabled() throws IOException {</span>
<span class="source-line-no">1728</span><span id="line-1728">    return executeCallable(new MasterCallable&lt;Boolean&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">1729</span><span id="line-1729">      @Override</span>
<span class="source-line-no">1730</span><span id="line-1730">      protected Boolean rpcCall() throws Exception {</span>
<span class="source-line-no">1731</span><span id="line-1731">        return master.isNormalizerEnabled(getRpcController(),</span>
<span class="source-line-no">1732</span><span id="line-1732">          RequestConverter.buildIsNormalizerEnabledRequest()).getEnabled();</span>
<span class="source-line-no">1733</span><span id="line-1733">      }</span>
<span class="source-line-no">1734</span><span id="line-1734">    });</span>
<span class="source-line-no">1735</span><span id="line-1735">  }</span>
<span class="source-line-no">1736</span><span id="line-1736"></span>
<span class="source-line-no">1737</span><span id="line-1737">  @Override</span>
<span class="source-line-no">1738</span><span id="line-1738">  public boolean normalizerSwitch(final boolean on) throws IOException {</span>
<span class="source-line-no">1739</span><span id="line-1739">    return executeCallable(new MasterCallable&lt;Boolean&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">1740</span><span id="line-1740">      @Override</span>
<span class="source-line-no">1741</span><span id="line-1741">      protected Boolean rpcCall() throws Exception {</span>
<span class="source-line-no">1742</span><span id="line-1742">        SetNormalizerRunningRequest req = RequestConverter.buildSetNormalizerRunningRequest(on);</span>
<span class="source-line-no">1743</span><span id="line-1743">        return master.setNormalizerRunning(getRpcController(), req).getPrevNormalizerValue();</span>
<span class="source-line-no">1744</span><span id="line-1744">      }</span>
<span class="source-line-no">1745</span><span id="line-1745">    });</span>
<span class="source-line-no">1746</span><span id="line-1746">  }</span>
<span class="source-line-no">1747</span><span id="line-1747"></span>
<span class="source-line-no">1748</span><span id="line-1748">  @Override</span>
<span class="source-line-no">1749</span><span id="line-1749">  public boolean catalogJanitorSwitch(final boolean enable) throws IOException {</span>
<span class="source-line-no">1750</span><span id="line-1750">    return executeCallable(new MasterCallable&lt;Boolean&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">1751</span><span id="line-1751">      @Override</span>
<span class="source-line-no">1752</span><span id="line-1752">      protected Boolean rpcCall() throws Exception {</span>
<span class="source-line-no">1753</span><span id="line-1753">        return master.enableCatalogJanitor(getRpcController(),</span>
<span class="source-line-no">1754</span><span id="line-1754">          RequestConverter.buildEnableCatalogJanitorRequest(enable)).getPrevValue();</span>
<span class="source-line-no">1755</span><span id="line-1755">      }</span>
<span class="source-line-no">1756</span><span id="line-1756">    });</span>
<span class="source-line-no">1757</span><span id="line-1757">  }</span>
<span class="source-line-no">1758</span><span id="line-1758"></span>
<span class="source-line-no">1759</span><span id="line-1759">  @Override</span>
<span class="source-line-no">1760</span><span id="line-1760">  public int runCatalogJanitor() throws IOException {</span>
<span class="source-line-no">1761</span><span id="line-1761">    return executeCallable(new MasterCallable&lt;Integer&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">1762</span><span id="line-1762">      @Override</span>
<span class="source-line-no">1763</span><span id="line-1763">      protected Integer rpcCall() throws Exception {</span>
<span class="source-line-no">1764</span><span id="line-1764">        return master.runCatalogScan(getRpcController(), RequestConverter.buildCatalogScanRequest())</span>
<span class="source-line-no">1765</span><span id="line-1765">          .getScanResult();</span>
<span class="source-line-no">1766</span><span id="line-1766">      }</span>
<span class="source-line-no">1767</span><span id="line-1767">    });</span>
<span class="source-line-no">1768</span><span id="line-1768">  }</span>
<span class="source-line-no">1769</span><span id="line-1769"></span>
<span class="source-line-no">1770</span><span id="line-1770">  @Override</span>
<span class="source-line-no">1771</span><span id="line-1771">  public boolean isCatalogJanitorEnabled() throws IOException {</span>
<span class="source-line-no">1772</span><span id="line-1772">    return executeCallable(new MasterCallable&lt;Boolean&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">1773</span><span id="line-1773">      @Override</span>
<span class="source-line-no">1774</span><span id="line-1774">      protected Boolean rpcCall() throws Exception {</span>
<span class="source-line-no">1775</span><span id="line-1775">        return master.isCatalogJanitorEnabled(getRpcController(),</span>
<span class="source-line-no">1776</span><span id="line-1776">          RequestConverter.buildIsCatalogJanitorEnabledRequest()).getValue();</span>
<span class="source-line-no">1777</span><span id="line-1777">      }</span>
<span class="source-line-no">1778</span><span id="line-1778">    });</span>
<span class="source-line-no">1779</span><span id="line-1779">  }</span>
<span class="source-line-no">1780</span><span id="line-1780"></span>
<span class="source-line-no">1781</span><span id="line-1781">  @Override</span>
<span class="source-line-no">1782</span><span id="line-1782">  public boolean cleanerChoreSwitch(final boolean on) throws IOException {</span>
<span class="source-line-no">1783</span><span id="line-1783">    return executeCallable(new MasterCallable&lt;Boolean&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">1784</span><span id="line-1784">      @Override</span>
<span class="source-line-no">1785</span><span id="line-1785">      public Boolean rpcCall() throws Exception {</span>
<span class="source-line-no">1786</span><span id="line-1786">        return master.setCleanerChoreRunning(getRpcController(),</span>
<span class="source-line-no">1787</span><span id="line-1787">          RequestConverter.buildSetCleanerChoreRunningRequest(on)).getPrevValue();</span>
<span class="source-line-no">1788</span><span id="line-1788">      }</span>
<span class="source-line-no">1789</span><span id="line-1789">    });</span>
<span class="source-line-no">1790</span><span id="line-1790">  }</span>
<span class="source-line-no">1791</span><span id="line-1791"></span>
<span class="source-line-no">1792</span><span id="line-1792">  @Override</span>
<span class="source-line-no">1793</span><span id="line-1793">  public boolean runCleanerChore() throws IOException {</span>
<span class="source-line-no">1794</span><span id="line-1794">    return executeCallable(new MasterCallable&lt;Boolean&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">1795</span><span id="line-1795">      @Override</span>
<span class="source-line-no">1796</span><span id="line-1796">      public Boolean rpcCall() throws Exception {</span>
<span class="source-line-no">1797</span><span id="line-1797">        return master</span>
<span class="source-line-no">1798</span><span id="line-1798">          .runCleanerChore(getRpcController(), RequestConverter.buildRunCleanerChoreRequest())</span>
<span class="source-line-no">1799</span><span id="line-1799">          .getCleanerChoreRan();</span>
<span class="source-line-no">1800</span><span id="line-1800">      }</span>
<span class="source-line-no">1801</span><span id="line-1801">    });</span>
<span class="source-line-no">1802</span><span id="line-1802">  }</span>
<span class="source-line-no">1803</span><span id="line-1803"></span>
<span class="source-line-no">1804</span><span id="line-1804">  @Override</span>
<span class="source-line-no">1805</span><span id="line-1805">  public boolean isCleanerChoreEnabled() throws IOException {</span>
<span class="source-line-no">1806</span><span id="line-1806">    return executeCallable(new MasterCallable&lt;Boolean&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">1807</span><span id="line-1807">      @Override</span>
<span class="source-line-no">1808</span><span id="line-1808">      public Boolean rpcCall() throws Exception {</span>
<span class="source-line-no">1809</span><span id="line-1809">        return master.isCleanerChoreEnabled(getRpcController(),</span>
<span class="source-line-no">1810</span><span id="line-1810">          RequestConverter.buildIsCleanerChoreEnabledRequest()).getValue();</span>
<span class="source-line-no">1811</span><span id="line-1811">      }</span>
<span class="source-line-no">1812</span><span id="line-1812">    });</span>
<span class="source-line-no">1813</span><span id="line-1813">  }</span>
<span class="source-line-no">1814</span><span id="line-1814"></span>
<span class="source-line-no">1815</span><span id="line-1815">  /**</span>
<span class="source-line-no">1816</span><span id="line-1816">   * Merge two regions. Synchronous operation. Note: It is not feasible to predict the length of</span>
<span class="source-line-no">1817</span><span id="line-1817">   * merge. Therefore, this is for internal testing only.</span>
<span class="source-line-no">1818</span><span id="line-1818">   * @param nameOfRegionA encoded or full name of region a</span>
<span class="source-line-no">1819</span><span id="line-1819">   * @param nameOfRegionB encoded or full name of region b</span>
<span class="source-line-no">1820</span><span id="line-1820">   * @param forcible      true if do a compulsory merge, otherwise we will only merge two adjacent</span>
<span class="source-line-no">1821</span><span id="line-1821">   *                      regions</span>
<span class="source-line-no">1822</span><span id="line-1822">   * @throws IOException if a remote or network exception occurs</span>
<span class="source-line-no">1823</span><span id="line-1823">   */</span>
<span class="source-line-no">1824</span><span id="line-1824">  public void mergeRegionsSync(final byte[] nameOfRegionA, final byte[] nameOfRegionB,</span>
<span class="source-line-no">1825</span><span id="line-1825">    final boolean forcible) throws IOException {</span>
<span class="source-line-no">1826</span><span id="line-1826">    get(mergeRegionsAsync(nameOfRegionA, nameOfRegionB, forcible), syncWaitTimeout,</span>
<span class="source-line-no">1827</span><span id="line-1827">      TimeUnit.MILLISECONDS);</span>
<span class="source-line-no">1828</span><span id="line-1828">  }</span>
<span class="source-line-no">1829</span><span id="line-1829"></span>
<span class="source-line-no">1830</span><span id="line-1830">  /**</span>
<span class="source-line-no">1831</span><span id="line-1831">   * Merge two regions. Asynchronous operation.</span>
<span class="source-line-no">1832</span><span id="line-1832">   * @param nameOfRegionA encoded or full name of region a</span>
<span class="source-line-no">1833</span><span id="line-1833">   * @param nameOfRegionB encoded or full name of region b</span>
<span class="source-line-no">1834</span><span id="line-1834">   * @param forcible      true if do a compulsory merge, otherwise we will only merge two adjacent</span>
<span class="source-line-no">1835</span><span id="line-1835">   *                      regions</span>
<span class="source-line-no">1836</span><span id="line-1836">   * @throws IOException if a remote or network exception occurs</span>
<span class="source-line-no">1837</span><span id="line-1837">   * @deprecated Since 2.0. Will be removed in 3.0. Use</span>
<span class="source-line-no">1838</span><span id="line-1838">   *             {@link #mergeRegionsAsync(byte[], byte[], boolean)} instead.</span>
<span class="source-line-no">1839</span><span id="line-1839">   */</span>
<span class="source-line-no">1840</span><span id="line-1840">  @Deprecated</span>
<span class="source-line-no">1841</span><span id="line-1841">  @Override</span>
<span class="source-line-no">1842</span><span id="line-1842">  public void mergeRegions(final byte[] nameOfRegionA, final byte[] nameOfRegionB,</span>
<span class="source-line-no">1843</span><span id="line-1843">    final boolean forcible) throws IOException {</span>
<span class="source-line-no">1844</span><span id="line-1844">    mergeRegionsAsync(nameOfRegionA, nameOfRegionB, forcible);</span>
<span class="source-line-no">1845</span><span id="line-1845">  }</span>
<span class="source-line-no">1846</span><span id="line-1846"></span>
<span class="source-line-no">1847</span><span id="line-1847">  /**</span>
<span class="source-line-no">1848</span><span id="line-1848">   * Merge two regions. Asynchronous operation.</span>
<span class="source-line-no">1849</span><span id="line-1849">   * @param nameofRegionsToMerge encoded or full name of daughter regions</span>
<span class="source-line-no">1850</span><span id="line-1850">   * @param forcible             true if do a compulsory merge, otherwise we will only merge</span>
<span class="source-line-no">1851</span><span id="line-1851">   *                             adjacent regions</span>
<span class="source-line-no">1852</span><span id="line-1852">   */</span>
<span class="source-line-no">1853</span><span id="line-1853">  @Override</span>
<span class="source-line-no">1854</span><span id="line-1854">  public Future&lt;Void&gt; mergeRegionsAsync(final byte[][] nameofRegionsToMerge, final boolean forcible)</span>
<span class="source-line-no">1855</span><span id="line-1855">    throws IOException {</span>
<span class="source-line-no">1856</span><span id="line-1856">    Preconditions.checkArgument(nameofRegionsToMerge.length &gt;= 2, "Can not merge only %s region",</span>
<span class="source-line-no">1857</span><span id="line-1857">      nameofRegionsToMerge.length);</span>
<span class="source-line-no">1858</span><span id="line-1858">    byte[][] encodedNameofRegionsToMerge = new byte[nameofRegionsToMerge.length][];</span>
<span class="source-line-no">1859</span><span id="line-1859">    for (int i = 0; i &lt; nameofRegionsToMerge.length; i++) {</span>
<span class="source-line-no">1860</span><span id="line-1860">      encodedNameofRegionsToMerge[i] = RegionInfo.isEncodedRegionName(nameofRegionsToMerge[i])</span>
<span class="source-line-no">1861</span><span id="line-1861">        ? nameofRegionsToMerge[i]</span>
<span class="source-line-no">1862</span><span id="line-1862">        : Bytes.toBytes(RegionInfo.encodeRegionName(nameofRegionsToMerge[i]));</span>
<span class="source-line-no">1863</span><span id="line-1863">    }</span>
<span class="source-line-no">1864</span><span id="line-1864"></span>
<span class="source-line-no">1865</span><span id="line-1865">    TableName tableName = null;</span>
<span class="source-line-no">1866</span><span id="line-1866">    Pair&lt;RegionInfo, ServerName&gt; pair;</span>
<span class="source-line-no">1867</span><span id="line-1867"></span>
<span class="source-line-no">1868</span><span id="line-1868">    for (int i = 0; i &lt; nameofRegionsToMerge.length; i++) {</span>
<span class="source-line-no">1869</span><span id="line-1869">      pair = getRegion(nameofRegionsToMerge[i]);</span>
<span class="source-line-no">1870</span><span id="line-1870"></span>
<span class="source-line-no">1871</span><span id="line-1871">      if (pair != null) {</span>
<span class="source-line-no">1872</span><span id="line-1872">        if (pair.getFirst().getReplicaId() != HRegionInfo.DEFAULT_REPLICA_ID) {</span>
<span class="source-line-no">1873</span><span id="line-1873">          throw new IllegalArgumentException("Can't invoke merge on non-default regions directly");</span>
<span class="source-line-no">1874</span><span id="line-1874">        }</span>
<span class="source-line-no">1875</span><span id="line-1875">        if (tableName == null) {</span>
<span class="source-line-no">1876</span><span id="line-1876">          tableName = pair.getFirst().getTable();</span>
<span class="source-line-no">1877</span><span id="line-1877">        } else if (!tableName.equals(pair.getFirst().getTable())) {</span>
<span class="source-line-no">1878</span><span id="line-1878">          throw new IllegalArgumentException("Cannot merge regions from two different tables "</span>
<span class="source-line-no">1879</span><span id="line-1879">            + tableName + " and " + pair.getFirst().getTable());</span>
<span class="source-line-no">1880</span><span id="line-1880">        }</span>
<span class="source-line-no">1881</span><span id="line-1881">      } else {</span>
<span class="source-line-no">1882</span><span id="line-1882">        throw new UnknownRegionException("Can't invoke merge on unknown region "</span>
<span class="source-line-no">1883</span><span id="line-1883">          + Bytes.toStringBinary(encodedNameofRegionsToMerge[i]));</span>
<span class="source-line-no">1884</span><span id="line-1884">      }</span>
<span class="source-line-no">1885</span><span id="line-1885">    }</span>
<span class="source-line-no">1886</span><span id="line-1886"></span>
<span class="source-line-no">1887</span><span id="line-1887">    MergeTableRegionsResponse response = executeCallable(</span>
<span class="source-line-no">1888</span><span id="line-1888">      new MasterCallable&lt;MergeTableRegionsResponse&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">1889</span><span id="line-1889">        Long nonceGroup = ng.getNonceGroup();</span>
<span class="source-line-no">1890</span><span id="line-1890">        Long nonce = ng.newNonce();</span>
<span class="source-line-no">1891</span><span id="line-1891"></span>
<span class="source-line-no">1892</span><span id="line-1892">        @Override</span>
<span class="source-line-no">1893</span><span id="line-1893">        protected MergeTableRegionsResponse rpcCall() throws Exception {</span>
<span class="source-line-no">1894</span><span id="line-1894">          MergeTableRegionsRequest request = RequestConverter.buildMergeTableRegionsRequest(</span>
<span class="source-line-no">1895</span><span id="line-1895">            encodedNameofRegionsToMerge, forcible, nonceGroup, nonce);</span>
<span class="source-line-no">1896</span><span id="line-1896">          return master.mergeTableRegions(getRpcController(), request);</span>
<span class="source-line-no">1897</span><span id="line-1897">        }</span>
<span class="source-line-no">1898</span><span id="line-1898">      });</span>
<span class="source-line-no">1899</span><span id="line-1899">    return new MergeTableRegionsFuture(this, tableName, response);</span>
<span class="source-line-no">1900</span><span id="line-1900">  }</span>
<span class="source-line-no">1901</span><span id="line-1901"></span>
<span class="source-line-no">1902</span><span id="line-1902">  private static class MergeTableRegionsFuture extends TableFuture&lt;Void&gt; {</span>
<span class="source-line-no">1903</span><span id="line-1903">    public MergeTableRegionsFuture(final HBaseAdmin admin, final TableName tableName,</span>
<span class="source-line-no">1904</span><span id="line-1904">      final MergeTableRegionsResponse response) {</span>
<span class="source-line-no">1905</span><span id="line-1905">      super(admin, tableName,</span>
<span class="source-line-no">1906</span><span id="line-1906">        (response != null &amp;&amp; response.hasProcId()) ? response.getProcId() : null);</span>
<span class="source-line-no">1907</span><span id="line-1907">    }</span>
<span class="source-line-no">1908</span><span id="line-1908"></span>
<span class="source-line-no">1909</span><span id="line-1909">    public MergeTableRegionsFuture(final HBaseAdmin admin, final TableName tableName,</span>
<span class="source-line-no">1910</span><span id="line-1910">      final Long procId) {</span>
<span class="source-line-no">1911</span><span id="line-1911">      super(admin, tableName, procId);</span>
<span class="source-line-no">1912</span><span id="line-1912">    }</span>
<span class="source-line-no">1913</span><span id="line-1913"></span>
<span class="source-line-no">1914</span><span id="line-1914">    @Override</span>
<span class="source-line-no">1915</span><span id="line-1915">    public String getOperationType() {</span>
<span class="source-line-no">1916</span><span id="line-1916">      return "MERGE_REGIONS";</span>
<span class="source-line-no">1917</span><span id="line-1917">    }</span>
<span class="source-line-no">1918</span><span id="line-1918">  }</span>
<span class="source-line-no">1919</span><span id="line-1919"></span>
<span class="source-line-no">1920</span><span id="line-1920">  /**</span>
<span class="source-line-no">1921</span><span id="line-1921">   * Split one region. Synchronous operation. Note: It is not feasible to predict the length of</span>
<span class="source-line-no">1922</span><span id="line-1922">   * split. Therefore, this is for internal testing only.</span>
<span class="source-line-no">1923</span><span id="line-1923">   * @param regionName encoded or full name of region</span>
<span class="source-line-no">1924</span><span id="line-1924">   * @param splitPoint key where region splits</span>
<span class="source-line-no">1925</span><span id="line-1925">   * @throws IOException if a remote or network exception occurs</span>
<span class="source-line-no">1926</span><span id="line-1926">   */</span>
<span class="source-line-no">1927</span><span id="line-1927">  public void splitRegionSync(byte[] regionName, byte[] splitPoint) throws IOException {</span>
<span class="source-line-no">1928</span><span id="line-1928">    splitRegionSync(regionName, splitPoint, syncWaitTimeout, TimeUnit.MILLISECONDS);</span>
<span class="source-line-no">1929</span><span id="line-1929">  }</span>
<span class="source-line-no">1930</span><span id="line-1930"></span>
<span class="source-line-no">1931</span><span id="line-1931">  /**</span>
<span class="source-line-no">1932</span><span id="line-1932">   * Split one region. Synchronous operation.</span>
<span class="source-line-no">1933</span><span id="line-1933">   * @param regionName region to be split</span>
<span class="source-line-no">1934</span><span id="line-1934">   * @param splitPoint split point</span>
<span class="source-line-no">1935</span><span id="line-1935">   * @param timeout    how long to wait on split</span>
<span class="source-line-no">1936</span><span id="line-1936">   * @param units      time units</span>
<span class="source-line-no">1937</span><span id="line-1937">   * @throws IOException if a remote or network exception occurs</span>
<span class="source-line-no">1938</span><span id="line-1938">   */</span>
<span class="source-line-no">1939</span><span id="line-1939">  public void splitRegionSync(byte[] regionName, byte[] splitPoint, final long timeout,</span>
<span class="source-line-no">1940</span><span id="line-1940">    final TimeUnit units) throws IOException {</span>
<span class="source-line-no">1941</span><span id="line-1941">    get(splitRegionAsync(regionName, splitPoint), timeout, units);</span>
<span class="source-line-no">1942</span><span id="line-1942">  }</span>
<span class="source-line-no">1943</span><span id="line-1943"></span>
<span class="source-line-no">1944</span><span id="line-1944">  @Override</span>
<span class="source-line-no">1945</span><span id="line-1945">  public Future&lt;Void&gt; splitRegionAsync(byte[] regionName, byte[] splitPoint) throws IOException {</span>
<span class="source-line-no">1946</span><span id="line-1946">    byte[] encodedNameofRegionToSplit = HRegionInfo.isEncodedRegionName(regionName)</span>
<span class="source-line-no">1947</span><span id="line-1947">      ? regionName</span>
<span class="source-line-no">1948</span><span id="line-1948">      : Bytes.toBytes(HRegionInfo.encodeRegionName(regionName));</span>
<span class="source-line-no">1949</span><span id="line-1949">    Pair&lt;RegionInfo, ServerName&gt; pair = getRegion(regionName);</span>
<span class="source-line-no">1950</span><span id="line-1950">    if (pair != null) {</span>
<span class="source-line-no">1951</span><span id="line-1951">      if (</span>
<span class="source-line-no">1952</span><span id="line-1952">        pair.getFirst() != null &amp;&amp; pair.getFirst().getReplicaId() != HRegionInfo.DEFAULT_REPLICA_ID</span>
<span class="source-line-no">1953</span><span id="line-1953">      ) {</span>
<span class="source-line-no">1954</span><span id="line-1954">        throw new IllegalArgumentException("Can't invoke split on non-default regions directly");</span>
<span class="source-line-no">1955</span><span id="line-1955">      }</span>
<span class="source-line-no">1956</span><span id="line-1956">    } else {</span>
<span class="source-line-no">1957</span><span id="line-1957">      throw new UnknownRegionException(</span>
<span class="source-line-no">1958</span><span id="line-1958">        "Can't invoke merge on unknown region " + Bytes.toStringBinary(encodedNameofRegionToSplit));</span>
<span class="source-line-no">1959</span><span id="line-1959">    }</span>
<span class="source-line-no">1960</span><span id="line-1960"></span>
<span class="source-line-no">1961</span><span id="line-1961">    return splitRegionAsync(pair.getFirst(), splitPoint);</span>
<span class="source-line-no">1962</span><span id="line-1962">  }</span>
<span class="source-line-no">1963</span><span id="line-1963"></span>
<span class="source-line-no">1964</span><span id="line-1964">  Future&lt;Void&gt; splitRegionAsync(RegionInfo hri, byte[] splitPoint) throws IOException {</span>
<span class="source-line-no">1965</span><span id="line-1965">    TableName tableName = hri.getTable();</span>
<span class="source-line-no">1966</span><span id="line-1966">    if (</span>
<span class="source-line-no">1967</span><span id="line-1967">      hri.getStartKey() != null &amp;&amp; splitPoint != null</span>
<span class="source-line-no">1968</span><span id="line-1968">        &amp;&amp; Bytes.compareTo(hri.getStartKey(), splitPoint) == 0</span>
<span class="source-line-no">1969</span><span id="line-1969">    ) {</span>
<span class="source-line-no">1970</span><span id="line-1970">      throw new IOException("should not give a splitkey which equals to startkey!");</span>
<span class="source-line-no">1971</span><span id="line-1971">    }</span>
<span class="source-line-no">1972</span><span id="line-1972"></span>
<span class="source-line-no">1973</span><span id="line-1973">    SplitTableRegionResponse response = executeCallable(</span>
<span class="source-line-no">1974</span><span id="line-1974">      new MasterCallable&lt;SplitTableRegionResponse&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">1975</span><span id="line-1975">        Long nonceGroup = ng.getNonceGroup();</span>
<span class="source-line-no">1976</span><span id="line-1976">        Long nonce = ng.newNonce();</span>
<span class="source-line-no">1977</span><span id="line-1977"></span>
<span class="source-line-no">1978</span><span id="line-1978">        @Override</span>
<span class="source-line-no">1979</span><span id="line-1979">        protected SplitTableRegionResponse rpcCall() throws Exception {</span>
<span class="source-line-no">1980</span><span id="line-1980">          setPriority(tableName);</span>
<span class="source-line-no">1981</span><span id="line-1981">          SplitTableRegionRequest request =</span>
<span class="source-line-no">1982</span><span id="line-1982">            RequestConverter.buildSplitTableRegionRequest(hri, splitPoint, nonceGroup, nonce);</span>
<span class="source-line-no">1983</span><span id="line-1983">          return master.splitRegion(getRpcController(), request);</span>
<span class="source-line-no">1984</span><span id="line-1984">        }</span>
<span class="source-line-no">1985</span><span id="line-1985">      });</span>
<span class="source-line-no">1986</span><span id="line-1986">    return new SplitTableRegionFuture(this, tableName, response);</span>
<span class="source-line-no">1987</span><span id="line-1987">  }</span>
<span class="source-line-no">1988</span><span id="line-1988"></span>
<span class="source-line-no">1989</span><span id="line-1989">  private static class SplitTableRegionFuture extends TableFuture&lt;Void&gt; {</span>
<span class="source-line-no">1990</span><span id="line-1990">    public SplitTableRegionFuture(final HBaseAdmin admin, final TableName tableName,</span>
<span class="source-line-no">1991</span><span id="line-1991">      final SplitTableRegionResponse response) {</span>
<span class="source-line-no">1992</span><span id="line-1992">      super(admin, tableName,</span>
<span class="source-line-no">1993</span><span id="line-1993">        (response != null &amp;&amp; response.hasProcId()) ? response.getProcId() : null);</span>
<span class="source-line-no">1994</span><span id="line-1994">    }</span>
<span class="source-line-no">1995</span><span id="line-1995"></span>
<span class="source-line-no">1996</span><span id="line-1996">    public SplitTableRegionFuture(final HBaseAdmin admin, final TableName tableName,</span>
<span class="source-line-no">1997</span><span id="line-1997">      final Long procId) {</span>
<span class="source-line-no">1998</span><span id="line-1998">      super(admin, tableName, procId);</span>
<span class="source-line-no">1999</span><span id="line-1999">    }</span>
<span class="source-line-no">2000</span><span id="line-2000"></span>
<span class="source-line-no">2001</span><span id="line-2001">    @Override</span>
<span class="source-line-no">2002</span><span id="line-2002">    public String getOperationType() {</span>
<span class="source-line-no">2003</span><span id="line-2003">      return "SPLIT_REGION";</span>
<span class="source-line-no">2004</span><span id="line-2004">    }</span>
<span class="source-line-no">2005</span><span id="line-2005">  }</span>
<span class="source-line-no">2006</span><span id="line-2006"></span>
<span class="source-line-no">2007</span><span id="line-2007">  @Override</span>
<span class="source-line-no">2008</span><span id="line-2008">  public void split(final TableName tableName) throws IOException {</span>
<span class="source-line-no">2009</span><span id="line-2009">    split(tableName, null);</span>
<span class="source-line-no">2010</span><span id="line-2010">  }</span>
<span class="source-line-no">2011</span><span id="line-2011"></span>
<span class="source-line-no">2012</span><span id="line-2012">  @Override</span>
<span class="source-line-no">2013</span><span id="line-2013">  public void splitRegion(final byte[] regionName) throws IOException {</span>
<span class="source-line-no">2014</span><span id="line-2014">    splitRegion(regionName, null);</span>
<span class="source-line-no">2015</span><span id="line-2015">  }</span>
<span class="source-line-no">2016</span><span id="line-2016"></span>
<span class="source-line-no">2017</span><span id="line-2017">  @Override</span>
<span class="source-line-no">2018</span><span id="line-2018">  public void split(final TableName tableName, final byte[] splitPoint) throws IOException {</span>
<span class="source-line-no">2019</span><span id="line-2019">    checkTableExists(tableName);</span>
<span class="source-line-no">2020</span><span id="line-2020">    for (HRegionLocation loc : connection.locateRegions(tableName, false, false)) {</span>
<span class="source-line-no">2021</span><span id="line-2021">      ServerName sn = loc.getServerName();</span>
<span class="source-line-no">2022</span><span id="line-2022">      if (sn == null) {</span>
<span class="source-line-no">2023</span><span id="line-2023">        continue;</span>
<span class="source-line-no">2024</span><span id="line-2024">      }</span>
<span class="source-line-no">2025</span><span id="line-2025">      RegionInfo r = loc.getRegion();</span>
<span class="source-line-no">2026</span><span id="line-2026">      // check for parents</span>
<span class="source-line-no">2027</span><span id="line-2027">      if (r.isSplitParent()) {</span>
<span class="source-line-no">2028</span><span id="line-2028">        continue;</span>
<span class="source-line-no">2029</span><span id="line-2029">      }</span>
<span class="source-line-no">2030</span><span id="line-2030">      // if a split point given, only split that particular region</span>
<span class="source-line-no">2031</span><span id="line-2031">      if (</span>
<span class="source-line-no">2032</span><span id="line-2032">        r.getReplicaId() != RegionInfo.DEFAULT_REPLICA_ID</span>
<span class="source-line-no">2033</span><span id="line-2033">          || (splitPoint != null &amp;&amp; !r.containsRow(splitPoint))</span>
<span class="source-line-no">2034</span><span id="line-2034">      ) {</span>
<span class="source-line-no">2035</span><span id="line-2035">        continue;</span>
<span class="source-line-no">2036</span><span id="line-2036">      }</span>
<span class="source-line-no">2037</span><span id="line-2037">      // call out to master to do split now</span>
<span class="source-line-no">2038</span><span id="line-2038">      splitRegionAsync(r, splitPoint);</span>
<span class="source-line-no">2039</span><span id="line-2039">    }</span>
<span class="source-line-no">2040</span><span id="line-2040">  }</span>
<span class="source-line-no">2041</span><span id="line-2041"></span>
<span class="source-line-no">2042</span><span id="line-2042">  @Override</span>
<span class="source-line-no">2043</span><span id="line-2043">  public void splitRegion(final byte[] regionName, final byte[] splitPoint) throws IOException {</span>
<span class="source-line-no">2044</span><span id="line-2044">    Pair&lt;RegionInfo, ServerName&gt; regionServerPair = getRegion(regionName);</span>
<span class="source-line-no">2045</span><span id="line-2045">    if (regionServerPair == null) {</span>
<span class="source-line-no">2046</span><span id="line-2046">      throw new IllegalArgumentException("Invalid region: " + Bytes.toStringBinary(regionName));</span>
<span class="source-line-no">2047</span><span id="line-2047">    }</span>
<span class="source-line-no">2048</span><span id="line-2048">    if (</span>
<span class="source-line-no">2049</span><span id="line-2049">      regionServerPair.getFirst() != null</span>
<span class="source-line-no">2050</span><span id="line-2050">        &amp;&amp; regionServerPair.getFirst().getReplicaId() != HRegionInfo.DEFAULT_REPLICA_ID</span>
<span class="source-line-no">2051</span><span id="line-2051">    ) {</span>
<span class="source-line-no">2052</span><span id="line-2052">      throw new IllegalArgumentException(</span>
<span class="source-line-no">2053</span><span id="line-2053">        "Can't split replicas directly. " + "Replicas are auto-split when their primary is split.");</span>
<span class="source-line-no">2054</span><span id="line-2054">    }</span>
<span class="source-line-no">2055</span><span id="line-2055">    if (regionServerPair.getSecond() == null) {</span>
<span class="source-line-no">2056</span><span id="line-2056">      throw new NoServerForRegionException(Bytes.toStringBinary(regionName));</span>
<span class="source-line-no">2057</span><span id="line-2057">    }</span>
<span class="source-line-no">2058</span><span id="line-2058">    splitRegionAsync(regionServerPair.getFirst(), splitPoint);</span>
<span class="source-line-no">2059</span><span id="line-2059">  }</span>
<span class="source-line-no">2060</span><span id="line-2060"></span>
<span class="source-line-no">2061</span><span id="line-2061">  @Override</span>
<span class="source-line-no">2062</span><span id="line-2062">  public void truncateRegion(byte[] regionName) throws IOException {</span>
<span class="source-line-no">2063</span><span id="line-2063">    get(truncateRegionAsync(regionName), syncWaitTimeout, TimeUnit.MILLISECONDS);</span>
<span class="source-line-no">2064</span><span id="line-2064">  }</span>
<span class="source-line-no">2065</span><span id="line-2065"></span>
<span class="source-line-no">2066</span><span id="line-2066">  @Override</span>
<span class="source-line-no">2067</span><span id="line-2067">  public Future&lt;Void&gt; truncateRegionAsync(byte[] regionName) throws IOException {</span>
<span class="source-line-no">2068</span><span id="line-2068">    Pair&lt;RegionInfo, ServerName&gt; pair = getRegion(regionName);</span>
<span class="source-line-no">2069</span><span id="line-2069">    RegionInfo hri;</span>
<span class="source-line-no">2070</span><span id="line-2070"></span>
<span class="source-line-no">2071</span><span id="line-2071">    if (pair != null) {</span>
<span class="source-line-no">2072</span><span id="line-2072">      hri = pair.getFirst();</span>
<span class="source-line-no">2073</span><span id="line-2073">      if (hri != null &amp;&amp; hri.getReplicaId() != HRegionInfo.DEFAULT_REPLICA_ID) {</span>
<span class="source-line-no">2074</span><span id="line-2074">        throw new IllegalArgumentException(</span>
<span class="source-line-no">2075</span><span id="line-2075">          "Can't truncate replicas directly.Replicas are auto-truncated "</span>
<span class="source-line-no">2076</span><span id="line-2076">            + "when their primary is truncated.");</span>
<span class="source-line-no">2077</span><span id="line-2077">      }</span>
<span class="source-line-no">2078</span><span id="line-2078">    } else {</span>
<span class="source-line-no">2079</span><span id="line-2079">      throw new IllegalArgumentException("Invalid region: " + Bytes.toStringBinary(regionName));</span>
<span class="source-line-no">2080</span><span id="line-2080">    }</span>
<span class="source-line-no">2081</span><span id="line-2081"></span>
<span class="source-line-no">2082</span><span id="line-2082">    TableName tableName = (hri != null) ? hri.getTable() : null;</span>
<span class="source-line-no">2083</span><span id="line-2083"></span>
<span class="source-line-no">2084</span><span id="line-2084">    MasterProtos.TruncateRegionResponse response =</span>
<span class="source-line-no">2085</span><span id="line-2085">      executeCallable(getTruncateRegionCallable(tableName, hri));</span>
<span class="source-line-no">2086</span><span id="line-2086"></span>
<span class="source-line-no">2087</span><span id="line-2087">    return new TruncateRegionFuture(this, tableName, response);</span>
<span class="source-line-no">2088</span><span id="line-2088">  }</span>
<span class="source-line-no">2089</span><span id="line-2089"></span>
<span class="source-line-no">2090</span><span id="line-2090">  /**</span>
<span class="source-line-no">2091</span><span id="line-2091">   * Get the list of cached files</span>
<span class="source-line-no">2092</span><span id="line-2092">   */</span>
<span class="source-line-no">2093</span><span id="line-2093">  @Override</span>
<span class="source-line-no">2094</span><span id="line-2094">  public List&lt;String&gt; getCachedFilesList(ServerName serverName) throws IOException {</span>
<span class="source-line-no">2095</span><span id="line-2095">    return ProtobufUtil.getCachedFilesList(rpcControllerFactory.newController(),</span>
<span class="source-line-no">2096</span><span id="line-2096">      this.connection.getAdmin(serverName));</span>
<span class="source-line-no">2097</span><span id="line-2097">  }</span>
<span class="source-line-no">2098</span><span id="line-2098"></span>
<span class="source-line-no">2099</span><span id="line-2099">  private MasterCallable&lt;MasterProtos.TruncateRegionResponse&gt;</span>
<span class="source-line-no">2100</span><span id="line-2100">    getTruncateRegionCallable(TableName tableName, RegionInfo hri) {</span>
<span class="source-line-no">2101</span><span id="line-2101">    return new MasterCallable&lt;MasterProtos.TruncateRegionResponse&gt;(getConnection(),</span>
<span class="source-line-no">2102</span><span id="line-2102">      getRpcControllerFactory()) {</span>
<span class="source-line-no">2103</span><span id="line-2103">      Long nonceGroup = ng.getNonceGroup();</span>
<span class="source-line-no">2104</span><span id="line-2104">      Long nonce = ng.newNonce();</span>
<span class="source-line-no">2105</span><span id="line-2105"></span>
<span class="source-line-no">2106</span><span id="line-2106">      @Override</span>
<span class="source-line-no">2107</span><span id="line-2107">      protected MasterProtos.TruncateRegionResponse rpcCall() throws Exception {</span>
<span class="source-line-no">2108</span><span id="line-2108">        setPriority(tableName);</span>
<span class="source-line-no">2109</span><span id="line-2109">        MasterProtos.TruncateRegionRequest request =</span>
<span class="source-line-no">2110</span><span id="line-2110">          RequestConverter.buildTruncateRegionRequest(hri, nonceGroup, nonce);</span>
<span class="source-line-no">2111</span><span id="line-2111">        return master.truncateRegion(getRpcController(), request);</span>
<span class="source-line-no">2112</span><span id="line-2112">      }</span>
<span class="source-line-no">2113</span><span id="line-2113">    };</span>
<span class="source-line-no">2114</span><span id="line-2114">  }</span>
<span class="source-line-no">2115</span><span id="line-2115"></span>
<span class="source-line-no">2116</span><span id="line-2116">  private static class TruncateRegionFuture extends TableFuture&lt;Void&gt; {</span>
<span class="source-line-no">2117</span><span id="line-2117">    public TruncateRegionFuture(final HBaseAdmin admin, final TableName tableName,</span>
<span class="source-line-no">2118</span><span id="line-2118">      final MasterProtos.TruncateRegionResponse response) {</span>
<span class="source-line-no">2119</span><span id="line-2119">      super(admin, tableName,</span>
<span class="source-line-no">2120</span><span id="line-2120">        (response != null &amp;&amp; response.hasProcId()) ? response.getProcId() : null);</span>
<span class="source-line-no">2121</span><span id="line-2121">    }</span>
<span class="source-line-no">2122</span><span id="line-2122"></span>
<span class="source-line-no">2123</span><span id="line-2123">    @Override</span>
<span class="source-line-no">2124</span><span id="line-2124">    public String getOperationType() {</span>
<span class="source-line-no">2125</span><span id="line-2125">      return "TRUNCATE_REGION";</span>
<span class="source-line-no">2126</span><span id="line-2126">    }</span>
<span class="source-line-no">2127</span><span id="line-2127">  }</span>
<span class="source-line-no">2128</span><span id="line-2128"></span>
<span class="source-line-no">2129</span><span id="line-2129">  private static class ModifyTableFuture extends TableFuture&lt;Void&gt; {</span>
<span class="source-line-no">2130</span><span id="line-2130">    public ModifyTableFuture(final HBaseAdmin admin, final TableName tableName,</span>
<span class="source-line-no">2131</span><span id="line-2131">      final ModifyTableResponse response) {</span>
<span class="source-line-no">2132</span><span id="line-2132">      super(admin, tableName,</span>
<span class="source-line-no">2133</span><span id="line-2133">        (response != null &amp;&amp; response.hasProcId()) ? response.getProcId() : null);</span>
<span class="source-line-no">2134</span><span id="line-2134">    }</span>
<span class="source-line-no">2135</span><span id="line-2135"></span>
<span class="source-line-no">2136</span><span id="line-2136">    public ModifyTableFuture(final HBaseAdmin admin, final TableName tableName, final Long procId) {</span>
<span class="source-line-no">2137</span><span id="line-2137">      super(admin, tableName, procId);</span>
<span class="source-line-no">2138</span><span id="line-2138">    }</span>
<span class="source-line-no">2139</span><span id="line-2139"></span>
<span class="source-line-no">2140</span><span id="line-2140">    @Override</span>
<span class="source-line-no">2141</span><span id="line-2141">    public String getOperationType() {</span>
<span class="source-line-no">2142</span><span id="line-2142">      return "MODIFY";</span>
<span class="source-line-no">2143</span><span id="line-2143">    }</span>
<span class="source-line-no">2144</span><span id="line-2144"></span>
<span class="source-line-no">2145</span><span id="line-2145">    @Override</span>
<span class="source-line-no">2146</span><span id="line-2146">    protected Void postOperationResult(final Void result, final long deadlineTs)</span>
<span class="source-line-no">2147</span><span id="line-2147">      throws IOException, TimeoutException {</span>
<span class="source-line-no">2148</span><span id="line-2148">      // The modify operation on the table is asynchronous on the server side irrespective</span>
<span class="source-line-no">2149</span><span id="line-2149">      // of whether Procedure V2 is supported or not. So, we wait in the client till</span>
<span class="source-line-no">2150</span><span id="line-2150">      // all regions get updated.</span>
<span class="source-line-no">2151</span><span id="line-2151">      waitForSchemaUpdate(deadlineTs);</span>
<span class="source-line-no">2152</span><span id="line-2152">      return result;</span>
<span class="source-line-no">2153</span><span id="line-2153">    }</span>
<span class="source-line-no">2154</span><span id="line-2154">  }</span>
<span class="source-line-no">2155</span><span id="line-2155"></span>
<span class="source-line-no">2156</span><span id="line-2156">  /**</span>
<span class="source-line-no">2157</span><span id="line-2157">   * @param regionName Name of a region.</span>
<span class="source-line-no">2158</span><span id="line-2158">   * @return a pair of HRegionInfo and ServerName if &lt;code&gt;regionName&lt;/code&gt; is a verified region</span>
<span class="source-line-no">2159</span><span id="line-2159">   *         name (we call {@link MetaTableAccessor#getRegionLocation(Connection, byte[])} else</span>
<span class="source-line-no">2160</span><span id="line-2160">   *         null. Throw IllegalArgumentException if &lt;code&gt;regionName&lt;/code&gt; is null.</span>
<span class="source-line-no">2161</span><span id="line-2161">   * @throws IOException if a remote or network exception occurs</span>
<span class="source-line-no">2162</span><span id="line-2162">   */</span>
<span class="source-line-no">2163</span><span id="line-2163">  Pair&lt;RegionInfo, ServerName&gt; getRegion(final byte[] regionName) throws IOException {</span>
<span class="source-line-no">2164</span><span id="line-2164">    if (regionName == null) {</span>
<span class="source-line-no">2165</span><span id="line-2165">      throw new IllegalArgumentException("Pass a table name or region name");</span>
<span class="source-line-no">2166</span><span id="line-2166">    }</span>
<span class="source-line-no">2167</span><span id="line-2167">    Pair&lt;RegionInfo, ServerName&gt; pair = MetaTableAccessor.getRegion(connection, regionName);</span>
<span class="source-line-no">2168</span><span id="line-2168">    if (pair == null) {</span>
<span class="source-line-no">2169</span><span id="line-2169">      final String encodedName = Bytes.toString(regionName);</span>
<span class="source-line-no">2170</span><span id="line-2170">      // When it is not a valid regionName, it is possible that it could be an encoded regionName.</span>
<span class="source-line-no">2171</span><span id="line-2171">      // To match the encoded regionName, it has to scan the meta table and compare entry by entry.</span>
<span class="source-line-no">2172</span><span id="line-2172">      // Since it scans meta table, so it has to be the MD5 hash, it can filter out</span>
<span class="source-line-no">2173</span><span id="line-2173">      // most of invalid cases.</span>
<span class="source-line-no">2174</span><span id="line-2174">      if (!RegionInfo.isMD5Hash(encodedName)) {</span>
<span class="source-line-no">2175</span><span id="line-2175">        return null;</span>
<span class="source-line-no">2176</span><span id="line-2176">      }</span>
<span class="source-line-no">2177</span><span id="line-2177">      final AtomicReference&lt;Pair&lt;RegionInfo, ServerName&gt;&gt; result = new AtomicReference&lt;&gt;(null);</span>
<span class="source-line-no">2178</span><span id="line-2178">      MetaTableAccessor.Visitor visitor = new MetaTableAccessor.Visitor() {</span>
<span class="source-line-no">2179</span><span id="line-2179">        @Override</span>
<span class="source-line-no">2180</span><span id="line-2180">        public boolean visit(Result data) throws IOException {</span>
<span class="source-line-no">2181</span><span id="line-2181">          RegionInfo info = MetaTableAccessor.getRegionInfo(data);</span>
<span class="source-line-no">2182</span><span id="line-2182">          if (info == null) {</span>
<span class="source-line-no">2183</span><span id="line-2183">            LOG.warn("No serialized HRegionInfo in " + data);</span>
<span class="source-line-no">2184</span><span id="line-2184">            return true;</span>
<span class="source-line-no">2185</span><span id="line-2185">          }</span>
<span class="source-line-no">2186</span><span id="line-2186">          RegionLocations rl = MetaTableAccessor.getRegionLocations(data);</span>
<span class="source-line-no">2187</span><span id="line-2187">          boolean matched = false;</span>
<span class="source-line-no">2188</span><span id="line-2188">          ServerName sn = null;</span>
<span class="source-line-no">2189</span><span id="line-2189">          if (rl != null) {</span>
<span class="source-line-no">2190</span><span id="line-2190">            for (HRegionLocation h : rl.getRegionLocations()) {</span>
<span class="source-line-no">2191</span><span id="line-2191">              if (h != null &amp;&amp; encodedName.equals(h.getRegionInfo().getEncodedName())) {</span>
<span class="source-line-no">2192</span><span id="line-2192">                sn = h.getServerName();</span>
<span class="source-line-no">2193</span><span id="line-2193">                info = h.getRegionInfo();</span>
<span class="source-line-no">2194</span><span id="line-2194">                matched = true;</span>
<span class="source-line-no">2195</span><span id="line-2195">              }</span>
<span class="source-line-no">2196</span><span id="line-2196">            }</span>
<span class="source-line-no">2197</span><span id="line-2197">          }</span>
<span class="source-line-no">2198</span><span id="line-2198">          if (!matched) return true;</span>
<span class="source-line-no">2199</span><span id="line-2199">          result.set(new Pair&lt;&gt;(info, sn));</span>
<span class="source-line-no">2200</span><span id="line-2200">          return false; // found the region, stop</span>
<span class="source-line-no">2201</span><span id="line-2201">        }</span>
<span class="source-line-no">2202</span><span id="line-2202">      };</span>
<span class="source-line-no">2203</span><span id="line-2203"></span>
<span class="source-line-no">2204</span><span id="line-2204">      MetaTableAccessor.fullScanRegions(connection, visitor);</span>
<span class="source-line-no">2205</span><span id="line-2205">      pair = result.get();</span>
<span class="source-line-no">2206</span><span id="line-2206">    }</span>
<span class="source-line-no">2207</span><span id="line-2207">    return pair;</span>
<span class="source-line-no">2208</span><span id="line-2208">  }</span>
<span class="source-line-no">2209</span><span id="line-2209"></span>
<span class="source-line-no">2210</span><span id="line-2210">  /**</span>
<span class="source-line-no">2211</span><span id="line-2211">   * If the input is a region name, it is returned as is. If it's an encoded region name, the</span>
<span class="source-line-no">2212</span><span id="line-2212">   * corresponding region is found from meta and its region name is returned. If we can't find any</span>
<span class="source-line-no">2213</span><span id="line-2213">   * region in meta matching the input as either region name or encoded region name, the input is</span>
<span class="source-line-no">2214</span><span id="line-2214">   * returned as is. We don't throw unknown region exception.</span>
<span class="source-line-no">2215</span><span id="line-2215">   */</span>
<span class="source-line-no">2216</span><span id="line-2216">  private byte[] getRegionName(final byte[] regionNameOrEncodedRegionName) throws IOException {</span>
<span class="source-line-no">2217</span><span id="line-2217">    if (</span>
<span class="source-line-no">2218</span><span id="line-2218">      Bytes.equals(regionNameOrEncodedRegionName, HRegionInfo.FIRST_META_REGIONINFO.getRegionName())</span>
<span class="source-line-no">2219</span><span id="line-2219">        || Bytes.equals(regionNameOrEncodedRegionName,</span>
<span class="source-line-no">2220</span><span id="line-2220">          HRegionInfo.FIRST_META_REGIONINFO.getEncodedNameAsBytes())</span>
<span class="source-line-no">2221</span><span id="line-2221">    ) {</span>
<span class="source-line-no">2222</span><span id="line-2222">      return HRegionInfo.FIRST_META_REGIONINFO.getRegionName();</span>
<span class="source-line-no">2223</span><span id="line-2223">    }</span>
<span class="source-line-no">2224</span><span id="line-2224">    byte[] tmp = regionNameOrEncodedRegionName;</span>
<span class="source-line-no">2225</span><span id="line-2225">    Pair&lt;RegionInfo, ServerName&gt; regionServerPair = getRegion(regionNameOrEncodedRegionName);</span>
<span class="source-line-no">2226</span><span id="line-2226">    if (regionServerPair != null &amp;&amp; regionServerPair.getFirst() != null) {</span>
<span class="source-line-no">2227</span><span id="line-2227">      tmp = regionServerPair.getFirst().getRegionName();</span>
<span class="source-line-no">2228</span><span id="line-2228">    }</span>
<span class="source-line-no">2229</span><span id="line-2229">    return tmp;</span>
<span class="source-line-no">2230</span><span id="line-2230">  }</span>
<span class="source-line-no">2231</span><span id="line-2231"></span>
<span class="source-line-no">2232</span><span id="line-2232">  /**</span>
<span class="source-line-no">2233</span><span id="line-2233">   * Check if table exists or not</span>
<span class="source-line-no">2234</span><span id="line-2234">   * @param tableName Name of a table.</span>
<span class="source-line-no">2235</span><span id="line-2235">   * @return tableName instance</span>
<span class="source-line-no">2236</span><span id="line-2236">   * @throws IOException            if a remote or network exception occurs.</span>
<span class="source-line-no">2237</span><span id="line-2237">   * @throws TableNotFoundException if table does not exist.</span>
<span class="source-line-no">2238</span><span id="line-2238">   */</span>
<span class="source-line-no">2239</span><span id="line-2239">  private TableName checkTableExists(final TableName tableName) throws IOException {</span>
<span class="source-line-no">2240</span><span id="line-2240">    return executeCallable(new RpcRetryingCallable&lt;TableName&gt;() {</span>
<span class="source-line-no">2241</span><span id="line-2241">      @Override</span>
<span class="source-line-no">2242</span><span id="line-2242">      protected TableName rpcCall(int callTimeout) throws Exception {</span>
<span class="source-line-no">2243</span><span id="line-2243">        if (MetaTableAccessor.getTableState(getConnection(), tableName) == null) {</span>
<span class="source-line-no">2244</span><span id="line-2244">          throw new TableNotFoundException(tableName);</span>
<span class="source-line-no">2245</span><span id="line-2245">        }</span>
<span class="source-line-no">2246</span><span id="line-2246">        return tableName;</span>
<span class="source-line-no">2247</span><span id="line-2247">      }</span>
<span class="source-line-no">2248</span><span id="line-2248">    });</span>
<span class="source-line-no">2249</span><span id="line-2249">  }</span>
<span class="source-line-no">2250</span><span id="line-2250"></span>
<span class="source-line-no">2251</span><span id="line-2251">  @Override</span>
<span class="source-line-no">2252</span><span id="line-2252">  public synchronized void shutdown() throws IOException {</span>
<span class="source-line-no">2253</span><span id="line-2253">    executeCallable(new MasterCallable&lt;Void&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">2254</span><span id="line-2254">      @Override</span>
<span class="source-line-no">2255</span><span id="line-2255">      protected Void rpcCall() throws Exception {</span>
<span class="source-line-no">2256</span><span id="line-2256">        setPriority(HConstants.HIGH_QOS);</span>
<span class="source-line-no">2257</span><span id="line-2257">        master.shutdown(getRpcController(), ShutdownRequest.newBuilder().build());</span>
<span class="source-line-no">2258</span><span id="line-2258">        return null;</span>
<span class="source-line-no">2259</span><span id="line-2259">      }</span>
<span class="source-line-no">2260</span><span id="line-2260">    });</span>
<span class="source-line-no">2261</span><span id="line-2261">  }</span>
<span class="source-line-no">2262</span><span id="line-2262"></span>
<span class="source-line-no">2263</span><span id="line-2263">  @Override</span>
<span class="source-line-no">2264</span><span id="line-2264">  public synchronized void stopMaster() throws IOException {</span>
<span class="source-line-no">2265</span><span id="line-2265">    executeCallable(new MasterCallable&lt;Void&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">2266</span><span id="line-2266">      @Override</span>
<span class="source-line-no">2267</span><span id="line-2267">      protected Void rpcCall() throws Exception {</span>
<span class="source-line-no">2268</span><span id="line-2268">        setPriority(HConstants.HIGH_QOS);</span>
<span class="source-line-no">2269</span><span id="line-2269">        master.stopMaster(getRpcController(), StopMasterRequest.newBuilder().build());</span>
<span class="source-line-no">2270</span><span id="line-2270">        return null;</span>
<span class="source-line-no">2271</span><span id="line-2271">      }</span>
<span class="source-line-no">2272</span><span id="line-2272">    });</span>
<span class="source-line-no">2273</span><span id="line-2273">  }</span>
<span class="source-line-no">2274</span><span id="line-2274"></span>
<span class="source-line-no">2275</span><span id="line-2275">  @Override</span>
<span class="source-line-no">2276</span><span id="line-2276">  public synchronized void stopRegionServer(final String hostnamePort) throws IOException {</span>
<span class="source-line-no">2277</span><span id="line-2277">    String hostname = Addressing.parseHostname(hostnamePort);</span>
<span class="source-line-no">2278</span><span id="line-2278">    int port = Addressing.parsePort(hostnamePort);</span>
<span class="source-line-no">2279</span><span id="line-2279">    final AdminService.BlockingInterface admin =</span>
<span class="source-line-no">2280</span><span id="line-2280">      this.connection.getAdmin(ServerName.valueOf(hostname, port, 0));</span>
<span class="source-line-no">2281</span><span id="line-2281">    // TODO: There is no timeout on this controller. Set one!</span>
<span class="source-line-no">2282</span><span id="line-2282">    HBaseRpcController controller = rpcControllerFactory.newController();</span>
<span class="source-line-no">2283</span><span id="line-2283">    controller.setPriority(HConstants.HIGH_QOS);</span>
<span class="source-line-no">2284</span><span id="line-2284">    StopServerRequest request = RequestConverter</span>
<span class="source-line-no">2285</span><span id="line-2285">      .buildStopServerRequest("Called by admin client " + this.connection.toString());</span>
<span class="source-line-no">2286</span><span id="line-2286">    try {</span>
<span class="source-line-no">2287</span><span id="line-2287">      admin.stopServer(controller, request);</span>
<span class="source-line-no">2288</span><span id="line-2288">    } catch (Exception e) {</span>
<span class="source-line-no">2289</span><span id="line-2289">      throw ProtobufUtil.handleRemoteException(e);</span>
<span class="source-line-no">2290</span><span id="line-2290">    }</span>
<span class="source-line-no">2291</span><span id="line-2291">  }</span>
<span class="source-line-no">2292</span><span id="line-2292"></span>
<span class="source-line-no">2293</span><span id="line-2293">  @Override</span>
<span class="source-line-no">2294</span><span id="line-2294">  public boolean isMasterInMaintenanceMode() throws IOException {</span>
<span class="source-line-no">2295</span><span id="line-2295">    return executeCallable(</span>
<span class="source-line-no">2296</span><span id="line-2296">      new MasterCallable&lt;IsInMaintenanceModeResponse&gt;(getConnection(), this.rpcControllerFactory) {</span>
<span class="source-line-no">2297</span><span id="line-2297">        @Override</span>
<span class="source-line-no">2298</span><span id="line-2298">        protected IsInMaintenanceModeResponse rpcCall() throws Exception {</span>
<span class="source-line-no">2299</span><span id="line-2299">          return master.isMasterInMaintenanceMode(getRpcController(),</span>
<span class="source-line-no">2300</span><span id="line-2300">            IsInMaintenanceModeRequest.newBuilder().build());</span>
<span class="source-line-no">2301</span><span id="line-2301">        }</span>
<span class="source-line-no">2302</span><span id="line-2302">      }).getInMaintenanceMode();</span>
<span class="source-line-no">2303</span><span id="line-2303">  }</span>
<span class="source-line-no">2304</span><span id="line-2304"></span>
<span class="source-line-no">2305</span><span id="line-2305">  @Override</span>
<span class="source-line-no">2306</span><span id="line-2306">  public ClusterMetrics getClusterMetrics(EnumSet&lt;Option&gt; options) throws IOException {</span>
<span class="source-line-no">2307</span><span id="line-2307">    return executeCallable(</span>
<span class="source-line-no">2308</span><span id="line-2308">      new MasterCallable&lt;ClusterMetrics&gt;(getConnection(), this.rpcControllerFactory) {</span>
<span class="source-line-no">2309</span><span id="line-2309">        @Override</span>
<span class="source-line-no">2310</span><span id="line-2310">        protected ClusterMetrics rpcCall() throws Exception {</span>
<span class="source-line-no">2311</span><span id="line-2311">          GetClusterStatusRequest req = RequestConverter.buildGetClusterStatusRequest(options);</span>
<span class="source-line-no">2312</span><span id="line-2312">          return ClusterMetricsBuilder</span>
<span class="source-line-no">2313</span><span id="line-2313">            .toClusterMetrics(master.getClusterStatus(getRpcController(), req).getClusterStatus());</span>
<span class="source-line-no">2314</span><span id="line-2314">        }</span>
<span class="source-line-no">2315</span><span id="line-2315">      });</span>
<span class="source-line-no">2316</span><span id="line-2316">  }</span>
<span class="source-line-no">2317</span><span id="line-2317"></span>
<span class="source-line-no">2318</span><span id="line-2318">  @Override</span>
<span class="source-line-no">2319</span><span id="line-2319">  public List&lt;RegionMetrics&gt; getRegionMetrics(ServerName serverName, TableName tableName)</span>
<span class="source-line-no">2320</span><span id="line-2320">    throws IOException {</span>
<span class="source-line-no">2321</span><span id="line-2321">    AdminService.BlockingInterface admin = this.connection.getAdmin(serverName);</span>
<span class="source-line-no">2322</span><span id="line-2322">    HBaseRpcController controller = rpcControllerFactory.newController();</span>
<span class="source-line-no">2323</span><span id="line-2323">    AdminProtos.GetRegionLoadRequest request =</span>
<span class="source-line-no">2324</span><span id="line-2324">      RequestConverter.buildGetRegionLoadRequest(tableName);</span>
<span class="source-line-no">2325</span><span id="line-2325">    try {</span>
<span class="source-line-no">2326</span><span id="line-2326">      return admin.getRegionLoad(controller, request).getRegionLoadsList().stream()</span>
<span class="source-line-no">2327</span><span id="line-2327">        .map(RegionMetricsBuilder::toRegionMetrics).collect(Collectors.toList());</span>
<span class="source-line-no">2328</span><span id="line-2328">    } catch (ServiceException se) {</span>
<span class="source-line-no">2329</span><span id="line-2329">      throw ProtobufUtil.getRemoteException(se);</span>
<span class="source-line-no">2330</span><span id="line-2330">    }</span>
<span class="source-line-no">2331</span><span id="line-2331">  }</span>
<span class="source-line-no">2332</span><span id="line-2332"></span>
<span class="source-line-no">2333</span><span id="line-2333">  @Override</span>
<span class="source-line-no">2334</span><span id="line-2334">  public Configuration getConfiguration() {</span>
<span class="source-line-no">2335</span><span id="line-2335">    return this.conf;</span>
<span class="source-line-no">2336</span><span id="line-2336">  }</span>
<span class="source-line-no">2337</span><span id="line-2337"></span>
<span class="source-line-no">2338</span><span id="line-2338">  /**</span>
<span class="source-line-no">2339</span><span id="line-2339">   * Do a get with a timeout against the passed in &lt;code&gt;future&lt;/code&gt;.</span>
<span class="source-line-no">2340</span><span id="line-2340">   */</span>
<span class="source-line-no">2341</span><span id="line-2341">  private static &lt;T&gt; T get(final Future&lt;T&gt; future, final long timeout, final TimeUnit units)</span>
<span class="source-line-no">2342</span><span id="line-2342">    throws IOException {</span>
<span class="source-line-no">2343</span><span id="line-2343">    try {</span>
<span class="source-line-no">2344</span><span id="line-2344">      // TODO: how long should we wait? Spin forever?</span>
<span class="source-line-no">2345</span><span id="line-2345">      return future.get(timeout, units);</span>
<span class="source-line-no">2346</span><span id="line-2346">    } catch (InterruptedException e) {</span>
<span class="source-line-no">2347</span><span id="line-2347">      IOException ioe = new InterruptedIOException("Interrupt while waiting on " + future);</span>
<span class="source-line-no">2348</span><span id="line-2348">      ioe.initCause(e);</span>
<span class="source-line-no">2349</span><span id="line-2349">      throw ioe;</span>
<span class="source-line-no">2350</span><span id="line-2350">    } catch (TimeoutException e) {</span>
<span class="source-line-no">2351</span><span id="line-2351">      throw new TimeoutIOException(e);</span>
<span class="source-line-no">2352</span><span id="line-2352">    } catch (ExecutionException e) {</span>
<span class="source-line-no">2353</span><span id="line-2353">      if (e.getCause() instanceof IOException) {</span>
<span class="source-line-no">2354</span><span id="line-2354">        throw (IOException) e.getCause();</span>
<span class="source-line-no">2355</span><span id="line-2355">      } else {</span>
<span class="source-line-no">2356</span><span id="line-2356">        throw new IOException(e.getCause());</span>
<span class="source-line-no">2357</span><span id="line-2357">      }</span>
<span class="source-line-no">2358</span><span id="line-2358">    }</span>
<span class="source-line-no">2359</span><span id="line-2359">  }</span>
<span class="source-line-no">2360</span><span id="line-2360"></span>
<span class="source-line-no">2361</span><span id="line-2361">  @Override</span>
<span class="source-line-no">2362</span><span id="line-2362">  public Future&lt;Void&gt; createNamespaceAsync(final NamespaceDescriptor descriptor)</span>
<span class="source-line-no">2363</span><span id="line-2363">    throws IOException {</span>
<span class="source-line-no">2364</span><span id="line-2364">    CreateNamespaceResponse response = executeCallable(</span>
<span class="source-line-no">2365</span><span id="line-2365">      new MasterCallable&lt;CreateNamespaceResponse&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">2366</span><span id="line-2366">        @Override</span>
<span class="source-line-no">2367</span><span id="line-2367">        protected CreateNamespaceResponse rpcCall() throws Exception {</span>
<span class="source-line-no">2368</span><span id="line-2368">          return master.createNamespace(getRpcController(), CreateNamespaceRequest.newBuilder()</span>
<span class="source-line-no">2369</span><span id="line-2369">            .setNamespaceDescriptor(ProtobufUtil.toProtoNamespaceDescriptor(descriptor)).build());</span>
<span class="source-line-no">2370</span><span id="line-2370">        }</span>
<span class="source-line-no">2371</span><span id="line-2371">      });</span>
<span class="source-line-no">2372</span><span id="line-2372">    return new NamespaceFuture(this, descriptor.getName(), response.getProcId()) {</span>
<span class="source-line-no">2373</span><span id="line-2373">      @Override</span>
<span class="source-line-no">2374</span><span id="line-2374">      public String getOperationType() {</span>
<span class="source-line-no">2375</span><span id="line-2375">        return "CREATE_NAMESPACE";</span>
<span class="source-line-no">2376</span><span id="line-2376">      }</span>
<span class="source-line-no">2377</span><span id="line-2377">    };</span>
<span class="source-line-no">2378</span><span id="line-2378">  }</span>
<span class="source-line-no">2379</span><span id="line-2379"></span>
<span class="source-line-no">2380</span><span id="line-2380">  @Override</span>
<span class="source-line-no">2381</span><span id="line-2381">  public Future&lt;Void&gt; modifyNamespaceAsync(final NamespaceDescriptor descriptor)</span>
<span class="source-line-no">2382</span><span id="line-2382">    throws IOException {</span>
<span class="source-line-no">2383</span><span id="line-2383">    ModifyNamespaceResponse response = executeCallable(</span>
<span class="source-line-no">2384</span><span id="line-2384">      new MasterCallable&lt;ModifyNamespaceResponse&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">2385</span><span id="line-2385">        @Override</span>
<span class="source-line-no">2386</span><span id="line-2386">        protected ModifyNamespaceResponse rpcCall() throws Exception {</span>
<span class="source-line-no">2387</span><span id="line-2387">          // TODO: set priority based on NS?</span>
<span class="source-line-no">2388</span><span id="line-2388">          return master.modifyNamespace(getRpcController(), ModifyNamespaceRequest.newBuilder()</span>
<span class="source-line-no">2389</span><span id="line-2389">            .setNamespaceDescriptor(ProtobufUtil.toProtoNamespaceDescriptor(descriptor)).build());</span>
<span class="source-line-no">2390</span><span id="line-2390">        }</span>
<span class="source-line-no">2391</span><span id="line-2391">      });</span>
<span class="source-line-no">2392</span><span id="line-2392">    return new NamespaceFuture(this, descriptor.getName(), response.getProcId()) {</span>
<span class="source-line-no">2393</span><span id="line-2393">      @Override</span>
<span class="source-line-no">2394</span><span id="line-2394">      public String getOperationType() {</span>
<span class="source-line-no">2395</span><span id="line-2395">        return "MODIFY_NAMESPACE";</span>
<span class="source-line-no">2396</span><span id="line-2396">      }</span>
<span class="source-line-no">2397</span><span id="line-2397">    };</span>
<span class="source-line-no">2398</span><span id="line-2398">  }</span>
<span class="source-line-no">2399</span><span id="line-2399"></span>
<span class="source-line-no">2400</span><span id="line-2400">  @Override</span>
<span class="source-line-no">2401</span><span id="line-2401">  public Future&lt;Void&gt; deleteNamespaceAsync(final String name) throws IOException {</span>
<span class="source-line-no">2402</span><span id="line-2402">    DeleteNamespaceResponse response = executeCallable(</span>
<span class="source-line-no">2403</span><span id="line-2403">      new MasterCallable&lt;DeleteNamespaceResponse&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">2404</span><span id="line-2404">        @Override</span>
<span class="source-line-no">2405</span><span id="line-2405">        protected DeleteNamespaceResponse rpcCall() throws Exception {</span>
<span class="source-line-no">2406</span><span id="line-2406">          // TODO: set priority based on NS?</span>
<span class="source-line-no">2407</span><span id="line-2407">          return master.deleteNamespace(getRpcController(),</span>
<span class="source-line-no">2408</span><span id="line-2408">            DeleteNamespaceRequest.newBuilder().setNamespaceName(name).build());</span>
<span class="source-line-no">2409</span><span id="line-2409">        }</span>
<span class="source-line-no">2410</span><span id="line-2410">      });</span>
<span class="source-line-no">2411</span><span id="line-2411">    return new NamespaceFuture(this, name, response.getProcId()) {</span>
<span class="source-line-no">2412</span><span id="line-2412">      @Override</span>
<span class="source-line-no">2413</span><span id="line-2413">      public String getOperationType() {</span>
<span class="source-line-no">2414</span><span id="line-2414">        return "DELETE_NAMESPACE";</span>
<span class="source-line-no">2415</span><span id="line-2415">      }</span>
<span class="source-line-no">2416</span><span id="line-2416">    };</span>
<span class="source-line-no">2417</span><span id="line-2417">  }</span>
<span class="source-line-no">2418</span><span id="line-2418"></span>
<span class="source-line-no">2419</span><span id="line-2419">  @Override</span>
<span class="source-line-no">2420</span><span id="line-2420">  public NamespaceDescriptor getNamespaceDescriptor(final String name)</span>
<span class="source-line-no">2421</span><span id="line-2421">    throws NamespaceNotFoundException, IOException {</span>
<span class="source-line-no">2422</span><span id="line-2422">    return executeCallable(</span>
<span class="source-line-no">2423</span><span id="line-2423">      new MasterCallable&lt;NamespaceDescriptor&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">2424</span><span id="line-2424">        @Override</span>
<span class="source-line-no">2425</span><span id="line-2425">        protected NamespaceDescriptor rpcCall() throws Exception {</span>
<span class="source-line-no">2426</span><span id="line-2426">          return ProtobufUtil.toNamespaceDescriptor(master</span>
<span class="source-line-no">2427</span><span id="line-2427">            .getNamespaceDescriptor(getRpcController(),</span>
<span class="source-line-no">2428</span><span id="line-2428">              GetNamespaceDescriptorRequest.newBuilder().setNamespaceName(name).build())</span>
<span class="source-line-no">2429</span><span id="line-2429">            .getNamespaceDescriptor());</span>
<span class="source-line-no">2430</span><span id="line-2430">        }</span>
<span class="source-line-no">2431</span><span id="line-2431">      });</span>
<span class="source-line-no">2432</span><span id="line-2432">  }</span>
<span class="source-line-no">2433</span><span id="line-2433"></span>
<span class="source-line-no">2434</span><span id="line-2434">  /**</span>
<span class="source-line-no">2435</span><span id="line-2435">   * List available namespaces</span>
<span class="source-line-no">2436</span><span id="line-2436">   * @return List of namespace names</span>
<span class="source-line-no">2437</span><span id="line-2437">   * @throws IOException if a remote or network exception occurs</span>
<span class="source-line-no">2438</span><span id="line-2438">   */</span>
<span class="source-line-no">2439</span><span id="line-2439">  @Override</span>
<span class="source-line-no">2440</span><span id="line-2440">  public String[] listNamespaces() throws IOException {</span>
<span class="source-line-no">2441</span><span id="line-2441">    return executeCallable(</span>
<span class="source-line-no">2442</span><span id="line-2442">      new MasterCallable&lt;String[]&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">2443</span><span id="line-2443">        @Override</span>
<span class="source-line-no">2444</span><span id="line-2444">        protected String[] rpcCall() throws Exception {</span>
<span class="source-line-no">2445</span><span id="line-2445">          List&lt;String&gt; list =</span>
<span class="source-line-no">2446</span><span id="line-2446">            master.listNamespaces(getRpcController(), ListNamespacesRequest.newBuilder().build())</span>
<span class="source-line-no">2447</span><span id="line-2447">              .getNamespaceNameList();</span>
<span class="source-line-no">2448</span><span id="line-2448">          return list.toArray(new String[list.size()]);</span>
<span class="source-line-no">2449</span><span id="line-2449">        }</span>
<span class="source-line-no">2450</span><span id="line-2450">      });</span>
<span class="source-line-no">2451</span><span id="line-2451">  }</span>
<span class="source-line-no">2452</span><span id="line-2452"></span>
<span class="source-line-no">2453</span><span id="line-2453">  /**</span>
<span class="source-line-no">2454</span><span id="line-2454">   * List available namespace descriptors</span>
<span class="source-line-no">2455</span><span id="line-2455">   * @return List of descriptors</span>
<span class="source-line-no">2456</span><span id="line-2456">   * @throws IOException if a remote or network exception occurs</span>
<span class="source-line-no">2457</span><span id="line-2457">   */</span>
<span class="source-line-no">2458</span><span id="line-2458">  @Override</span>
<span class="source-line-no">2459</span><span id="line-2459">  public NamespaceDescriptor[] listNamespaceDescriptors() throws IOException {</span>
<span class="source-line-no">2460</span><span id="line-2460">    return executeCallable(</span>
<span class="source-line-no">2461</span><span id="line-2461">      new MasterCallable&lt;NamespaceDescriptor[]&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">2462</span><span id="line-2462">        @Override</span>
<span class="source-line-no">2463</span><span id="line-2463">        protected NamespaceDescriptor[] rpcCall() throws Exception {</span>
<span class="source-line-no">2464</span><span id="line-2464">          List&lt;</span>
<span class="source-line-no">2465</span><span id="line-2465">            HBaseProtos.NamespaceDescriptor&gt; list =</span>
<span class="source-line-no">2466</span><span id="line-2466">              master</span>
<span class="source-line-no">2467</span><span id="line-2467">                .listNamespaceDescriptors(getRpcController(),</span>
<span class="source-line-no">2468</span><span id="line-2468">                  ListNamespaceDescriptorsRequest.newBuilder().build())</span>
<span class="source-line-no">2469</span><span id="line-2469">                .getNamespaceDescriptorList();</span>
<span class="source-line-no">2470</span><span id="line-2470">          NamespaceDescriptor[] res = new NamespaceDescriptor[list.size()];</span>
<span class="source-line-no">2471</span><span id="line-2471">          for (int i = 0; i &lt; list.size(); i++) {</span>
<span class="source-line-no">2472</span><span id="line-2472">            res[i] = ProtobufUtil.toNamespaceDescriptor(list.get(i));</span>
<span class="source-line-no">2473</span><span id="line-2473">          }</span>
<span class="source-line-no">2474</span><span id="line-2474">          return res;</span>
<span class="source-line-no">2475</span><span id="line-2475">        }</span>
<span class="source-line-no">2476</span><span id="line-2476">      });</span>
<span class="source-line-no">2477</span><span id="line-2477">  }</span>
<span class="source-line-no">2478</span><span id="line-2478"></span>
<span class="source-line-no">2479</span><span id="line-2479">  @Override</span>
<span class="source-line-no">2480</span><span id="line-2480">  public String getProcedures() throws IOException {</span>
<span class="source-line-no">2481</span><span id="line-2481">    return executeCallable(new MasterCallable&lt;String&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">2482</span><span id="line-2482">      @Override</span>
<span class="source-line-no">2483</span><span id="line-2483">      protected String rpcCall() throws Exception {</span>
<span class="source-line-no">2484</span><span id="line-2484">        GetProceduresRequest request = GetProceduresRequest.newBuilder().build();</span>
<span class="source-line-no">2485</span><span id="line-2485">        GetProceduresResponse response = master.getProcedures(getRpcController(), request);</span>
<span class="source-line-no">2486</span><span id="line-2486">        return ProtobufUtil.toProcedureJson(response.getProcedureList());</span>
<span class="source-line-no">2487</span><span id="line-2487">      }</span>
<span class="source-line-no">2488</span><span id="line-2488">    });</span>
<span class="source-line-no">2489</span><span id="line-2489">  }</span>
<span class="source-line-no">2490</span><span id="line-2490"></span>
<span class="source-line-no">2491</span><span id="line-2491">  @Override</span>
<span class="source-line-no">2492</span><span id="line-2492">  public String getLocks() throws IOException {</span>
<span class="source-line-no">2493</span><span id="line-2493">    return executeCallable(new MasterCallable&lt;String&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">2494</span><span id="line-2494">      @Override</span>
<span class="source-line-no">2495</span><span id="line-2495">      protected String rpcCall() throws Exception {</span>
<span class="source-line-no">2496</span><span id="line-2496">        GetLocksRequest request = GetLocksRequest.newBuilder().build();</span>
<span class="source-line-no">2497</span><span id="line-2497">        GetLocksResponse response = master.getLocks(getRpcController(), request);</span>
<span class="source-line-no">2498</span><span id="line-2498">        return ProtobufUtil.toLockJson(response.getLockList());</span>
<span class="source-line-no">2499</span><span id="line-2499">      }</span>
<span class="source-line-no">2500</span><span id="line-2500">    });</span>
<span class="source-line-no">2501</span><span id="line-2501">  }</span>
<span class="source-line-no">2502</span><span id="line-2502"></span>
<span class="source-line-no">2503</span><span id="line-2503">  @Override</span>
<span class="source-line-no">2504</span><span id="line-2504">  public HTableDescriptor[] listTableDescriptorsByNamespace(final String name) throws IOException {</span>
<span class="source-line-no">2505</span><span id="line-2505">    return executeCallable(</span>
<span class="source-line-no">2506</span><span id="line-2506">      new MasterCallable&lt;HTableDescriptor[]&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">2507</span><span id="line-2507">        @Override</span>
<span class="source-line-no">2508</span><span id="line-2508">        protected HTableDescriptor[] rpcCall() throws Exception {</span>
<span class="source-line-no">2509</span><span id="line-2509">          List&lt;TableSchema&gt; list = master</span>
<span class="source-line-no">2510</span><span id="line-2510">            .listTableDescriptorsByNamespace(getRpcController(),</span>
<span class="source-line-no">2511</span><span id="line-2511">              ListTableDescriptorsByNamespaceRequest.newBuilder().setNamespaceName(name).build())</span>
<span class="source-line-no">2512</span><span id="line-2512">            .getTableSchemaList();</span>
<span class="source-line-no">2513</span><span id="line-2513">          HTableDescriptor[] res = new HTableDescriptor[list.size()];</span>
<span class="source-line-no">2514</span><span id="line-2514">          for (int i = 0; i &lt; list.size(); i++) {</span>
<span class="source-line-no">2515</span><span id="line-2515">            res[i] = new ImmutableHTableDescriptor(ProtobufUtil.toTableDescriptor(list.get(i)));</span>
<span class="source-line-no">2516</span><span id="line-2516">          }</span>
<span class="source-line-no">2517</span><span id="line-2517">          return res;</span>
<span class="source-line-no">2518</span><span id="line-2518">        }</span>
<span class="source-line-no">2519</span><span id="line-2519">      });</span>
<span class="source-line-no">2520</span><span id="line-2520">  }</span>
<span class="source-line-no">2521</span><span id="line-2521"></span>
<span class="source-line-no">2522</span><span id="line-2522">  @Override</span>
<span class="source-line-no">2523</span><span id="line-2523">  public TableName[] listTableNamesByNamespace(final String name) throws IOException {</span>
<span class="source-line-no">2524</span><span id="line-2524">    return executeCallable(</span>
<span class="source-line-no">2525</span><span id="line-2525">      new MasterCallable&lt;TableName[]&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">2526</span><span id="line-2526">        @Override</span>
<span class="source-line-no">2527</span><span id="line-2527">        protected TableName[] rpcCall() throws Exception {</span>
<span class="source-line-no">2528</span><span id="line-2528">          List&lt;HBaseProtos.TableName&gt; tableNames = master</span>
<span class="source-line-no">2529</span><span id="line-2529">            .listTableNamesByNamespace(getRpcController(),</span>
<span class="source-line-no">2530</span><span id="line-2530">              ListTableNamesByNamespaceRequest.newBuilder().setNamespaceName(name).build())</span>
<span class="source-line-no">2531</span><span id="line-2531">            .getTableNameList();</span>
<span class="source-line-no">2532</span><span id="line-2532">          TableName[] result = new TableName[tableNames.size()];</span>
<span class="source-line-no">2533</span><span id="line-2533">          for (int i = 0; i &lt; tableNames.size(); i++) {</span>
<span class="source-line-no">2534</span><span id="line-2534">            result[i] = ProtobufUtil.toTableName(tableNames.get(i));</span>
<span class="source-line-no">2535</span><span id="line-2535">          }</span>
<span class="source-line-no">2536</span><span id="line-2536">          return result;</span>
<span class="source-line-no">2537</span><span id="line-2537">        }</span>
<span class="source-line-no">2538</span><span id="line-2538">      });</span>
<span class="source-line-no">2539</span><span id="line-2539">  }</span>
<span class="source-line-no">2540</span><span id="line-2540"></span>
<span class="source-line-no">2541</span><span id="line-2541">  /**</span>
<span class="source-line-no">2542</span><span id="line-2542">   * Is HBase available? Throw an exception if not.</span>
<span class="source-line-no">2543</span><span id="line-2543">   * @param conf system configuration</span>
<span class="source-line-no">2544</span><span id="line-2544">   * @throws MasterNotRunningException    if the master is not running.</span>
<span class="source-line-no">2545</span><span id="line-2545">   * @throws ZooKeeperConnectionException if unable to connect to zookeeper. // TODO do not expose</span>
<span class="source-line-no">2546</span><span id="line-2546">   *                                      ZKConnectionException.</span>
<span class="source-line-no">2547</span><span id="line-2547">   */</span>
<span class="source-line-no">2548</span><span id="line-2548">  public static void available(final Configuration conf)</span>
<span class="source-line-no">2549</span><span id="line-2549">    throws MasterNotRunningException, ZooKeeperConnectionException, IOException {</span>
<span class="source-line-no">2550</span><span id="line-2550">    Configuration copyOfConf = HBaseConfiguration.create(conf);</span>
<span class="source-line-no">2551</span><span id="line-2551">    // We set it to make it fail as soon as possible if HBase is not available</span>
<span class="source-line-no">2552</span><span id="line-2552">    copyOfConf.setInt(HConstants.HBASE_CLIENT_RETRIES_NUMBER, 1);</span>
<span class="source-line-no">2553</span><span id="line-2553">    copyOfConf.setInt("zookeeper.recovery.retry", 0);</span>
<span class="source-line-no">2554</span><span id="line-2554"></span>
<span class="source-line-no">2555</span><span id="line-2555">    // Check ZK first.</span>
<span class="source-line-no">2556</span><span id="line-2556">    // If the connection exists, we may have a connection to ZK that does not work anymore</span>
<span class="source-line-no">2557</span><span id="line-2557">    try (ClusterConnection connection =</span>
<span class="source-line-no">2558</span><span id="line-2558">      (ClusterConnection) ConnectionFactory.createConnection(copyOfConf)) {</span>
<span class="source-line-no">2559</span><span id="line-2559">      // can throw MasterNotRunningException</span>
<span class="source-line-no">2560</span><span id="line-2560">      connection.isMasterRunning();</span>
<span class="source-line-no">2561</span><span id="line-2561">    }</span>
<span class="source-line-no">2562</span><span id="line-2562">  }</span>
<span class="source-line-no">2563</span><span id="line-2563"></span>
<span class="source-line-no">2564</span><span id="line-2564">  /**</span>
<span class="source-line-no">2565</span><span id="line-2565">   * @return List of {@link HRegionInfo}.</span>
<span class="source-line-no">2566</span><span id="line-2566">   * @throws IOException if a remote or network exception occurs</span>
<span class="source-line-no">2567</span><span id="line-2567">   * @deprecated As of release 2.0.0, this will be removed in HBase 3.0.0 Use</span>
<span class="source-line-no">2568</span><span id="line-2568">   *             {@link #getRegions(TableName)}.</span>
<span class="source-line-no">2569</span><span id="line-2569">   */</span>
<span class="source-line-no">2570</span><span id="line-2570">  @Deprecated</span>
<span class="source-line-no">2571</span><span id="line-2571">  @Override</span>
<span class="source-line-no">2572</span><span id="line-2572">  public List&lt;HRegionInfo&gt; getTableRegions(final TableName tableName) throws IOException {</span>
<span class="source-line-no">2573</span><span id="line-2573">    return getRegions(tableName).stream().map(ImmutableHRegionInfo::new)</span>
<span class="source-line-no">2574</span><span id="line-2574">      .collect(Collectors.toList());</span>
<span class="source-line-no">2575</span><span id="line-2575">  }</span>
<span class="source-line-no">2576</span><span id="line-2576"></span>
<span class="source-line-no">2577</span><span id="line-2577">  @Override</span>
<span class="source-line-no">2578</span><span id="line-2578">  public synchronized void close() throws IOException {</span>
<span class="source-line-no">2579</span><span id="line-2579">  }</span>
<span class="source-line-no">2580</span><span id="line-2580"></span>
<span class="source-line-no">2581</span><span id="line-2581">  @Override</span>
<span class="source-line-no">2582</span><span id="line-2582">  public HTableDescriptor[] getTableDescriptorsByTableName(final List&lt;TableName&gt; tableNames)</span>
<span class="source-line-no">2583</span><span id="line-2583">    throws IOException {</span>
<span class="source-line-no">2584</span><span id="line-2584">    return executeCallable(</span>
<span class="source-line-no">2585</span><span id="line-2585">      new MasterCallable&lt;HTableDescriptor[]&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">2586</span><span id="line-2586">        @Override</span>
<span class="source-line-no">2587</span><span id="line-2587">        protected HTableDescriptor[] rpcCall() throws Exception {</span>
<span class="source-line-no">2588</span><span id="line-2588">          GetTableDescriptorsRequest req =</span>
<span class="source-line-no">2589</span><span id="line-2589">            RequestConverter.buildGetTableDescriptorsRequest(tableNames);</span>
<span class="source-line-no">2590</span><span id="line-2590">          return ProtobufUtil</span>
<span class="source-line-no">2591</span><span id="line-2591">            .toTableDescriptorList(master.getTableDescriptors(getRpcController(), req)).stream()</span>
<span class="source-line-no">2592</span><span id="line-2592">            .map(ImmutableHTableDescriptor::new).toArray(HTableDescriptor[]::new);</span>
<span class="source-line-no">2593</span><span id="line-2593">        }</span>
<span class="source-line-no">2594</span><span id="line-2594">      });</span>
<span class="source-line-no">2595</span><span id="line-2595">  }</span>
<span class="source-line-no">2596</span><span id="line-2596"></span>
<span class="source-line-no">2597</span><span id="line-2597">  @Override</span>
<span class="source-line-no">2598</span><span id="line-2598">  public HTableDescriptor[] getTableDescriptors(List&lt;String&gt; names) throws IOException {</span>
<span class="source-line-no">2599</span><span id="line-2599">    List&lt;TableName&gt; tableNames = new ArrayList&lt;&gt;(names.size());</span>
<span class="source-line-no">2600</span><span id="line-2600">    for (String name : names) {</span>
<span class="source-line-no">2601</span><span id="line-2601">      tableNames.add(TableName.valueOf(name));</span>
<span class="source-line-no">2602</span><span id="line-2602">    }</span>
<span class="source-line-no">2603</span><span id="line-2603">    return getTableDescriptorsByTableName(tableNames);</span>
<span class="source-line-no">2604</span><span id="line-2604">  }</span>
<span class="source-line-no">2605</span><span id="line-2605"></span>
<span class="source-line-no">2606</span><span id="line-2606">  private RollWALWriterResponse rollWALWriterImpl(final ServerName sn)</span>
<span class="source-line-no">2607</span><span id="line-2607">    throws IOException, FailedLogCloseException {</span>
<span class="source-line-no">2608</span><span id="line-2608">    final AdminService.BlockingInterface admin = this.connection.getAdmin(sn);</span>
<span class="source-line-no">2609</span><span id="line-2609">    RollWALWriterRequest request = RequestConverter.buildRollWALWriterRequest();</span>
<span class="source-line-no">2610</span><span id="line-2610">    // TODO: There is no timeout on this controller. Set one!</span>
<span class="source-line-no">2611</span><span id="line-2611">    HBaseRpcController controller = rpcControllerFactory.newController();</span>
<span class="source-line-no">2612</span><span id="line-2612">    try {</span>
<span class="source-line-no">2613</span><span id="line-2613">      return admin.rollWALWriter(controller, request);</span>
<span class="source-line-no">2614</span><span id="line-2614">    } catch (ServiceException e) {</span>
<span class="source-line-no">2615</span><span id="line-2615">      throw ProtobufUtil.handleRemoteException(e);</span>
<span class="source-line-no">2616</span><span id="line-2616">    }</span>
<span class="source-line-no">2617</span><span id="line-2617">  }</span>
<span class="source-line-no">2618</span><span id="line-2618"></span>
<span class="source-line-no">2619</span><span id="line-2619">  @Override</span>
<span class="source-line-no">2620</span><span id="line-2620">  public synchronized void rollWALWriter(ServerName serverName)</span>
<span class="source-line-no">2621</span><span id="line-2621">    throws IOException, FailedLogCloseException {</span>
<span class="source-line-no">2622</span><span id="line-2622">    rollWALWriterImpl(serverName);</span>
<span class="source-line-no">2623</span><span id="line-2623">  }</span>
<span class="source-line-no">2624</span><span id="line-2624"></span>
<span class="source-line-no">2625</span><span id="line-2625">  @Override</span>
<span class="source-line-no">2626</span><span id="line-2626">  public CompactionState getCompactionState(final TableName tableName) throws IOException {</span>
<span class="source-line-no">2627</span><span id="line-2627">    return getCompactionState(tableName, CompactType.NORMAL);</span>
<span class="source-line-no">2628</span><span id="line-2628">  }</span>
<span class="source-line-no">2629</span><span id="line-2629"></span>
<span class="source-line-no">2630</span><span id="line-2630">  @Override</span>
<span class="source-line-no">2631</span><span id="line-2631">  public CompactionState getCompactionStateForRegion(final byte[] regionName) throws IOException {</span>
<span class="source-line-no">2632</span><span id="line-2632">    final Pair&lt;RegionInfo, ServerName&gt; regionServerPair = getRegion(regionName);</span>
<span class="source-line-no">2633</span><span id="line-2633">    if (regionServerPair == null) {</span>
<span class="source-line-no">2634</span><span id="line-2634">      throw new IllegalArgumentException("Invalid region: " + Bytes.toStringBinary(regionName));</span>
<span class="source-line-no">2635</span><span id="line-2635">    }</span>
<span class="source-line-no">2636</span><span id="line-2636">    if (regionServerPair.getSecond() == null) {</span>
<span class="source-line-no">2637</span><span id="line-2637">      throw new NoServerForRegionException(Bytes.toStringBinary(regionName));</span>
<span class="source-line-no">2638</span><span id="line-2638">    }</span>
<span class="source-line-no">2639</span><span id="line-2639">    ServerName sn = regionServerPair.getSecond();</span>
<span class="source-line-no">2640</span><span id="line-2640">    final AdminService.BlockingInterface admin = this.connection.getAdmin(sn);</span>
<span class="source-line-no">2641</span><span id="line-2641">    // TODO: There is no timeout on this controller. Set one!</span>
<span class="source-line-no">2642</span><span id="line-2642">    HBaseRpcController controller = rpcControllerFactory.newController();</span>
<span class="source-line-no">2643</span><span id="line-2643">    GetRegionInfoRequest request =</span>
<span class="source-line-no">2644</span><span id="line-2644">      RequestConverter.buildGetRegionInfoRequest(regionServerPair.getFirst().getRegionName(), true);</span>
<span class="source-line-no">2645</span><span id="line-2645">    GetRegionInfoResponse response;</span>
<span class="source-line-no">2646</span><span id="line-2646">    try {</span>
<span class="source-line-no">2647</span><span id="line-2647">      response = admin.getRegionInfo(controller, request);</span>
<span class="source-line-no">2648</span><span id="line-2648">    } catch (ServiceException e) {</span>
<span class="source-line-no">2649</span><span id="line-2649">      throw ProtobufUtil.handleRemoteException(e);</span>
<span class="source-line-no">2650</span><span id="line-2650">    }</span>
<span class="source-line-no">2651</span><span id="line-2651">    if (response.getCompactionState() != null) {</span>
<span class="source-line-no">2652</span><span id="line-2652">      return ProtobufUtil.createCompactionState(response.getCompactionState());</span>
<span class="source-line-no">2653</span><span id="line-2653">    }</span>
<span class="source-line-no">2654</span><span id="line-2654">    return null;</span>
<span class="source-line-no">2655</span><span id="line-2655">  }</span>
<span class="source-line-no">2656</span><span id="line-2656"></span>
<span class="source-line-no">2657</span><span id="line-2657">  @Override</span>
<span class="source-line-no">2658</span><span id="line-2658">  public Future&lt;Void&gt; snapshotAsync(SnapshotDescription snapshotDesc)</span>
<span class="source-line-no">2659</span><span id="line-2659">    throws IOException, SnapshotCreationException {</span>
<span class="source-line-no">2660</span><span id="line-2660">    SnapshotResponse resp = asyncSnapshot(ProtobufUtil.createHBaseProtosSnapshotDesc(snapshotDesc));</span>
<span class="source-line-no">2661</span><span id="line-2661">    // This is for keeping compatibility with old implementation.</span>
<span class="source-line-no">2662</span><span id="line-2662">    // If there is a procId field in the response, then the snapshot will be operated with a</span>
<span class="source-line-no">2663</span><span id="line-2663">    // SnapshotProcedure, otherwise the snapshot will be coordinated by zk.</span>
<span class="source-line-no">2664</span><span id="line-2664">    if (resp.hasProcId()) {</span>
<span class="source-line-no">2665</span><span id="line-2665">      return new SnapshotFuture(this, snapshotDesc, resp.getProcId());</span>
<span class="source-line-no">2666</span><span id="line-2666">    } else {</span>
<span class="source-line-no">2667</span><span id="line-2667">      return new SnapshotFuture(this, snapshotDesc, null);</span>
<span class="source-line-no">2668</span><span id="line-2668">    }</span>
<span class="source-line-no">2669</span><span id="line-2669">  }</span>
<span class="source-line-no">2670</span><span id="line-2670"></span>
<span class="source-line-no">2671</span><span id="line-2671">  private static final class SnapshotFuture extends TableFuture&lt;Void&gt; {</span>
<span class="source-line-no">2672</span><span id="line-2672">    private final SnapshotDescription snapshotDesc;</span>
<span class="source-line-no">2673</span><span id="line-2673"></span>
<span class="source-line-no">2674</span><span id="line-2674">    public SnapshotFuture(HBaseAdmin admin, SnapshotDescription snapshotDesc, Long procId) {</span>
<span class="source-line-no">2675</span><span id="line-2675">      super(admin, snapshotDesc.getTableName(), procId);</span>
<span class="source-line-no">2676</span><span id="line-2676">      this.snapshotDesc = snapshotDesc;</span>
<span class="source-line-no">2677</span><span id="line-2677">    }</span>
<span class="source-line-no">2678</span><span id="line-2678"></span>
<span class="source-line-no">2679</span><span id="line-2679">    @Override</span>
<span class="source-line-no">2680</span><span id="line-2680">    public String getOperationType() {</span>
<span class="source-line-no">2681</span><span id="line-2681">      return "SNAPSHOT";</span>
<span class="source-line-no">2682</span><span id="line-2682">    }</span>
<span class="source-line-no">2683</span><span id="line-2683"></span>
<span class="source-line-no">2684</span><span id="line-2684">    @Override</span>
<span class="source-line-no">2685</span><span id="line-2685">    protected Void waitOperationResult(long deadlineTs) throws IOException, TimeoutException {</span>
<span class="source-line-no">2686</span><span id="line-2686">      waitForState(deadlineTs, new TableWaitForStateCallable() {</span>
<span class="source-line-no">2687</span><span id="line-2687">        @Override</span>
<span class="source-line-no">2688</span><span id="line-2688">        public boolean checkState(int tries) throws IOException {</span>
<span class="source-line-no">2689</span><span id="line-2689">          return getAdmin().isSnapshotFinished(snapshotDesc);</span>
<span class="source-line-no">2690</span><span id="line-2690">        }</span>
<span class="source-line-no">2691</span><span id="line-2691">      });</span>
<span class="source-line-no">2692</span><span id="line-2692">      return null;</span>
<span class="source-line-no">2693</span><span id="line-2693">    }</span>
<span class="source-line-no">2694</span><span id="line-2694">  }</span>
<span class="source-line-no">2695</span><span id="line-2695"></span>
<span class="source-line-no">2696</span><span id="line-2696">  private SnapshotResponse asyncSnapshot(SnapshotProtos.SnapshotDescription snapshot)</span>
<span class="source-line-no">2697</span><span id="line-2697">    throws IOException {</span>
<span class="source-line-no">2698</span><span id="line-2698">    ClientSnapshotDescriptionUtils.assertSnapshotRequestIsValid(snapshot);</span>
<span class="source-line-no">2699</span><span id="line-2699">    final SnapshotRequest request = SnapshotRequest.newBuilder().setSnapshot(snapshot)</span>
<span class="source-line-no">2700</span><span id="line-2700">      .setNonceGroup(ng.newNonce()).setNonce(ng.newNonce()).build();</span>
<span class="source-line-no">2701</span><span id="line-2701">    // run the snapshot on the master</span>
<span class="source-line-no">2702</span><span id="line-2702">    return executeCallable(</span>
<span class="source-line-no">2703</span><span id="line-2703">      new MasterCallable&lt;SnapshotResponse&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">2704</span><span id="line-2704">        @Override</span>
<span class="source-line-no">2705</span><span id="line-2705">        protected SnapshotResponse rpcCall() throws Exception {</span>
<span class="source-line-no">2706</span><span id="line-2706">          return master.snapshot(getRpcController(), request);</span>
<span class="source-line-no">2707</span><span id="line-2707">        }</span>
<span class="source-line-no">2708</span><span id="line-2708">      });</span>
<span class="source-line-no">2709</span><span id="line-2709">  }</span>
<span class="source-line-no">2710</span><span id="line-2710"></span>
<span class="source-line-no">2711</span><span id="line-2711">  @Override</span>
<span class="source-line-no">2712</span><span id="line-2712">  public boolean isSnapshotFinished(final SnapshotDescription snapshotDesc)</span>
<span class="source-line-no">2713</span><span id="line-2713">    throws IOException, HBaseSnapshotException, UnknownSnapshotException {</span>
<span class="source-line-no">2714</span><span id="line-2714">    final SnapshotProtos.SnapshotDescription snapshot =</span>
<span class="source-line-no">2715</span><span id="line-2715">      ProtobufUtil.createHBaseProtosSnapshotDesc(snapshotDesc);</span>
<span class="source-line-no">2716</span><span id="line-2716">    return executeCallable(</span>
<span class="source-line-no">2717</span><span id="line-2717">      new MasterCallable&lt;IsSnapshotDoneResponse&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">2718</span><span id="line-2718">        @Override</span>
<span class="source-line-no">2719</span><span id="line-2719">        protected IsSnapshotDoneResponse rpcCall() throws Exception {</span>
<span class="source-line-no">2720</span><span id="line-2720">          return master.isSnapshotDone(getRpcController(),</span>
<span class="source-line-no">2721</span><span id="line-2721">            IsSnapshotDoneRequest.newBuilder().setSnapshot(snapshot).build());</span>
<span class="source-line-no">2722</span><span id="line-2722">        }</span>
<span class="source-line-no">2723</span><span id="line-2723">      }).getDone();</span>
<span class="source-line-no">2724</span><span id="line-2724">  }</span>
<span class="source-line-no">2725</span><span id="line-2725"></span>
<span class="source-line-no">2726</span><span id="line-2726">  @Override</span>
<span class="source-line-no">2727</span><span id="line-2727">  public void restoreSnapshot(final byte[] snapshotName)</span>
<span class="source-line-no">2728</span><span id="line-2728">    throws IOException, RestoreSnapshotException {</span>
<span class="source-line-no">2729</span><span id="line-2729">    restoreSnapshot(Bytes.toString(snapshotName));</span>
<span class="source-line-no">2730</span><span id="line-2730">  }</span>
<span class="source-line-no">2731</span><span id="line-2731"></span>
<span class="source-line-no">2732</span><span id="line-2732">  @Override</span>
<span class="source-line-no">2733</span><span id="line-2733">  public void restoreSnapshot(final String snapshotName)</span>
<span class="source-line-no">2734</span><span id="line-2734">    throws IOException, RestoreSnapshotException {</span>
<span class="source-line-no">2735</span><span id="line-2735">    boolean takeFailSafeSnapshot =</span>
<span class="source-line-no">2736</span><span id="line-2736">      conf.getBoolean(HConstants.SNAPSHOT_RESTORE_TAKE_FAILSAFE_SNAPSHOT,</span>
<span class="source-line-no">2737</span><span id="line-2737">        HConstants.DEFAULT_SNAPSHOT_RESTORE_TAKE_FAILSAFE_SNAPSHOT);</span>
<span class="source-line-no">2738</span><span id="line-2738">    restoreSnapshot(snapshotName, takeFailSafeSnapshot);</span>
<span class="source-line-no">2739</span><span id="line-2739">  }</span>
<span class="source-line-no">2740</span><span id="line-2740"></span>
<span class="source-line-no">2741</span><span id="line-2741">  @Override</span>
<span class="source-line-no">2742</span><span id="line-2742">  public void restoreSnapshot(final byte[] snapshotName, final boolean takeFailSafeSnapshot)</span>
<span class="source-line-no">2743</span><span id="line-2743">    throws IOException, RestoreSnapshotException {</span>
<span class="source-line-no">2744</span><span id="line-2744">    restoreSnapshot(Bytes.toString(snapshotName), takeFailSafeSnapshot);</span>
<span class="source-line-no">2745</span><span id="line-2745">  }</span>
<span class="source-line-no">2746</span><span id="line-2746"></span>
<span class="source-line-no">2747</span><span id="line-2747">  /**</span>
<span class="source-line-no">2748</span><span id="line-2748">   * Check whether the snapshot exists and contains disabled table</span>
<span class="source-line-no">2749</span><span id="line-2749">   * @param snapshotName name of the snapshot to restore</span>
<span class="source-line-no">2750</span><span id="line-2750">   * @throws IOException              if a remote or network exception occurs</span>
<span class="source-line-no">2751</span><span id="line-2751">   * @throws RestoreSnapshotException if no valid snapshot is found</span>
<span class="source-line-no">2752</span><span id="line-2752">   */</span>
<span class="source-line-no">2753</span><span id="line-2753">  private TableName getTableNameBeforeRestoreSnapshot(final String snapshotName)</span>
<span class="source-line-no">2754</span><span id="line-2754">    throws IOException, RestoreSnapshotException {</span>
<span class="source-line-no">2755</span><span id="line-2755">    TableName tableName = null;</span>
<span class="source-line-no">2756</span><span id="line-2756">    for (SnapshotDescription snapshotInfo : listSnapshots()) {</span>
<span class="source-line-no">2757</span><span id="line-2757">      if (snapshotInfo.getName().equals(snapshotName)) {</span>
<span class="source-line-no">2758</span><span id="line-2758">        tableName = snapshotInfo.getTableName();</span>
<span class="source-line-no">2759</span><span id="line-2759">        break;</span>
<span class="source-line-no">2760</span><span id="line-2760">      }</span>
<span class="source-line-no">2761</span><span id="line-2761">    }</span>
<span class="source-line-no">2762</span><span id="line-2762"></span>
<span class="source-line-no">2763</span><span id="line-2763">    if (tableName == null) {</span>
<span class="source-line-no">2764</span><span id="line-2764">      throw new RestoreSnapshotException(</span>
<span class="source-line-no">2765</span><span id="line-2765">        "Unable to find the table name for snapshot=" + snapshotName);</span>
<span class="source-line-no">2766</span><span id="line-2766">    }</span>
<span class="source-line-no">2767</span><span id="line-2767">    return tableName;</span>
<span class="source-line-no">2768</span><span id="line-2768">  }</span>
<span class="source-line-no">2769</span><span id="line-2769"></span>
<span class="source-line-no">2770</span><span id="line-2770">  @Override</span>
<span class="source-line-no">2771</span><span id="line-2771">  public void restoreSnapshot(String snapshotName, boolean takeFailSafeSnapshot)</span>
<span class="source-line-no">2772</span><span id="line-2772">    throws IOException, RestoreSnapshotException {</span>
<span class="source-line-no">2773</span><span id="line-2773">    restoreSnapshot(snapshotName, takeFailSafeSnapshot, false);</span>
<span class="source-line-no">2774</span><span id="line-2774">  }</span>
<span class="source-line-no">2775</span><span id="line-2775"></span>
<span class="source-line-no">2776</span><span id="line-2776">  @Override</span>
<span class="source-line-no">2777</span><span id="line-2777">  public void restoreSnapshot(final String snapshotName, final boolean takeFailSafeSnapshot,</span>
<span class="source-line-no">2778</span><span id="line-2778">    final boolean restoreAcl) throws IOException, RestoreSnapshotException {</span>
<span class="source-line-no">2779</span><span id="line-2779">    TableName tableName = getTableNameBeforeRestoreSnapshot(snapshotName);</span>
<span class="source-line-no">2780</span><span id="line-2780"></span>
<span class="source-line-no">2781</span><span id="line-2781">    // The table does not exists, switch to clone.</span>
<span class="source-line-no">2782</span><span id="line-2782">    if (!tableExists(tableName)) {</span>
<span class="source-line-no">2783</span><span id="line-2783">      cloneSnapshot(snapshotName, tableName, restoreAcl);</span>
<span class="source-line-no">2784</span><span id="line-2784">      return;</span>
<span class="source-line-no">2785</span><span id="line-2785">    }</span>
<span class="source-line-no">2786</span><span id="line-2786"></span>
<span class="source-line-no">2787</span><span id="line-2787">    // Check if the table is disabled</span>
<span class="source-line-no">2788</span><span id="line-2788">    if (!isTableDisabled(tableName)) {</span>
<span class="source-line-no">2789</span><span id="line-2789">      throw new TableNotDisabledException(tableName);</span>
<span class="source-line-no">2790</span><span id="line-2790">    }</span>
<span class="source-line-no">2791</span><span id="line-2791"></span>
<span class="source-line-no">2792</span><span id="line-2792">    // Take a snapshot of the current state</span>
<span class="source-line-no">2793</span><span id="line-2793">    String failSafeSnapshotSnapshotName = null;</span>
<span class="source-line-no">2794</span><span id="line-2794">    if (takeFailSafeSnapshot) {</span>
<span class="source-line-no">2795</span><span id="line-2795">      failSafeSnapshotSnapshotName = conf.get("hbase.snapshot.restore.failsafe.name",</span>
<span class="source-line-no">2796</span><span id="line-2796">        "hbase-failsafe-{snapshot.name}-{restore.timestamp}");</span>
<span class="source-line-no">2797</span><span id="line-2797">      failSafeSnapshotSnapshotName =</span>
<span class="source-line-no">2798</span><span id="line-2798">        failSafeSnapshotSnapshotName.replace("{snapshot.name}", snapshotName)</span>
<span class="source-line-no">2799</span><span id="line-2799">          .replace("{table.name}", tableName.toString().replace(TableName.NAMESPACE_DELIM, '.'))</span>
<span class="source-line-no">2800</span><span id="line-2800">          .replace("{restore.timestamp}", String.valueOf(EnvironmentEdgeManager.currentTime()));</span>
<span class="source-line-no">2801</span><span id="line-2801">      LOG.info("Taking restore-failsafe snapshot: " + failSafeSnapshotSnapshotName);</span>
<span class="source-line-no">2802</span><span id="line-2802">      snapshot(failSafeSnapshotSnapshotName, tableName);</span>
<span class="source-line-no">2803</span><span id="line-2803">    }</span>
<span class="source-line-no">2804</span><span id="line-2804"></span>
<span class="source-line-no">2805</span><span id="line-2805">    try {</span>
<span class="source-line-no">2806</span><span id="line-2806">      // Restore snapshot</span>
<span class="source-line-no">2807</span><span id="line-2807">      get(internalRestoreSnapshotAsync(snapshotName, tableName, restoreAcl, null), syncWaitTimeout,</span>
<span class="source-line-no">2808</span><span id="line-2808">        TimeUnit.MILLISECONDS);</span>
<span class="source-line-no">2809</span><span id="line-2809">    } catch (IOException e) {</span>
<span class="source-line-no">2810</span><span id="line-2810">      // Something went wrong during the restore...</span>
<span class="source-line-no">2811</span><span id="line-2811">      // if the pre-restore snapshot is available try to rollback</span>
<span class="source-line-no">2812</span><span id="line-2812">      if (takeFailSafeSnapshot) {</span>
<span class="source-line-no">2813</span><span id="line-2813">        try {</span>
<span class="source-line-no">2814</span><span id="line-2814">          get(</span>
<span class="source-line-no">2815</span><span id="line-2815">            internalRestoreSnapshotAsync(failSafeSnapshotSnapshotName, tableName, restoreAcl, null),</span>
<span class="source-line-no">2816</span><span id="line-2816">            syncWaitTimeout, TimeUnit.MILLISECONDS);</span>
<span class="source-line-no">2817</span><span id="line-2817">          String msg = "Restore snapshot=" + snapshotName + " failed. Rollback to snapshot="</span>
<span class="source-line-no">2818</span><span id="line-2818">            + failSafeSnapshotSnapshotName + " succeeded.";</span>
<span class="source-line-no">2819</span><span id="line-2819">          LOG.error(msg, e);</span>
<span class="source-line-no">2820</span><span id="line-2820">          throw new RestoreSnapshotException(msg, e);</span>
<span class="source-line-no">2821</span><span id="line-2821">        } catch (IOException ex) {</span>
<span class="source-line-no">2822</span><span id="line-2822">          String msg = "Failed to restore and rollback to snapshot=" + failSafeSnapshotSnapshotName;</span>
<span class="source-line-no">2823</span><span id="line-2823">          LOG.error(msg, ex);</span>
<span class="source-line-no">2824</span><span id="line-2824">          throw new RestoreSnapshotException(msg, e);</span>
<span class="source-line-no">2825</span><span id="line-2825">        }</span>
<span class="source-line-no">2826</span><span id="line-2826">      } else {</span>
<span class="source-line-no">2827</span><span id="line-2827">        throw new RestoreSnapshotException("Failed to restore snapshot=" + snapshotName, e);</span>
<span class="source-line-no">2828</span><span id="line-2828">      }</span>
<span class="source-line-no">2829</span><span id="line-2829">    }</span>
<span class="source-line-no">2830</span><span id="line-2830"></span>
<span class="source-line-no">2831</span><span id="line-2831">    // If the restore is succeeded, delete the pre-restore snapshot</span>
<span class="source-line-no">2832</span><span id="line-2832">    if (takeFailSafeSnapshot) {</span>
<span class="source-line-no">2833</span><span id="line-2833">      try {</span>
<span class="source-line-no">2834</span><span id="line-2834">        LOG.info("Deleting restore-failsafe snapshot: " + failSafeSnapshotSnapshotName);</span>
<span class="source-line-no">2835</span><span id="line-2835">        deleteSnapshot(failSafeSnapshotSnapshotName);</span>
<span class="source-line-no">2836</span><span id="line-2836">      } catch (IOException e) {</span>
<span class="source-line-no">2837</span><span id="line-2837">        LOG.error("Unable to remove the failsafe snapshot: " + failSafeSnapshotSnapshotName, e);</span>
<span class="source-line-no">2838</span><span id="line-2838">      }</span>
<span class="source-line-no">2839</span><span id="line-2839">    }</span>
<span class="source-line-no">2840</span><span id="line-2840">  }</span>
<span class="source-line-no">2841</span><span id="line-2841"></span>
<span class="source-line-no">2842</span><span id="line-2842">  @Override</span>
<span class="source-line-no">2843</span><span id="line-2843">  public Future&lt;Void&gt; restoreSnapshotAsync(final String snapshotName)</span>
<span class="source-line-no">2844</span><span id="line-2844">    throws IOException, RestoreSnapshotException {</span>
<span class="source-line-no">2845</span><span id="line-2845">    TableName tableName = getTableNameBeforeRestoreSnapshot(snapshotName);</span>
<span class="source-line-no">2846</span><span id="line-2846"></span>
<span class="source-line-no">2847</span><span id="line-2847">    // The table does not exists, switch to clone.</span>
<span class="source-line-no">2848</span><span id="line-2848">    if (!tableExists(tableName)) {</span>
<span class="source-line-no">2849</span><span id="line-2849">      return cloneSnapshotAsync(snapshotName, tableName);</span>
<span class="source-line-no">2850</span><span id="line-2850">    }</span>
<span class="source-line-no">2851</span><span id="line-2851"></span>
<span class="source-line-no">2852</span><span id="line-2852">    // Check if the table is disabled</span>
<span class="source-line-no">2853</span><span id="line-2853">    if (!isTableDisabled(tableName)) {</span>
<span class="source-line-no">2854</span><span id="line-2854">      throw new TableNotDisabledException(tableName);</span>
<span class="source-line-no">2855</span><span id="line-2855">    }</span>
<span class="source-line-no">2856</span><span id="line-2856"></span>
<span class="source-line-no">2857</span><span id="line-2857">    return internalRestoreSnapshotAsync(snapshotName, tableName, false, null);</span>
<span class="source-line-no">2858</span><span id="line-2858">  }</span>
<span class="source-line-no">2859</span><span id="line-2859"></span>
<span class="source-line-no">2860</span><span id="line-2860">  @Override</span>
<span class="source-line-no">2861</span><span id="line-2861">  public Future&lt;Void&gt; cloneSnapshotAsync(String snapshotName, TableName tableName,</span>
<span class="source-line-no">2862</span><span id="line-2862">    boolean restoreAcl, String customSFT)</span>
<span class="source-line-no">2863</span><span id="line-2863">    throws IOException, TableExistsException, RestoreSnapshotException {</span>
<span class="source-line-no">2864</span><span id="line-2864">    if (tableExists(tableName)) {</span>
<span class="source-line-no">2865</span><span id="line-2865">      throw new TableExistsException(tableName);</span>
<span class="source-line-no">2866</span><span id="line-2866">    }</span>
<span class="source-line-no">2867</span><span id="line-2867">    return internalRestoreSnapshotAsync(snapshotName, tableName, restoreAcl, customSFT);</span>
<span class="source-line-no">2868</span><span id="line-2868">  }</span>
<span class="source-line-no">2869</span><span id="line-2869"></span>
<span class="source-line-no">2870</span><span id="line-2870">  @Override</span>
<span class="source-line-no">2871</span><span id="line-2871">  public byte[] execProcedureWithReturn(String signature, String instance,</span>
<span class="source-line-no">2872</span><span id="line-2872">    Map&lt;String, String&gt; props) throws IOException {</span>
<span class="source-line-no">2873</span><span id="line-2873">    ProcedureDescription desc = ProtobufUtil.buildProcedureDescription(signature, instance, props);</span>
<span class="source-line-no">2874</span><span id="line-2874">    final ExecProcedureRequest request =</span>
<span class="source-line-no">2875</span><span id="line-2875">      ExecProcedureRequest.newBuilder().setProcedure(desc).build();</span>
<span class="source-line-no">2876</span><span id="line-2876">    // run the procedure on the master</span>
<span class="source-line-no">2877</span><span id="line-2877">    ExecProcedureResponse response = executeCallable(</span>
<span class="source-line-no">2878</span><span id="line-2878">      new MasterCallable&lt;ExecProcedureResponse&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">2879</span><span id="line-2879">        @Override</span>
<span class="source-line-no">2880</span><span id="line-2880">        protected ExecProcedureResponse rpcCall() throws Exception {</span>
<span class="source-line-no">2881</span><span id="line-2881">          return master.execProcedureWithRet(getRpcController(), request);</span>
<span class="source-line-no">2882</span><span id="line-2882">        }</span>
<span class="source-line-no">2883</span><span id="line-2883">      });</span>
<span class="source-line-no">2884</span><span id="line-2884"></span>
<span class="source-line-no">2885</span><span id="line-2885">    return response.hasReturnData() ? response.getReturnData().toByteArray() : null;</span>
<span class="source-line-no">2886</span><span id="line-2886">  }</span>
<span class="source-line-no">2887</span><span id="line-2887"></span>
<span class="source-line-no">2888</span><span id="line-2888">  @Override</span>
<span class="source-line-no">2889</span><span id="line-2889">  public void execProcedure(String signature, String instance, Map&lt;String, String&gt; props)</span>
<span class="source-line-no">2890</span><span id="line-2890">    throws IOException {</span>
<span class="source-line-no">2891</span><span id="line-2891">    ProcedureDescription desc = ProtobufUtil.buildProcedureDescription(signature, instance, props);</span>
<span class="source-line-no">2892</span><span id="line-2892">    final ExecProcedureRequest request =</span>
<span class="source-line-no">2893</span><span id="line-2893">      ExecProcedureRequest.newBuilder().setProcedure(desc).build();</span>
<span class="source-line-no">2894</span><span id="line-2894">    // run the procedure on the master</span>
<span class="source-line-no">2895</span><span id="line-2895">    ExecProcedureResponse response = executeCallable(</span>
<span class="source-line-no">2896</span><span id="line-2896">      new MasterCallable&lt;ExecProcedureResponse&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">2897</span><span id="line-2897">        @Override</span>
<span class="source-line-no">2898</span><span id="line-2898">        protected ExecProcedureResponse rpcCall() throws Exception {</span>
<span class="source-line-no">2899</span><span id="line-2899">          return master.execProcedure(getRpcController(), request);</span>
<span class="source-line-no">2900</span><span id="line-2900">        }</span>
<span class="source-line-no">2901</span><span id="line-2901">      });</span>
<span class="source-line-no">2902</span><span id="line-2902"></span>
<span class="source-line-no">2903</span><span id="line-2903">    long start = EnvironmentEdgeManager.currentTime();</span>
<span class="source-line-no">2904</span><span id="line-2904">    long max = response.getExpectedTimeout();</span>
<span class="source-line-no">2905</span><span id="line-2905">    long maxPauseTime = max / this.numRetries;</span>
<span class="source-line-no">2906</span><span id="line-2906">    int tries = 0;</span>
<span class="source-line-no">2907</span><span id="line-2907">    LOG.debug("Waiting a max of " + max + " ms for procedure '" + signature + " : " + instance</span>
<span class="source-line-no">2908</span><span id="line-2908">      + "'' to complete. (max " + maxPauseTime + " ms per retry)");</span>
<span class="source-line-no">2909</span><span id="line-2909">    boolean done = false;</span>
<span class="source-line-no">2910</span><span id="line-2910">    while (tries == 0 || ((EnvironmentEdgeManager.currentTime() - start) &lt; max &amp;&amp; !done)) {</span>
<span class="source-line-no">2911</span><span id="line-2911">      try {</span>
<span class="source-line-no">2912</span><span id="line-2912">        // sleep a backoff &lt;= pauseTime amount</span>
<span class="source-line-no">2913</span><span id="line-2913">        long sleep = getPauseTime(tries++);</span>
<span class="source-line-no">2914</span><span id="line-2914">        sleep = sleep &gt; maxPauseTime ? maxPauseTime : sleep;</span>
<span class="source-line-no">2915</span><span id="line-2915">        LOG.debug(</span>
<span class="source-line-no">2916</span><span id="line-2916">          "(#" + tries + ") Sleeping: " + sleep + "ms while waiting for procedure completion.");</span>
<span class="source-line-no">2917</span><span id="line-2917">        Thread.sleep(sleep);</span>
<span class="source-line-no">2918</span><span id="line-2918">      } catch (InterruptedException e) {</span>
<span class="source-line-no">2919</span><span id="line-2919">        throw (InterruptedIOException) new InterruptedIOException("Interrupted").initCause(e);</span>
<span class="source-line-no">2920</span><span id="line-2920">      }</span>
<span class="source-line-no">2921</span><span id="line-2921">      LOG.debug("Getting current status of procedure from master...");</span>
<span class="source-line-no">2922</span><span id="line-2922">      done = isProcedureFinished(signature, instance, props);</span>
<span class="source-line-no">2923</span><span id="line-2923">    }</span>
<span class="source-line-no">2924</span><span id="line-2924">    if (!done) {</span>
<span class="source-line-no">2925</span><span id="line-2925">      throw new IOException("Procedure '" + signature + " : " + instance</span>
<span class="source-line-no">2926</span><span id="line-2926">        + "' wasn't completed in expectedTime:" + max + " ms");</span>
<span class="source-line-no">2927</span><span id="line-2927">    }</span>
<span class="source-line-no">2928</span><span id="line-2928">  }</span>
<span class="source-line-no">2929</span><span id="line-2929"></span>
<span class="source-line-no">2930</span><span id="line-2930">  @Override</span>
<span class="source-line-no">2931</span><span id="line-2931">  public boolean isProcedureFinished(String signature, String instance, Map&lt;String, String&gt; props)</span>
<span class="source-line-no">2932</span><span id="line-2932">    throws IOException {</span>
<span class="source-line-no">2933</span><span id="line-2933">    ProcedureDescription desc = ProtobufUtil.buildProcedureDescription(signature, instance, props);</span>
<span class="source-line-no">2934</span><span id="line-2934">    return executeCallable(</span>
<span class="source-line-no">2935</span><span id="line-2935">      new MasterCallable&lt;IsProcedureDoneResponse&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">2936</span><span id="line-2936">        @Override</span>
<span class="source-line-no">2937</span><span id="line-2937">        protected IsProcedureDoneResponse rpcCall() throws Exception {</span>
<span class="source-line-no">2938</span><span id="line-2938">          return master.isProcedureDone(getRpcController(),</span>
<span class="source-line-no">2939</span><span id="line-2939">            IsProcedureDoneRequest.newBuilder().setProcedure(desc).build());</span>
<span class="source-line-no">2940</span><span id="line-2940">        }</span>
<span class="source-line-no">2941</span><span id="line-2941">      }).getDone();</span>
<span class="source-line-no">2942</span><span id="line-2942">  }</span>
<span class="source-line-no">2943</span><span id="line-2943"></span>
<span class="source-line-no">2944</span><span id="line-2944">  /**</span>
<span class="source-line-no">2945</span><span id="line-2945">   * Execute Restore/Clone snapshot and wait for the server to complete (blocking). To check if the</span>
<span class="source-line-no">2946</span><span id="line-2946">   * cloned table exists, use {@link #isTableAvailable} -- it is not safe to create an HTable</span>
<span class="source-line-no">2947</span><span id="line-2947">   * instance to this table before it is available.</span>
<span class="source-line-no">2948</span><span id="line-2948">   * @param snapshotName snapshot to restore</span>
<span class="source-line-no">2949</span><span id="line-2949">   * @param tableName    table name to restore the snapshot on</span>
<span class="source-line-no">2950</span><span id="line-2950">   * @throws IOException              if a remote or network exception occurs</span>
<span class="source-line-no">2951</span><span id="line-2951">   * @throws RestoreSnapshotException if snapshot failed to be restored</span>
<span class="source-line-no">2952</span><span id="line-2952">   * @throws IllegalArgumentException if the restore request is formatted incorrectly</span>
<span class="source-line-no">2953</span><span id="line-2953">   */</span>
<span class="source-line-no">2954</span><span id="line-2954">  private Future&lt;Void&gt; internalRestoreSnapshotAsync(final String snapshotName,</span>
<span class="source-line-no">2955</span><span id="line-2955">    final TableName tableName, final boolean restoreAcl, String customSFT)</span>
<span class="source-line-no">2956</span><span id="line-2956">    throws IOException, RestoreSnapshotException {</span>
<span class="source-line-no">2957</span><span id="line-2957">    final SnapshotProtos.SnapshotDescription snapshot = SnapshotProtos.SnapshotDescription</span>
<span class="source-line-no">2958</span><span id="line-2958">      .newBuilder().setName(snapshotName).setTable(tableName.getNameAsString()).build();</span>
<span class="source-line-no">2959</span><span id="line-2959"></span>
<span class="source-line-no">2960</span><span id="line-2960">    // actually restore the snapshot</span>
<span class="source-line-no">2961</span><span id="line-2961">    ClientSnapshotDescriptionUtils.assertSnapshotRequestIsValid(snapshot);</span>
<span class="source-line-no">2962</span><span id="line-2962"></span>
<span class="source-line-no">2963</span><span id="line-2963">    RestoreSnapshotResponse response = executeCallable(</span>
<span class="source-line-no">2964</span><span id="line-2964">      new MasterCallable&lt;RestoreSnapshotResponse&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">2965</span><span id="line-2965">        Long nonceGroup = ng.getNonceGroup();</span>
<span class="source-line-no">2966</span><span id="line-2966">        Long nonce = ng.newNonce();</span>
<span class="source-line-no">2967</span><span id="line-2967"></span>
<span class="source-line-no">2968</span><span id="line-2968">        @Override</span>
<span class="source-line-no">2969</span><span id="line-2969">        protected RestoreSnapshotResponse rpcCall() throws Exception {</span>
<span class="source-line-no">2970</span><span id="line-2970">          final RestoreSnapshotRequest.Builder builder =</span>
<span class="source-line-no">2971</span><span id="line-2971">            RestoreSnapshotRequest.newBuilder().setSnapshot(snapshot).setNonceGroup(nonceGroup)</span>
<span class="source-line-no">2972</span><span id="line-2972">              .setNonce(nonce).setRestoreACL(restoreAcl);</span>
<span class="source-line-no">2973</span><span id="line-2973">          if (customSFT != null) {</span>
<span class="source-line-no">2974</span><span id="line-2974">            builder.setCustomSFT(customSFT);</span>
<span class="source-line-no">2975</span><span id="line-2975">          }</span>
<span class="source-line-no">2976</span><span id="line-2976">          return master.restoreSnapshot(getRpcController(), builder.build());</span>
<span class="source-line-no">2977</span><span id="line-2977">        }</span>
<span class="source-line-no">2978</span><span id="line-2978">      });</span>
<span class="source-line-no">2979</span><span id="line-2979"></span>
<span class="source-line-no">2980</span><span id="line-2980">    return new RestoreSnapshotFuture(this, snapshot, tableName, response);</span>
<span class="source-line-no">2981</span><span id="line-2981">  }</span>
<span class="source-line-no">2982</span><span id="line-2982"></span>
<span class="source-line-no">2983</span><span id="line-2983">  private static class RestoreSnapshotFuture extends TableFuture&lt;Void&gt; {</span>
<span class="source-line-no">2984</span><span id="line-2984">    public RestoreSnapshotFuture(final HBaseAdmin admin,</span>
<span class="source-line-no">2985</span><span id="line-2985">      final SnapshotProtos.SnapshotDescription snapshot, final TableName tableName,</span>
<span class="source-line-no">2986</span><span id="line-2986">      final RestoreSnapshotResponse response) {</span>
<span class="source-line-no">2987</span><span id="line-2987">      super(admin, tableName,</span>
<span class="source-line-no">2988</span><span id="line-2988">        (response != null &amp;&amp; response.hasProcId()) ? response.getProcId() : null);</span>
<span class="source-line-no">2989</span><span id="line-2989"></span>
<span class="source-line-no">2990</span><span id="line-2990">      if (response != null &amp;&amp; !response.hasProcId()) {</span>
<span class="source-line-no">2991</span><span id="line-2991">        throw new UnsupportedOperationException("Client could not call old version of Server");</span>
<span class="source-line-no">2992</span><span id="line-2992">      }</span>
<span class="source-line-no">2993</span><span id="line-2993">    }</span>
<span class="source-line-no">2994</span><span id="line-2994"></span>
<span class="source-line-no">2995</span><span id="line-2995">    public RestoreSnapshotFuture(final HBaseAdmin admin, final TableName tableName,</span>
<span class="source-line-no">2996</span><span id="line-2996">      final Long procId) {</span>
<span class="source-line-no">2997</span><span id="line-2997">      super(admin, tableName, procId);</span>
<span class="source-line-no">2998</span><span id="line-2998">    }</span>
<span class="source-line-no">2999</span><span id="line-2999"></span>
<span class="source-line-no">3000</span><span id="line-3000">    @Override</span>
<span class="source-line-no">3001</span><span id="line-3001">    public String getOperationType() {</span>
<span class="source-line-no">3002</span><span id="line-3002">      return "MODIFY";</span>
<span class="source-line-no">3003</span><span id="line-3003">    }</span>
<span class="source-line-no">3004</span><span id="line-3004">  }</span>
<span class="source-line-no">3005</span><span id="line-3005"></span>
<span class="source-line-no">3006</span><span id="line-3006">  @Override</span>
<span class="source-line-no">3007</span><span id="line-3007">  public List&lt;SnapshotDescription&gt; listSnapshots() throws IOException {</span>
<span class="source-line-no">3008</span><span id="line-3008">    return executeCallable(</span>
<span class="source-line-no">3009</span><span id="line-3009">      new MasterCallable&lt;List&lt;SnapshotDescription&gt;&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">3010</span><span id="line-3010">        @Override</span>
<span class="source-line-no">3011</span><span id="line-3011">        protected List&lt;SnapshotDescription&gt; rpcCall() throws Exception {</span>
<span class="source-line-no">3012</span><span id="line-3012">          List&lt;SnapshotProtos.SnapshotDescription&gt; snapshotsList =</span>
<span class="source-line-no">3013</span><span id="line-3013">            master.getCompletedSnapshots(getRpcController(),</span>
<span class="source-line-no">3014</span><span id="line-3014">              GetCompletedSnapshotsRequest.newBuilder().build()).getSnapshotsList();</span>
<span class="source-line-no">3015</span><span id="line-3015">          List&lt;SnapshotDescription&gt; result = new ArrayList&lt;&gt;(snapshotsList.size());</span>
<span class="source-line-no">3016</span><span id="line-3016">          for (SnapshotProtos.SnapshotDescription snapshot : snapshotsList) {</span>
<span class="source-line-no">3017</span><span id="line-3017">            result.add(ProtobufUtil.createSnapshotDesc(snapshot));</span>
<span class="source-line-no">3018</span><span id="line-3018">          }</span>
<span class="source-line-no">3019</span><span id="line-3019">          return result;</span>
<span class="source-line-no">3020</span><span id="line-3020">        }</span>
<span class="source-line-no">3021</span><span id="line-3021">      });</span>
<span class="source-line-no">3022</span><span id="line-3022">  }</span>
<span class="source-line-no">3023</span><span id="line-3023"></span>
<span class="source-line-no">3024</span><span id="line-3024">  @Override</span>
<span class="source-line-no">3025</span><span id="line-3025">  public List&lt;SnapshotDescription&gt; listSnapshots(String regex) throws IOException {</span>
<span class="source-line-no">3026</span><span id="line-3026">    return listSnapshots(Pattern.compile(regex));</span>
<span class="source-line-no">3027</span><span id="line-3027">  }</span>
<span class="source-line-no">3028</span><span id="line-3028"></span>
<span class="source-line-no">3029</span><span id="line-3029">  @Override</span>
<span class="source-line-no">3030</span><span id="line-3030">  public List&lt;SnapshotDescription&gt; listSnapshots(Pattern pattern) throws IOException {</span>
<span class="source-line-no">3031</span><span id="line-3031">    List&lt;SnapshotDescription&gt; matched = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">3032</span><span id="line-3032">    List&lt;SnapshotDescription&gt; snapshots = listSnapshots();</span>
<span class="source-line-no">3033</span><span id="line-3033">    for (SnapshotDescription snapshot : snapshots) {</span>
<span class="source-line-no">3034</span><span id="line-3034">      if (pattern.matcher(snapshot.getName()).matches()) {</span>
<span class="source-line-no">3035</span><span id="line-3035">        matched.add(snapshot);</span>
<span class="source-line-no">3036</span><span id="line-3036">      }</span>
<span class="source-line-no">3037</span><span id="line-3037">    }</span>
<span class="source-line-no">3038</span><span id="line-3038">    return matched;</span>
<span class="source-line-no">3039</span><span id="line-3039">  }</span>
<span class="source-line-no">3040</span><span id="line-3040"></span>
<span class="source-line-no">3041</span><span id="line-3041">  @Override</span>
<span class="source-line-no">3042</span><span id="line-3042">  public List&lt;SnapshotDescription&gt; listTableSnapshots(String tableNameRegex,</span>
<span class="source-line-no">3043</span><span id="line-3043">    String snapshotNameRegex) throws IOException {</span>
<span class="source-line-no">3044</span><span id="line-3044">    return listTableSnapshots(Pattern.compile(tableNameRegex), Pattern.compile(snapshotNameRegex));</span>
<span class="source-line-no">3045</span><span id="line-3045">  }</span>
<span class="source-line-no">3046</span><span id="line-3046"></span>
<span class="source-line-no">3047</span><span id="line-3047">  @Override</span>
<span class="source-line-no">3048</span><span id="line-3048">  public List&lt;SnapshotDescription&gt; listTableSnapshots(Pattern tableNamePattern,</span>
<span class="source-line-no">3049</span><span id="line-3049">    Pattern snapshotNamePattern) throws IOException {</span>
<span class="source-line-no">3050</span><span id="line-3050">    TableName[] tableNames = listTableNames(tableNamePattern);</span>
<span class="source-line-no">3051</span><span id="line-3051"></span>
<span class="source-line-no">3052</span><span id="line-3052">    List&lt;SnapshotDescription&gt; tableSnapshots = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">3053</span><span id="line-3053">    List&lt;SnapshotDescription&gt; snapshots = listSnapshots(snapshotNamePattern);</span>
<span class="source-line-no">3054</span><span id="line-3054"></span>
<span class="source-line-no">3055</span><span id="line-3055">    List&lt;TableName&gt; listOfTableNames = Arrays.asList(tableNames);</span>
<span class="source-line-no">3056</span><span id="line-3056">    for (SnapshotDescription snapshot : snapshots) {</span>
<span class="source-line-no">3057</span><span id="line-3057">      if (listOfTableNames.contains(snapshot.getTableName())) {</span>
<span class="source-line-no">3058</span><span id="line-3058">        tableSnapshots.add(snapshot);</span>
<span class="source-line-no">3059</span><span id="line-3059">      }</span>
<span class="source-line-no">3060</span><span id="line-3060">    }</span>
<span class="source-line-no">3061</span><span id="line-3061">    return tableSnapshots;</span>
<span class="source-line-no">3062</span><span id="line-3062">  }</span>
<span class="source-line-no">3063</span><span id="line-3063"></span>
<span class="source-line-no">3064</span><span id="line-3064">  @Override</span>
<span class="source-line-no">3065</span><span id="line-3065">  public void deleteSnapshot(final byte[] snapshotName) throws IOException {</span>
<span class="source-line-no">3066</span><span id="line-3066">    deleteSnapshot(Bytes.toString(snapshotName));</span>
<span class="source-line-no">3067</span><span id="line-3067">  }</span>
<span class="source-line-no">3068</span><span id="line-3068"></span>
<span class="source-line-no">3069</span><span id="line-3069">  @Override</span>
<span class="source-line-no">3070</span><span id="line-3070">  public void deleteSnapshot(final String snapshotName) throws IOException {</span>
<span class="source-line-no">3071</span><span id="line-3071">    // make sure the snapshot is possibly valid</span>
<span class="source-line-no">3072</span><span id="line-3072">    TableName.isLegalFullyQualifiedTableName(Bytes.toBytes(snapshotName));</span>
<span class="source-line-no">3073</span><span id="line-3073">    // do the delete</span>
<span class="source-line-no">3074</span><span id="line-3074">    executeCallable(new MasterCallable&lt;Void&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">3075</span><span id="line-3075">      @Override</span>
<span class="source-line-no">3076</span><span id="line-3076">      protected Void rpcCall() throws Exception {</span>
<span class="source-line-no">3077</span><span id="line-3077">        master.deleteSnapshot(getRpcController(),</span>
<span class="source-line-no">3078</span><span id="line-3078">          DeleteSnapshotRequest.newBuilder()</span>
<span class="source-line-no">3079</span><span id="line-3079">            .setSnapshot(</span>
<span class="source-line-no">3080</span><span id="line-3080">              SnapshotProtos.SnapshotDescription.newBuilder().setName(snapshotName).build())</span>
<span class="source-line-no">3081</span><span id="line-3081">            .build());</span>
<span class="source-line-no">3082</span><span id="line-3082">        return null;</span>
<span class="source-line-no">3083</span><span id="line-3083">      }</span>
<span class="source-line-no">3084</span><span id="line-3084">    });</span>
<span class="source-line-no">3085</span><span id="line-3085">  }</span>
<span class="source-line-no">3086</span><span id="line-3086"></span>
<span class="source-line-no">3087</span><span id="line-3087">  @Override</span>
<span class="source-line-no">3088</span><span id="line-3088">  public void deleteSnapshots(final String regex) throws IOException {</span>
<span class="source-line-no">3089</span><span id="line-3089">    deleteSnapshots(Pattern.compile(regex));</span>
<span class="source-line-no">3090</span><span id="line-3090">  }</span>
<span class="source-line-no">3091</span><span id="line-3091"></span>
<span class="source-line-no">3092</span><span id="line-3092">  @Override</span>
<span class="source-line-no">3093</span><span id="line-3093">  public void deleteSnapshots(final Pattern pattern) throws IOException {</span>
<span class="source-line-no">3094</span><span id="line-3094">    List&lt;SnapshotDescription&gt; snapshots = listSnapshots(pattern);</span>
<span class="source-line-no">3095</span><span id="line-3095">    for (final SnapshotDescription snapshot : snapshots) {</span>
<span class="source-line-no">3096</span><span id="line-3096">      try {</span>
<span class="source-line-no">3097</span><span id="line-3097">        internalDeleteSnapshot(snapshot);</span>
<span class="source-line-no">3098</span><span id="line-3098">      } catch (IOException ex) {</span>
<span class="source-line-no">3099</span><span id="line-3099">        LOG.info("Failed to delete snapshot " + snapshot.getName() + " for table "</span>
<span class="source-line-no">3100</span><span id="line-3100">          + snapshot.getTableNameAsString(), ex);</span>
<span class="source-line-no">3101</span><span id="line-3101">      }</span>
<span class="source-line-no">3102</span><span id="line-3102">    }</span>
<span class="source-line-no">3103</span><span id="line-3103">  }</span>
<span class="source-line-no">3104</span><span id="line-3104"></span>
<span class="source-line-no">3105</span><span id="line-3105">  private void internalDeleteSnapshot(final SnapshotDescription snapshot) throws IOException {</span>
<span class="source-line-no">3106</span><span id="line-3106">    executeCallable(new MasterCallable&lt;Void&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">3107</span><span id="line-3107">      @Override</span>
<span class="source-line-no">3108</span><span id="line-3108">      protected Void rpcCall() throws Exception {</span>
<span class="source-line-no">3109</span><span id="line-3109">        this.master.deleteSnapshot(getRpcController(), DeleteSnapshotRequest.newBuilder()</span>
<span class="source-line-no">3110</span><span id="line-3110">          .setSnapshot(ProtobufUtil.createHBaseProtosSnapshotDesc(snapshot)).build());</span>
<span class="source-line-no">3111</span><span id="line-3111">        return null;</span>
<span class="source-line-no">3112</span><span id="line-3112">      }</span>
<span class="source-line-no">3113</span><span id="line-3113">    });</span>
<span class="source-line-no">3114</span><span id="line-3114">  }</span>
<span class="source-line-no">3115</span><span id="line-3115"></span>
<span class="source-line-no">3116</span><span id="line-3116">  @Override</span>
<span class="source-line-no">3117</span><span id="line-3117">  public void deleteTableSnapshots(String tableNameRegex, String snapshotNameRegex)</span>
<span class="source-line-no">3118</span><span id="line-3118">    throws IOException {</span>
<span class="source-line-no">3119</span><span id="line-3119">    deleteTableSnapshots(Pattern.compile(tableNameRegex), Pattern.compile(snapshotNameRegex));</span>
<span class="source-line-no">3120</span><span id="line-3120">  }</span>
<span class="source-line-no">3121</span><span id="line-3121"></span>
<span class="source-line-no">3122</span><span id="line-3122">  @Override</span>
<span class="source-line-no">3123</span><span id="line-3123">  public void deleteTableSnapshots(Pattern tableNamePattern, Pattern snapshotNamePattern)</span>
<span class="source-line-no">3124</span><span id="line-3124">    throws IOException {</span>
<span class="source-line-no">3125</span><span id="line-3125">    List&lt;SnapshotDescription&gt; snapshots = listTableSnapshots(tableNamePattern, snapshotNamePattern);</span>
<span class="source-line-no">3126</span><span id="line-3126">    for (SnapshotDescription snapshot : snapshots) {</span>
<span class="source-line-no">3127</span><span id="line-3127">      try {</span>
<span class="source-line-no">3128</span><span id="line-3128">        internalDeleteSnapshot(snapshot);</span>
<span class="source-line-no">3129</span><span id="line-3129">        LOG.debug("Successfully deleted snapshot: " + snapshot.getName());</span>
<span class="source-line-no">3130</span><span id="line-3130">      } catch (IOException e) {</span>
<span class="source-line-no">3131</span><span id="line-3131">        LOG.error("Failed to delete snapshot: " + snapshot.getName(), e);</span>
<span class="source-line-no">3132</span><span id="line-3132">      }</span>
<span class="source-line-no">3133</span><span id="line-3133">    }</span>
<span class="source-line-no">3134</span><span id="line-3134">  }</span>
<span class="source-line-no">3135</span><span id="line-3135"></span>
<span class="source-line-no">3136</span><span id="line-3136">  @Override</span>
<span class="source-line-no">3137</span><span id="line-3137">  public void setQuota(final QuotaSettings quota) throws IOException {</span>
<span class="source-line-no">3138</span><span id="line-3138">    executeCallable(new MasterCallable&lt;Void&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">3139</span><span id="line-3139">      @Override</span>
<span class="source-line-no">3140</span><span id="line-3140">      protected Void rpcCall() throws Exception {</span>
<span class="source-line-no">3141</span><span id="line-3141">        this.master.setQuota(getRpcController(), QuotaSettings.buildSetQuotaRequestProto(quota));</span>
<span class="source-line-no">3142</span><span id="line-3142">        return null;</span>
<span class="source-line-no">3143</span><span id="line-3143">      }</span>
<span class="source-line-no">3144</span><span id="line-3144">    });</span>
<span class="source-line-no">3145</span><span id="line-3145">  }</span>
<span class="source-line-no">3146</span><span id="line-3146"></span>
<span class="source-line-no">3147</span><span id="line-3147">  @Override</span>
<span class="source-line-no">3148</span><span id="line-3148">  public QuotaRetriever getQuotaRetriever(final QuotaFilter filter) throws IOException {</span>
<span class="source-line-no">3149</span><span id="line-3149">    return QuotaRetriever.open(conf, filter);</span>
<span class="source-line-no">3150</span><span id="line-3150">  }</span>
<span class="source-line-no">3151</span><span id="line-3151"></span>
<span class="source-line-no">3152</span><span id="line-3152">  @Override</span>
<span class="source-line-no">3153</span><span id="line-3153">  public List&lt;QuotaSettings&gt; getQuota(QuotaFilter filter) throws IOException {</span>
<span class="source-line-no">3154</span><span id="line-3154">    List&lt;QuotaSettings&gt; quotas = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">3155</span><span id="line-3155">    try (QuotaRetriever retriever = QuotaRetriever.open(conf, filter)) {</span>
<span class="source-line-no">3156</span><span id="line-3156">      Iterator&lt;QuotaSettings&gt; iterator = retriever.iterator();</span>
<span class="source-line-no">3157</span><span id="line-3157">      while (iterator.hasNext()) {</span>
<span class="source-line-no">3158</span><span id="line-3158">        quotas.add(iterator.next());</span>
<span class="source-line-no">3159</span><span id="line-3159">      }</span>
<span class="source-line-no">3160</span><span id="line-3160">    }</span>
<span class="source-line-no">3161</span><span id="line-3161">    return quotas;</span>
<span class="source-line-no">3162</span><span id="line-3162">  }</span>
<span class="source-line-no">3163</span><span id="line-3163"></span>
<span class="source-line-no">3164</span><span id="line-3164">  private &lt;C extends RetryingCallable&lt;V&gt; &amp; Closeable, V&gt; V executeCallable(C callable)</span>
<span class="source-line-no">3165</span><span id="line-3165">    throws IOException {</span>
<span class="source-line-no">3166</span><span id="line-3166">    return executeCallable(callable, rpcCallerFactory, operationTimeout, rpcTimeout);</span>
<span class="source-line-no">3167</span><span id="line-3167">  }</span>
<span class="source-line-no">3168</span><span id="line-3168"></span>
<span class="source-line-no">3169</span><span id="line-3169">  static private &lt;C extends RetryingCallable&lt;V&gt; &amp; Closeable, V&gt; V executeCallable(C callable,</span>
<span class="source-line-no">3170</span><span id="line-3170">    RpcRetryingCallerFactory rpcCallerFactory, int operationTimeout, int rpcTimeout)</span>
<span class="source-line-no">3171</span><span id="line-3171">    throws IOException {</span>
<span class="source-line-no">3172</span><span id="line-3172">    RpcRetryingCaller&lt;V&gt; caller = rpcCallerFactory.newCaller(rpcTimeout);</span>
<span class="source-line-no">3173</span><span id="line-3173">    try {</span>
<span class="source-line-no">3174</span><span id="line-3174">      return caller.callWithRetries(callable, operationTimeout);</span>
<span class="source-line-no">3175</span><span id="line-3175">    } finally {</span>
<span class="source-line-no">3176</span><span id="line-3176">      callable.close();</span>
<span class="source-line-no">3177</span><span id="line-3177">    }</span>
<span class="source-line-no">3178</span><span id="line-3178">  }</span>
<span class="source-line-no">3179</span><span id="line-3179"></span>
<span class="source-line-no">3180</span><span id="line-3180">  @Override</span>
<span class="source-line-no">3181</span><span id="line-3181">  // Coprocessor Endpoint against the Master.</span>
<span class="source-line-no">3182</span><span id="line-3182">  public CoprocessorRpcChannel coprocessorService() {</span>
<span class="source-line-no">3183</span><span id="line-3183">    return new SyncCoprocessorRpcChannel() {</span>
<span class="source-line-no">3184</span><span id="line-3184">      @Override</span>
<span class="source-line-no">3185</span><span id="line-3185">      protected Message callExecService(final RpcController controller,</span>
<span class="source-line-no">3186</span><span id="line-3186">        final Descriptors.MethodDescriptor method, final Message request,</span>
<span class="source-line-no">3187</span><span id="line-3187">        final Message responsePrototype) throws IOException {</span>
<span class="source-line-no">3188</span><span id="line-3188">        if (LOG.isTraceEnabled()) {</span>
<span class="source-line-no">3189</span><span id="line-3189">          LOG.trace("Call: " + method.getName() + ", " + request.toString());</span>
<span class="source-line-no">3190</span><span id="line-3190">        }</span>
<span class="source-line-no">3191</span><span id="line-3191">        // Try-with-resources so close gets called when we are done.</span>
<span class="source-line-no">3192</span><span id="line-3192">        try (MasterCallable&lt;CoprocessorServiceResponse&gt; callable =</span>
<span class="source-line-no">3193</span><span id="line-3193">          new MasterCallable&lt;CoprocessorServiceResponse&gt;(connection,</span>
<span class="source-line-no">3194</span><span id="line-3194">            connection.getRpcControllerFactory()) {</span>
<span class="source-line-no">3195</span><span id="line-3195">            @Override</span>
<span class="source-line-no">3196</span><span id="line-3196">            protected CoprocessorServiceResponse rpcCall() throws Exception {</span>
<span class="source-line-no">3197</span><span id="line-3197">              CoprocessorServiceRequest csr =</span>
<span class="source-line-no">3198</span><span id="line-3198">                CoprocessorRpcUtils.getCoprocessorServiceRequest(method, request);</span>
<span class="source-line-no">3199</span><span id="line-3199">              return this.master.execMasterService(getRpcController(), csr);</span>
<span class="source-line-no">3200</span><span id="line-3200">            }</span>
<span class="source-line-no">3201</span><span id="line-3201">          }) {</span>
<span class="source-line-no">3202</span><span id="line-3202">          // TODO: Are we retrying here? Does not seem so. We should use RetryingRpcCaller</span>
<span class="source-line-no">3203</span><span id="line-3203">          callable.prepare(false);</span>
<span class="source-line-no">3204</span><span id="line-3204">          int operationTimeout = connection.getConnectionConfiguration().getOperationTimeout();</span>
<span class="source-line-no">3205</span><span id="line-3205">          CoprocessorServiceResponse result = callable.call(operationTimeout);</span>
<span class="source-line-no">3206</span><span id="line-3206">          return CoprocessorRpcUtils.getResponse(result, responsePrototype);</span>
<span class="source-line-no">3207</span><span id="line-3207">        }</span>
<span class="source-line-no">3208</span><span id="line-3208">      }</span>
<span class="source-line-no">3209</span><span id="line-3209">    };</span>
<span class="source-line-no">3210</span><span id="line-3210">  }</span>
<span class="source-line-no">3211</span><span id="line-3211"></span>
<span class="source-line-no">3212</span><span id="line-3212">  @Override</span>
<span class="source-line-no">3213</span><span id="line-3213">  public CoprocessorRpcChannel coprocessorService(final ServerName serverName) {</span>
<span class="source-line-no">3214</span><span id="line-3214">    return new SyncCoprocessorRpcChannel() {</span>
<span class="source-line-no">3215</span><span id="line-3215">      @Override</span>
<span class="source-line-no">3216</span><span id="line-3216">      protected Message callExecService(RpcController controller,</span>
<span class="source-line-no">3217</span><span id="line-3217">        Descriptors.MethodDescriptor method, Message request, Message responsePrototype)</span>
<span class="source-line-no">3218</span><span id="line-3218">        throws IOException {</span>
<span class="source-line-no">3219</span><span id="line-3219">        if (LOG.isTraceEnabled()) {</span>
<span class="source-line-no">3220</span><span id="line-3220">          LOG.trace("Call: " + method.getName() + ", " + request.toString());</span>
<span class="source-line-no">3221</span><span id="line-3221">        }</span>
<span class="source-line-no">3222</span><span id="line-3222">        CoprocessorServiceRequest csr =</span>
<span class="source-line-no">3223</span><span id="line-3223">          CoprocessorRpcUtils.getCoprocessorServiceRequest(method, request);</span>
<span class="source-line-no">3224</span><span id="line-3224">        // TODO: Are we retrying here? Does not seem so. We should use RetryingRpcCaller</span>
<span class="source-line-no">3225</span><span id="line-3225">        // TODO: Make this same as RegionCoprocessorRpcChannel and MasterCoprocessorRpcChannel. They</span>
<span class="source-line-no">3226</span><span id="line-3226">        // are all different though should do same thing; e.g. RpcChannel setup.</span>
<span class="source-line-no">3227</span><span id="line-3227">        ClientProtos.ClientService.BlockingInterface stub = connection.getClient(serverName);</span>
<span class="source-line-no">3228</span><span id="line-3228">        CoprocessorServiceResponse result;</span>
<span class="source-line-no">3229</span><span id="line-3229">        try {</span>
<span class="source-line-no">3230</span><span id="line-3230">          result =</span>
<span class="source-line-no">3231</span><span id="line-3231">            stub.execRegionServerService(connection.getRpcControllerFactory().newController(), csr);</span>
<span class="source-line-no">3232</span><span id="line-3232">          return CoprocessorRpcUtils.getResponse(result, responsePrototype);</span>
<span class="source-line-no">3233</span><span id="line-3233">        } catch (ServiceException e) {</span>
<span class="source-line-no">3234</span><span id="line-3234">          throw ProtobufUtil.handleRemoteException(e);</span>
<span class="source-line-no">3235</span><span id="line-3235">        }</span>
<span class="source-line-no">3236</span><span id="line-3236">      }</span>
<span class="source-line-no">3237</span><span id="line-3237">    };</span>
<span class="source-line-no">3238</span><span id="line-3238">  }</span>
<span class="source-line-no">3239</span><span id="line-3239"></span>
<span class="source-line-no">3240</span><span id="line-3240">  @Override</span>
<span class="source-line-no">3241</span><span id="line-3241">  public void updateConfiguration(final ServerName server) throws IOException {</span>
<span class="source-line-no">3242</span><span id="line-3242">    final AdminService.BlockingInterface admin = this.connection.getAdmin(server);</span>
<span class="source-line-no">3243</span><span id="line-3243">    Callable&lt;Void&gt; callable = new Callable&lt;Void&gt;() {</span>
<span class="source-line-no">3244</span><span id="line-3244">      @Override</span>
<span class="source-line-no">3245</span><span id="line-3245">      public Void call() throws Exception {</span>
<span class="source-line-no">3246</span><span id="line-3246">        admin.updateConfiguration(null, UpdateConfigurationRequest.getDefaultInstance());</span>
<span class="source-line-no">3247</span><span id="line-3247">        return null;</span>
<span class="source-line-no">3248</span><span id="line-3248">      }</span>
<span class="source-line-no">3249</span><span id="line-3249">    };</span>
<span class="source-line-no">3250</span><span id="line-3250">    ProtobufUtil.call(callable);</span>
<span class="source-line-no">3251</span><span id="line-3251">  }</span>
<span class="source-line-no">3252</span><span id="line-3252"></span>
<span class="source-line-no">3253</span><span id="line-3253">  @Override</span>
<span class="source-line-no">3254</span><span id="line-3254">  public void updateConfiguration() throws IOException {</span>
<span class="source-line-no">3255</span><span id="line-3255">    ClusterMetrics status =</span>
<span class="source-line-no">3256</span><span id="line-3256">      getClusterMetrics(EnumSet.of(Option.LIVE_SERVERS, Option.MASTER, Option.BACKUP_MASTERS));</span>
<span class="source-line-no">3257</span><span id="line-3257">    for (ServerName server : status.getLiveServerMetrics().keySet()) {</span>
<span class="source-line-no">3258</span><span id="line-3258">      updateConfiguration(server);</span>
<span class="source-line-no">3259</span><span id="line-3259">    }</span>
<span class="source-line-no">3260</span><span id="line-3260"></span>
<span class="source-line-no">3261</span><span id="line-3261">    updateConfiguration(status.getMasterName());</span>
<span class="source-line-no">3262</span><span id="line-3262"></span>
<span class="source-line-no">3263</span><span id="line-3263">    for (ServerName server : status.getBackupMasterNames()) {</span>
<span class="source-line-no">3264</span><span id="line-3264">      updateConfiguration(server);</span>
<span class="source-line-no">3265</span><span id="line-3265">    }</span>
<span class="source-line-no">3266</span><span id="line-3266">  }</span>
<span class="source-line-no">3267</span><span id="line-3267"></span>
<span class="source-line-no">3268</span><span id="line-3268">  @Override</span>
<span class="source-line-no">3269</span><span id="line-3269">  public long getLastMajorCompactionTimestamp(final TableName tableName) throws IOException {</span>
<span class="source-line-no">3270</span><span id="line-3270">    return executeCallable(new MasterCallable&lt;Long&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">3271</span><span id="line-3271">      @Override</span>
<span class="source-line-no">3272</span><span id="line-3272">      protected Long rpcCall() throws Exception {</span>
<span class="source-line-no">3273</span><span id="line-3273">        MajorCompactionTimestampRequest req = MajorCompactionTimestampRequest.newBuilder()</span>
<span class="source-line-no">3274</span><span id="line-3274">          .setTableName(ProtobufUtil.toProtoTableName(tableName)).build();</span>
<span class="source-line-no">3275</span><span id="line-3275">        return master.getLastMajorCompactionTimestamp(getRpcController(), req)</span>
<span class="source-line-no">3276</span><span id="line-3276">          .getCompactionTimestamp();</span>
<span class="source-line-no">3277</span><span id="line-3277">      }</span>
<span class="source-line-no">3278</span><span id="line-3278">    });</span>
<span class="source-line-no">3279</span><span id="line-3279">  }</span>
<span class="source-line-no">3280</span><span id="line-3280"></span>
<span class="source-line-no">3281</span><span id="line-3281">  @Override</span>
<span class="source-line-no">3282</span><span id="line-3282">  public long getLastMajorCompactionTimestampForRegion(final byte[] regionName) throws IOException {</span>
<span class="source-line-no">3283</span><span id="line-3283">    return executeCallable(new MasterCallable&lt;Long&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">3284</span><span id="line-3284">      @Override</span>
<span class="source-line-no">3285</span><span id="line-3285">      protected Long rpcCall() throws Exception {</span>
<span class="source-line-no">3286</span><span id="line-3286">        MajorCompactionTimestampForRegionRequest req =</span>
<span class="source-line-no">3287</span><span id="line-3287">          MajorCompactionTimestampForRegionRequest.newBuilder()</span>
<span class="source-line-no">3288</span><span id="line-3288">            .setRegion(</span>
<span class="source-line-no">3289</span><span id="line-3289">              RequestConverter.buildRegionSpecifier(RegionSpecifierType.REGION_NAME, regionName))</span>
<span class="source-line-no">3290</span><span id="line-3290">            .build();</span>
<span class="source-line-no">3291</span><span id="line-3291">        return master.getLastMajorCompactionTimestampForRegion(getRpcController(), req)</span>
<span class="source-line-no">3292</span><span id="line-3292">          .getCompactionTimestamp();</span>
<span class="source-line-no">3293</span><span id="line-3293">      }</span>
<span class="source-line-no">3294</span><span id="line-3294">    });</span>
<span class="source-line-no">3295</span><span id="line-3295">  }</span>
<span class="source-line-no">3296</span><span id="line-3296"></span>
<span class="source-line-no">3297</span><span id="line-3297">  /**</span>
<span class="source-line-no">3298</span><span id="line-3298">   * {@inheritDoc}</span>
<span class="source-line-no">3299</span><span id="line-3299">   */</span>
<span class="source-line-no">3300</span><span id="line-3300">  @Override</span>
<span class="source-line-no">3301</span><span id="line-3301">  public void compact(final TableName tableName, final byte[] columnFamily, CompactType compactType)</span>
<span class="source-line-no">3302</span><span id="line-3302">    throws IOException, InterruptedException {</span>
<span class="source-line-no">3303</span><span id="line-3303">    compact(tableName, columnFamily, false, compactType);</span>
<span class="source-line-no">3304</span><span id="line-3304">  }</span>
<span class="source-line-no">3305</span><span id="line-3305"></span>
<span class="source-line-no">3306</span><span id="line-3306">  /**</span>
<span class="source-line-no">3307</span><span id="line-3307">   * {@inheritDoc}</span>
<span class="source-line-no">3308</span><span id="line-3308">   */</span>
<span class="source-line-no">3309</span><span id="line-3309">  @Override</span>
<span class="source-line-no">3310</span><span id="line-3310">  public void compact(final TableName tableName, CompactType compactType)</span>
<span class="source-line-no">3311</span><span id="line-3311">    throws IOException, InterruptedException {</span>
<span class="source-line-no">3312</span><span id="line-3312">    compact(tableName, null, false, compactType);</span>
<span class="source-line-no">3313</span><span id="line-3313">  }</span>
<span class="source-line-no">3314</span><span id="line-3314"></span>
<span class="source-line-no">3315</span><span id="line-3315">  /**</span>
<span class="source-line-no">3316</span><span id="line-3316">   * {@inheritDoc}</span>
<span class="source-line-no">3317</span><span id="line-3317">   */</span>
<span class="source-line-no">3318</span><span id="line-3318">  @Override</span>
<span class="source-line-no">3319</span><span id="line-3319">  public void majorCompact(final TableName tableName, final byte[] columnFamily,</span>
<span class="source-line-no">3320</span><span id="line-3320">    CompactType compactType) throws IOException, InterruptedException {</span>
<span class="source-line-no">3321</span><span id="line-3321">    compact(tableName, columnFamily, true, compactType);</span>
<span class="source-line-no">3322</span><span id="line-3322">  }</span>
<span class="source-line-no">3323</span><span id="line-3323"></span>
<span class="source-line-no">3324</span><span id="line-3324">  /**</span>
<span class="source-line-no">3325</span><span id="line-3325">   * {@inheritDoc}</span>
<span class="source-line-no">3326</span><span id="line-3326">   */</span>
<span class="source-line-no">3327</span><span id="line-3327">  @Override</span>
<span class="source-line-no">3328</span><span id="line-3328">  public void majorCompact(final TableName tableName, CompactType compactType)</span>
<span class="source-line-no">3329</span><span id="line-3329">    throws IOException, InterruptedException {</span>
<span class="source-line-no">3330</span><span id="line-3330">    compact(tableName, null, true, compactType);</span>
<span class="source-line-no">3331</span><span id="line-3331">  }</span>
<span class="source-line-no">3332</span><span id="line-3332"></span>
<span class="source-line-no">3333</span><span id="line-3333">  /**</span>
<span class="source-line-no">3334</span><span id="line-3334">   * {@inheritDoc}</span>
<span class="source-line-no">3335</span><span id="line-3335">   */</span>
<span class="source-line-no">3336</span><span id="line-3336">  @Override</span>
<span class="source-line-no">3337</span><span id="line-3337">  public CompactionState getCompactionState(final TableName tableName, CompactType compactType)</span>
<span class="source-line-no">3338</span><span id="line-3338">    throws IOException {</span>
<span class="source-line-no">3339</span><span id="line-3339">    checkTableExists(tableName);</span>
<span class="source-line-no">3340</span><span id="line-3340">    if (!isTableEnabled(tableName)) {</span>
<span class="source-line-no">3341</span><span id="line-3341">      // If the table is disabled, the compaction state of the table should always be NONE</span>
<span class="source-line-no">3342</span><span id="line-3342">      return ProtobufUtil</span>
<span class="source-line-no">3343</span><span id="line-3343">        .createCompactionState(AdminProtos.GetRegionInfoResponse.CompactionState.NONE);</span>
<span class="source-line-no">3344</span><span id="line-3344">    }</span>
<span class="source-line-no">3345</span><span id="line-3345"></span>
<span class="source-line-no">3346</span><span id="line-3346">    AdminProtos.GetRegionInfoResponse.CompactionState state =</span>
<span class="source-line-no">3347</span><span id="line-3347">      AdminProtos.GetRegionInfoResponse.CompactionState.NONE;</span>
<span class="source-line-no">3348</span><span id="line-3348"></span>
<span class="source-line-no">3349</span><span id="line-3349">    // TODO: There is no timeout on this controller. Set one!</span>
<span class="source-line-no">3350</span><span id="line-3350">    HBaseRpcController rpcController = rpcControllerFactory.newController();</span>
<span class="source-line-no">3351</span><span id="line-3351">    switch (compactType) {</span>
<span class="source-line-no">3352</span><span id="line-3352">      case MOB:</span>
<span class="source-line-no">3353</span><span id="line-3353">        final AdminProtos.AdminService.BlockingInterface masterAdmin =</span>
<span class="source-line-no">3354</span><span id="line-3354">          this.connection.getAdminForMaster();</span>
<span class="source-line-no">3355</span><span id="line-3355">        Callable&lt;AdminProtos.GetRegionInfoResponse.CompactionState&gt; callable =</span>
<span class="source-line-no">3356</span><span id="line-3356">          new Callable&lt;AdminProtos.GetRegionInfoResponse.CompactionState&gt;() {</span>
<span class="source-line-no">3357</span><span id="line-3357">            @Override</span>
<span class="source-line-no">3358</span><span id="line-3358">            public AdminProtos.GetRegionInfoResponse.CompactionState call() throws Exception {</span>
<span class="source-line-no">3359</span><span id="line-3359">              RegionInfo info = RegionInfo.createMobRegionInfo(tableName);</span>
<span class="source-line-no">3360</span><span id="line-3360">              GetRegionInfoRequest request =</span>
<span class="source-line-no">3361</span><span id="line-3361">                RequestConverter.buildGetRegionInfoRequest(info.getRegionName(), true);</span>
<span class="source-line-no">3362</span><span id="line-3362">              GetRegionInfoResponse response = masterAdmin.getRegionInfo(rpcController, request);</span>
<span class="source-line-no">3363</span><span id="line-3363">              return response.getCompactionState();</span>
<span class="source-line-no">3364</span><span id="line-3364">            }</span>
<span class="source-line-no">3365</span><span id="line-3365">          };</span>
<span class="source-line-no">3366</span><span id="line-3366">        state = ProtobufUtil.call(callable);</span>
<span class="source-line-no">3367</span><span id="line-3367">        break;</span>
<span class="source-line-no">3368</span><span id="line-3368">      case NORMAL:</span>
<span class="source-line-no">3369</span><span id="line-3369">        for (HRegionLocation loc : connection.locateRegions(tableName, false, false)) {</span>
<span class="source-line-no">3370</span><span id="line-3370">          ServerName sn = loc.getServerName();</span>
<span class="source-line-no">3371</span><span id="line-3371">          if (sn == null) {</span>
<span class="source-line-no">3372</span><span id="line-3372">            continue;</span>
<span class="source-line-no">3373</span><span id="line-3373">          }</span>
<span class="source-line-no">3374</span><span id="line-3374">          byte[] regionName = loc.getRegion().getRegionName();</span>
<span class="source-line-no">3375</span><span id="line-3375">          AdminService.BlockingInterface snAdmin = this.connection.getAdmin(sn);</span>
<span class="source-line-no">3376</span><span id="line-3376">          try {</span>
<span class="source-line-no">3377</span><span id="line-3377">            Callable&lt;GetRegionInfoResponse&gt; regionInfoCallable =</span>
<span class="source-line-no">3378</span><span id="line-3378">              new Callable&lt;GetRegionInfoResponse&gt;() {</span>
<span class="source-line-no">3379</span><span id="line-3379">                @Override</span>
<span class="source-line-no">3380</span><span id="line-3380">                public GetRegionInfoResponse call() throws Exception {</span>
<span class="source-line-no">3381</span><span id="line-3381">                  GetRegionInfoRequest request =</span>
<span class="source-line-no">3382</span><span id="line-3382">                    RequestConverter.buildGetRegionInfoRequest(regionName, true);</span>
<span class="source-line-no">3383</span><span id="line-3383">                  return snAdmin.getRegionInfo(rpcController, request);</span>
<span class="source-line-no">3384</span><span id="line-3384">                }</span>
<span class="source-line-no">3385</span><span id="line-3385">              };</span>
<span class="source-line-no">3386</span><span id="line-3386">            GetRegionInfoResponse response = ProtobufUtil.call(regionInfoCallable);</span>
<span class="source-line-no">3387</span><span id="line-3387">            switch (response.getCompactionState()) {</span>
<span class="source-line-no">3388</span><span id="line-3388">              case MAJOR_AND_MINOR:</span>
<span class="source-line-no">3389</span><span id="line-3389">                return CompactionState.MAJOR_AND_MINOR;</span>
<span class="source-line-no">3390</span><span id="line-3390">              case MAJOR:</span>
<span class="source-line-no">3391</span><span id="line-3391">                if (state == AdminProtos.GetRegionInfoResponse.CompactionState.MINOR) {</span>
<span class="source-line-no">3392</span><span id="line-3392">                  return CompactionState.MAJOR_AND_MINOR;</span>
<span class="source-line-no">3393</span><span id="line-3393">                }</span>
<span class="source-line-no">3394</span><span id="line-3394">                state = AdminProtos.GetRegionInfoResponse.CompactionState.MAJOR;</span>
<span class="source-line-no">3395</span><span id="line-3395">                break;</span>
<span class="source-line-no">3396</span><span id="line-3396">              case MINOR:</span>
<span class="source-line-no">3397</span><span id="line-3397">                if (state == AdminProtos.GetRegionInfoResponse.CompactionState.MAJOR) {</span>
<span class="source-line-no">3398</span><span id="line-3398">                  return CompactionState.MAJOR_AND_MINOR;</span>
<span class="source-line-no">3399</span><span id="line-3399">                }</span>
<span class="source-line-no">3400</span><span id="line-3400">                state = AdminProtos.GetRegionInfoResponse.CompactionState.MINOR;</span>
<span class="source-line-no">3401</span><span id="line-3401">                break;</span>
<span class="source-line-no">3402</span><span id="line-3402">              case NONE:</span>
<span class="source-line-no">3403</span><span id="line-3403">              default: // nothing, continue</span>
<span class="source-line-no">3404</span><span id="line-3404">            }</span>
<span class="source-line-no">3405</span><span id="line-3405">          } catch (NotServingRegionException e) {</span>
<span class="source-line-no">3406</span><span id="line-3406">            if (LOG.isDebugEnabled()) {</span>
<span class="source-line-no">3407</span><span id="line-3407">              LOG.debug("Trying to get compaction state of " + loc.getRegion() + ": "</span>
<span class="source-line-no">3408</span><span id="line-3408">                + StringUtils.stringifyException(e));</span>
<span class="source-line-no">3409</span><span id="line-3409">            }</span>
<span class="source-line-no">3410</span><span id="line-3410">          } catch (RemoteException e) {</span>
<span class="source-line-no">3411</span><span id="line-3411">            if (e.getMessage().indexOf(NotServingRegionException.class.getName()) &gt;= 0) {</span>
<span class="source-line-no">3412</span><span id="line-3412">              if (LOG.isDebugEnabled()) {</span>
<span class="source-line-no">3413</span><span id="line-3413">                LOG.debug("Trying to get compaction state of " + loc.getRegion() + ": "</span>
<span class="source-line-no">3414</span><span id="line-3414">                  + StringUtils.stringifyException(e));</span>
<span class="source-line-no">3415</span><span id="line-3415">              }</span>
<span class="source-line-no">3416</span><span id="line-3416">            } else {</span>
<span class="source-line-no">3417</span><span id="line-3417">              throw e;</span>
<span class="source-line-no">3418</span><span id="line-3418">            }</span>
<span class="source-line-no">3419</span><span id="line-3419">          }</span>
<span class="source-line-no">3420</span><span id="line-3420">        }</span>
<span class="source-line-no">3421</span><span id="line-3421">        break;</span>
<span class="source-line-no">3422</span><span id="line-3422">      default:</span>
<span class="source-line-no">3423</span><span id="line-3423">        throw new IllegalArgumentException("Unknown compactType: " + compactType);</span>
<span class="source-line-no">3424</span><span id="line-3424">    }</span>
<span class="source-line-no">3425</span><span id="line-3425">    if (state != null) {</span>
<span class="source-line-no">3426</span><span id="line-3426">      return ProtobufUtil.createCompactionState(state);</span>
<span class="source-line-no">3427</span><span id="line-3427">    }</span>
<span class="source-line-no">3428</span><span id="line-3428">    return null;</span>
<span class="source-line-no">3429</span><span id="line-3429">  }</span>
<span class="source-line-no">3430</span><span id="line-3430"></span>
<span class="source-line-no">3431</span><span id="line-3431">  /**</span>
<span class="source-line-no">3432</span><span id="line-3432">   * Future that waits on a procedure result. Returned by the async version of the Admin calls, and</span>
<span class="source-line-no">3433</span><span id="line-3433">   * used internally by the sync calls to wait on the result of the procedure.</span>
<span class="source-line-no">3434</span><span id="line-3434">   */</span>
<span class="source-line-no">3435</span><span id="line-3435">  @InterfaceAudience.Private</span>
<span class="source-line-no">3436</span><span id="line-3436">  @InterfaceStability.Evolving</span>
<span class="source-line-no">3437</span><span id="line-3437">  protected static class ProcedureFuture&lt;V&gt; implements Future&lt;V&gt; {</span>
<span class="source-line-no">3438</span><span id="line-3438">    private ExecutionException exception = null;</span>
<span class="source-line-no">3439</span><span id="line-3439">    private boolean procResultFound = false;</span>
<span class="source-line-no">3440</span><span id="line-3440">    private boolean done = false;</span>
<span class="source-line-no">3441</span><span id="line-3441">    private boolean cancelled = false;</span>
<span class="source-line-no">3442</span><span id="line-3442">    private V result = null;</span>
<span class="source-line-no">3443</span><span id="line-3443"></span>
<span class="source-line-no">3444</span><span id="line-3444">    private final HBaseAdmin admin;</span>
<span class="source-line-no">3445</span><span id="line-3445">    protected final Long procId;</span>
<span class="source-line-no">3446</span><span id="line-3446"></span>
<span class="source-line-no">3447</span><span id="line-3447">    public ProcedureFuture(final HBaseAdmin admin, final Long procId) {</span>
<span class="source-line-no">3448</span><span id="line-3448">      this.admin = admin;</span>
<span class="source-line-no">3449</span><span id="line-3449">      this.procId = procId;</span>
<span class="source-line-no">3450</span><span id="line-3450">    }</span>
<span class="source-line-no">3451</span><span id="line-3451"></span>
<span class="source-line-no">3452</span><span id="line-3452">    @Override</span>
<span class="source-line-no">3453</span><span id="line-3453">    public boolean cancel(boolean mayInterruptIfRunning) {</span>
<span class="source-line-no">3454</span><span id="line-3454">      AbortProcedureRequest abortProcRequest = AbortProcedureRequest.newBuilder().setProcId(procId)</span>
<span class="source-line-no">3455</span><span id="line-3455">        .setMayInterruptIfRunning(mayInterruptIfRunning).build();</span>
<span class="source-line-no">3456</span><span id="line-3456">      try {</span>
<span class="source-line-no">3457</span><span id="line-3457">        cancelled = abortProcedureResult(abortProcRequest).getIsProcedureAborted();</span>
<span class="source-line-no">3458</span><span id="line-3458">        if (cancelled) {</span>
<span class="source-line-no">3459</span><span id="line-3459">          done = true;</span>
<span class="source-line-no">3460</span><span id="line-3460">        }</span>
<span class="source-line-no">3461</span><span id="line-3461">      } catch (IOException e) {</span>
<span class="source-line-no">3462</span><span id="line-3462">        // Cancell thrown exception for some reason. At this time, we are not sure whether</span>
<span class="source-line-no">3463</span><span id="line-3463">        // the cancell succeeds or fails. We assume that it is failed, but print out a warning</span>
<span class="source-line-no">3464</span><span id="line-3464">        // for debugging purpose.</span>
<span class="source-line-no">3465</span><span id="line-3465">        LOG.warn(</span>
<span class="source-line-no">3466</span><span id="line-3466">          "Cancelling the procedure with procId=" + procId + " throws exception " + e.getMessage(),</span>
<span class="source-line-no">3467</span><span id="line-3467">          e);</span>
<span class="source-line-no">3468</span><span id="line-3468">        cancelled = false;</span>
<span class="source-line-no">3469</span><span id="line-3469">      }</span>
<span class="source-line-no">3470</span><span id="line-3470">      return cancelled;</span>
<span class="source-line-no">3471</span><span id="line-3471">    }</span>
<span class="source-line-no">3472</span><span id="line-3472"></span>
<span class="source-line-no">3473</span><span id="line-3473">    @Override</span>
<span class="source-line-no">3474</span><span id="line-3474">    public boolean isCancelled() {</span>
<span class="source-line-no">3475</span><span id="line-3475">      return cancelled;</span>
<span class="source-line-no">3476</span><span id="line-3476">    }</span>
<span class="source-line-no">3477</span><span id="line-3477"></span>
<span class="source-line-no">3478</span><span id="line-3478">    protected AbortProcedureResponse abortProcedureResult(final AbortProcedureRequest request)</span>
<span class="source-line-no">3479</span><span id="line-3479">      throws IOException {</span>
<span class="source-line-no">3480</span><span id="line-3480">      return admin.executeCallable(new MasterCallable&lt;AbortProcedureResponse&gt;(admin.getConnection(),</span>
<span class="source-line-no">3481</span><span id="line-3481">        admin.getRpcControllerFactory()) {</span>
<span class="source-line-no">3482</span><span id="line-3482">        @Override</span>
<span class="source-line-no">3483</span><span id="line-3483">        protected AbortProcedureResponse rpcCall() throws Exception {</span>
<span class="source-line-no">3484</span><span id="line-3484">          return master.abortProcedure(getRpcController(), request);</span>
<span class="source-line-no">3485</span><span id="line-3485">        }</span>
<span class="source-line-no">3486</span><span id="line-3486">      });</span>
<span class="source-line-no">3487</span><span id="line-3487">    }</span>
<span class="source-line-no">3488</span><span id="line-3488"></span>
<span class="source-line-no">3489</span><span id="line-3489">    @Override</span>
<span class="source-line-no">3490</span><span id="line-3490">    public V get() throws InterruptedException, ExecutionException {</span>
<span class="source-line-no">3491</span><span id="line-3491">      // TODO: should we ever spin forever?</span>
<span class="source-line-no">3492</span><span id="line-3492">      // fix HBASE-21715. TODO: If the function call get() without timeout limit is not allowed,</span>
<span class="source-line-no">3493</span><span id="line-3493">      // is it possible to compose instead of inheriting from the class Future for this class?</span>
<span class="source-line-no">3494</span><span id="line-3494">      try {</span>
<span class="source-line-no">3495</span><span id="line-3495">        return get(admin.getProcedureTimeout, TimeUnit.MILLISECONDS);</span>
<span class="source-line-no">3496</span><span id="line-3496">      } catch (TimeoutException e) {</span>
<span class="source-line-no">3497</span><span id="line-3497">        LOG.warn("Failed to get the procedure with procId=" + procId + " throws exception "</span>
<span class="source-line-no">3498</span><span id="line-3498">          + e.getMessage(), e);</span>
<span class="source-line-no">3499</span><span id="line-3499">        return null;</span>
<span class="source-line-no">3500</span><span id="line-3500">      }</span>
<span class="source-line-no">3501</span><span id="line-3501">    }</span>
<span class="source-line-no">3502</span><span id="line-3502"></span>
<span class="source-line-no">3503</span><span id="line-3503">    @Override</span>
<span class="source-line-no">3504</span><span id="line-3504">    public V get(long timeout, TimeUnit unit)</span>
<span class="source-line-no">3505</span><span id="line-3505">      throws InterruptedException, ExecutionException, TimeoutException {</span>
<span class="source-line-no">3506</span><span id="line-3506">      if (!done) {</span>
<span class="source-line-no">3507</span><span id="line-3507">        long deadlineTs = EnvironmentEdgeManager.currentTime() + unit.toMillis(timeout);</span>
<span class="source-line-no">3508</span><span id="line-3508">        try {</span>
<span class="source-line-no">3509</span><span id="line-3509">          try {</span>
<span class="source-line-no">3510</span><span id="line-3510">            // if the master support procedures, try to wait the result</span>
<span class="source-line-no">3511</span><span id="line-3511">            if (procId != null) {</span>
<span class="source-line-no">3512</span><span id="line-3512">              result = waitProcedureResult(procId, deadlineTs);</span>
<span class="source-line-no">3513</span><span id="line-3513">            }</span>
<span class="source-line-no">3514</span><span id="line-3514">            // if we don't have a proc result, try the compatibility wait</span>
<span class="source-line-no">3515</span><span id="line-3515">            if (!procResultFound) {</span>
<span class="source-line-no">3516</span><span id="line-3516">              result = waitOperationResult(deadlineTs);</span>
<span class="source-line-no">3517</span><span id="line-3517">            }</span>
<span class="source-line-no">3518</span><span id="line-3518">            result = postOperationResult(result, deadlineTs);</span>
<span class="source-line-no">3519</span><span id="line-3519">            done = true;</span>
<span class="source-line-no">3520</span><span id="line-3520">          } catch (IOException e) {</span>
<span class="source-line-no">3521</span><span id="line-3521">            result = postOperationFailure(e, deadlineTs);</span>
<span class="source-line-no">3522</span><span id="line-3522">            done = true;</span>
<span class="source-line-no">3523</span><span id="line-3523">          }</span>
<span class="source-line-no">3524</span><span id="line-3524">        } catch (IOException e) {</span>
<span class="source-line-no">3525</span><span id="line-3525">          exception = new ExecutionException(e);</span>
<span class="source-line-no">3526</span><span id="line-3526">          done = true;</span>
<span class="source-line-no">3527</span><span id="line-3527">        }</span>
<span class="source-line-no">3528</span><span id="line-3528">      }</span>
<span class="source-line-no">3529</span><span id="line-3529">      if (exception != null) {</span>
<span class="source-line-no">3530</span><span id="line-3530">        throw exception;</span>
<span class="source-line-no">3531</span><span id="line-3531">      }</span>
<span class="source-line-no">3532</span><span id="line-3532">      return result;</span>
<span class="source-line-no">3533</span><span id="line-3533">    }</span>
<span class="source-line-no">3534</span><span id="line-3534"></span>
<span class="source-line-no">3535</span><span id="line-3535">    @Override</span>
<span class="source-line-no">3536</span><span id="line-3536">    public boolean isDone() {</span>
<span class="source-line-no">3537</span><span id="line-3537">      return done;</span>
<span class="source-line-no">3538</span><span id="line-3538">    }</span>
<span class="source-line-no">3539</span><span id="line-3539"></span>
<span class="source-line-no">3540</span><span id="line-3540">    protected HBaseAdmin getAdmin() {</span>
<span class="source-line-no">3541</span><span id="line-3541">      return admin;</span>
<span class="source-line-no">3542</span><span id="line-3542">    }</span>
<span class="source-line-no">3543</span><span id="line-3543"></span>
<span class="source-line-no">3544</span><span id="line-3544">    private V waitProcedureResult(long procId, long deadlineTs)</span>
<span class="source-line-no">3545</span><span id="line-3545">      throws IOException, TimeoutException, InterruptedException {</span>
<span class="source-line-no">3546</span><span id="line-3546">      GetProcedureResultRequest request =</span>
<span class="source-line-no">3547</span><span id="line-3547">        GetProcedureResultRequest.newBuilder().setProcId(procId).build();</span>
<span class="source-line-no">3548</span><span id="line-3548"></span>
<span class="source-line-no">3549</span><span id="line-3549">      int tries = 0;</span>
<span class="source-line-no">3550</span><span id="line-3550">      IOException serviceEx = null;</span>
<span class="source-line-no">3551</span><span id="line-3551">      while (EnvironmentEdgeManager.currentTime() &lt; deadlineTs) {</span>
<span class="source-line-no">3552</span><span id="line-3552">        GetProcedureResultResponse response = null;</span>
<span class="source-line-no">3553</span><span id="line-3553">        try {</span>
<span class="source-line-no">3554</span><span id="line-3554">          // Try to fetch the result</span>
<span class="source-line-no">3555</span><span id="line-3555">          response = getProcedureResult(request);</span>
<span class="source-line-no">3556</span><span id="line-3556">        } catch (IOException e) {</span>
<span class="source-line-no">3557</span><span id="line-3557">          serviceEx = unwrapException(e);</span>
<span class="source-line-no">3558</span><span id="line-3558"></span>
<span class="source-line-no">3559</span><span id="line-3559">          // the master may be down</span>
<span class="source-line-no">3560</span><span id="line-3560">          LOG.warn("failed to get the procedure result procId=" + procId, serviceEx);</span>
<span class="source-line-no">3561</span><span id="line-3561"></span>
<span class="source-line-no">3562</span><span id="line-3562">          // Not much to do, if we have a DoNotRetryIOException</span>
<span class="source-line-no">3563</span><span id="line-3563">          if (serviceEx instanceof DoNotRetryIOException) {</span>
<span class="source-line-no">3564</span><span id="line-3564">            // TODO: looks like there is no way to unwrap this exception and get the proper</span>
<span class="source-line-no">3565</span><span id="line-3565">            // UnsupportedOperationException aside from looking at the message.</span>
<span class="source-line-no">3566</span><span id="line-3566">            // anyway, if we fail here we just failover to the compatibility side</span>
<span class="source-line-no">3567</span><span id="line-3567">            // and that is always a valid solution.</span>
<span class="source-line-no">3568</span><span id="line-3568">            LOG.warn("Proc-v2 is unsupported on this master: " + serviceEx.getMessage(), serviceEx);</span>
<span class="source-line-no">3569</span><span id="line-3569">            procResultFound = false;</span>
<span class="source-line-no">3570</span><span id="line-3570">            return null;</span>
<span class="source-line-no">3571</span><span id="line-3571">          }</span>
<span class="source-line-no">3572</span><span id="line-3572">        }</span>
<span class="source-line-no">3573</span><span id="line-3573"></span>
<span class="source-line-no">3574</span><span id="line-3574">        // If the procedure is no longer running, we should have a result</span>
<span class="source-line-no">3575</span><span id="line-3575">        if (response != null &amp;&amp; response.getState() != GetProcedureResultResponse.State.RUNNING) {</span>
<span class="source-line-no">3576</span><span id="line-3576">          procResultFound = response.getState() != GetProcedureResultResponse.State.NOT_FOUND;</span>
<span class="source-line-no">3577</span><span id="line-3577">          return convertResult(response);</span>
<span class="source-line-no">3578</span><span id="line-3578">        }</span>
<span class="source-line-no">3579</span><span id="line-3579"></span>
<span class="source-line-no">3580</span><span id="line-3580">        try {</span>
<span class="source-line-no">3581</span><span id="line-3581">          Thread.sleep(getAdmin().getPauseTime(tries++));</span>
<span class="source-line-no">3582</span><span id="line-3582">        } catch (InterruptedException e) {</span>
<span class="source-line-no">3583</span><span id="line-3583">          throw new InterruptedException(</span>
<span class="source-line-no">3584</span><span id="line-3584">            "Interrupted while waiting for the result of proc " + procId);</span>
<span class="source-line-no">3585</span><span id="line-3585">        }</span>
<span class="source-line-no">3586</span><span id="line-3586">      }</span>
<span class="source-line-no">3587</span><span id="line-3587">      if (serviceEx != null) {</span>
<span class="source-line-no">3588</span><span id="line-3588">        throw serviceEx;</span>
<span class="source-line-no">3589</span><span id="line-3589">      } else {</span>
<span class="source-line-no">3590</span><span id="line-3590">        throw new TimeoutException("The procedure " + procId + " is still running");</span>
<span class="source-line-no">3591</span><span id="line-3591">      }</span>
<span class="source-line-no">3592</span><span id="line-3592">    }</span>
<span class="source-line-no">3593</span><span id="line-3593"></span>
<span class="source-line-no">3594</span><span id="line-3594">    private static IOException unwrapException(IOException e) {</span>
<span class="source-line-no">3595</span><span id="line-3595">      if (e instanceof RemoteException) {</span>
<span class="source-line-no">3596</span><span id="line-3596">        return ((RemoteException) e).unwrapRemoteException();</span>
<span class="source-line-no">3597</span><span id="line-3597">      }</span>
<span class="source-line-no">3598</span><span id="line-3598">      return e;</span>
<span class="source-line-no">3599</span><span id="line-3599">    }</span>
<span class="source-line-no">3600</span><span id="line-3600"></span>
<span class="source-line-no">3601</span><span id="line-3601">    protected GetProcedureResultResponse getProcedureResult(final GetProcedureResultRequest request)</span>
<span class="source-line-no">3602</span><span id="line-3602">      throws IOException {</span>
<span class="source-line-no">3603</span><span id="line-3603">      return admin.executeCallable(new MasterCallable&lt;GetProcedureResultResponse&gt;(</span>
<span class="source-line-no">3604</span><span id="line-3604">        admin.getConnection(), admin.getRpcControllerFactory()) {</span>
<span class="source-line-no">3605</span><span id="line-3605">        @Override</span>
<span class="source-line-no">3606</span><span id="line-3606">        protected GetProcedureResultResponse rpcCall() throws Exception {</span>
<span class="source-line-no">3607</span><span id="line-3607">          return master.getProcedureResult(getRpcController(), request);</span>
<span class="source-line-no">3608</span><span id="line-3608">        }</span>
<span class="source-line-no">3609</span><span id="line-3609">      });</span>
<span class="source-line-no">3610</span><span id="line-3610">    }</span>
<span class="source-line-no">3611</span><span id="line-3611"></span>
<span class="source-line-no">3612</span><span id="line-3612">    /**</span>
<span class="source-line-no">3613</span><span id="line-3613">     * Convert the procedure result response to a specified type.</span>
<span class="source-line-no">3614</span><span id="line-3614">     * @param response the procedure result object to parse</span>
<span class="source-line-no">3615</span><span id="line-3615">     * @return the result data of the procedure.</span>
<span class="source-line-no">3616</span><span id="line-3616">     */</span>
<span class="source-line-no">3617</span><span id="line-3617">    protected V convertResult(final GetProcedureResultResponse response) throws IOException {</span>
<span class="source-line-no">3618</span><span id="line-3618">      if (response.hasException()) {</span>
<span class="source-line-no">3619</span><span id="line-3619">        throw ForeignExceptionUtil.toIOException(response.getException());</span>
<span class="source-line-no">3620</span><span id="line-3620">      }</span>
<span class="source-line-no">3621</span><span id="line-3621">      return null;</span>
<span class="source-line-no">3622</span><span id="line-3622">    }</span>
<span class="source-line-no">3623</span><span id="line-3623"></span>
<span class="source-line-no">3624</span><span id="line-3624">    /**</span>
<span class="source-line-no">3625</span><span id="line-3625">     * Fallback implementation in case the procedure is not supported by the server. It should try</span>
<span class="source-line-no">3626</span><span id="line-3626">     * to wait until the operation is completed.</span>
<span class="source-line-no">3627</span><span id="line-3627">     * @param deadlineTs the timestamp after which this method should throw a TimeoutException</span>
<span class="source-line-no">3628</span><span id="line-3628">     * @return the result data of the operation</span>
<span class="source-line-no">3629</span><span id="line-3629">     */</span>
<span class="source-line-no">3630</span><span id="line-3630">    protected V waitOperationResult(final long deadlineTs) throws IOException, TimeoutException {</span>
<span class="source-line-no">3631</span><span id="line-3631">      return null;</span>
<span class="source-line-no">3632</span><span id="line-3632">    }</span>
<span class="source-line-no">3633</span><span id="line-3633"></span>
<span class="source-line-no">3634</span><span id="line-3634">    /**</span>
<span class="source-line-no">3635</span><span id="line-3635">     * Called after the operation is completed and the result fetched. this allows to perform extra</span>
<span class="source-line-no">3636</span><span id="line-3636">     * steps after the procedure is completed. it allows to apply transformations to the result that</span>
<span class="source-line-no">3637</span><span id="line-3637">     * will be returned by get().</span>
<span class="source-line-no">3638</span><span id="line-3638">     * @param result     the result of the procedure</span>
<span class="source-line-no">3639</span><span id="line-3639">     * @param deadlineTs the timestamp after which this method should throw a TimeoutException</span>
<span class="source-line-no">3640</span><span id="line-3640">     * @return the result of the procedure, which may be the same as the passed one</span>
<span class="source-line-no">3641</span><span id="line-3641">     */</span>
<span class="source-line-no">3642</span><span id="line-3642">    protected V postOperationResult(final V result, final long deadlineTs)</span>
<span class="source-line-no">3643</span><span id="line-3643">      throws IOException, TimeoutException {</span>
<span class="source-line-no">3644</span><span id="line-3644">      return result;</span>
<span class="source-line-no">3645</span><span id="line-3645">    }</span>
<span class="source-line-no">3646</span><span id="line-3646"></span>
<span class="source-line-no">3647</span><span id="line-3647">    /**</span>
<span class="source-line-no">3648</span><span id="line-3648">     * Called after the operation is terminated with a failure. this allows to perform extra steps</span>
<span class="source-line-no">3649</span><span id="line-3649">     * after the procedure is terminated. it allows to apply transformations to the result that will</span>
<span class="source-line-no">3650</span><span id="line-3650">     * be returned by get(). The default implementation will rethrow the exception</span>
<span class="source-line-no">3651</span><span id="line-3651">     * @param exception  the exception got from fetching the result</span>
<span class="source-line-no">3652</span><span id="line-3652">     * @param deadlineTs the timestamp after which this method should throw a TimeoutException</span>
<span class="source-line-no">3653</span><span id="line-3653">     * @return the result of the procedure, which may be the same as the passed one</span>
<span class="source-line-no">3654</span><span id="line-3654">     */</span>
<span class="source-line-no">3655</span><span id="line-3655">    protected V postOperationFailure(final IOException exception, final long deadlineTs)</span>
<span class="source-line-no">3656</span><span id="line-3656">      throws IOException, TimeoutException {</span>
<span class="source-line-no">3657</span><span id="line-3657">      throw exception;</span>
<span class="source-line-no">3658</span><span id="line-3658">    }</span>
<span class="source-line-no">3659</span><span id="line-3659"></span>
<span class="source-line-no">3660</span><span id="line-3660">    protected interface WaitForStateCallable {</span>
<span class="source-line-no">3661</span><span id="line-3661">      boolean checkState(int tries) throws IOException;</span>
<span class="source-line-no">3662</span><span id="line-3662"></span>
<span class="source-line-no">3663</span><span id="line-3663">      void throwInterruptedException() throws InterruptedIOException;</span>
<span class="source-line-no">3664</span><span id="line-3664"></span>
<span class="source-line-no">3665</span><span id="line-3665">      void throwTimeoutException(long elapsed) throws TimeoutException;</span>
<span class="source-line-no">3666</span><span id="line-3666">    }</span>
<span class="source-line-no">3667</span><span id="line-3667"></span>
<span class="source-line-no">3668</span><span id="line-3668">    protected void waitForState(final long deadlineTs, final WaitForStateCallable callable)</span>
<span class="source-line-no">3669</span><span id="line-3669">      throws IOException, TimeoutException {</span>
<span class="source-line-no">3670</span><span id="line-3670">      int tries = 0;</span>
<span class="source-line-no">3671</span><span id="line-3671">      IOException serverEx = null;</span>
<span class="source-line-no">3672</span><span id="line-3672">      long startTime = EnvironmentEdgeManager.currentTime();</span>
<span class="source-line-no">3673</span><span id="line-3673">      while (EnvironmentEdgeManager.currentTime() &lt; deadlineTs) {</span>
<span class="source-line-no">3674</span><span id="line-3674">        serverEx = null;</span>
<span class="source-line-no">3675</span><span id="line-3675">        try {</span>
<span class="source-line-no">3676</span><span id="line-3676">          if (callable.checkState(tries)) {</span>
<span class="source-line-no">3677</span><span id="line-3677">            return;</span>
<span class="source-line-no">3678</span><span id="line-3678">          }</span>
<span class="source-line-no">3679</span><span id="line-3679">        } catch (IOException e) {</span>
<span class="source-line-no">3680</span><span id="line-3680">          serverEx = e;</span>
<span class="source-line-no">3681</span><span id="line-3681">        }</span>
<span class="source-line-no">3682</span><span id="line-3682">        try {</span>
<span class="source-line-no">3683</span><span id="line-3683">          Thread.sleep(getAdmin().getPauseTime(tries++));</span>
<span class="source-line-no">3684</span><span id="line-3684">        } catch (InterruptedException e) {</span>
<span class="source-line-no">3685</span><span id="line-3685">          callable.throwInterruptedException();</span>
<span class="source-line-no">3686</span><span id="line-3686">        }</span>
<span class="source-line-no">3687</span><span id="line-3687">      }</span>
<span class="source-line-no">3688</span><span id="line-3688">      if (serverEx != null) {</span>
<span class="source-line-no">3689</span><span id="line-3689">        throw unwrapException(serverEx);</span>
<span class="source-line-no">3690</span><span id="line-3690">      } else {</span>
<span class="source-line-no">3691</span><span id="line-3691">        callable.throwTimeoutException(EnvironmentEdgeManager.currentTime() - startTime);</span>
<span class="source-line-no">3692</span><span id="line-3692">      }</span>
<span class="source-line-no">3693</span><span id="line-3693">    }</span>
<span class="source-line-no">3694</span><span id="line-3694">  }</span>
<span class="source-line-no">3695</span><span id="line-3695"></span>
<span class="source-line-no">3696</span><span id="line-3696">  @InterfaceAudience.Private</span>
<span class="source-line-no">3697</span><span id="line-3697">  @InterfaceStability.Evolving</span>
<span class="source-line-no">3698</span><span id="line-3698">  protected static abstract class TableFuture&lt;V&gt; extends ProcedureFuture&lt;V&gt; {</span>
<span class="source-line-no">3699</span><span id="line-3699">    private final TableName tableName;</span>
<span class="source-line-no">3700</span><span id="line-3700"></span>
<span class="source-line-no">3701</span><span id="line-3701">    public TableFuture(final HBaseAdmin admin, final TableName tableName, final Long procId) {</span>
<span class="source-line-no">3702</span><span id="line-3702">      super(admin, procId);</span>
<span class="source-line-no">3703</span><span id="line-3703">      this.tableName = tableName;</span>
<span class="source-line-no">3704</span><span id="line-3704">    }</span>
<span class="source-line-no">3705</span><span id="line-3705"></span>
<span class="source-line-no">3706</span><span id="line-3706">    @Override</span>
<span class="source-line-no">3707</span><span id="line-3707">    public String toString() {</span>
<span class="source-line-no">3708</span><span id="line-3708">      return getDescription();</span>
<span class="source-line-no">3709</span><span id="line-3709">    }</span>
<span class="source-line-no">3710</span><span id="line-3710"></span>
<span class="source-line-no">3711</span><span id="line-3711">    /** Returns the table name */</span>
<span class="source-line-no">3712</span><span id="line-3712">    protected TableName getTableName() {</span>
<span class="source-line-no">3713</span><span id="line-3713">      return tableName;</span>
<span class="source-line-no">3714</span><span id="line-3714">    }</span>
<span class="source-line-no">3715</span><span id="line-3715"></span>
<span class="source-line-no">3716</span><span id="line-3716">    /** Returns the table descriptor */</span>
<span class="source-line-no">3717</span><span id="line-3717">    protected TableDescriptor getTableDescriptor() throws IOException {</span>
<span class="source-line-no">3718</span><span id="line-3718">      return getAdmin().getDescriptor(getTableName());</span>
<span class="source-line-no">3719</span><span id="line-3719">    }</span>
<span class="source-line-no">3720</span><span id="line-3720"></span>
<span class="source-line-no">3721</span><span id="line-3721">    /** Returns the operation type like CREATE, DELETE, DISABLE etc. */</span>
<span class="source-line-no">3722</span><span id="line-3722">    public abstract String getOperationType();</span>
<span class="source-line-no">3723</span><span id="line-3723"></span>
<span class="source-line-no">3724</span><span id="line-3724">    /** Returns a description of the operation */</span>
<span class="source-line-no">3725</span><span id="line-3725">    protected String getDescription() {</span>
<span class="source-line-no">3726</span><span id="line-3726">      return "Operation: " + getOperationType() + ", " + "Table Name: "</span>
<span class="source-line-no">3727</span><span id="line-3727">        + tableName.getNameWithNamespaceInclAsString() + ", procId: " + procId;</span>
<span class="source-line-no">3728</span><span id="line-3728">    }</span>
<span class="source-line-no">3729</span><span id="line-3729"></span>
<span class="source-line-no">3730</span><span id="line-3730">    protected abstract class TableWaitForStateCallable implements WaitForStateCallable {</span>
<span class="source-line-no">3731</span><span id="line-3731">      @Override</span>
<span class="source-line-no">3732</span><span id="line-3732">      public void throwInterruptedException() throws InterruptedIOException {</span>
<span class="source-line-no">3733</span><span id="line-3733">        throw new InterruptedIOException("Interrupted while waiting for " + getDescription());</span>
<span class="source-line-no">3734</span><span id="line-3734">      }</span>
<span class="source-line-no">3735</span><span id="line-3735"></span>
<span class="source-line-no">3736</span><span id="line-3736">      @Override</span>
<span class="source-line-no">3737</span><span id="line-3737">      public void throwTimeoutException(long elapsedTime) throws TimeoutException {</span>
<span class="source-line-no">3738</span><span id="line-3738">        throw new TimeoutException(</span>
<span class="source-line-no">3739</span><span id="line-3739">          getDescription() + " has not completed after " + elapsedTime + "ms");</span>
<span class="source-line-no">3740</span><span id="line-3740">      }</span>
<span class="source-line-no">3741</span><span id="line-3741">    }</span>
<span class="source-line-no">3742</span><span id="line-3742"></span>
<span class="source-line-no">3743</span><span id="line-3743">    @Override</span>
<span class="source-line-no">3744</span><span id="line-3744">    protected V postOperationResult(final V result, final long deadlineTs)</span>
<span class="source-line-no">3745</span><span id="line-3745">      throws IOException, TimeoutException {</span>
<span class="source-line-no">3746</span><span id="line-3746">      LOG.info(getDescription() + " completed");</span>
<span class="source-line-no">3747</span><span id="line-3747">      return super.postOperationResult(result, deadlineTs);</span>
<span class="source-line-no">3748</span><span id="line-3748">    }</span>
<span class="source-line-no">3749</span><span id="line-3749"></span>
<span class="source-line-no">3750</span><span id="line-3750">    @Override</span>
<span class="source-line-no">3751</span><span id="line-3751">    protected V postOperationFailure(final IOException exception, final long deadlineTs)</span>
<span class="source-line-no">3752</span><span id="line-3752">      throws IOException, TimeoutException {</span>
<span class="source-line-no">3753</span><span id="line-3753">      LOG.info(getDescription() + " failed with " + exception.getMessage());</span>
<span class="source-line-no">3754</span><span id="line-3754">      return super.postOperationFailure(exception, deadlineTs);</span>
<span class="source-line-no">3755</span><span id="line-3755">    }</span>
<span class="source-line-no">3756</span><span id="line-3756"></span>
<span class="source-line-no">3757</span><span id="line-3757">    protected void waitForTableEnabled(final long deadlineTs) throws IOException, TimeoutException {</span>
<span class="source-line-no">3758</span><span id="line-3758">      waitForState(deadlineTs, new TableWaitForStateCallable() {</span>
<span class="source-line-no">3759</span><span id="line-3759">        @Override</span>
<span class="source-line-no">3760</span><span id="line-3760">        public boolean checkState(int tries) throws IOException {</span>
<span class="source-line-no">3761</span><span id="line-3761">          try {</span>
<span class="source-line-no">3762</span><span id="line-3762">            if (getAdmin().isTableAvailable(tableName)) {</span>
<span class="source-line-no">3763</span><span id="line-3763">              return true;</span>
<span class="source-line-no">3764</span><span id="line-3764">            }</span>
<span class="source-line-no">3765</span><span id="line-3765">          } catch (TableNotFoundException tnfe) {</span>
<span class="source-line-no">3766</span><span id="line-3766">            LOG.debug("Table " + tableName.getNameWithNamespaceInclAsString()</span>
<span class="source-line-no">3767</span><span id="line-3767">              + " was not enabled, sleeping. tries=" + tries);</span>
<span class="source-line-no">3768</span><span id="line-3768">          }</span>
<span class="source-line-no">3769</span><span id="line-3769">          return false;</span>
<span class="source-line-no">3770</span><span id="line-3770">        }</span>
<span class="source-line-no">3771</span><span id="line-3771">      });</span>
<span class="source-line-no">3772</span><span id="line-3772">    }</span>
<span class="source-line-no">3773</span><span id="line-3773"></span>
<span class="source-line-no">3774</span><span id="line-3774">    protected void waitForTableDisabled(final long deadlineTs)</span>
<span class="source-line-no">3775</span><span id="line-3775">      throws IOException, TimeoutException {</span>
<span class="source-line-no">3776</span><span id="line-3776">      waitForState(deadlineTs, new TableWaitForStateCallable() {</span>
<span class="source-line-no">3777</span><span id="line-3777">        @Override</span>
<span class="source-line-no">3778</span><span id="line-3778">        public boolean checkState(int tries) throws IOException {</span>
<span class="source-line-no">3779</span><span id="line-3779">          return getAdmin().isTableDisabled(tableName);</span>
<span class="source-line-no">3780</span><span id="line-3780">        }</span>
<span class="source-line-no">3781</span><span id="line-3781">      });</span>
<span class="source-line-no">3782</span><span id="line-3782">    }</span>
<span class="source-line-no">3783</span><span id="line-3783"></span>
<span class="source-line-no">3784</span><span id="line-3784">    protected void waitTableNotFound(final long deadlineTs) throws IOException, TimeoutException {</span>
<span class="source-line-no">3785</span><span id="line-3785">      waitForState(deadlineTs, new TableWaitForStateCallable() {</span>
<span class="source-line-no">3786</span><span id="line-3786">        @Override</span>
<span class="source-line-no">3787</span><span id="line-3787">        public boolean checkState(int tries) throws IOException {</span>
<span class="source-line-no">3788</span><span id="line-3788">          return !getAdmin().tableExists(tableName);</span>
<span class="source-line-no">3789</span><span id="line-3789">        }</span>
<span class="source-line-no">3790</span><span id="line-3790">      });</span>
<span class="source-line-no">3791</span><span id="line-3791">    }</span>
<span class="source-line-no">3792</span><span id="line-3792"></span>
<span class="source-line-no">3793</span><span id="line-3793">    protected void waitForSchemaUpdate(final long deadlineTs) throws IOException, TimeoutException {</span>
<span class="source-line-no">3794</span><span id="line-3794">      waitForState(deadlineTs, new TableWaitForStateCallable() {</span>
<span class="source-line-no">3795</span><span id="line-3795">        @Override</span>
<span class="source-line-no">3796</span><span id="line-3796">        public boolean checkState(int tries) throws IOException {</span>
<span class="source-line-no">3797</span><span id="line-3797">          return getAdmin().getAlterStatus(tableName).getFirst() == 0;</span>
<span class="source-line-no">3798</span><span id="line-3798">        }</span>
<span class="source-line-no">3799</span><span id="line-3799">      });</span>
<span class="source-line-no">3800</span><span id="line-3800">    }</span>
<span class="source-line-no">3801</span><span id="line-3801"></span>
<span class="source-line-no">3802</span><span id="line-3802">    protected void waitForAllRegionsOnline(final long deadlineTs, final byte[][] splitKeys)</span>
<span class="source-line-no">3803</span><span id="line-3803">      throws IOException, TimeoutException {</span>
<span class="source-line-no">3804</span><span id="line-3804">      final TableDescriptor desc = getTableDescriptor();</span>
<span class="source-line-no">3805</span><span id="line-3805">      final AtomicInteger actualRegCount = new AtomicInteger(0);</span>
<span class="source-line-no">3806</span><span id="line-3806">      final MetaTableAccessor.Visitor visitor = new MetaTableAccessor.Visitor() {</span>
<span class="source-line-no">3807</span><span id="line-3807">        @Override</span>
<span class="source-line-no">3808</span><span id="line-3808">        public boolean visit(Result rowResult) throws IOException {</span>
<span class="source-line-no">3809</span><span id="line-3809">          RegionLocations list = MetaTableAccessor.getRegionLocations(rowResult);</span>
<span class="source-line-no">3810</span><span id="line-3810">          if (list == null) {</span>
<span class="source-line-no">3811</span><span id="line-3811">            LOG.warn("No serialized HRegionInfo in " + rowResult);</span>
<span class="source-line-no">3812</span><span id="line-3812">            return true;</span>
<span class="source-line-no">3813</span><span id="line-3813">          }</span>
<span class="source-line-no">3814</span><span id="line-3814">          HRegionLocation l = list.getRegionLocation();</span>
<span class="source-line-no">3815</span><span id="line-3815">          if (l == null) {</span>
<span class="source-line-no">3816</span><span id="line-3816">            return true;</span>
<span class="source-line-no">3817</span><span id="line-3817">          }</span>
<span class="source-line-no">3818</span><span id="line-3818">          if (!l.getRegionInfo().getTable().equals(desc.getTableName())) {</span>
<span class="source-line-no">3819</span><span id="line-3819">            return false;</span>
<span class="source-line-no">3820</span><span id="line-3820">          }</span>
<span class="source-line-no">3821</span><span id="line-3821">          if (l.getRegionInfo().isOffline() || l.getRegionInfo().isSplit()) return true;</span>
<span class="source-line-no">3822</span><span id="line-3822">          HRegionLocation[] locations = list.getRegionLocations();</span>
<span class="source-line-no">3823</span><span id="line-3823">          for (HRegionLocation location : locations) {</span>
<span class="source-line-no">3824</span><span id="line-3824">            if (location == null) continue;</span>
<span class="source-line-no">3825</span><span id="line-3825">            ServerName serverName = location.getServerName();</span>
<span class="source-line-no">3826</span><span id="line-3826">            // Make sure that regions are assigned to server</span>
<span class="source-line-no">3827</span><span id="line-3827">            if (serverName != null &amp;&amp; serverName.getAddress() != null) {</span>
<span class="source-line-no">3828</span><span id="line-3828">              actualRegCount.incrementAndGet();</span>
<span class="source-line-no">3829</span><span id="line-3829">            }</span>
<span class="source-line-no">3830</span><span id="line-3830">          }</span>
<span class="source-line-no">3831</span><span id="line-3831">          return true;</span>
<span class="source-line-no">3832</span><span id="line-3832">        }</span>
<span class="source-line-no">3833</span><span id="line-3833">      };</span>
<span class="source-line-no">3834</span><span id="line-3834"></span>
<span class="source-line-no">3835</span><span id="line-3835">      int tries = 0;</span>
<span class="source-line-no">3836</span><span id="line-3836">      int numRegs = (splitKeys == null ? 1 : splitKeys.length + 1) * desc.getRegionReplication();</span>
<span class="source-line-no">3837</span><span id="line-3837">      while (EnvironmentEdgeManager.currentTime() &lt; deadlineTs) {</span>
<span class="source-line-no">3838</span><span id="line-3838">        actualRegCount.set(0);</span>
<span class="source-line-no">3839</span><span id="line-3839">        MetaTableAccessor.scanMetaForTableRegions(getAdmin().getConnection(), visitor,</span>
<span class="source-line-no">3840</span><span id="line-3840">          desc.getTableName());</span>
<span class="source-line-no">3841</span><span id="line-3841">        if (actualRegCount.get() == numRegs) {</span>
<span class="source-line-no">3842</span><span id="line-3842">          // all the regions are online</span>
<span class="source-line-no">3843</span><span id="line-3843">          return;</span>
<span class="source-line-no">3844</span><span id="line-3844">        }</span>
<span class="source-line-no">3845</span><span id="line-3845"></span>
<span class="source-line-no">3846</span><span id="line-3846">        try {</span>
<span class="source-line-no">3847</span><span id="line-3847">          Thread.sleep(getAdmin().getPauseTime(tries++));</span>
<span class="source-line-no">3848</span><span id="line-3848">        } catch (InterruptedException e) {</span>
<span class="source-line-no">3849</span><span id="line-3849">          throw new InterruptedIOException("Interrupted when opening" + " regions; "</span>
<span class="source-line-no">3850</span><span id="line-3850">            + actualRegCount.get() + " of " + numRegs + " regions processed so far");</span>
<span class="source-line-no">3851</span><span id="line-3851">        }</span>
<span class="source-line-no">3852</span><span id="line-3852">      }</span>
<span class="source-line-no">3853</span><span id="line-3853">      throw new TimeoutException("Only " + actualRegCount.get() + " of " + numRegs</span>
<span class="source-line-no">3854</span><span id="line-3854">        + " regions are online; retries exhausted.");</span>
<span class="source-line-no">3855</span><span id="line-3855">    }</span>
<span class="source-line-no">3856</span><span id="line-3856">  }</span>
<span class="source-line-no">3857</span><span id="line-3857"></span>
<span class="source-line-no">3858</span><span id="line-3858">  @InterfaceAudience.Private</span>
<span class="source-line-no">3859</span><span id="line-3859">  @InterfaceStability.Evolving</span>
<span class="source-line-no">3860</span><span id="line-3860">  protected static abstract class NamespaceFuture extends ProcedureFuture&lt;Void&gt; {</span>
<span class="source-line-no">3861</span><span id="line-3861">    private final String namespaceName;</span>
<span class="source-line-no">3862</span><span id="line-3862"></span>
<span class="source-line-no">3863</span><span id="line-3863">    public NamespaceFuture(final HBaseAdmin admin, final String namespaceName, final Long procId) {</span>
<span class="source-line-no">3864</span><span id="line-3864">      super(admin, procId);</span>
<span class="source-line-no">3865</span><span id="line-3865">      this.namespaceName = namespaceName;</span>
<span class="source-line-no">3866</span><span id="line-3866">    }</span>
<span class="source-line-no">3867</span><span id="line-3867"></span>
<span class="source-line-no">3868</span><span id="line-3868">    /** Returns the namespace name */</span>
<span class="source-line-no">3869</span><span id="line-3869">    protected String getNamespaceName() {</span>
<span class="source-line-no">3870</span><span id="line-3870">      return namespaceName;</span>
<span class="source-line-no">3871</span><span id="line-3871">    }</span>
<span class="source-line-no">3872</span><span id="line-3872"></span>
<span class="source-line-no">3873</span><span id="line-3873">    /** Returns the operation type like CREATE_NAMESPACE, DELETE_NAMESPACE, etc. */</span>
<span class="source-line-no">3874</span><span id="line-3874">    public abstract String getOperationType();</span>
<span class="source-line-no">3875</span><span id="line-3875"></span>
<span class="source-line-no">3876</span><span id="line-3876">    @Override</span>
<span class="source-line-no">3877</span><span id="line-3877">    public String toString() {</span>
<span class="source-line-no">3878</span><span id="line-3878">      return "Operation: " + getOperationType() + ", Namespace: " + getNamespaceName();</span>
<span class="source-line-no">3879</span><span id="line-3879">    }</span>
<span class="source-line-no">3880</span><span id="line-3880">  }</span>
<span class="source-line-no">3881</span><span id="line-3881"></span>
<span class="source-line-no">3882</span><span id="line-3882">  @InterfaceAudience.Private</span>
<span class="source-line-no">3883</span><span id="line-3883">  @InterfaceStability.Evolving</span>
<span class="source-line-no">3884</span><span id="line-3884">  private static class ReplicationFuture extends ProcedureFuture&lt;Void&gt; {</span>
<span class="source-line-no">3885</span><span id="line-3885">    private final String peerId;</span>
<span class="source-line-no">3886</span><span id="line-3886">    private final Supplier&lt;String&gt; getOperation;</span>
<span class="source-line-no">3887</span><span id="line-3887"></span>
<span class="source-line-no">3888</span><span id="line-3888">    public ReplicationFuture(HBaseAdmin admin, String peerId, Long procId,</span>
<span class="source-line-no">3889</span><span id="line-3889">      Supplier&lt;String&gt; getOperation) {</span>
<span class="source-line-no">3890</span><span id="line-3890">      super(admin, procId);</span>
<span class="source-line-no">3891</span><span id="line-3891">      this.peerId = peerId;</span>
<span class="source-line-no">3892</span><span id="line-3892">      this.getOperation = getOperation;</span>
<span class="source-line-no">3893</span><span id="line-3893">    }</span>
<span class="source-line-no">3894</span><span id="line-3894"></span>
<span class="source-line-no">3895</span><span id="line-3895">    @Override</span>
<span class="source-line-no">3896</span><span id="line-3896">    public String toString() {</span>
<span class="source-line-no">3897</span><span id="line-3897">      return "Operation: " + getOperation.get() + ", peerId: " + peerId;</span>
<span class="source-line-no">3898</span><span id="line-3898">    }</span>
<span class="source-line-no">3899</span><span id="line-3899">  }</span>
<span class="source-line-no">3900</span><span id="line-3900"></span>
<span class="source-line-no">3901</span><span id="line-3901">  @Override</span>
<span class="source-line-no">3902</span><span id="line-3902">  public List&lt;SecurityCapability&gt; getSecurityCapabilities() throws IOException {</span>
<span class="source-line-no">3903</span><span id="line-3903">    try {</span>
<span class="source-line-no">3904</span><span id="line-3904">      return executeCallable(</span>
<span class="source-line-no">3905</span><span id="line-3905">        new MasterCallable&lt;List&lt;SecurityCapability&gt;&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">3906</span><span id="line-3906">          @Override</span>
<span class="source-line-no">3907</span><span id="line-3907">          protected List&lt;SecurityCapability&gt; rpcCall() throws Exception {</span>
<span class="source-line-no">3908</span><span id="line-3908">            SecurityCapabilitiesRequest req = SecurityCapabilitiesRequest.newBuilder().build();</span>
<span class="source-line-no">3909</span><span id="line-3909">            return ProtobufUtil.toSecurityCapabilityList(</span>
<span class="source-line-no">3910</span><span id="line-3910">              master.getSecurityCapabilities(getRpcController(), req).getCapabilitiesList());</span>
<span class="source-line-no">3911</span><span id="line-3911">          }</span>
<span class="source-line-no">3912</span><span id="line-3912">        });</span>
<span class="source-line-no">3913</span><span id="line-3913">    } catch (IOException e) {</span>
<span class="source-line-no">3914</span><span id="line-3914">      if (e instanceof RemoteException) {</span>
<span class="source-line-no">3915</span><span id="line-3915">        e = ((RemoteException) e).unwrapRemoteException();</span>
<span class="source-line-no">3916</span><span id="line-3916">      }</span>
<span class="source-line-no">3917</span><span id="line-3917">      throw e;</span>
<span class="source-line-no">3918</span><span id="line-3918">    }</span>
<span class="source-line-no">3919</span><span id="line-3919">  }</span>
<span class="source-line-no">3920</span><span id="line-3920"></span>
<span class="source-line-no">3921</span><span id="line-3921">  @Override</span>
<span class="source-line-no">3922</span><span id="line-3922">  public boolean splitSwitch(boolean enabled, boolean synchronous) throws IOException {</span>
<span class="source-line-no">3923</span><span id="line-3923">    return splitOrMergeSwitch(enabled, synchronous, MasterSwitchType.SPLIT);</span>
<span class="source-line-no">3924</span><span id="line-3924">  }</span>
<span class="source-line-no">3925</span><span id="line-3925"></span>
<span class="source-line-no">3926</span><span id="line-3926">  @Override</span>
<span class="source-line-no">3927</span><span id="line-3927">  public boolean mergeSwitch(boolean enabled, boolean synchronous) throws IOException {</span>
<span class="source-line-no">3928</span><span id="line-3928">    return splitOrMergeSwitch(enabled, synchronous, MasterSwitchType.MERGE);</span>
<span class="source-line-no">3929</span><span id="line-3929">  }</span>
<span class="source-line-no">3930</span><span id="line-3930"></span>
<span class="source-line-no">3931</span><span id="line-3931">  private boolean splitOrMergeSwitch(boolean enabled, boolean synchronous,</span>
<span class="source-line-no">3932</span><span id="line-3932">    MasterSwitchType switchType) throws IOException {</span>
<span class="source-line-no">3933</span><span id="line-3933">    return executeCallable(new MasterCallable&lt;Boolean&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">3934</span><span id="line-3934">      @Override</span>
<span class="source-line-no">3935</span><span id="line-3935">      protected Boolean rpcCall() throws Exception {</span>
<span class="source-line-no">3936</span><span id="line-3936">        MasterProtos.SetSplitOrMergeEnabledResponse response =</span>
<span class="source-line-no">3937</span><span id="line-3937">          master.setSplitOrMergeEnabled(getRpcController(),</span>
<span class="source-line-no">3938</span><span id="line-3938">            RequestConverter.buildSetSplitOrMergeEnabledRequest(enabled, synchronous, switchType));</span>
<span class="source-line-no">3939</span><span id="line-3939">        return response.getPrevValueList().get(0);</span>
<span class="source-line-no">3940</span><span id="line-3940">      }</span>
<span class="source-line-no">3941</span><span id="line-3941">    });</span>
<span class="source-line-no">3942</span><span id="line-3942">  }</span>
<span class="source-line-no">3943</span><span id="line-3943"></span>
<span class="source-line-no">3944</span><span id="line-3944">  @Override</span>
<span class="source-line-no">3945</span><span id="line-3945">  public boolean isSplitEnabled() throws IOException {</span>
<span class="source-line-no">3946</span><span id="line-3946">    return executeCallable(new MasterCallable&lt;Boolean&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">3947</span><span id="line-3947">      @Override</span>
<span class="source-line-no">3948</span><span id="line-3948">      protected Boolean rpcCall() throws Exception {</span>
<span class="source-line-no">3949</span><span id="line-3949">        return master</span>
<span class="source-line-no">3950</span><span id="line-3950">          .isSplitOrMergeEnabled(getRpcController(),</span>
<span class="source-line-no">3951</span><span id="line-3951">            RequestConverter.buildIsSplitOrMergeEnabledRequest(MasterSwitchType.SPLIT))</span>
<span class="source-line-no">3952</span><span id="line-3952">          .getEnabled();</span>
<span class="source-line-no">3953</span><span id="line-3953">      }</span>
<span class="source-line-no">3954</span><span id="line-3954">    });</span>
<span class="source-line-no">3955</span><span id="line-3955">  }</span>
<span class="source-line-no">3956</span><span id="line-3956"></span>
<span class="source-line-no">3957</span><span id="line-3957">  @Override</span>
<span class="source-line-no">3958</span><span id="line-3958">  public boolean isMergeEnabled() throws IOException {</span>
<span class="source-line-no">3959</span><span id="line-3959">    return executeCallable(new MasterCallable&lt;Boolean&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">3960</span><span id="line-3960">      @Override</span>
<span class="source-line-no">3961</span><span id="line-3961">      protected Boolean rpcCall() throws Exception {</span>
<span class="source-line-no">3962</span><span id="line-3962">        return master</span>
<span class="source-line-no">3963</span><span id="line-3963">          .isSplitOrMergeEnabled(getRpcController(),</span>
<span class="source-line-no">3964</span><span id="line-3964">            RequestConverter.buildIsSplitOrMergeEnabledRequest(MasterSwitchType.MERGE))</span>
<span class="source-line-no">3965</span><span id="line-3965">          .getEnabled();</span>
<span class="source-line-no">3966</span><span id="line-3966">      }</span>
<span class="source-line-no">3967</span><span id="line-3967">    });</span>
<span class="source-line-no">3968</span><span id="line-3968">  }</span>
<span class="source-line-no">3969</span><span id="line-3969"></span>
<span class="source-line-no">3970</span><span id="line-3970">  private RpcControllerFactory getRpcControllerFactory() {</span>
<span class="source-line-no">3971</span><span id="line-3971">    return this.rpcControllerFactory;</span>
<span class="source-line-no">3972</span><span id="line-3972">  }</span>
<span class="source-line-no">3973</span><span id="line-3973"></span>
<span class="source-line-no">3974</span><span id="line-3974">  @Override</span>
<span class="source-line-no">3975</span><span id="line-3975">  public Future&lt;Void&gt; addReplicationPeerAsync(String peerId, ReplicationPeerConfig peerConfig,</span>
<span class="source-line-no">3976</span><span id="line-3976">    boolean enabled) throws IOException {</span>
<span class="source-line-no">3977</span><span id="line-3977">    AddReplicationPeerResponse response = executeCallable(</span>
<span class="source-line-no">3978</span><span id="line-3978">      new MasterCallable&lt;AddReplicationPeerResponse&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">3979</span><span id="line-3979">        @Override</span>
<span class="source-line-no">3980</span><span id="line-3980">        protected AddReplicationPeerResponse rpcCall() throws Exception {</span>
<span class="source-line-no">3981</span><span id="line-3981">          return master.addReplicationPeer(getRpcController(),</span>
<span class="source-line-no">3982</span><span id="line-3982">            RequestConverter.buildAddReplicationPeerRequest(peerId, peerConfig, enabled));</span>
<span class="source-line-no">3983</span><span id="line-3983">        }</span>
<span class="source-line-no">3984</span><span id="line-3984">      });</span>
<span class="source-line-no">3985</span><span id="line-3985">    return new ReplicationFuture(this, peerId, response.getProcId(), () -&gt; "ADD_REPLICATION_PEER");</span>
<span class="source-line-no">3986</span><span id="line-3986">  }</span>
<span class="source-line-no">3987</span><span id="line-3987"></span>
<span class="source-line-no">3988</span><span id="line-3988">  @Override</span>
<span class="source-line-no">3989</span><span id="line-3989">  public Future&lt;Void&gt; removeReplicationPeerAsync(String peerId) throws IOException {</span>
<span class="source-line-no">3990</span><span id="line-3990">    RemoveReplicationPeerResponse response =</span>
<span class="source-line-no">3991</span><span id="line-3991">      executeCallable(new MasterCallable&lt;RemoveReplicationPeerResponse&gt;(getConnection(),</span>
<span class="source-line-no">3992</span><span id="line-3992">        getRpcControllerFactory()) {</span>
<span class="source-line-no">3993</span><span id="line-3993">        @Override</span>
<span class="source-line-no">3994</span><span id="line-3994">        protected RemoveReplicationPeerResponse rpcCall() throws Exception {</span>
<span class="source-line-no">3995</span><span id="line-3995">          return master.removeReplicationPeer(getRpcController(),</span>
<span class="source-line-no">3996</span><span id="line-3996">            RequestConverter.buildRemoveReplicationPeerRequest(peerId));</span>
<span class="source-line-no">3997</span><span id="line-3997">        }</span>
<span class="source-line-no">3998</span><span id="line-3998">      });</span>
<span class="source-line-no">3999</span><span id="line-3999">    return new ReplicationFuture(this, peerId, response.getProcId(),</span>
<span class="source-line-no">4000</span><span id="line-4000">      () -&gt; "REMOVE_REPLICATION_PEER");</span>
<span class="source-line-no">4001</span><span id="line-4001">  }</span>
<span class="source-line-no">4002</span><span id="line-4002"></span>
<span class="source-line-no">4003</span><span id="line-4003">  @Override</span>
<span class="source-line-no">4004</span><span id="line-4004">  public Future&lt;Void&gt; enableReplicationPeerAsync(final String peerId) throws IOException {</span>
<span class="source-line-no">4005</span><span id="line-4005">    EnableReplicationPeerResponse response =</span>
<span class="source-line-no">4006</span><span id="line-4006">      executeCallable(new MasterCallable&lt;EnableReplicationPeerResponse&gt;(getConnection(),</span>
<span class="source-line-no">4007</span><span id="line-4007">        getRpcControllerFactory()) {</span>
<span class="source-line-no">4008</span><span id="line-4008">        @Override</span>
<span class="source-line-no">4009</span><span id="line-4009">        protected EnableReplicationPeerResponse rpcCall() throws Exception {</span>
<span class="source-line-no">4010</span><span id="line-4010">          return master.enableReplicationPeer(getRpcController(),</span>
<span class="source-line-no">4011</span><span id="line-4011">            RequestConverter.buildEnableReplicationPeerRequest(peerId));</span>
<span class="source-line-no">4012</span><span id="line-4012">        }</span>
<span class="source-line-no">4013</span><span id="line-4013">      });</span>
<span class="source-line-no">4014</span><span id="line-4014">    return new ReplicationFuture(this, peerId, response.getProcId(),</span>
<span class="source-line-no">4015</span><span id="line-4015">      () -&gt; "ENABLE_REPLICATION_PEER");</span>
<span class="source-line-no">4016</span><span id="line-4016">  }</span>
<span class="source-line-no">4017</span><span id="line-4017"></span>
<span class="source-line-no">4018</span><span id="line-4018">  @Override</span>
<span class="source-line-no">4019</span><span id="line-4019">  public Future&lt;Void&gt; disableReplicationPeerAsync(final String peerId) throws IOException {</span>
<span class="source-line-no">4020</span><span id="line-4020">    DisableReplicationPeerResponse response =</span>
<span class="source-line-no">4021</span><span id="line-4021">      executeCallable(new MasterCallable&lt;DisableReplicationPeerResponse&gt;(getConnection(),</span>
<span class="source-line-no">4022</span><span id="line-4022">        getRpcControllerFactory()) {</span>
<span class="source-line-no">4023</span><span id="line-4023">        @Override</span>
<span class="source-line-no">4024</span><span id="line-4024">        protected DisableReplicationPeerResponse rpcCall() throws Exception {</span>
<span class="source-line-no">4025</span><span id="line-4025">          return master.disableReplicationPeer(getRpcController(),</span>
<span class="source-line-no">4026</span><span id="line-4026">            RequestConverter.buildDisableReplicationPeerRequest(peerId));</span>
<span class="source-line-no">4027</span><span id="line-4027">        }</span>
<span class="source-line-no">4028</span><span id="line-4028">      });</span>
<span class="source-line-no">4029</span><span id="line-4029">    return new ReplicationFuture(this, peerId, response.getProcId(),</span>
<span class="source-line-no">4030</span><span id="line-4030">      () -&gt; "DISABLE_REPLICATION_PEER");</span>
<span class="source-line-no">4031</span><span id="line-4031">  }</span>
<span class="source-line-no">4032</span><span id="line-4032"></span>
<span class="source-line-no">4033</span><span id="line-4033">  @Override</span>
<span class="source-line-no">4034</span><span id="line-4034">  public ReplicationPeerConfig getReplicationPeerConfig(final String peerId) throws IOException {</span>
<span class="source-line-no">4035</span><span id="line-4035">    return executeCallable(</span>
<span class="source-line-no">4036</span><span id="line-4036">      new MasterCallable&lt;ReplicationPeerConfig&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">4037</span><span id="line-4037">        @Override</span>
<span class="source-line-no">4038</span><span id="line-4038">        protected ReplicationPeerConfig rpcCall() throws Exception {</span>
<span class="source-line-no">4039</span><span id="line-4039">          GetReplicationPeerConfigResponse response = master.getReplicationPeerConfig(</span>
<span class="source-line-no">4040</span><span id="line-4040">            getRpcController(), RequestConverter.buildGetReplicationPeerConfigRequest(peerId));</span>
<span class="source-line-no">4041</span><span id="line-4041">          return ReplicationPeerConfigUtil.convert(response.getPeerConfig());</span>
<span class="source-line-no">4042</span><span id="line-4042">        }</span>
<span class="source-line-no">4043</span><span id="line-4043">      });</span>
<span class="source-line-no">4044</span><span id="line-4044">  }</span>
<span class="source-line-no">4045</span><span id="line-4045"></span>
<span class="source-line-no">4046</span><span id="line-4046">  @Override</span>
<span class="source-line-no">4047</span><span id="line-4047">  public Future&lt;Void&gt; updateReplicationPeerConfigAsync(final String peerId,</span>
<span class="source-line-no">4048</span><span id="line-4048">    final ReplicationPeerConfig peerConfig) throws IOException {</span>
<span class="source-line-no">4049</span><span id="line-4049">    UpdateReplicationPeerConfigResponse response =</span>
<span class="source-line-no">4050</span><span id="line-4050">      executeCallable(new MasterCallable&lt;UpdateReplicationPeerConfigResponse&gt;(getConnection(),</span>
<span class="source-line-no">4051</span><span id="line-4051">        getRpcControllerFactory()) {</span>
<span class="source-line-no">4052</span><span id="line-4052">        @Override</span>
<span class="source-line-no">4053</span><span id="line-4053">        protected UpdateReplicationPeerConfigResponse rpcCall() throws Exception {</span>
<span class="source-line-no">4054</span><span id="line-4054">          return master.updateReplicationPeerConfig(getRpcController(),</span>
<span class="source-line-no">4055</span><span id="line-4055">            RequestConverter.buildUpdateReplicationPeerConfigRequest(peerId, peerConfig));</span>
<span class="source-line-no">4056</span><span id="line-4056">        }</span>
<span class="source-line-no">4057</span><span id="line-4057">      });</span>
<span class="source-line-no">4058</span><span id="line-4058">    return new ReplicationFuture(this, peerId, response.getProcId(),</span>
<span class="source-line-no">4059</span><span id="line-4059">      () -&gt; "UPDATE_REPLICATION_PEER_CONFIG");</span>
<span class="source-line-no">4060</span><span id="line-4060">  }</span>
<span class="source-line-no">4061</span><span id="line-4061"></span>
<span class="source-line-no">4062</span><span id="line-4062">  @Override</span>
<span class="source-line-no">4063</span><span id="line-4063">  public List&lt;ReplicationPeerDescription&gt; listReplicationPeers() throws IOException {</span>
<span class="source-line-no">4064</span><span id="line-4064">    return listReplicationPeers((Pattern) null);</span>
<span class="source-line-no">4065</span><span id="line-4065">  }</span>
<span class="source-line-no">4066</span><span id="line-4066"></span>
<span class="source-line-no">4067</span><span id="line-4067">  @Override</span>
<span class="source-line-no">4068</span><span id="line-4068">  public List&lt;ReplicationPeerDescription&gt; listReplicationPeers(Pattern pattern) throws IOException {</span>
<span class="source-line-no">4069</span><span id="line-4069">    return executeCallable(new MasterCallable&lt;List&lt;ReplicationPeerDescription&gt;&gt;(getConnection(),</span>
<span class="source-line-no">4070</span><span id="line-4070">      getRpcControllerFactory()) {</span>
<span class="source-line-no">4071</span><span id="line-4071">      @Override</span>
<span class="source-line-no">4072</span><span id="line-4072">      protected List&lt;ReplicationPeerDescription&gt; rpcCall() throws Exception {</span>
<span class="source-line-no">4073</span><span id="line-4073">        List&lt;ReplicationProtos.ReplicationPeerDescription&gt; peersList =</span>
<span class="source-line-no">4074</span><span id="line-4074">          master.listReplicationPeers(getRpcController(),</span>
<span class="source-line-no">4075</span><span id="line-4075">            RequestConverter.buildListReplicationPeersRequest(pattern)).getPeerDescList();</span>
<span class="source-line-no">4076</span><span id="line-4076">        List&lt;ReplicationPeerDescription&gt; result = new ArrayList&lt;&gt;(peersList.size());</span>
<span class="source-line-no">4077</span><span id="line-4077">        for (ReplicationProtos.ReplicationPeerDescription peer : peersList) {</span>
<span class="source-line-no">4078</span><span id="line-4078">          result.add(ReplicationPeerConfigUtil.toReplicationPeerDescription(peer));</span>
<span class="source-line-no">4079</span><span id="line-4079">        }</span>
<span class="source-line-no">4080</span><span id="line-4080">        return result;</span>
<span class="source-line-no">4081</span><span id="line-4081">      }</span>
<span class="source-line-no">4082</span><span id="line-4082">    });</span>
<span class="source-line-no">4083</span><span id="line-4083">  }</span>
<span class="source-line-no">4084</span><span id="line-4084"></span>
<span class="source-line-no">4085</span><span id="line-4085">  @Override</span>
<span class="source-line-no">4086</span><span id="line-4086">  public void decommissionRegionServers(List&lt;ServerName&gt; servers, boolean offload)</span>
<span class="source-line-no">4087</span><span id="line-4087">    throws IOException {</span>
<span class="source-line-no">4088</span><span id="line-4088">    executeCallable(new MasterCallable&lt;Void&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">4089</span><span id="line-4089">      @Override</span>
<span class="source-line-no">4090</span><span id="line-4090">      public Void rpcCall() throws ServiceException {</span>
<span class="source-line-no">4091</span><span id="line-4091">        master.decommissionRegionServers(getRpcController(),</span>
<span class="source-line-no">4092</span><span id="line-4092">          RequestConverter.buildDecommissionRegionServersRequest(servers, offload));</span>
<span class="source-line-no">4093</span><span id="line-4093">        return null;</span>
<span class="source-line-no">4094</span><span id="line-4094">      }</span>
<span class="source-line-no">4095</span><span id="line-4095">    });</span>
<span class="source-line-no">4096</span><span id="line-4096">  }</span>
<span class="source-line-no">4097</span><span id="line-4097"></span>
<span class="source-line-no">4098</span><span id="line-4098">  @Override</span>
<span class="source-line-no">4099</span><span id="line-4099">  public List&lt;ServerName&gt; listDecommissionedRegionServers() throws IOException {</span>
<span class="source-line-no">4100</span><span id="line-4100">    return executeCallable(</span>
<span class="source-line-no">4101</span><span id="line-4101">      new MasterCallable&lt;List&lt;ServerName&gt;&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">4102</span><span id="line-4102">        @Override</span>
<span class="source-line-no">4103</span><span id="line-4103">        public List&lt;ServerName&gt; rpcCall() throws ServiceException {</span>
<span class="source-line-no">4104</span><span id="line-4104">          ListDecommissionedRegionServersRequest req =</span>
<span class="source-line-no">4105</span><span id="line-4105">            ListDecommissionedRegionServersRequest.newBuilder().build();</span>
<span class="source-line-no">4106</span><span id="line-4106">          List&lt;ServerName&gt; servers = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">4107</span><span id="line-4107">          for (HBaseProtos.ServerName server : master</span>
<span class="source-line-no">4108</span><span id="line-4108">            .listDecommissionedRegionServers(getRpcController(), req).getServerNameList()) {</span>
<span class="source-line-no">4109</span><span id="line-4109">            servers.add(ProtobufUtil.toServerName(server));</span>
<span class="source-line-no">4110</span><span id="line-4110">          }</span>
<span class="source-line-no">4111</span><span id="line-4111">          return servers;</span>
<span class="source-line-no">4112</span><span id="line-4112">        }</span>
<span class="source-line-no">4113</span><span id="line-4113">      });</span>
<span class="source-line-no">4114</span><span id="line-4114">  }</span>
<span class="source-line-no">4115</span><span id="line-4115"></span>
<span class="source-line-no">4116</span><span id="line-4116">  @Override</span>
<span class="source-line-no">4117</span><span id="line-4117">  public void recommissionRegionServer(ServerName server, List&lt;byte[]&gt; encodedRegionNames)</span>
<span class="source-line-no">4118</span><span id="line-4118">    throws IOException {</span>
<span class="source-line-no">4119</span><span id="line-4119">    executeCallable(new MasterCallable&lt;Void&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">4120</span><span id="line-4120">      @Override</span>
<span class="source-line-no">4121</span><span id="line-4121">      public Void rpcCall() throws ServiceException {</span>
<span class="source-line-no">4122</span><span id="line-4122">        master.recommissionRegionServer(getRpcController(),</span>
<span class="source-line-no">4123</span><span id="line-4123">          RequestConverter.buildRecommissionRegionServerRequest(server, encodedRegionNames));</span>
<span class="source-line-no">4124</span><span id="line-4124">        return null;</span>
<span class="source-line-no">4125</span><span id="line-4125">      }</span>
<span class="source-line-no">4126</span><span id="line-4126">    });</span>
<span class="source-line-no">4127</span><span id="line-4127">  }</span>
<span class="source-line-no">4128</span><span id="line-4128"></span>
<span class="source-line-no">4129</span><span id="line-4129">  @Override</span>
<span class="source-line-no">4130</span><span id="line-4130">  public List&lt;TableCFs&gt; listReplicatedTableCFs() throws IOException {</span>
<span class="source-line-no">4131</span><span id="line-4131">    List&lt;TableCFs&gt; replicatedTableCFs = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">4132</span><span id="line-4132">    List&lt;TableDescriptor&gt; tables = listTableDescriptors();</span>
<span class="source-line-no">4133</span><span id="line-4133">    tables.forEach(table -&gt; {</span>
<span class="source-line-no">4134</span><span id="line-4134">      Map&lt;String, Integer&gt; cfs = new HashMap&lt;&gt;();</span>
<span class="source-line-no">4135</span><span id="line-4135">      Stream.of(table.getColumnFamilies())</span>
<span class="source-line-no">4136</span><span id="line-4136">        .filter(column -&gt; column.getScope() != HConstants.REPLICATION_SCOPE_LOCAL)</span>
<span class="source-line-no">4137</span><span id="line-4137">        .forEach(column -&gt; {</span>
<span class="source-line-no">4138</span><span id="line-4138">          cfs.put(column.getNameAsString(), column.getScope());</span>
<span class="source-line-no">4139</span><span id="line-4139">        });</span>
<span class="source-line-no">4140</span><span id="line-4140">      if (!cfs.isEmpty()) {</span>
<span class="source-line-no">4141</span><span id="line-4141">        replicatedTableCFs.add(new TableCFs(table.getTableName(), cfs));</span>
<span class="source-line-no">4142</span><span id="line-4142">      }</span>
<span class="source-line-no">4143</span><span id="line-4143">    });</span>
<span class="source-line-no">4144</span><span id="line-4144">    return replicatedTableCFs;</span>
<span class="source-line-no">4145</span><span id="line-4145">  }</span>
<span class="source-line-no">4146</span><span id="line-4146"></span>
<span class="source-line-no">4147</span><span id="line-4147">  @Override</span>
<span class="source-line-no">4148</span><span id="line-4148">  public void enableTableReplication(final TableName tableName) throws IOException {</span>
<span class="source-line-no">4149</span><span id="line-4149">    if (tableName == null) {</span>
<span class="source-line-no">4150</span><span id="line-4150">      throw new IllegalArgumentException("Table name cannot be null");</span>
<span class="source-line-no">4151</span><span id="line-4151">    }</span>
<span class="source-line-no">4152</span><span id="line-4152">    if (!tableExists(tableName)) {</span>
<span class="source-line-no">4153</span><span id="line-4153">      throw new TableNotFoundException(</span>
<span class="source-line-no">4154</span><span id="line-4154">        "Table '" + tableName.getNameAsString() + "' does not exists.");</span>
<span class="source-line-no">4155</span><span id="line-4155">    }</span>
<span class="source-line-no">4156</span><span id="line-4156">    byte[][] splits = getTableSplits(tableName);</span>
<span class="source-line-no">4157</span><span id="line-4157">    checkAndSyncTableDescToPeers(tableName, splits);</span>
<span class="source-line-no">4158</span><span id="line-4158">    setTableRep(tableName, true);</span>
<span class="source-line-no">4159</span><span id="line-4159">  }</span>
<span class="source-line-no">4160</span><span id="line-4160"></span>
<span class="source-line-no">4161</span><span id="line-4161">  @Override</span>
<span class="source-line-no">4162</span><span id="line-4162">  public void disableTableReplication(final TableName tableName) throws IOException {</span>
<span class="source-line-no">4163</span><span id="line-4163">    if (tableName == null) {</span>
<span class="source-line-no">4164</span><span id="line-4164">      throw new IllegalArgumentException("Table name is null");</span>
<span class="source-line-no">4165</span><span id="line-4165">    }</span>
<span class="source-line-no">4166</span><span id="line-4166">    if (!tableExists(tableName)) {</span>
<span class="source-line-no">4167</span><span id="line-4167">      throw new TableNotFoundException(</span>
<span class="source-line-no">4168</span><span id="line-4168">        "Table '" + tableName.getNameAsString() + "' does not exists.");</span>
<span class="source-line-no">4169</span><span id="line-4169">    }</span>
<span class="source-line-no">4170</span><span id="line-4170">    setTableRep(tableName, false);</span>
<span class="source-line-no">4171</span><span id="line-4171">  }</span>
<span class="source-line-no">4172</span><span id="line-4172"></span>
<span class="source-line-no">4173</span><span id="line-4173">  @Override</span>
<span class="source-line-no">4174</span><span id="line-4174">  public boolean isReplicationPeerEnabled(String peerId) throws IOException {</span>
<span class="source-line-no">4175</span><span id="line-4175">    return executeCallable(new MasterCallable&lt;Boolean&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">4176</span><span id="line-4176">      @Override</span>
<span class="source-line-no">4177</span><span id="line-4177">      protected Boolean rpcCall() throws Exception {</span>
<span class="source-line-no">4178</span><span id="line-4178">        GetReplicationPeerStateRequest.Builder request =</span>
<span class="source-line-no">4179</span><span id="line-4179">          GetReplicationPeerStateRequest.newBuilder();</span>
<span class="source-line-no">4180</span><span id="line-4180">        request.setPeerId(peerId);</span>
<span class="source-line-no">4181</span><span id="line-4181">        GetReplicationPeerStateResponse response =</span>
<span class="source-line-no">4182</span><span id="line-4182">          master.isReplicationPeerEnabled(getRpcController(), request.build());</span>
<span class="source-line-no">4183</span><span id="line-4183">        return response.getIsEnabled();</span>
<span class="source-line-no">4184</span><span id="line-4184">      }</span>
<span class="source-line-no">4185</span><span id="line-4185">    });</span>
<span class="source-line-no">4186</span><span id="line-4186">  }</span>
<span class="source-line-no">4187</span><span id="line-4187"></span>
<span class="source-line-no">4188</span><span id="line-4188">  /**</span>
<span class="source-line-no">4189</span><span id="line-4189">   * Connect to peer and check the table descriptor on peer:</span>
<span class="source-line-no">4190</span><span id="line-4190">   * &lt;ol&gt;</span>
<span class="source-line-no">4191</span><span id="line-4191">   * &lt;li&gt;Create the same table on peer when not exist.&lt;/li&gt;</span>
<span class="source-line-no">4192</span><span id="line-4192">   * &lt;li&gt;Throw an exception if the table already has replication enabled on any of the column</span>
<span class="source-line-no">4193</span><span id="line-4193">   * families.&lt;/li&gt;</span>
<span class="source-line-no">4194</span><span id="line-4194">   * &lt;li&gt;Throw an exception if the table exists on peer cluster but descriptors are not same.&lt;/li&gt;</span>
<span class="source-line-no">4195</span><span id="line-4195">   * &lt;/ol&gt;</span>
<span class="source-line-no">4196</span><span id="line-4196">   * @param tableName name of the table to sync to the peer</span>
<span class="source-line-no">4197</span><span id="line-4197">   * @param splits    table split keys</span>
<span class="source-line-no">4198</span><span id="line-4198">   * @throws IOException if a remote or network exception occurs</span>
<span class="source-line-no">4199</span><span id="line-4199">   */</span>
<span class="source-line-no">4200</span><span id="line-4200">  private void checkAndSyncTableDescToPeers(final TableName tableName, final byte[][] splits)</span>
<span class="source-line-no">4201</span><span id="line-4201">    throws IOException {</span>
<span class="source-line-no">4202</span><span id="line-4202">    List&lt;ReplicationPeerDescription&gt; peers = listReplicationPeers();</span>
<span class="source-line-no">4203</span><span id="line-4203">    if (peers == null || peers.size() &lt;= 0) {</span>
<span class="source-line-no">4204</span><span id="line-4204">      throw new IllegalArgumentException("Found no peer cluster for replication.");</span>
<span class="source-line-no">4205</span><span id="line-4205">    }</span>
<span class="source-line-no">4206</span><span id="line-4206"></span>
<span class="source-line-no">4207</span><span id="line-4207">    for (ReplicationPeerDescription peerDesc : peers) {</span>
<span class="source-line-no">4208</span><span id="line-4208">      if (peerDesc.getPeerConfig().needToReplicate(tableName)) {</span>
<span class="source-line-no">4209</span><span id="line-4209">        Configuration peerConf =</span>
<span class="source-line-no">4210</span><span id="line-4210">          ReplicationPeerConfigUtil.getPeerClusterConfiguration(this.conf, peerDesc);</span>
<span class="source-line-no">4211</span><span id="line-4211">        try (Connection conn = ConnectionFactory.createConnection(peerConf);</span>
<span class="source-line-no">4212</span><span id="line-4212">          Admin repHBaseAdmin = conn.getAdmin()) {</span>
<span class="source-line-no">4213</span><span id="line-4213">          TableDescriptor tableDesc = getDescriptor(tableName);</span>
<span class="source-line-no">4214</span><span id="line-4214">          TableDescriptor peerTableDesc = null;</span>
<span class="source-line-no">4215</span><span id="line-4215">          if (!repHBaseAdmin.tableExists(tableName)) {</span>
<span class="source-line-no">4216</span><span id="line-4216">            repHBaseAdmin.createTable(tableDesc, splits);</span>
<span class="source-line-no">4217</span><span id="line-4217">          } else {</span>
<span class="source-line-no">4218</span><span id="line-4218">            peerTableDesc = repHBaseAdmin.getDescriptor(tableName);</span>
<span class="source-line-no">4219</span><span id="line-4219">            if (peerTableDesc == null) {</span>
<span class="source-line-no">4220</span><span id="line-4220">              throw new IllegalArgumentException("Failed to get table descriptor for table "</span>
<span class="source-line-no">4221</span><span id="line-4221">                + tableName.getNameAsString() + " from peer cluster " + peerDesc.getPeerId());</span>
<span class="source-line-no">4222</span><span id="line-4222">            }</span>
<span class="source-line-no">4223</span><span id="line-4223">            if (</span>
<span class="source-line-no">4224</span><span id="line-4224">              TableDescriptor.COMPARATOR_IGNORE_REPLICATION.compare(peerTableDesc, tableDesc) != 0</span>
<span class="source-line-no">4225</span><span id="line-4225">            ) {</span>
<span class="source-line-no">4226</span><span id="line-4226">              throw new IllegalArgumentException("Table " + tableName.getNameAsString()</span>
<span class="source-line-no">4227</span><span id="line-4227">                + " exists in peer cluster " + peerDesc.getPeerId()</span>
<span class="source-line-no">4228</span><span id="line-4228">                + ", but the table descriptors are not same when compared with source cluster."</span>
<span class="source-line-no">4229</span><span id="line-4229">                + " Thus can not enable the table's replication switch.");</span>
<span class="source-line-no">4230</span><span id="line-4230">            }</span>
<span class="source-line-no">4231</span><span id="line-4231">          }</span>
<span class="source-line-no">4232</span><span id="line-4232">        }</span>
<span class="source-line-no">4233</span><span id="line-4233">      }</span>
<span class="source-line-no">4234</span><span id="line-4234">    }</span>
<span class="source-line-no">4235</span><span id="line-4235">  }</span>
<span class="source-line-no">4236</span><span id="line-4236"></span>
<span class="source-line-no">4237</span><span id="line-4237">  /**</span>
<span class="source-line-no">4238</span><span id="line-4238">   * Set the table's replication switch if the table's replication switch is already not set.</span>
<span class="source-line-no">4239</span><span id="line-4239">   * @param tableName name of the table</span>
<span class="source-line-no">4240</span><span id="line-4240">   * @param enableRep is replication switch enable or disable</span>
<span class="source-line-no">4241</span><span id="line-4241">   * @throws IOException if a remote or network exception occurs</span>
<span class="source-line-no">4242</span><span id="line-4242">   */</span>
<span class="source-line-no">4243</span><span id="line-4243">  private void setTableRep(final TableName tableName, boolean enableRep) throws IOException {</span>
<span class="source-line-no">4244</span><span id="line-4244">    TableDescriptor tableDesc = getDescriptor(tableName);</span>
<span class="source-line-no">4245</span><span id="line-4245">    if (!tableDesc.matchReplicationScope(enableRep)) {</span>
<span class="source-line-no">4246</span><span id="line-4246">      int scope =</span>
<span class="source-line-no">4247</span><span id="line-4247">        enableRep ? HConstants.REPLICATION_SCOPE_GLOBAL : HConstants.REPLICATION_SCOPE_LOCAL;</span>
<span class="source-line-no">4248</span><span id="line-4248">      modifyTable(TableDescriptorBuilder.newBuilder(tableDesc).setReplicationScope(scope).build());</span>
<span class="source-line-no">4249</span><span id="line-4249">    }</span>
<span class="source-line-no">4250</span><span id="line-4250">  }</span>
<span class="source-line-no">4251</span><span id="line-4251"></span>
<span class="source-line-no">4252</span><span id="line-4252">  @Override</span>
<span class="source-line-no">4253</span><span id="line-4253">  public void clearCompactionQueues(final ServerName sn, final Set&lt;String&gt; queues)</span>
<span class="source-line-no">4254</span><span id="line-4254">    throws IOException, InterruptedException {</span>
<span class="source-line-no">4255</span><span id="line-4255">    if (queues == null || queues.size() == 0) {</span>
<span class="source-line-no">4256</span><span id="line-4256">      throw new IllegalArgumentException("queues cannot be null or empty");</span>
<span class="source-line-no">4257</span><span id="line-4257">    }</span>
<span class="source-line-no">4258</span><span id="line-4258">    final AdminService.BlockingInterface admin = this.connection.getAdmin(sn);</span>
<span class="source-line-no">4259</span><span id="line-4259">    Callable&lt;Void&gt; callable = new Callable&lt;Void&gt;() {</span>
<span class="source-line-no">4260</span><span id="line-4260">      @Override</span>
<span class="source-line-no">4261</span><span id="line-4261">      public Void call() throws Exception {</span>
<span class="source-line-no">4262</span><span id="line-4262">        // TODO: There is no timeout on this controller. Set one!</span>
<span class="source-line-no">4263</span><span id="line-4263">        HBaseRpcController controller = rpcControllerFactory.newController();</span>
<span class="source-line-no">4264</span><span id="line-4264">        ClearCompactionQueuesRequest request =</span>
<span class="source-line-no">4265</span><span id="line-4265">          RequestConverter.buildClearCompactionQueuesRequest(queues);</span>
<span class="source-line-no">4266</span><span id="line-4266">        admin.clearCompactionQueues(controller, request);</span>
<span class="source-line-no">4267</span><span id="line-4267">        return null;</span>
<span class="source-line-no">4268</span><span id="line-4268">      }</span>
<span class="source-line-no">4269</span><span id="line-4269">    };</span>
<span class="source-line-no">4270</span><span id="line-4270">    ProtobufUtil.call(callable);</span>
<span class="source-line-no">4271</span><span id="line-4271">  }</span>
<span class="source-line-no">4272</span><span id="line-4272"></span>
<span class="source-line-no">4273</span><span id="line-4273">  @Override</span>
<span class="source-line-no">4274</span><span id="line-4274">  public List&lt;ServerName&gt; clearDeadServers(List&lt;ServerName&gt; servers) throws IOException {</span>
<span class="source-line-no">4275</span><span id="line-4275">    return executeCallable(</span>
<span class="source-line-no">4276</span><span id="line-4276">      new MasterCallable&lt;List&lt;ServerName&gt;&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">4277</span><span id="line-4277">        @Override</span>
<span class="source-line-no">4278</span><span id="line-4278">        protected List&lt;ServerName&gt; rpcCall() throws Exception {</span>
<span class="source-line-no">4279</span><span id="line-4279">          ClearDeadServersRequest req = RequestConverter</span>
<span class="source-line-no">4280</span><span id="line-4280">            .buildClearDeadServersRequest(servers == null ? Collections.EMPTY_LIST : servers);</span>
<span class="source-line-no">4281</span><span id="line-4281">          return ProtobufUtil</span>
<span class="source-line-no">4282</span><span id="line-4282">            .toServerNameList(master.clearDeadServers(getRpcController(), req).getServerNameList());</span>
<span class="source-line-no">4283</span><span id="line-4283">        }</span>
<span class="source-line-no">4284</span><span id="line-4284">      });</span>
<span class="source-line-no">4285</span><span id="line-4285">  }</span>
<span class="source-line-no">4286</span><span id="line-4286"></span>
<span class="source-line-no">4287</span><span id="line-4287">  @Override</span>
<span class="source-line-no">4288</span><span id="line-4288">  public void cloneTableSchema(final TableName tableName, final TableName newTableName,</span>
<span class="source-line-no">4289</span><span id="line-4289">    final boolean preserveSplits) throws IOException {</span>
<span class="source-line-no">4290</span><span id="line-4290">    checkTableExists(tableName);</span>
<span class="source-line-no">4291</span><span id="line-4291">    if (tableExists(newTableName)) {</span>
<span class="source-line-no">4292</span><span id="line-4292">      throw new TableExistsException(newTableName);</span>
<span class="source-line-no">4293</span><span id="line-4293">    }</span>
<span class="source-line-no">4294</span><span id="line-4294">    TableDescriptor htd = TableDescriptorBuilder.copy(newTableName, getTableDescriptor(tableName));</span>
<span class="source-line-no">4295</span><span id="line-4295">    if (preserveSplits) {</span>
<span class="source-line-no">4296</span><span id="line-4296">      createTable(htd, getTableSplits(tableName));</span>
<span class="source-line-no">4297</span><span id="line-4297">    } else {</span>
<span class="source-line-no">4298</span><span id="line-4298">      createTable(htd);</span>
<span class="source-line-no">4299</span><span id="line-4299">    }</span>
<span class="source-line-no">4300</span><span id="line-4300">  }</span>
<span class="source-line-no">4301</span><span id="line-4301"></span>
<span class="source-line-no">4302</span><span id="line-4302">  @Override</span>
<span class="source-line-no">4303</span><span id="line-4303">  public boolean switchRpcThrottle(final boolean enable) throws IOException {</span>
<span class="source-line-no">4304</span><span id="line-4304">    return executeCallable(new MasterCallable&lt;Boolean&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">4305</span><span id="line-4305">      @Override</span>
<span class="source-line-no">4306</span><span id="line-4306">      protected Boolean rpcCall() throws Exception {</span>
<span class="source-line-no">4307</span><span id="line-4307">        return this.master.switchRpcThrottle(getRpcController(),</span>
<span class="source-line-no">4308</span><span id="line-4308">          MasterProtos.SwitchRpcThrottleRequest.newBuilder().setRpcThrottleEnabled(enable).build())</span>
<span class="source-line-no">4309</span><span id="line-4309">          .getPreviousRpcThrottleEnabled();</span>
<span class="source-line-no">4310</span><span id="line-4310">      }</span>
<span class="source-line-no">4311</span><span id="line-4311">    });</span>
<span class="source-line-no">4312</span><span id="line-4312">  }</span>
<span class="source-line-no">4313</span><span id="line-4313"></span>
<span class="source-line-no">4314</span><span id="line-4314">  @Override</span>
<span class="source-line-no">4315</span><span id="line-4315">  public boolean isRpcThrottleEnabled() throws IOException {</span>
<span class="source-line-no">4316</span><span id="line-4316">    return executeCallable(new MasterCallable&lt;Boolean&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">4317</span><span id="line-4317">      @Override</span>
<span class="source-line-no">4318</span><span id="line-4318">      protected Boolean rpcCall() throws Exception {</span>
<span class="source-line-no">4319</span><span id="line-4319">        return this.master.isRpcThrottleEnabled(getRpcController(),</span>
<span class="source-line-no">4320</span><span id="line-4320">          IsRpcThrottleEnabledRequest.newBuilder().build()).getRpcThrottleEnabled();</span>
<span class="source-line-no">4321</span><span id="line-4321">      }</span>
<span class="source-line-no">4322</span><span id="line-4322">    });</span>
<span class="source-line-no">4323</span><span id="line-4323">  }</span>
<span class="source-line-no">4324</span><span id="line-4324"></span>
<span class="source-line-no">4325</span><span id="line-4325">  @Override</span>
<span class="source-line-no">4326</span><span id="line-4326">  public boolean exceedThrottleQuotaSwitch(final boolean enable) throws IOException {</span>
<span class="source-line-no">4327</span><span id="line-4327">    return executeCallable(new MasterCallable&lt;Boolean&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">4328</span><span id="line-4328">      @Override</span>
<span class="source-line-no">4329</span><span id="line-4329">      protected Boolean rpcCall() throws Exception {</span>
<span class="source-line-no">4330</span><span id="line-4330">        return this.master</span>
<span class="source-line-no">4331</span><span id="line-4331">          .switchExceedThrottleQuota(getRpcController(),</span>
<span class="source-line-no">4332</span><span id="line-4332">            MasterProtos.SwitchExceedThrottleQuotaRequest.newBuilder()</span>
<span class="source-line-no">4333</span><span id="line-4333">              .setExceedThrottleQuotaEnabled(enable).build())</span>
<span class="source-line-no">4334</span><span id="line-4334">          .getPreviousExceedThrottleQuotaEnabled();</span>
<span class="source-line-no">4335</span><span id="line-4335">      }</span>
<span class="source-line-no">4336</span><span id="line-4336">    });</span>
<span class="source-line-no">4337</span><span id="line-4337">  }</span>
<span class="source-line-no">4338</span><span id="line-4338"></span>
<span class="source-line-no">4339</span><span id="line-4339">  @Override</span>
<span class="source-line-no">4340</span><span id="line-4340">  public Map&lt;TableName, Long&gt; getSpaceQuotaTableSizes() throws IOException {</span>
<span class="source-line-no">4341</span><span id="line-4341">    return executeCallable(</span>
<span class="source-line-no">4342</span><span id="line-4342">      new MasterCallable&lt;Map&lt;TableName, Long&gt;&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">4343</span><span id="line-4343">        @Override</span>
<span class="source-line-no">4344</span><span id="line-4344">        protected Map&lt;TableName, Long&gt; rpcCall() throws Exception {</span>
<span class="source-line-no">4345</span><span id="line-4345">          GetSpaceQuotaRegionSizesResponse resp = master.getSpaceQuotaRegionSizes(</span>
<span class="source-line-no">4346</span><span id="line-4346">            getRpcController(), RequestConverter.buildGetSpaceQuotaRegionSizesRequest());</span>
<span class="source-line-no">4347</span><span id="line-4347">          Map&lt;TableName, Long&gt; tableSizes = new HashMap&lt;&gt;();</span>
<span class="source-line-no">4348</span><span id="line-4348">          for (RegionSizes sizes : resp.getSizesList()) {</span>
<span class="source-line-no">4349</span><span id="line-4349">            TableName tn = ProtobufUtil.toTableName(sizes.getTableName());</span>
<span class="source-line-no">4350</span><span id="line-4350">            tableSizes.put(tn, sizes.getSize());</span>
<span class="source-line-no">4351</span><span id="line-4351">          }</span>
<span class="source-line-no">4352</span><span id="line-4352">          return tableSizes;</span>
<span class="source-line-no">4353</span><span id="line-4353">        }</span>
<span class="source-line-no">4354</span><span id="line-4354">      });</span>
<span class="source-line-no">4355</span><span id="line-4355">  }</span>
<span class="source-line-no">4356</span><span id="line-4356"></span>
<span class="source-line-no">4357</span><span id="line-4357">  @Override</span>
<span class="source-line-no">4358</span><span id="line-4358">  public Map&lt;TableName, SpaceQuotaSnapshot&gt;</span>
<span class="source-line-no">4359</span><span id="line-4359">    getRegionServerSpaceQuotaSnapshots(ServerName serverName) throws IOException {</span>
<span class="source-line-no">4360</span><span id="line-4360">    final AdminService.BlockingInterface admin = this.connection.getAdmin(serverName);</span>
<span class="source-line-no">4361</span><span id="line-4361">    Callable&lt;GetSpaceQuotaSnapshotsResponse&gt; callable =</span>
<span class="source-line-no">4362</span><span id="line-4362">      new Callable&lt;GetSpaceQuotaSnapshotsResponse&gt;() {</span>
<span class="source-line-no">4363</span><span id="line-4363">        @Override</span>
<span class="source-line-no">4364</span><span id="line-4364">        public GetSpaceQuotaSnapshotsResponse call() throws Exception {</span>
<span class="source-line-no">4365</span><span id="line-4365">          return admin.getSpaceQuotaSnapshots(rpcControllerFactory.newController(),</span>
<span class="source-line-no">4366</span><span id="line-4366">            RequestConverter.buildGetSpaceQuotaSnapshotsRequest());</span>
<span class="source-line-no">4367</span><span id="line-4367">        }</span>
<span class="source-line-no">4368</span><span id="line-4368">      };</span>
<span class="source-line-no">4369</span><span id="line-4369">    GetSpaceQuotaSnapshotsResponse resp = ProtobufUtil.call(callable);</span>
<span class="source-line-no">4370</span><span id="line-4370">    Map&lt;TableName, SpaceQuotaSnapshot&gt; snapshots = new HashMap&lt;&gt;();</span>
<span class="source-line-no">4371</span><span id="line-4371">    for (TableQuotaSnapshot snapshot : resp.getSnapshotsList()) {</span>
<span class="source-line-no">4372</span><span id="line-4372">      snapshots.put(ProtobufUtil.toTableName(snapshot.getTableName()),</span>
<span class="source-line-no">4373</span><span id="line-4373">        SpaceQuotaSnapshot.toSpaceQuotaSnapshot(snapshot.getSnapshot()));</span>
<span class="source-line-no">4374</span><span id="line-4374">    }</span>
<span class="source-line-no">4375</span><span id="line-4375">    return snapshots;</span>
<span class="source-line-no">4376</span><span id="line-4376">  }</span>
<span class="source-line-no">4377</span><span id="line-4377"></span>
<span class="source-line-no">4378</span><span id="line-4378">  @Override</span>
<span class="source-line-no">4379</span><span id="line-4379">  public SpaceQuotaSnapshot getCurrentSpaceQuotaSnapshot(String namespace) throws IOException {</span>
<span class="source-line-no">4380</span><span id="line-4380">    return executeCallable(</span>
<span class="source-line-no">4381</span><span id="line-4381">      new MasterCallable&lt;SpaceQuotaSnapshot&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">4382</span><span id="line-4382">        @Override</span>
<span class="source-line-no">4383</span><span id="line-4383">        protected SpaceQuotaSnapshot rpcCall() throws Exception {</span>
<span class="source-line-no">4384</span><span id="line-4384">          GetQuotaStatesResponse resp = master.getQuotaStates(getRpcController(),</span>
<span class="source-line-no">4385</span><span id="line-4385">            RequestConverter.buildGetQuotaStatesRequest());</span>
<span class="source-line-no">4386</span><span id="line-4386">          for (GetQuotaStatesResponse.NamespaceQuotaSnapshot nsSnapshot : resp</span>
<span class="source-line-no">4387</span><span id="line-4387">            .getNsSnapshotsList()) {</span>
<span class="source-line-no">4388</span><span id="line-4388">            if (namespace.equals(nsSnapshot.getNamespace())) {</span>
<span class="source-line-no">4389</span><span id="line-4389">              return SpaceQuotaSnapshot.toSpaceQuotaSnapshot(nsSnapshot.getSnapshot());</span>
<span class="source-line-no">4390</span><span id="line-4390">            }</span>
<span class="source-line-no">4391</span><span id="line-4391">          }</span>
<span class="source-line-no">4392</span><span id="line-4392">          return null;</span>
<span class="source-line-no">4393</span><span id="line-4393">        }</span>
<span class="source-line-no">4394</span><span id="line-4394">      });</span>
<span class="source-line-no">4395</span><span id="line-4395">  }</span>
<span class="source-line-no">4396</span><span id="line-4396"></span>
<span class="source-line-no">4397</span><span id="line-4397">  @Override</span>
<span class="source-line-no">4398</span><span id="line-4398">  public SpaceQuotaSnapshot getCurrentSpaceQuotaSnapshot(TableName tableName) throws IOException {</span>
<span class="source-line-no">4399</span><span id="line-4399">    return executeCallable(</span>
<span class="source-line-no">4400</span><span id="line-4400">      new MasterCallable&lt;SpaceQuotaSnapshot&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">4401</span><span id="line-4401">        @Override</span>
<span class="source-line-no">4402</span><span id="line-4402">        protected SpaceQuotaSnapshot rpcCall() throws Exception {</span>
<span class="source-line-no">4403</span><span id="line-4403">          GetQuotaStatesResponse resp = master.getQuotaStates(getRpcController(),</span>
<span class="source-line-no">4404</span><span id="line-4404">            RequestConverter.buildGetQuotaStatesRequest());</span>
<span class="source-line-no">4405</span><span id="line-4405">          HBaseProtos.TableName protoTableName = ProtobufUtil.toProtoTableName(tableName);</span>
<span class="source-line-no">4406</span><span id="line-4406">          for (GetQuotaStatesResponse.TableQuotaSnapshot tableSnapshot : resp</span>
<span class="source-line-no">4407</span><span id="line-4407">            .getTableSnapshotsList()) {</span>
<span class="source-line-no">4408</span><span id="line-4408">            if (protoTableName.equals(tableSnapshot.getTableName())) {</span>
<span class="source-line-no">4409</span><span id="line-4409">              return SpaceQuotaSnapshot.toSpaceQuotaSnapshot(tableSnapshot.getSnapshot());</span>
<span class="source-line-no">4410</span><span id="line-4410">            }</span>
<span class="source-line-no">4411</span><span id="line-4411">          }</span>
<span class="source-line-no">4412</span><span id="line-4412">          return null;</span>
<span class="source-line-no">4413</span><span id="line-4413">        }</span>
<span class="source-line-no">4414</span><span id="line-4414">      });</span>
<span class="source-line-no">4415</span><span id="line-4415">  }</span>
<span class="source-line-no">4416</span><span id="line-4416"></span>
<span class="source-line-no">4417</span><span id="line-4417">  @Override</span>
<span class="source-line-no">4418</span><span id="line-4418">  public void grant(UserPermission userPermission, boolean mergeExistingPermissions)</span>
<span class="source-line-no">4419</span><span id="line-4419">    throws IOException {</span>
<span class="source-line-no">4420</span><span id="line-4420">    executeCallable(new MasterCallable&lt;Void&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">4421</span><span id="line-4421">      @Override</span>
<span class="source-line-no">4422</span><span id="line-4422">      protected Void rpcCall() throws Exception {</span>
<span class="source-line-no">4423</span><span id="line-4423">        GrantRequest req =</span>
<span class="source-line-no">4424</span><span id="line-4424">          ShadedAccessControlUtil.buildGrantRequest(userPermission, mergeExistingPermissions);</span>
<span class="source-line-no">4425</span><span id="line-4425">        this.master.grant(getRpcController(), req);</span>
<span class="source-line-no">4426</span><span id="line-4426">        return null;</span>
<span class="source-line-no">4427</span><span id="line-4427">      }</span>
<span class="source-line-no">4428</span><span id="line-4428">    });</span>
<span class="source-line-no">4429</span><span id="line-4429">  }</span>
<span class="source-line-no">4430</span><span id="line-4430"></span>
<span class="source-line-no">4431</span><span id="line-4431">  @Override</span>
<span class="source-line-no">4432</span><span id="line-4432">  public void revoke(UserPermission userPermission) throws IOException {</span>
<span class="source-line-no">4433</span><span id="line-4433">    executeCallable(new MasterCallable&lt;Void&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">4434</span><span id="line-4434">      @Override</span>
<span class="source-line-no">4435</span><span id="line-4435">      protected Void rpcCall() throws Exception {</span>
<span class="source-line-no">4436</span><span id="line-4436">        RevokeRequest req = ShadedAccessControlUtil.buildRevokeRequest(userPermission);</span>
<span class="source-line-no">4437</span><span id="line-4437">        this.master.revoke(getRpcController(), req);</span>
<span class="source-line-no">4438</span><span id="line-4438">        return null;</span>
<span class="source-line-no">4439</span><span id="line-4439">      }</span>
<span class="source-line-no">4440</span><span id="line-4440">    });</span>
<span class="source-line-no">4441</span><span id="line-4441">  }</span>
<span class="source-line-no">4442</span><span id="line-4442"></span>
<span class="source-line-no">4443</span><span id="line-4443">  @Override</span>
<span class="source-line-no">4444</span><span id="line-4444">  public List&lt;UserPermission&gt;</span>
<span class="source-line-no">4445</span><span id="line-4445">    getUserPermissions(GetUserPermissionsRequest getUserPermissionsRequest) throws IOException {</span>
<span class="source-line-no">4446</span><span id="line-4446">    return executeCallable(</span>
<span class="source-line-no">4447</span><span id="line-4447">      new MasterCallable&lt;List&lt;UserPermission&gt;&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">4448</span><span id="line-4448">        @Override</span>
<span class="source-line-no">4449</span><span id="line-4449">        protected List&lt;UserPermission&gt; rpcCall() throws Exception {</span>
<span class="source-line-no">4450</span><span id="line-4450">          AccessControlProtos.GetUserPermissionsRequest req =</span>
<span class="source-line-no">4451</span><span id="line-4451">            ShadedAccessControlUtil.buildGetUserPermissionsRequest(getUserPermissionsRequest);</span>
<span class="source-line-no">4452</span><span id="line-4452">          AccessControlProtos.GetUserPermissionsResponse response =</span>
<span class="source-line-no">4453</span><span id="line-4453">            this.master.getUserPermissions(getRpcController(), req);</span>
<span class="source-line-no">4454</span><span id="line-4454">          return response.getUserPermissionList().stream()</span>
<span class="source-line-no">4455</span><span id="line-4455">            .map(userPermission -&gt; ShadedAccessControlUtil.toUserPermission(userPermission))</span>
<span class="source-line-no">4456</span><span id="line-4456">            .collect(Collectors.toList());</span>
<span class="source-line-no">4457</span><span id="line-4457">        }</span>
<span class="source-line-no">4458</span><span id="line-4458">      });</span>
<span class="source-line-no">4459</span><span id="line-4459">  }</span>
<span class="source-line-no">4460</span><span id="line-4460"></span>
<span class="source-line-no">4461</span><span id="line-4461">  @Override</span>
<span class="source-line-no">4462</span><span id="line-4462">  public Future&lt;Void&gt; splitRegionAsync(byte[] regionName) throws IOException {</span>
<span class="source-line-no">4463</span><span id="line-4463">    return splitRegionAsync(regionName, null);</span>
<span class="source-line-no">4464</span><span id="line-4464">  }</span>
<span class="source-line-no">4465</span><span id="line-4465"></span>
<span class="source-line-no">4466</span><span id="line-4466">  @Override</span>
<span class="source-line-no">4467</span><span id="line-4467">  public Future&lt;Void&gt; createTableAsync(TableDescriptor desc) throws IOException {</span>
<span class="source-line-no">4468</span><span id="line-4468">    return createTableAsync(desc, null);</span>
<span class="source-line-no">4469</span><span id="line-4469">  }</span>
<span class="source-line-no">4470</span><span id="line-4470"></span>
<span class="source-line-no">4471</span><span id="line-4471">  @Override</span>
<span class="source-line-no">4472</span><span id="line-4472">  public List&lt;Boolean&gt; hasUserPermissions(String userName, List&lt;Permission&gt; permissions)</span>
<span class="source-line-no">4473</span><span id="line-4473">    throws IOException {</span>
<span class="source-line-no">4474</span><span id="line-4474">    return executeCallable(</span>
<span class="source-line-no">4475</span><span id="line-4475">      new MasterCallable&lt;List&lt;Boolean&gt;&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">4476</span><span id="line-4476">        @Override</span>
<span class="source-line-no">4477</span><span id="line-4477">        protected List&lt;Boolean&gt; rpcCall() throws Exception {</span>
<span class="source-line-no">4478</span><span id="line-4478">          HasUserPermissionsRequest request =</span>
<span class="source-line-no">4479</span><span id="line-4479">            ShadedAccessControlUtil.buildHasUserPermissionsRequest(userName, permissions);</span>
<span class="source-line-no">4480</span><span id="line-4480">          return this.master.hasUserPermissions(getRpcController(), request)</span>
<span class="source-line-no">4481</span><span id="line-4481">            .getHasUserPermissionList();</span>
<span class="source-line-no">4482</span><span id="line-4482">        }</span>
<span class="source-line-no">4483</span><span id="line-4483">      });</span>
<span class="source-line-no">4484</span><span id="line-4484">  }</span>
<span class="source-line-no">4485</span><span id="line-4485"></span>
<span class="source-line-no">4486</span><span id="line-4486">  @Override</span>
<span class="source-line-no">4487</span><span id="line-4487">  public boolean snapshotCleanupSwitch(boolean on, boolean synchronous) throws IOException {</span>
<span class="source-line-no">4488</span><span id="line-4488">    return executeCallable(new MasterCallable&lt;Boolean&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">4489</span><span id="line-4489"></span>
<span class="source-line-no">4490</span><span id="line-4490">      @Override</span>
<span class="source-line-no">4491</span><span id="line-4491">      protected Boolean rpcCall() throws Exception {</span>
<span class="source-line-no">4492</span><span id="line-4492">        SetSnapshotCleanupRequest req =</span>
<span class="source-line-no">4493</span><span id="line-4493">          RequestConverter.buildSetSnapshotCleanupRequest(on, synchronous);</span>
<span class="source-line-no">4494</span><span id="line-4494">        return master.switchSnapshotCleanup(getRpcController(), req).getPrevSnapshotCleanup();</span>
<span class="source-line-no">4495</span><span id="line-4495">      }</span>
<span class="source-line-no">4496</span><span id="line-4496">    });</span>
<span class="source-line-no">4497</span><span id="line-4497"></span>
<span class="source-line-no">4498</span><span id="line-4498">  }</span>
<span class="source-line-no">4499</span><span id="line-4499"></span>
<span class="source-line-no">4500</span><span id="line-4500">  @Override</span>
<span class="source-line-no">4501</span><span id="line-4501">  public boolean isSnapshotCleanupEnabled() throws IOException {</span>
<span class="source-line-no">4502</span><span id="line-4502">    return executeCallable(new MasterCallable&lt;Boolean&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">4503</span><span id="line-4503"></span>
<span class="source-line-no">4504</span><span id="line-4504">      @Override</span>
<span class="source-line-no">4505</span><span id="line-4505">      protected Boolean rpcCall() throws Exception {</span>
<span class="source-line-no">4506</span><span id="line-4506">        IsSnapshotCleanupEnabledRequest req =</span>
<span class="source-line-no">4507</span><span id="line-4507">          RequestConverter.buildIsSnapshotCleanupEnabledRequest();</span>
<span class="source-line-no">4508</span><span id="line-4508">        return master.isSnapshotCleanupEnabled(getRpcController(), req).getEnabled();</span>
<span class="source-line-no">4509</span><span id="line-4509">      }</span>
<span class="source-line-no">4510</span><span id="line-4510">    });</span>
<span class="source-line-no">4511</span><span id="line-4511"></span>
<span class="source-line-no">4512</span><span id="line-4512">  }</span>
<span class="source-line-no">4513</span><span id="line-4513"></span>
<span class="source-line-no">4514</span><span id="line-4514">  private List&lt;LogEntry&gt; getSlowLogResponses(final Map&lt;String, Object&gt; filterParams,</span>
<span class="source-line-no">4515</span><span id="line-4515">    final Set&lt;ServerName&gt; serverNames, final int limit, final String logType) {</span>
<span class="source-line-no">4516</span><span id="line-4516">    if (CollectionUtils.isEmpty(serverNames)) {</span>
<span class="source-line-no">4517</span><span id="line-4517">      return Collections.emptyList();</span>
<span class="source-line-no">4518</span><span id="line-4518">    }</span>
<span class="source-line-no">4519</span><span id="line-4519">    return serverNames.stream().map(serverName -&gt; {</span>
<span class="source-line-no">4520</span><span id="line-4520">      try {</span>
<span class="source-line-no">4521</span><span id="line-4521">        return getSlowLogResponseFromServer(serverName, filterParams, limit, logType);</span>
<span class="source-line-no">4522</span><span id="line-4522">      } catch (IOException e) {</span>
<span class="source-line-no">4523</span><span id="line-4523">        throw new RuntimeException(e);</span>
<span class="source-line-no">4524</span><span id="line-4524">      }</span>
<span class="source-line-no">4525</span><span id="line-4525">    }).flatMap(List::stream).collect(Collectors.toList());</span>
<span class="source-line-no">4526</span><span id="line-4526">  }</span>
<span class="source-line-no">4527</span><span id="line-4527"></span>
<span class="source-line-no">4528</span><span id="line-4528">  private List&lt;LogEntry&gt; getSlowLogResponseFromServer(ServerName serverName,</span>
<span class="source-line-no">4529</span><span id="line-4529">    Map&lt;String, Object&gt; filterParams, int limit, String logType) throws IOException {</span>
<span class="source-line-no">4530</span><span id="line-4530">    AdminService.BlockingInterface admin = this.connection.getAdmin(serverName);</span>
<span class="source-line-no">4531</span><span id="line-4531">    return executeCallable(new RpcRetryingCallable&lt;List&lt;LogEntry&gt;&gt;() {</span>
<span class="source-line-no">4532</span><span id="line-4532">      @Override</span>
<span class="source-line-no">4533</span><span id="line-4533">      protected List&lt;LogEntry&gt; rpcCall(int callTimeout) throws Exception {</span>
<span class="source-line-no">4534</span><span id="line-4534">        HBaseRpcController controller = rpcControllerFactory.newController();</span>
<span class="source-line-no">4535</span><span id="line-4535">        HBaseProtos.LogRequest logRequest =</span>
<span class="source-line-no">4536</span><span id="line-4536">          RequestConverter.buildSlowLogResponseRequest(filterParams, limit, logType);</span>
<span class="source-line-no">4537</span><span id="line-4537">        HBaseProtos.LogEntry logEntry = admin.getLogEntries(controller, logRequest);</span>
<span class="source-line-no">4538</span><span id="line-4538">        return ProtobufUtil.toSlowLogPayloads(logEntry);</span>
<span class="source-line-no">4539</span><span id="line-4539">      }</span>
<span class="source-line-no">4540</span><span id="line-4540">    });</span>
<span class="source-line-no">4541</span><span id="line-4541">  }</span>
<span class="source-line-no">4542</span><span id="line-4542"></span>
<span class="source-line-no">4543</span><span id="line-4543">  @Override</span>
<span class="source-line-no">4544</span><span id="line-4544">  public List&lt;Boolean&gt; clearSlowLogResponses(@Nullable final Set&lt;ServerName&gt; serverNames)</span>
<span class="source-line-no">4545</span><span id="line-4545">    throws IOException {</span>
<span class="source-line-no">4546</span><span id="line-4546">    if (CollectionUtils.isEmpty(serverNames)) {</span>
<span class="source-line-no">4547</span><span id="line-4547">      return Collections.emptyList();</span>
<span class="source-line-no">4548</span><span id="line-4548">    }</span>
<span class="source-line-no">4549</span><span id="line-4549">    return serverNames.stream().map(serverName -&gt; {</span>
<span class="source-line-no">4550</span><span id="line-4550">      try {</span>
<span class="source-line-no">4551</span><span id="line-4551">        return clearSlowLogsResponses(serverName);</span>
<span class="source-line-no">4552</span><span id="line-4552">      } catch (IOException e) {</span>
<span class="source-line-no">4553</span><span id="line-4553">        throw new RuntimeException(e);</span>
<span class="source-line-no">4554</span><span id="line-4554">      }</span>
<span class="source-line-no">4555</span><span id="line-4555">    }).collect(Collectors.toList());</span>
<span class="source-line-no">4556</span><span id="line-4556">  }</span>
<span class="source-line-no">4557</span><span id="line-4557"></span>
<span class="source-line-no">4558</span><span id="line-4558">  @Override</span>
<span class="source-line-no">4559</span><span id="line-4559">  public List&lt;LogEntry&gt; getLogEntries(Set&lt;ServerName&gt; serverNames, String logType,</span>
<span class="source-line-no">4560</span><span id="line-4560">    ServerType serverType, int limit, Map&lt;String, Object&gt; filterParams) throws IOException {</span>
<span class="source-line-no">4561</span><span id="line-4561">    if (logType == null || serverType == null) {</span>
<span class="source-line-no">4562</span><span id="line-4562">      throw new IllegalArgumentException("logType and/or serverType cannot be empty");</span>
<span class="source-line-no">4563</span><span id="line-4563">    }</span>
<span class="source-line-no">4564</span><span id="line-4564">    if (logType.equals("SLOW_LOG") || logType.equals("LARGE_LOG")) {</span>
<span class="source-line-no">4565</span><span id="line-4565">      if (ServerType.MASTER.equals(serverType)) {</span>
<span class="source-line-no">4566</span><span id="line-4566">        throw new IllegalArgumentException("Slow/Large logs are not maintained by HMaster");</span>
<span class="source-line-no">4567</span><span id="line-4567">      }</span>
<span class="source-line-no">4568</span><span id="line-4568">      return getSlowLogResponses(filterParams, serverNames, limit, logType);</span>
<span class="source-line-no">4569</span><span id="line-4569">    } else if (logType.equals("BALANCER_DECISION")) {</span>
<span class="source-line-no">4570</span><span id="line-4570">      if (ServerType.REGION_SERVER.equals(serverType)) {</span>
<span class="source-line-no">4571</span><span id="line-4571">        throw new IllegalArgumentException(</span>
<span class="source-line-no">4572</span><span id="line-4572">          "Balancer Decision logs are not maintained by HRegionServer");</span>
<span class="source-line-no">4573</span><span id="line-4573">      }</span>
<span class="source-line-no">4574</span><span id="line-4574">      return getBalancerDecisions(limit);</span>
<span class="source-line-no">4575</span><span id="line-4575">    } else if (logType.equals("BALANCER_REJECTION")) {</span>
<span class="source-line-no">4576</span><span id="line-4576">      if (ServerType.REGION_SERVER.equals(serverType)) {</span>
<span class="source-line-no">4577</span><span id="line-4577">        throw new IllegalArgumentException(</span>
<span class="source-line-no">4578</span><span id="line-4578">          "Balancer Rejection logs are not maintained by HRegionServer");</span>
<span class="source-line-no">4579</span><span id="line-4579">      }</span>
<span class="source-line-no">4580</span><span id="line-4580">      return getBalancerRejections(limit);</span>
<span class="source-line-no">4581</span><span id="line-4581">    }</span>
<span class="source-line-no">4582</span><span id="line-4582">    return Collections.emptyList();</span>
<span class="source-line-no">4583</span><span id="line-4583">  }</span>
<span class="source-line-no">4584</span><span id="line-4584"></span>
<span class="source-line-no">4585</span><span id="line-4585">  @Override</span>
<span class="source-line-no">4586</span><span id="line-4586">  public void flushMasterStore() throws IOException {</span>
<span class="source-line-no">4587</span><span id="line-4587">    executeCallable(new MasterCallable&lt;Void&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">4588</span><span id="line-4588">      @Override</span>
<span class="source-line-no">4589</span><span id="line-4589">      protected Void rpcCall() throws Exception {</span>
<span class="source-line-no">4590</span><span id="line-4590">        FlushMasterStoreRequest request = FlushMasterStoreRequest.newBuilder().build();</span>
<span class="source-line-no">4591</span><span id="line-4591">        master.flushMasterStore(getRpcController(), request);</span>
<span class="source-line-no">4592</span><span id="line-4592">        return null;</span>
<span class="source-line-no">4593</span><span id="line-4593">      }</span>
<span class="source-line-no">4594</span><span id="line-4594">    });</span>
<span class="source-line-no">4595</span><span id="line-4595">  }</span>
<span class="source-line-no">4596</span><span id="line-4596"></span>
<span class="source-line-no">4597</span><span id="line-4597">  private List&lt;LogEntry&gt; getBalancerDecisions(final int limit) throws IOException {</span>
<span class="source-line-no">4598</span><span id="line-4598">    return executeCallable(</span>
<span class="source-line-no">4599</span><span id="line-4599">      new MasterCallable&lt;List&lt;LogEntry&gt;&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">4600</span><span id="line-4600">        @Override</span>
<span class="source-line-no">4601</span><span id="line-4601">        protected List&lt;LogEntry&gt; rpcCall() throws Exception {</span>
<span class="source-line-no">4602</span><span id="line-4602">          HBaseProtos.LogEntry logEntry =</span>
<span class="source-line-no">4603</span><span id="line-4603">            master.getLogEntries(getRpcController(), ProtobufUtil.toBalancerDecisionRequest(limit));</span>
<span class="source-line-no">4604</span><span id="line-4604">          return ProtobufUtil.toBalancerDecisionResponse(logEntry);</span>
<span class="source-line-no">4605</span><span id="line-4605">        }</span>
<span class="source-line-no">4606</span><span id="line-4606">      });</span>
<span class="source-line-no">4607</span><span id="line-4607">  }</span>
<span class="source-line-no">4608</span><span id="line-4608"></span>
<span class="source-line-no">4609</span><span id="line-4609">  private List&lt;LogEntry&gt; getBalancerRejections(final int limit) throws IOException {</span>
<span class="source-line-no">4610</span><span id="line-4610">    return executeCallable(</span>
<span class="source-line-no">4611</span><span id="line-4611">      new MasterCallable&lt;List&lt;LogEntry&gt;&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">4612</span><span id="line-4612">        @Override</span>
<span class="source-line-no">4613</span><span id="line-4613">        protected List&lt;LogEntry&gt; rpcCall() throws Exception {</span>
<span class="source-line-no">4614</span><span id="line-4614">          HBaseProtos.LogEntry logEntry = master.getLogEntries(getRpcController(),</span>
<span class="source-line-no">4615</span><span id="line-4615">            ProtobufUtil.toBalancerRejectionRequest(limit));</span>
<span class="source-line-no">4616</span><span id="line-4616">          return ProtobufUtil.toBalancerRejectionResponse(logEntry);</span>
<span class="source-line-no">4617</span><span id="line-4617">        }</span>
<span class="source-line-no">4618</span><span id="line-4618">      });</span>
<span class="source-line-no">4619</span><span id="line-4619">  }</span>
<span class="source-line-no">4620</span><span id="line-4620"></span>
<span class="source-line-no">4621</span><span id="line-4621">  private Boolean clearSlowLogsResponses(final ServerName serverName) throws IOException {</span>
<span class="source-line-no">4622</span><span id="line-4622">    AdminService.BlockingInterface admin = this.connection.getAdmin(serverName);</span>
<span class="source-line-no">4623</span><span id="line-4623">    return executeCallable(new RpcRetryingCallable&lt;Boolean&gt;() {</span>
<span class="source-line-no">4624</span><span id="line-4624">      @Override</span>
<span class="source-line-no">4625</span><span id="line-4625">      protected Boolean rpcCall(int callTimeout) throws Exception {</span>
<span class="source-line-no">4626</span><span id="line-4626">        HBaseRpcController controller = rpcControllerFactory.newController();</span>
<span class="source-line-no">4627</span><span id="line-4627">        AdminProtos.ClearSlowLogResponses clearSlowLogResponses = admin</span>
<span class="source-line-no">4628</span><span id="line-4628">          .clearSlowLogsResponses(controller, RequestConverter.buildClearSlowLogResponseRequest());</span>
<span class="source-line-no">4629</span><span id="line-4629">        return ProtobufUtil.toClearSlowLogPayload(clearSlowLogResponses);</span>
<span class="source-line-no">4630</span><span id="line-4630">      }</span>
<span class="source-line-no">4631</span><span id="line-4631">    });</span>
<span class="source-line-no">4632</span><span id="line-4632">  }</span>
<span class="source-line-no">4633</span><span id="line-4633"></span>
<span class="source-line-no">4634</span><span id="line-4634">  @Override</span>
<span class="source-line-no">4635</span><span id="line-4635">  public boolean replicationPeerModificationSwitch(boolean on, boolean drainProcedures)</span>
<span class="source-line-no">4636</span><span id="line-4636">    throws IOException {</span>
<span class="source-line-no">4637</span><span id="line-4637">    ReplicationPeerModificationSwitchRequest request =</span>
<span class="source-line-no">4638</span><span id="line-4638">      ReplicationPeerModificationSwitchRequest.newBuilder().setOn(on).build();</span>
<span class="source-line-no">4639</span><span id="line-4639">    boolean prevOn =</span>
<span class="source-line-no">4640</span><span id="line-4640">      executeCallable(new MasterCallable&lt;Boolean&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">4641</span><span id="line-4641">        @Override</span>
<span class="source-line-no">4642</span><span id="line-4642">        protected Boolean rpcCall() throws Exception {</span>
<span class="source-line-no">4643</span><span id="line-4643">          return master.replicationPeerModificationSwitch(getRpcController(), request)</span>
<span class="source-line-no">4644</span><span id="line-4644">            .getPreviousValue();</span>
<span class="source-line-no">4645</span><span id="line-4645">        }</span>
<span class="source-line-no">4646</span><span id="line-4646">      });</span>
<span class="source-line-no">4647</span><span id="line-4647">    // if we do not need to wait all previous peer modification procedure done, or we are enabling</span>
<span class="source-line-no">4648</span><span id="line-4648">    // peer modification, just return here.</span>
<span class="source-line-no">4649</span><span id="line-4649">    if (!drainProcedures || on) {</span>
<span class="source-line-no">4650</span><span id="line-4650">      return prevOn;</span>
<span class="source-line-no">4651</span><span id="line-4651">    }</span>
<span class="source-line-no">4652</span><span id="line-4652">    // otherwise we need to wait until all previous peer modification procedure done</span>
<span class="source-line-no">4653</span><span id="line-4653">    for (int retry = 0;; retry++) {</span>
<span class="source-line-no">4654</span><span id="line-4654">      List&lt;ProcedureProtos.Procedure&gt; procs =</span>
<span class="source-line-no">4655</span><span id="line-4655">        executeCallable(new MasterCallable&lt;List&lt;ProcedureProtos.Procedure&gt;&gt;(getConnection(),</span>
<span class="source-line-no">4656</span><span id="line-4656">          getRpcControllerFactory()) {</span>
<span class="source-line-no">4657</span><span id="line-4657">          @Override</span>
<span class="source-line-no">4658</span><span id="line-4658">          protected List&lt;ProcedureProtos.Procedure&gt; rpcCall() throws Exception {</span>
<span class="source-line-no">4659</span><span id="line-4659">            return master</span>
<span class="source-line-no">4660</span><span id="line-4660">              .getReplicationPeerModificationProcedures(getRpcController(),</span>
<span class="source-line-no">4661</span><span id="line-4661">                GetReplicationPeerModificationProceduresRequest.getDefaultInstance())</span>
<span class="source-line-no">4662</span><span id="line-4662">              .getProcedureList();</span>
<span class="source-line-no">4663</span><span id="line-4663">          }</span>
<span class="source-line-no">4664</span><span id="line-4664">        });</span>
<span class="source-line-no">4665</span><span id="line-4665">      if (procs.isEmpty()) {</span>
<span class="source-line-no">4666</span><span id="line-4666">        return prevOn;</span>
<span class="source-line-no">4667</span><span id="line-4667">      }</span>
<span class="source-line-no">4668</span><span id="line-4668">      try {</span>
<span class="source-line-no">4669</span><span id="line-4669">        Thread.sleep(ConnectionUtils.getPauseTime(pause, retry));</span>
<span class="source-line-no">4670</span><span id="line-4670">      } catch (InterruptedException e) {</span>
<span class="source-line-no">4671</span><span id="line-4671">        throw (IOException) new InterruptedIOException().initCause(e);</span>
<span class="source-line-no">4672</span><span id="line-4672">      }</span>
<span class="source-line-no">4673</span><span id="line-4673">    }</span>
<span class="source-line-no">4674</span><span id="line-4674">  }</span>
<span class="source-line-no">4675</span><span id="line-4675"></span>
<span class="source-line-no">4676</span><span id="line-4676">  @Override</span>
<span class="source-line-no">4677</span><span id="line-4677">  public boolean isReplicationPeerModificationEnabled() throws IOException {</span>
<span class="source-line-no">4678</span><span id="line-4678">    return executeCallable(new MasterCallable&lt;Boolean&gt;(getConnection(), getRpcControllerFactory()) {</span>
<span class="source-line-no">4679</span><span id="line-4679">      @Override</span>
<span class="source-line-no">4680</span><span id="line-4680">      protected Boolean rpcCall() throws Exception {</span>
<span class="source-line-no">4681</span><span id="line-4681">        return master.isReplicationPeerModificationEnabled(getRpcController(),</span>
<span class="source-line-no">4682</span><span id="line-4682">          IsReplicationPeerModificationEnabledRequest.getDefaultInstance()).getEnabled();</span>
<span class="source-line-no">4683</span><span id="line-4683">      }</span>
<span class="source-line-no">4684</span><span id="line-4684">    });</span>
<span class="source-line-no">4685</span><span id="line-4685">  }</span>
<span class="source-line-no">4686</span><span id="line-4686">}</span>




























































</pre>
</div>
</main>
</body>
</html>
